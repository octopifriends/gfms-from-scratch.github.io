<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 2: Geospatial Data Preprocessing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">GEOG 288KC</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">🏠 home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Syllabus.html"> 
<span class="menu-text">📋 syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-sessions" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">💻 weekly sessions</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-weekly-sessions">    
        <li>
    <a class="dropdown-item" href="../chapters/c01-geospatial-data-foundations.html">
 <span class="dropdown-text">Week 1 - 🚀 Core Tools and Data Access</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c02-spatial-temporal-attention-mechanisms.html">
 <span class="dropdown-text">Week 2 - ⚡ Rapid Remote Sensing Preprocessing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c03-complete-gfm-architecture.html">
 <span class="dropdown-text">Week 3 - 🤖 Machine Learning on Remote Sensing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c04-pretraining-implementation.html">
 <span class="dropdown-text">Week 4 - 🏗️ Foundation Models in Practice</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c05-training-loop-optimization.html">
 <span class="dropdown-text">Week 5 - 🔧 Fine-Tuning &amp; Transfer Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c06-model-evaluation-analysis.html">
 <span class="dropdown-text">Week 6 - ⏰ Spatiotemporal Modeling &amp; Projects</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cheatsheets" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">👀 cheatsheets</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-cheatsheets">    
        <li>
    <a class="dropdown-item" href="../cheatsheets.html">
 <span class="dropdown-text">📋 All Cheatsheets</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">⚡ Quick Starts</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/week01_imports.html">
 <span class="dropdown-text">Week 01: Import Guide</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-explainers" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">🧩 explainers</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-explainers">    
        <li class="dropdown-header">1️⃣ Week 1</li>
        <li>
    <a class="dropdown-item" href="../extras/ai-ml-dl-fm-hierarchy.html">
 <span class="dropdown-text">🤖 AI/ML/DL/FM Hierarchy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/geospatial-foundation-model-predictions-standalone.html">
 <span class="dropdown-text">🎯 GFM Predictions (Standalone)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/geospatial-prediction-hierarchy.html">
 <span class="dropdown-text">✅ Geospatial Task/Prediction Types</span></a>
  </li>  
        <li class="dropdown-header">2️⃣ Week 2</li>
        <li>
    <a class="dropdown-item" href="../chapters/c00a-foundation_model_architectures.html">
 <span class="dropdown-text">🏗️ Foundation Model Architectures</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c00b-introduction-to-deeplearning-architecture.html">
 <span class="dropdown-text">🎓 Introduction to Deep Learning Architecture</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-extras" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">📖 extras</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-extras">    
        <li class="dropdown-header">🎯 Practical Examples</li>
        <li>
    <a class="dropdown-item" href="../extras/examples/normalization_comparison.html">
 <span class="dropdown-text">Normalization Comparison</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/resnet.html">
 <span class="dropdown-text">ResNet Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/text_encoder.html">
 <span class="dropdown-text">Text Encoder</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/tiling-and-patches.html">
 <span class="dropdown-text">Tiling and Patches</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/terratorch_workflows.html">
 <span class="dropdown-text">TerraTorch Workflows</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/resources/course_resources.html">
 <span class="dropdown-text">📚 Reference Materials</span></a>
  </li>  
        <li class="dropdown-header">📁 Project Templates</li>
        <li>
    <a class="dropdown-item" href="../extras/projects/project-proposal-template.html">
 <span class="dropdown-text">Project Proposal Template</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/projects/mvp-template.html">
 <span class="dropdown-text">Project Results Template</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gfms-from-scratch/gfms-from-scratch.github.io" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">Week 2: Geospatial Data Preprocessing</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead">Building efficient pipelines for Sentinel-2 preprocessing</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#session-overview" id="toc-session-overview" class="nav-link" data-scroll-target="#session-overview">Session Overview</a></li>
  <li><a href="#step-1-multi-scene-data-discovery" id="toc-step-1-multi-scene-data-discovery" class="nav-link" data-scroll-target="#step-1-multi-scene-data-discovery">Step 1: Multi-Scene Data Discovery</a>
  <ul class="collapse">
  <li><a href="#define-study-area-and-time-range" id="toc-define-study-area-and-time-range" class="nav-link" data-scroll-target="#define-study-area-and-time-range">Define Study Area and Time Range</a></li>
  <li><a href="#search-for-multiple-scenes" id="toc-search-for-multiple-scenes" class="nav-link" data-scroll-target="#search-for-multiple-scenes">Search for Multiple Scenes</a></li>
  <li><a href="#visualize-scene-coverage" id="toc-visualize-scene-coverage" class="nav-link" data-scroll-target="#visualize-scene-coverage">Visualize Scene Coverage</a></li>
  </ul></li>
  <li><a href="#step-2-cloud-masking-pipeline" id="toc-step-2-cloud-masking-pipeline" class="nav-link" data-scroll-target="#step-2-cloud-masking-pipeline">Step 2: Cloud Masking Pipeline</a>
  <ul class="collapse">
  <li><a href="#understanding-scene-classification-layer" id="toc-understanding-scene-classification-layer" class="nav-link" data-scroll-target="#understanding-scene-classification-layer">Understanding Scene Classification Layer</a></li>
  </ul></li>
  <li><a href="#week-2-function-library" id="toc-week-2-function-library" class="nav-link" data-scroll-target="#week-2-function-library">Week 2 Function Library</a>
  <ul class="collapse">
  <li><a href="#test-cloud-masking-functions" id="toc-test-cloud-masking-functions" class="nav-link" data-scroll-target="#test-cloud-masking-functions">Test Cloud Masking Functions</a></li>
  <li><a href="#visualize-cloud-masking-results" id="toc-visualize-cloud-masking-results" class="nav-link" data-scroll-target="#visualize-cloud-masking-results">Visualize Cloud Masking Results</a></li>
  </ul></li>
  <li><a href="#step-3-reprojection-and-mosaicking" id="toc-step-3-reprojection-and-mosaicking" class="nav-link" data-scroll-target="#step-3-reprojection-and-mosaicking">Step 3: Reprojection and Mosaicking</a>
  <ul class="collapse">
  <li><a href="#batch-process-multiple-scenes" id="toc-batch-process-multiple-scenes" class="nav-link" data-scroll-target="#batch-process-multiple-scenes">Batch Process Multiple Scenes</a></li>
  <li><a href="#create-temporal-mosaic" id="toc-create-temporal-mosaic" class="nav-link" data-scroll-target="#create-temporal-mosaic">Create Temporal Mosaic</a></li>
  </ul></li>
  <li><a href="#step-4-analysis-ready-data-cubes" id="toc-step-4-analysis-ready-data-cubes" class="nav-link" data-scroll-target="#step-4-analysis-ready-data-cubes">Step 4: Analysis-Ready Data Cubes</a>
  <ul class="collapse">
  <li><a href="#build-temporal-data-cube" id="toc-build-temporal-data-cube" class="nav-link" data-scroll-target="#build-temporal-data-cube">Build Temporal Data Cube</a></li>
  <li><a href="#time-series-analysis-example" id="toc-time-series-analysis-example" class="nav-link" data-scroll-target="#time-series-analysis-example">Time Series Analysis Example</a></li>
  </ul></li>
  <li><a href="#step-5-scalable-batch-processing-workflow" id="toc-step-5-scalable-batch-processing-workflow" class="nav-link" data-scroll-target="#step-5-scalable-batch-processing-workflow">Step 5: Scalable Batch Processing Workflow</a>
  <ul class="collapse">
  <li><a href="#preprocessing-pipeline-class" id="toc-preprocessing-pipeline-class" class="nav-link" data-scroll-target="#preprocessing-pipeline-class">Preprocessing Pipeline Class</a></li>
  <li><a href="#initialize-and-test-the-preprocessing-pipeline" id="toc-initialize-and-test-the-preprocessing-pipeline" class="nav-link" data-scroll-target="#initialize-and-test-the-preprocessing-pipeline">Initialize and Test the Preprocessing Pipeline</a></li>
  <li><a href="#run-complete-preprocessing-workflow" id="toc-run-complete-preprocessing-workflow" class="nav-link" data-scroll-target="#run-complete-preprocessing-workflow">Run Complete Preprocessing Workflow</a></li>
  <li><a href="#create-processing-summary-report" id="toc-create-processing-summary-report" class="nav-link" data-scroll-target="#create-processing-summary-report">Create Processing Summary Report</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a>
  <ul class="collapse">
  <li><a href="#what-you-accomplished" id="toc-what-you-accomplished" class="nav-link" data-scroll-target="#what-you-accomplished">What You Accomplished:</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways:</a></li>
  <li><a href="#course-integration" id="toc-course-integration" class="nav-link" data-scroll-target="#course-integration">Course Integration</a></li>
  <li><a href="#next-week-preview" id="toc-next-week-preview" class="nav-link" data-scroll-target="#next-week-preview">Next Week Preview:</a></li>
  </ul></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This week we’ll build production-ready preprocessing pipelines that can handle multiple Sentinel-2 scenes efficiently. You’ll learn to process entire datasets, not just single scenes, with cloud masking, reprojection, and mosaicking.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>Before starting this session, ensure you have:</p>
<ul>
<li>Completed Week 1: Geospatial Data Foundations</li>
<li>Activated the <code>geoAI</code> conda environment</li>
<li>Access to UCSB AI Sandbox or local environment with 8GB+ RAM</li>
<li>Basic familiarity with xarray and rasterio from Week 1</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Optional NetCDF4 Installation
</div>
</div>
<div class="callout-body-container callout-body">
<p>For optimal performance saving data cubes, install netCDF4:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install netcdf4</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> install netcdf4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If netCDF4 is unavailable, the code will automatically fallback to scipy or zarr formats.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Computational Requirements
</div>
</div>
<div class="callout-body-container callout-body">
<p>Processing multiple Sentinel-2 scenes requires significant memory and storage. Each scene can be 100MB+ when loaded. Use the provided chunking parameters or reduce the number of scenes if running locally with limited resources.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning Goals
</div>
</div>
<div class="callout-body-container callout-body">
<p>By the end of this session, you will:</p>
<ul>
<li>Build reproducible preprocessing pipelines for multiple scenes</li>
<li>Handle cloud masking using Sentinel-2’s Scene Classification Layer</li>
<li>Reproject and mosaic multiple satellite scenes</li>
<li>Create analysis-ready data cubes with xarray</li>
<li>Optimize workflows with dask for large datasets</li>
</ul>
</div>
</div>
</section>
<section id="session-overview" class="level2">
<h2 class="anchored" data-anchor-id="session-overview">Session Overview</h2>
<p>Today’s hands-on workflow:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 19%">
<col style="width: 32%">
<col style="width: 22%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Activity</th>
<th>Tools</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Multi-scene data discovery</td>
<td>pystac-client</td>
<td>Scene inventory</td>
</tr>
<tr class="even">
<td>2</td>
<td>Cloud masking pipeline</td>
<td>rasterio, numpy</td>
<td>Clean pixels only</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Reprojection &amp; mosaicking</td>
<td>rasterio, rioxarray</td>
<td>Unified grid</td>
</tr>
<tr class="even">
<td>4</td>
<td>Analysis-ready data cubes</td>
<td>xarray, dask</td>
<td>Time series ready data</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Batch processing workflow</td>
<td>pathlib, concurrent.futures</td>
<td>Scalable pipeline</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="step-1-multi-scene-data-discovery" class="level2">
<h2 class="anchored" data-anchor-id="step-1-multi-scene-data-discovery">Step 1: Multi-Scene Data Discovery</h2>
<p>Let’s scale up from Week 1’s single scene approach to handle multiple scenes across time and space.</p>
<section id="define-study-area-and-time-range" class="level3">
<h3 class="anchored" data-anchor-id="define-study-area-and-time-range">Define Study Area and Time Range</h3>
<div id="7d528dd8" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import functions from our geogfm module</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c01 <span class="im">import</span> (</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    verify_environment,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    setup_planetary_computer_auth,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    search_sentinel2_scenes,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    load_sentinel2_bands</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Core libraries</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.warp <span class="im">import</span> calculate_default_transform, reproject, Resampling</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.merge <span class="im">import</span> merge</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pystac_client <span class="im">import</span> Client</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client <span class="im">as</span> DaskClient</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple, Optional, Union</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify environment using our standardized function</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>required_packages <span class="op">=</span> [</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'numpy'</span>, <span class="st">'pandas'</span>, <span class="st">'xarray'</span>, <span class="st">'rasterio'</span>, <span class="st">'rioxarray'</span>,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pystac_client'</span>, <span class="st">'folium'</span>, <span class="st">'matplotlib'</span>, <span class="st">'dask'</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>env_status <span class="op">=</span> verify_environment(required_packages)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up study area - Central Valley, California (agriculture focus)</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>central_valley_bbox <span class="op">=</span> [<span class="op">-</span><span class="fl">121.5</span>, <span class="fl">36.5</span>, <span class="op">-</span><span class="fl">120.0</span>, <span class="fl">38.0</span>]  <span class="co"># [west, south, east, north]</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Define longer time range for trend analysis</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"2024-06-01"</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2024-09-01"</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>max_cloud_cover <span class="op">=</span> <span class="dv">15</span>  <span class="co"># More restrictive for cleaner mosaics</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🗺️ Study Area: Central Valley, California"</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📅 Time Range: </span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"☁️ Max Cloud Cover: </span><span class="sc">{</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ All 9 packages verified
🗺️ Study Area: Central Valley, California
📅 Time Range: 2024-06-01 to 2024-09-01
☁️ Max Cloud Cover: 15%</code></pre>
</div>
</div>
</section>
<section id="search-for-multiple-scenes" class="level3">
<h3 class="anchored" data-anchor-id="search-for-multiple-scenes">Search for Multiple Scenes</h3>
<div id="9cf039af" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up authentication using our standardized function</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>auth_status <span class="op">=</span> setup_planetary_computer_auth()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for scenes using our enhanced search function</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🔍 Searching for multiple Sentinel-2 scenes..."</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> search_sentinel2_scenes(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    bbox<span class="op">=</span>central_valley_bbox,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    date_range<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    cloud_cover_max<span class="op">=</span>max_cloud_cover,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span><span class="dv">50</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📸 Found </span><span class="sc">{</span><span class="bu">len</span>(items)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Organize scenes by date and tile</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>scene_info <span class="op">=</span> []</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    props <span class="op">=</span> item.properties</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> props[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    tile_id <span class="op">=</span> item.<span class="bu">id</span>.split(<span class="st">'_'</span>)[<span class="dv">5</span>]  <span class="co"># Extract tile ID from scene name</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    cloud_cover <span class="op">=</span> props.get(<span class="st">'eo:cloud_cover'</span>, <span class="dv">0</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    scene_info.append({</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'id'</span>: item.<span class="bu">id</span>,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'date'</span>: date,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tile'</span>: tile_id,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cloud_cover'</span>: cloud_cover,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'item'</span>: item</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame for easier analysis</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>scenes_df <span class="op">=</span> pd.DataFrame(scene_info)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Scene Distribution:"</span>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Unique dates: </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Unique tiles: </span><span class="sc">{</span>scenes_df[<span class="st">'tile'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Date range: </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Show scenes by tile</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🗂️ Scenes by Tile:"</span>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>tile_counts <span class="op">=</span> scenes_df.groupby(<span class="st">'tile'</span>).size().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tile, count <span class="kw">in</span> tile_counts.head().items():</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    avg_cloud <span class="op">=</span> scenes_df[scenes_df[<span class="st">'tile'</span>] <span class="op">==</span> tile][<span class="st">'cloud_cover'</span>].mean()</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>tile<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> scenes (avg cloud: </span><span class="sc">{</span>avg_cloud<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:38:26,681 - INFO - Using anonymous access (basic rate limits)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>🔍 Searching for multiple Sentinel-2 scenes...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:38:31,720 - INFO - Found 279 Sentinel-2 scenes (cloud cover &lt; 15%)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>📸 Found 279 scenes

📊 Scene Distribution:
   Unique dates: 34
   Unique tiles: 181
   Date range: 2024-06-02 to 2024-08-31

🗂️ Scenes by Tile:
   20240901T011152: 9 scenes (avg cloud: 1.6%)
   20240829T011944: 9 scenes (avg cloud: 0.0%)
   20240826T222522: 9 scenes (avg cloud: 0.9%)
   20240822T022354: 9 scenes (avg cloud: 0.0%)
   20240819T015050: 9 scenes (avg cloud: 0.0%)</code></pre>
</div>
</div>
</section>
<section id="visualize-scene-coverage" class="level3">
<h3 class="anchored" data-anchor-id="visualize-scene-coverage">Visualize Scene Coverage</h3>
<div id="701fc605" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create map showing all scene footprints</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    location<span class="op">=</span>[<span class="fl">37.25</span>, <span class="op">-</span><span class="fl">120.75</span>],  <span class="co"># Center of Central Valley</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    zoom_start<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">'OpenStreetMap'</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add study area boundary</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>folium.Rectangle(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    bounds<span class="op">=</span>[[central_valley_bbox[<span class="dv">1</span>], central_valley_bbox[<span class="dv">0</span>]],</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            [central_valley_bbox[<span class="dv">3</span>], central_valley_bbox[<span class="dv">2</span>]]],</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    weight<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span><span class="st">"Study Area: Central Valley"</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Add scene footprints colored by date</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'blue'</span>, <span class="st">'green'</span>, <span class="st">'orange'</span>, <span class="st">'purple'</span>, <span class="st">'red'</span>]</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>unique_dates <span class="op">=</span> <span class="bu">sorted</span>(scenes_df[<span class="st">'date'</span>].unique())</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(unique_dates[:<span class="dv">5</span>]):  <span class="co"># Show first 5 dates</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    date_scenes <span class="op">=</span> scenes_df[scenes_df[<span class="st">'date'</span>] <span class="op">==</span> date]</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> colors[i <span class="op">%</span> <span class="bu">len</span>(colors)]</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, scene <span class="kw">in</span> date_scenes.iterrows():</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        item <span class="op">=</span> scene[<span class="st">'item'</span>]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        geom <span class="op">=</span> item.geometry</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add scene footprint</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        folium.GeoJson(</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>            geom,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>            style_function<span class="op">=</span><span class="kw">lambda</span> x, color<span class="op">=</span>color: {</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fillColor'</span>: color,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">'color'</span>: color,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">'weight'</span>: <span class="dv">2</span>,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fillOpacity'</span>: <span class="fl">0.3</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">=</span><span class="ss">f"Date: </span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">&lt;br&gt;Tile: </span><span class="sc">{</span>scene[<span class="st">'tile'</span>]<span class="sc">}</span><span class="ss">&lt;br&gt;Cloud: </span><span class="sc">{</span>scene[<span class="st">'cloud_cover'</span>]<span class="sc">:.1f}</span><span class="ss">%"</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        ).add_to(m)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🗺️ Scene coverage map created"</span>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>🗺️ Scene coverage map created</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div style="width:100%;"><div style="position:relative;width:100%;height:0;padding-bottom:60%;"><span style="color:#565656">Make this Notebook Trusted to load map: File -&gt; Trust Notebook</span><iframe srcdoc="<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot; />
    <script src=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js&quot;></script>
    <script src=&quot;https://code.jquery.com/jquery-3.7.1.min.js&quot;></script>
    <script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js&quot;></script>
    <script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js&quot;></script>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css&quot;/>
    
            <meta name=&quot;viewport&quot; content=&quot;width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot; />
            <style>
                #map_d049ed66b22c7d65c603a6468a0a8226 {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
</head>
<body>
    
    
            <div class=&quot;folium-map&quot; id=&quot;map_d049ed66b22c7d65c603a6468a0a8226&quot; ></div>
        
</body>
<script>
    
    
            var map_d049ed66b22c7d65c603a6468a0a8226 = L.map(
                &quot;map_d049ed66b22c7d65c603a6468a0a8226&quot;,
                {
                    center: [37.25, -120.75],
                    crs: L.CRS.EPSG3857,
                    ...{
  &quot;zoom&quot;: 8,
  &quot;zoomControl&quot;: true,
  &quot;preferCanvas&quot;: false,
}

                }
            );

            

        
    
            var tile_layer_170f2c628d516f6201a689ee09bfcaf2 = L.tileLayer(
                &quot;https://tile.openstreetmap.org/{z}/{x}/{y}.png&quot;,
                {
  &quot;minZoom&quot;: 0,
  &quot;maxZoom&quot;: 19,
  &quot;maxNativeZoom&quot;: 19,
  &quot;noWrap&quot;: false,
  &quot;attribution&quot;: &quot;\u0026copy; \u003ca href=\&quot;https://www.openstreetmap.org/copyright\&quot;\u003eOpenStreetMap\u003c/a\u003e contributors&quot;,
  &quot;subdomains&quot;: &quot;abc&quot;,
  &quot;detectRetina&quot;: false,
  &quot;tms&quot;: false,
  &quot;opacity&quot;: 1,
}

            );
        
    
            tile_layer_170f2c628d516f6201a689ee09bfcaf2.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
            var rectangle_ce4d7c09c66113a3742b06013c045a40 = L.rectangle(
                [[36.5, -121.5], [38.0, -120.0]],
                {&quot;bubblingMouseEvents&quot;: true, &quot;color&quot;: &quot;red&quot;, &quot;dashArray&quot;: null, &quot;dashOffset&quot;: null, &quot;fill&quot;: false, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.2, &quot;fillRule&quot;: &quot;evenodd&quot;, &quot;lineCap&quot;: &quot;round&quot;, &quot;lineJoin&quot;: &quot;round&quot;, &quot;noClip&quot;: false, &quot;opacity&quot;: 1.0, &quot;smoothFactor&quot;: 1.0, &quot;stroke&quot;: true, &quot;weight&quot;: 3}
            ).addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        var popup_7ee818d8af2bf0b693edb24ba23d2295 = L.popup({
  &quot;maxWidth&quot;: &quot;100%&quot;,
});

        
            
                var html_84931da9cb82e94860f64654e9123ccb = $(`<div id=&quot;html_84931da9cb82e94860f64654e9123ccb&quot; style=&quot;width: 100.0%; height: 100.0%;&quot;>Study Area: Central Valley</div>`)[0];
                popup_7ee818d8af2bf0b693edb24ba23d2295.setContent(html_84931da9cb82e94860f64654e9123ccb);
            
        

        rectangle_ce4d7c09c66113a3742b06013c045a40.bindPopup(popup_7ee818d8af2bf0b693edb24ba23d2295)
        ;

        
    
    
        function geo_json_a9d666fae758b8b5efafd4a3333ec0b6_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;blue&quot;, &quot;fillColor&quot;: &quot;blue&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_a9d666fae758b8b5efafd4a3333ec0b6_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_a9d666fae758b8b5efafd4a3333ec0b6 = L.geoJson(null, {
                onEachFeature: geo_json_a9d666fae758b8b5efafd4a3333ec0b6_onEachFeature,
            
                style: geo_json_a9d666fae758b8b5efafd4a3333ec0b6_styler,
            ...{
}
        });

        function geo_json_a9d666fae758b8b5efafd4a3333ec0b6_add (data) {
            geo_json_a9d666fae758b8b5efafd4a3333ec0b6
                .addData(data);
        }
            geo_json_a9d666fae758b8b5efafd4a3333ec0b6_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3677672, 36.9987506], [-120.3709121, 36.9892526], [-120.3713182, 36.9986681], [-120.3677672, 36.9987506]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_a9d666fae758b8b5efafd4a3333ec0b6.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_472c1320fb66e71f6125fe2a4972e2b0_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;blue&quot;, &quot;fillColor&quot;: &quot;blue&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_472c1320fb66e71f6125fe2a4972e2b0_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_472c1320fb66e71f6125fe2a4972e2b0 = L.geoJson(null, {
                onEachFeature: geo_json_472c1320fb66e71f6125fe2a4972e2b0_onEachFeature,
            
                style: geo_json_472c1320fb66e71f6125fe2a4972e2b0_styler,
            ...{
}
        });

        function geo_json_472c1320fb66e71f6125fe2a4972e2b0_add (data) {
            geo_json_472c1320fb66e71f6125fe2a4972e2b0
                .addData(data);
        }
            geo_json_472c1320fb66e71f6125fe2a4972e2b0_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0661728, 37.9062984], [-120.0891186, 37.8352618], [-120.1395301, 37.6888719], [-120.1875779, 37.5418041], [-120.2361422, 37.3947807], [-120.2850237, 37.2478917], [-120.333877, 37.101105], [-120.3709737, 36.9890666], [-120.4119725, 37.8980998], [-120.0661728, 37.9062984]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_472c1320fb66e71f6125fe2a4972e2b0.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_bdcbe4f3596b295e8c35540f4036c225_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;blue&quot;, &quot;fillColor&quot;: &quot;blue&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_bdcbe4f3596b295e8c35540f4036c225_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_bdcbe4f3596b295e8c35540f4036c225 = L.geoJson(null, {
                onEachFeature: geo_json_bdcbe4f3596b295e8c35540f4036c225_onEachFeature,
            
                style: geo_json_bdcbe4f3596b295e8c35540f4036c225_styler,
            ...{
}
        });

        function geo_json_bdcbe4f3596b295e8c35540f4036c225_add (data) {
            geo_json_bdcbe4f3596b295e8c35540f4036c225
                .addData(data);
        }
            geo_json_bdcbe4f3596b295e8c35540f4036c225_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3621005, 37.015865], [-120.3824602, 36.9543753], [-120.4308402, 36.8077022], [-120.4790582, 36.6610691], [-120.5276636, 36.5145963], [-120.5773539, 36.3684335], [-120.6246242, 36.2215667], [-120.6716921, 36.0746527], [-120.6848067, 36.0339168], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843], [-120.3621005, 37.015865]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_bdcbe4f3596b295e8c35540f4036c225.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b = L.geoJson(null, {
                onEachFeature: geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b_onEachFeature,
            
                style: geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b_styler,
            ...{
}
        });

        function geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b_add (data) {
            geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b
                .addData(data);
        }
            geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.5183132, 36.0462544], [-121.5103068, 36.0728152], [-121.4707947, 36.2209197], [-121.4281425, 36.3680188], [-121.3888727, 36.516128], [-121.345842, 36.6630775], [-121.3055075, 36.8109287], [-121.2632436, 36.9582434], [-121.2422437, 37.0319569], [-120.6415325, 37.0231378], [-120.6713858, 36.034105], [-121.5183132, 36.0462544]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_b1d25343e2b7d23d81c7e2a38db35512_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_b1d25343e2b7d23d81c7e2a38db35512_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_b1d25343e2b7d23d81c7e2a38db35512 = L.geoJson(null, {
                onEachFeature: geo_json_b1d25343e2b7d23d81c7e2a38db35512_onEachFeature,
            
                style: geo_json_b1d25343e2b7d23d81c7e2a38db35512_styler,
            ...{
}
        });

        function geo_json_b1d25343e2b7d23d81c7e2a38db35512_add (data) {
            geo_json_b1d25343e2b7d23d81c7e2a38db35512
                .addData(data);
        }
            geo_json_b1d25343e2b7d23d81c7e2a38db35512_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.6965296, 38.8262817], [-119.4335472, 38.7945272], [-119.4816378, 37.806857], [-120.7276358, 37.8375122], [-120.6965296, 38.8262817]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_b1d25343e2b7d23d81c7e2a38db35512.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_9025f109aa713ac986f6e28fe6686e89_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_9025f109aa713ac986f6e28fe6686e89_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_9025f109aa713ac986f6e28fe6686e89 = L.geoJson(null, {
                onEachFeature: geo_json_9025f109aa713ac986f6e28fe6686e89_onEachFeature,
            
                style: geo_json_9025f109aa713ac986f6e28fe6686e89_styler,
            ...{
}
        });

        function geo_json_9025f109aa713ac986f6e28fe6686e89_add (data) {
            geo_json_9025f109aa713ac986f6e28fe6686e89
                .addData(data);
        }
            geo_json_9025f109aa713ac986f6e28fe6686e89_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.4119725, 37.8980998], [-119.1643298, 37.9276804], [-119.136025, 36.9386673], [-120.367413, 36.9101192], [-120.4119725, 37.8980998]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_9025f109aa713ac986f6e28fe6686e89.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_acfd80d0dfd259dbb04a48b1aff1d65f_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_acfd80d0dfd259dbb04a48b1aff1d65f_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_acfd80d0dfd259dbb04a48b1aff1d65f = L.geoJson(null, {
                onEachFeature: geo_json_acfd80d0dfd259dbb04a48b1aff1d65f_onEachFeature,
            
                style: geo_json_acfd80d0dfd259dbb04a48b1aff1d65f_styler,
            ...{
}
        });

        function geo_json_acfd80d0dfd259dbb04a48b1aff1d65f_add (data) {
            geo_json_acfd80d0dfd259dbb04a48b1aff1d65f
                .addData(data);
        }
            geo_json_acfd80d0dfd259dbb04a48b1aff1d65f_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.454503, 38.7978946], [-119.1913473, 38.8284398], [-119.1617522, 37.8395955], [-120.4079147, 37.8101079], [-120.454503, 38.7978946]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_acfd80d0dfd259dbb04a48b1aff1d65f.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_7e30e2a9a529def0339ce5386a8de15d_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_7e30e2a9a529def0339ce5386a8de15d_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_7e30e2a9a529def0339ce5386a8de15d = L.geoJson(null, {
                onEachFeature: geo_json_7e30e2a9a529def0339ce5386a8de15d_onEachFeature,
            
                style: geo_json_7e30e2a9a529def0339ce5386a8de15d_styler,
            ...{
}
        });

        function geo_json_7e30e2a9a529def0339ce5386a8de15d_add (data) {
            geo_json_7e30e2a9a529def0339ce5386a8de15d
                .addData(data);
        }
            geo_json_7e30e2a9a529def0339ce5386a8de15d_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.7520695, 37.0252843], [-119.5194145, 36.9955107], [-119.563414, 36.007451], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_7e30e2a9a529def0339ce5386a8de15d.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_be31269e009d4f58808e89e29429e8a6_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_be31269e009d4f58808e89e29429e8a6_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_be31269e009d4f58808e89e29429e8a6 = L.geoJson(null, {
                onEachFeature: geo_json_be31269e009d4f58808e89e29429e8a6_onEachFeature,
            
                style: geo_json_be31269e009d4f58808e89e29429e8a6_styler,
            ...{
}
        });

        function geo_json_be31269e009d4f58808e89e29429e8a6_add (data) {
            geo_json_be31269e009d4f58808e89e29429e8a6
                .addData(data);
        }
            geo_json_be31269e009d4f58808e89e29429e8a6_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.7249265, 37.9255905], [-119.4774491, 37.8948387], [-119.5234457, 36.9069718], [-120.7546767, 36.9366504], [-120.7249265, 37.9255905]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_be31269e009d4f58808e89e29429e8a6.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_c08b135f18ca4101c2092d7a52edb95a_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_c08b135f18ca4101c2092d7a52edb95a_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_c08b135f18ca4101c2092d7a52edb95a = L.geoJson(null, {
                onEachFeature: geo_json_c08b135f18ca4101c2092d7a52edb95a_onEachFeature,
            
                style: geo_json_c08b135f18ca4101c2092d7a52edb95a_styler,
            ...{
}
        });

        function geo_json_c08b135f18ca4101c2092d7a52edb95a_add (data) {
            geo_json_c08b135f18ca4101c2092d7a52edb95a
                .addData(data);
        }
            geo_json_c08b135f18ca4101c2092d7a52edb95a_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.0115329, 37.8412183], [-121.0108995, 37.8434163], [-120.9682952, 37.9908182], [-120.9256071, 38.1381503], [-120.88266, 38.285366], [-120.8393857, 38.4325087], [-120.7959228, 38.5796384], [-120.7522505, 38.726786], [-120.7227048, 38.8261231], [-120.5832678, 38.8239923], [-120.6159, 37.8353021], [-121.0115329, 37.8412183]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_c08b135f18ca4101c2092d7a52edb95a.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f = L.geoJson(null, {
                onEachFeature: geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f_onEachFeature,
            
                style: geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f_styler,
            ...{
}
        });

        function geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f_add (data) {
            geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f
                .addData(data);
        }
            geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.267433, 36.9436409], [-121.2632436, 36.9582434], [-121.2212438, 37.1056707], [-121.1796672, 37.2532811], [-121.1380228, 37.4009556], [-121.0958403, 37.5484889], [-121.0533928, 37.6959631], [-121.0108995, 37.8434163], [-120.9861733, 37.9289639], [-120.6130578, 37.9233735], [-120.6442676, 36.9345108], [-121.267433, 36.9436409]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_743a30183685e4d314cc3605ae01b323_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_743a30183685e4d314cc3605ae01b323_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_743a30183685e4d314cc3605ae01b323 = L.geoJson(null, {
                onEachFeature: geo_json_743a30183685e4d314cc3605ae01b323_onEachFeature,
            
                style: geo_json_743a30183685e4d314cc3605ae01b323_styler,
            ...{
}
        });

        function geo_json_743a30183685e4d314cc3605ae01b323_add (data) {
            geo_json_743a30183685e4d314cc3605ae01b323
                .addData(data);
        }
            geo_json_743a30183685e4d314cc3605ae01b323_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3713182, 36.9986681], [-119.1385056, 37.0273077], [-119.1114312, 36.038128], [-120.3286936, 36.0104973], [-120.3713182, 36.9986681]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_743a30183685e4d314cc3605ae01b323.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_5c11ab313471be9375433420fa827c9f_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_5c11ab313471be9375433420fa827c9f_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_5c11ab313471be9375433420fa827c9f = L.geoJson(null, {
                onEachFeature: geo_json_5c11ab313471be9375433420fa827c9f_onEachFeature,
            
                style: geo_json_5c11ab313471be9375433420fa827c9f_styler,
            ...{
}
        });

        function geo_json_5c11ab313471be9375433420fa827c9f_add (data) {
            geo_json_5c11ab313471be9375433420fa827c9f
                .addData(data);
        }
            geo_json_5c11ab313471be9375433420fa827c9f_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3653635, 36.9988064], [-120.3706356, 36.9828436], [-120.3713182, 36.9986681], [-120.3653635, 36.9988064]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_5c11ab313471be9375433420fa827c9f.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_65f7ac8e139ab79c58f4dd870c6f64cd_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_65f7ac8e139ab79c58f4dd870c6f64cd_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_65f7ac8e139ab79c58f4dd870c6f64cd = L.geoJson(null, {
                onEachFeature: geo_json_65f7ac8e139ab79c58f4dd870c6f64cd_onEachFeature,
            
                style: geo_json_65f7ac8e139ab79c58f4dd870c6f64cd_styler,
            ...{
}
        });

        function geo_json_65f7ac8e139ab79c58f4dd870c6f64cd_add (data) {
            geo_json_65f7ac8e139ab79c58f4dd870c6f64cd
                .addData(data);
        }
            geo_json_65f7ac8e139ab79c58f4dd870c6f64cd_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3653635, 36.9988064], [-120.3706356, 36.9828436], [-120.3713182, 36.9986681], [-120.3653635, 36.9988064]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_65f7ac8e139ab79c58f4dd870c6f64cd.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_fb3eb0e7a99bdc11341e62a90761afe3_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_fb3eb0e7a99bdc11341e62a90761afe3_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_fb3eb0e7a99bdc11341e62a90761afe3 = L.geoJson(null, {
                onEachFeature: geo_json_fb3eb0e7a99bdc11341e62a90761afe3_onEachFeature,
            
                style: geo_json_fb3eb0e7a99bdc11341e62a90761afe3_styler,
            ...{
}
        });

        function geo_json_fb3eb0e7a99bdc11341e62a90761afe3_add (data) {
            geo_json_fb3eb0e7a99bdc11341e62a90761afe3
                .addData(data);
        }
            geo_json_fb3eb0e7a99bdc11341e62a90761afe3_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3597483, 37.0158081], [-120.3973688, 36.9019016], [-120.4457834, 36.7550418], [-120.4940714, 36.6082331], [-120.5382225, 36.4767954], [-120.5435159, 36.4610484], [-120.5498634, 36.4420946], [-120.5923575, 36.3152929], [-120.6389721, 36.1682105], [-120.6825712, 36.0338641], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843], [-120.3597483, 37.0158081]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_fb3eb0e7a99bdc11341e62a90761afe3.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_1ec994d3962a8afc695c9491c5fde6ef_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_1ec994d3962a8afc695c9491c5fde6ef_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_1ec994d3962a8afc695c9491c5fde6ef = L.geoJson(null, {
                onEachFeature: geo_json_1ec994d3962a8afc695c9491c5fde6ef_onEachFeature,
            
                style: geo_json_1ec994d3962a8afc695c9491c5fde6ef_styler,
            ...{
}
        });

        function geo_json_1ec994d3962a8afc695c9491c5fde6ef_add (data) {
            geo_json_1ec994d3962a8afc695c9491c5fde6ef
                .addData(data);
        }
            geo_json_1ec994d3962a8afc695c9491c5fde6ef_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.8477095, 38.8433146], [-120.5832678, 38.8239923], [-120.6159, 37.8353021], [-121.8632824, 37.853955], [-121.8477095, 38.8433146]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_1ec994d3962a8afc695c9491c5fde6ef.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_30fa7b0de6f6a01c311202ba1301a1c9_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_30fa7b0de6f6a01c311202ba1301a1c9_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_30fa7b0de6f6a01c311202ba1301a1c9 = L.geoJson(null, {
                onEachFeature: geo_json_30fa7b0de6f6a01c311202ba1301a1c9_onEachFeature,
            
                style: geo_json_30fa7b0de6f6a01c311202ba1301a1c9_styler,
            ...{
}
        });

        function geo_json_30fa7b0de6f6a01c311202ba1301a1c9_add (data) {
            geo_json_30fa7b0de6f6a01c311202ba1301a1c9
                .addData(data);
        }
            geo_json_30fa7b0de6f6a01c311202ba1301a1c9_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-119.759342, 38.8027185], [-119.8083666, 38.6624292], [-119.8602582, 38.5161817], [-119.9095229, 38.3693564], [-119.9595296, 38.2228413], [-120.0085501, 38.0760802], [-120.0569574, 37.929252], [-120.0928926, 37.8218957], [-120.7276358, 37.8375122], [-120.6965296, 38.8262817], [-119.759342, 38.8027185]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_30fa7b0de6f6a01c311202ba1301a1c9.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_f57654a99ccfe26433de49ca8488ede2_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_f57654a99ccfe26433de49ca8488ede2_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_f57654a99ccfe26433de49ca8488ede2 = L.geoJson(null, {
                onEachFeature: geo_json_f57654a99ccfe26433de49ca8488ede2_onEachFeature,
            
                style: geo_json_f57654a99ccfe26433de49ca8488ede2_styler,
            ...{
}
        });

        function geo_json_f57654a99ccfe26433de49ca8488ede2_add (data) {
            geo_json_f57654a99ccfe26433de49ca8488ede2
                .addData(data);
        }
            geo_json_f57654a99ccfe26433de49ca8488ede2_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-119.7551269, 38.8148067], [-119.7571805, 38.8089038], [-119.8083666, 38.6624292], [-119.8602582, 38.5161817], [-119.9095229, 38.3693564], [-119.9595296, 38.2228413], [-120.0085501, 38.0760802], [-120.0569574, 37.929252], [-120.0943548, 37.8175276], [-120.4079147, 37.8101079], [-120.454503, 38.7978946], [-119.7551269, 38.8148067]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_f57654a99ccfe26433de49ca8488ede2.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_da9dd42606eb993b4636d68fafcfda52_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_da9dd42606eb993b4636d68fafcfda52_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_da9dd42606eb993b4636d68fafcfda52 = L.geoJson(null, {
                onEachFeature: geo_json_da9dd42606eb993b4636d68fafcfda52_onEachFeature,
            
                style: geo_json_da9dd42606eb993b4636d68fafcfda52_styler,
            ...{
}
        });

        function geo_json_da9dd42606eb993b4636d68fafcfda52_add (data) {
            geo_json_da9dd42606eb993b4636d68fafcfda52
                .addData(data);
        }
            geo_json_da9dd42606eb993b4636d68fafcfda52_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0636396, 37.909289], [-120.1060296, 37.7826492], [-120.1541438, 37.6358354], [-120.2028871, 37.4891558], [-120.2514029, 37.3423494], [-120.3002045, 37.1955777], [-120.3488734, 37.0487347], [-120.3888049, 36.9278311], [-120.7546767, 36.9366504], [-120.7249265, 37.9255905], [-120.0636396, 37.909289]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_da9dd42606eb993b4636d68fafcfda52.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_3884bb08e21b364a0277e749cc3827e5_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_3884bb08e21b364a0277e749cc3827e5_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_3884bb08e21b364a0277e749cc3827e5 = L.geoJson(null, {
                onEachFeature: geo_json_3884bb08e21b364a0277e749cc3827e5_onEachFeature,
            
                style: geo_json_3884bb08e21b364a0277e749cc3827e5_styler,
            ...{
}
        });

        function geo_json_3884bb08e21b364a0277e749cc3827e5_add (data) {
            geo_json_3884bb08e21b364a0277e749cc3827e5
                .addData(data);
        }
            geo_json_3884bb08e21b364a0277e749cc3827e5_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.8619261, 37.9420853], [-120.6130578, 37.9233735], [-120.6442676, 36.9345108], [-121.8768197, 36.9525691], [-121.8619261, 37.9420853]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_3884bb08e21b364a0277e749cc3827e5.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_f9c5ee7f851dda22dbdd0ace20495488_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_f9c5ee7f851dda22dbdd0ace20495488_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_f9c5ee7f851dda22dbdd0ace20495488 = L.geoJson(null, {
                onEachFeature: geo_json_f9c5ee7f851dda22dbdd0ace20495488_onEachFeature,
            
                style: geo_json_f9c5ee7f851dda22dbdd0ace20495488_styler,
            ...{
}
        });

        function geo_json_f9c5ee7f851dda22dbdd0ace20495488_add (data) {
            geo_json_f9c5ee7f851dda22dbdd0ace20495488
                .addData(data);
        }
            geo_json_f9c5ee7f851dda22dbdd0ace20495488_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0646284, 37.906335], [-120.1060296, 37.7826492], [-120.1541438, 37.6358354], [-120.2028871, 37.4891558], [-120.2514029, 37.3423494], [-120.3002045, 37.1955777], [-120.3488734, 37.0487347], [-120.3706861, 36.9826908], [-120.4119725, 37.8980998], [-120.0646284, 37.906335]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_f9c5ee7f851dda22dbdd0ace20495488.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_ff070a2bca2e16529952aaa0ef4c3821_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_ff070a2bca2e16529952aaa0ef4c3821_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_ff070a2bca2e16529952aaa0ef4c3821 = L.geoJson(null, {
                onEachFeature: geo_json_ff070a2bca2e16529952aaa0ef4c3821_onEachFeature,
            
                style: geo_json_ff070a2bca2e16529952aaa0ef4c3821_styler,
            ...{
}
        });

        function geo_json_ff070a2bca2e16529952aaa0ef4c3821_add (data) {
            geo_json_ff070a2bca2e16529952aaa0ef4c3821
                .addData(data);
        }
            geo_json_ff070a2bca2e16529952aaa0ef4c3821_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0646284, 37.906335], [-120.1060296, 37.7826492], [-120.1541438, 37.6358354], [-120.2028871, 37.4891558], [-120.2514029, 37.3423494], [-120.3002045, 37.1955777], [-120.3488734, 37.0487347], [-120.3706861, 36.9826908], [-120.4119725, 37.8980998], [-120.0646284, 37.906335]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_ff070a2bca2e16529952aaa0ef4c3821.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8 = L.geoJson(null, {
                onEachFeature: geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8_onEachFeature,
            
                style: geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8_styler,
            ...{
}
        });

        function geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8_add (data) {
            geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8
                .addData(data);
        }
            geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.6702467, 36.0718407], [-120.6824415, 36.0342636], [-121.8897603, 36.0515828], [-121.8755145, 37.041254], [-120.6415325, 37.0231378], [-120.6702467, 36.0718407]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_0bd5504e752581be8a7cb12a5b3e4aaa_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_0bd5504e752581be8a7cb12a5b3e4aaa_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_0bd5504e752581be8a7cb12a5b3e4aaa = L.geoJson(null, {
                onEachFeature: geo_json_0bd5504e752581be8a7cb12a5b3e4aaa_onEachFeature,
            
                style: geo_json_0bd5504e752581be8a7cb12a5b3e4aaa_styler,
            ...{
}
        });

        function geo_json_0bd5504e752581be8a7cb12a5b3e4aaa_add (data) {
            geo_json_0bd5504e752581be8a7cb12a5b3e4aaa
                .addData(data);
        }
            geo_json_0bd5504e752581be8a7cb12a5b3e4aaa_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.0210451, 37.8413605], [-120.9891046, 37.9518145], [-120.9464325, 38.0991252], [-120.9035884, 38.2463801], [-120.8603581, 38.3935144], [-120.8170823, 38.5407225], [-120.7735805, 38.6879565], [-120.7327663, 38.8262769], [-120.5832678, 38.8239923], [-120.6159, 37.8353021], [-121.0210451, 37.8413605]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_0bd5504e752581be8a7cb12a5b3e4aaa.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef = L.geoJson(null, {
                onEachFeature: geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef_onEachFeature,
            
                style: geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef_styler,
            ...{
}
        });

        function geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef_add (data) {
            geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef
                .addData(data);
        }
            geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3713182, 36.9986681], [-119.1385056, 37.0273077], [-119.1114312, 36.038128], [-120.3286936, 36.0104973], [-120.3713182, 36.9986681]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_54cbf9186f6c001d368fe667edc1d381_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_54cbf9186f6c001d368fe667edc1d381_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_54cbf9186f6c001d368fe667edc1d381 = L.geoJson(null, {
                onEachFeature: geo_json_54cbf9186f6c001d368fe667edc1d381_onEachFeature,
            
                style: geo_json_54cbf9186f6c001d368fe667edc1d381_styler,
            ...{
}
        });

        function geo_json_54cbf9186f6c001d368fe667edc1d381_add (data) {
            geo_json_54cbf9186f6c001d368fe667edc1d381
                .addData(data);
        }
            geo_json_54cbf9186f6c001d368fe667edc1d381_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.7520695, 37.0252843], [-119.5194145, 36.9955107], [-119.563414, 36.007451], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_54cbf9186f6c001d368fe667edc1d381.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_ae4a534ccfe075d065cb8a2cc8d409dd_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_ae4a534ccfe075d065cb8a2cc8d409dd_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_ae4a534ccfe075d065cb8a2cc8d409dd = L.geoJson(null, {
                onEachFeature: geo_json_ae4a534ccfe075d065cb8a2cc8d409dd_onEachFeature,
            
                style: geo_json_ae4a534ccfe075d065cb8a2cc8d409dd_styler,
            ...{
}
        });

        function geo_json_ae4a534ccfe075d065cb8a2cc8d409dd_add (data) {
            geo_json_ae4a534ccfe075d065cb8a2cc8d409dd
                .addData(data);
        }
            geo_json_ae4a534ccfe075d065cb8a2cc8d409dd_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.2767402, 36.9437772], [-121.2421417, 37.0667065], [-121.2006849, 37.2144642], [-121.158659, 37.3620975], [-121.1165953, 37.5096497], [-121.0742173, 37.6570801], [-121.0317139, 37.8044668], [-120.9956713, 37.9291062], [-120.6130578, 37.9233735], [-120.6442676, 36.9345108], [-121.2767402, 36.9437772]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_ae4a534ccfe075d065cb8a2cc8d409dd.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_aa2b760b26c3869c72b5c04d0745f77b_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_aa2b760b26c3869c72b5c04d0745f77b_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_aa2b760b26c3869c72b5c04d0745f77b = L.geoJson(null, {
                onEachFeature: geo_json_aa2b760b26c3869c72b5c04d0745f77b_onEachFeature,
            
                style: geo_json_aa2b760b26c3869c72b5c04d0745f77b_styler,
            ...{
}
        });

        function geo_json_aa2b760b26c3869c72b5c04d0745f77b_add (data) {
            geo_json_aa2b760b26c3869c72b5c04d0745f77b
                .addData(data);
        }
            geo_json_aa2b760b26c3869c72b5c04d0745f77b_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.7249265, 37.9255905], [-119.4774491, 37.8948387], [-119.5234457, 36.9069718], [-120.7546767, 36.9366504], [-120.7249265, 37.9255905]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_aa2b760b26c3869c72b5c04d0745f77b.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_18d93c26975fdb4603f82889d230a502_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_18d93c26975fdb4603f82889d230a502_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_18d93c26975fdb4603f82889d230a502 = L.geoJson(null, {
                onEachFeature: geo_json_18d93c26975fdb4603f82889d230a502_onEachFeature,
            
                style: geo_json_18d93c26975fdb4603f82889d230a502_styler,
            ...{
}
        });

        function geo_json_18d93c26975fdb4603f82889d230a502_add (data) {
            geo_json_18d93c26975fdb4603f82889d230a502
                .addData(data);
        }
            geo_json_18d93c26975fdb4603f82889d230a502_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.6965296, 38.8262817], [-119.4335472, 38.7945272], [-119.4816378, 37.806857], [-120.7276358, 37.8375122], [-120.6965296, 38.8262817]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_18d93c26975fdb4603f82889d230a502.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_be01d42d4d6cc2a1f63cf04b24e7df44_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_be01d42d4d6cc2a1f63cf04b24e7df44_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_be01d42d4d6cc2a1f63cf04b24e7df44 = L.geoJson(null, {
                onEachFeature: geo_json_be01d42d4d6cc2a1f63cf04b24e7df44_onEachFeature,
            
                style: geo_json_be01d42d4d6cc2a1f63cf04b24e7df44_styler,
            ...{
}
        });

        function geo_json_be01d42d4d6cc2a1f63cf04b24e7df44_add (data) {
            geo_json_be01d42d4d6cc2a1f63cf04b24e7df44
                .addData(data);
        }
            geo_json_be01d42d4d6cc2a1f63cf04b24e7df44_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.4119725, 37.8980998], [-119.1643298, 37.9276804], [-119.136025, 36.9386673], [-120.367413, 36.9101192], [-120.4119725, 37.8980998]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_be01d42d4d6cc2a1f63cf04b24e7df44.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_2d692c4c0e532d0fcc0f229c6b6a4589_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_2d692c4c0e532d0fcc0f229c6b6a4589_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_2d692c4c0e532d0fcc0f229c6b6a4589 = L.geoJson(null, {
                onEachFeature: geo_json_2d692c4c0e532d0fcc0f229c6b6a4589_onEachFeature,
            
                style: geo_json_2d692c4c0e532d0fcc0f229c6b6a4589_styler,
            ...{
}
        });

        function geo_json_2d692c4c0e532d0fcc0f229c6b6a4589_add (data) {
            geo_json_2d692c4c0e532d0fcc0f229c6b6a4589
                .addData(data);
        }
            geo_json_2d692c4c0e532d0fcc0f229c6b6a4589_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.454503, 38.7978946], [-119.1913473, 38.8284398], [-119.1617522, 37.8395955], [-120.4079147, 37.8101079], [-120.454503, 38.7978946]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_2d692c4c0e532d0fcc0f229c6b6a4589.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_03f938b946f364d6728f9cb8a5dc164d_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_03f938b946f364d6728f9cb8a5dc164d_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_03f938b946f364d6728f9cb8a5dc164d = L.geoJson(null, {
                onEachFeature: geo_json_03f938b946f364d6728f9cb8a5dc164d_onEachFeature,
            
                style: geo_json_03f938b946f364d6728f9cb8a5dc164d_styler,
            ...{
}
        });

        function geo_json_03f938b946f364d6728f9cb8a5dc164d_add (data) {
            geo_json_03f938b946f364d6728f9cb8a5dc164d
                .addData(data);
        }
            geo_json_03f938b946f364d6728f9cb8a5dc164d_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.5287941, 36.0464047], [-121.4905054, 36.1816997], [-121.4495655, 36.3292626], [-121.4096976, 36.4771034], [-121.3673597, 36.6242566], [-121.3261024, 36.771779], [-121.2836932, 36.9190732], [-121.2518821, 37.0320984], [-120.6415325, 37.0231378], [-120.6713858, 36.034105], [-121.5287941, 36.0464047]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_03f938b946f364d6728f9cb8a5dc164d.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_81454a1801fdc8462d6549f5df5c58cc_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_81454a1801fdc8462d6549f5df5c58cc_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_81454a1801fdc8462d6549f5df5c58cc = L.geoJson(null, {
                onEachFeature: geo_json_81454a1801fdc8462d6549f5df5c58cc_onEachFeature,
            
                style: geo_json_81454a1801fdc8462d6549f5df5c58cc_styler,
            ...{
}
        });

        function geo_json_81454a1801fdc8462d6549f5df5c58cc_add (data) {
            geo_json_81454a1801fdc8462d6549f5df5c58cc
                .addData(data);
        }
            geo_json_81454a1801fdc8462d6549f5df5c58cc_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.8477095, 38.8433146], [-120.5832678, 38.8239923], [-120.6159, 37.8353021], [-121.8632824, 37.853955], [-121.8477095, 38.8433146]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_81454a1801fdc8462d6549f5df5c58cc.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_f648c04f45aa8c3686a49fec95a7d1df_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_f648c04f45aa8c3686a49fec95a7d1df_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_f648c04f45aa8c3686a49fec95a7d1df = L.geoJson(null, {
                onEachFeature: geo_json_f648c04f45aa8c3686a49fec95a7d1df_onEachFeature,
            
                style: geo_json_f648c04f45aa8c3686a49fec95a7d1df_styler,
            ...{
}
        });

        function geo_json_f648c04f45aa8c3686a49fec95a7d1df_add (data) {
            geo_json_f648c04f45aa8c3686a49fec95a7d1df
                .addData(data);
        }
            geo_json_f648c04f45aa8c3686a49fec95a7d1df_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3687338, 37.0160252], [-120.3866369, 36.9618059], [-120.4350484, 36.815055], [-120.4834302, 36.6682811], [-120.5322977, 36.5215755], [-120.5824905, 36.3751423], [-120.629312, 36.2279036], [-120.6766164, 36.0809222], [-120.6916783, 36.034079], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843], [-120.3687338, 37.0160252]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_f648c04f45aa8c3686a49fec95a7d1df.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_643771ed43a0a1c001c791dcff21ec96_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_643771ed43a0a1c001c791dcff21ec96_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_643771ed43a0a1c001c791dcff21ec96 = L.geoJson(null, {
                onEachFeature: geo_json_643771ed43a0a1c001c791dcff21ec96_onEachFeature,
            
                style: geo_json_643771ed43a0a1c001c791dcff21ec96_styler,
            ...{
}
        });

        function geo_json_643771ed43a0a1c001c791dcff21ec96_add (data) {
            geo_json_643771ed43a0a1c001c791dcff21ec96
                .addData(data);
        }
            geo_json_643771ed43a0a1c001c791dcff21ec96_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-119.7687299, 38.8029546], [-119.7970096, 38.7223655], [-119.8494586, 38.5764196], [-119.8983426, 38.4294608], [-119.9484484, 38.2827416], [-119.9980429, 38.1358844], [-120.0466952, 37.9888634], [-120.0941107, 37.8416124], [-120.100841, 37.8220912], [-120.7276358, 37.8375122], [-120.6965296, 38.8262817], [-119.7687299, 38.8029546]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_643771ed43a0a1c001c791dcff21ec96.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_51e43a106c186925b1906fb2f95c222c_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_51e43a106c186925b1906fb2f95c222c_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_51e43a106c186925b1906fb2f95c222c = L.geoJson(null, {
                onEachFeature: geo_json_51e43a106c186925b1906fb2f95c222c_onEachFeature,
            
                style: geo_json_51e43a106c186925b1906fb2f95c222c_styler,
            ...{
}
        });

        function geo_json_51e43a106c186925b1906fb2f95c222c_add (data) {
            geo_json_51e43a106c186925b1906fb2f95c222c
                .addData(data);
        }
            geo_json_51e43a106c186925b1906fb2f95c222c_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-119.7646517, 38.8145763], [-119.7970096, 38.7223655], [-119.8494586, 38.5764196], [-119.8983426, 38.4294608], [-119.9484484, 38.2827416], [-119.9980429, 38.1358844], [-120.0466952, 37.9888634], [-120.0941107, 37.8416124], [-120.1024807, 37.8173353], [-120.4079147, 37.8101079], [-120.454503, 38.7978946], [-119.7646517, 38.8145763]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_51e43a106c186925b1906fb2f95c222c.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_afc2f2a2ec9d34ad9d729bd9f2151221_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_afc2f2a2ec9d34ad9d729bd9f2151221_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_afc2f2a2ec9d34ad9d729bd9f2151221 = L.geoJson(null, {
                onEachFeature: geo_json_afc2f2a2ec9d34ad9d729bd9f2151221_onEachFeature,
            
                style: geo_json_afc2f2a2ec9d34ad9d729bd9f2151221_styler,
            ...{
}
        });

        function geo_json_afc2f2a2ec9d34ad9d729bd9f2151221_add (data) {
            geo_json_afc2f2a2ec9d34ad9d729bd9f2151221
                .addData(data);
        }
            geo_json_afc2f2a2ec9d34ad9d729bd9f2151221_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0722502, 37.9095013], [-120.0941107, 37.8416124], [-120.1445565, 37.6952955], [-120.1925325, 37.5484247], [-120.2409683, 37.4017572], [-120.2895791, 37.2551667], [-120.3381955, 37.1085098], [-120.3866369, 36.9618059], [-120.3977734, 36.9280473], [-120.7546767, 36.9366504], [-120.7249265, 37.9255905], [-120.0722502, 37.9095013]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_afc2f2a2ec9d34ad9d729bd9f2151221.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_320a460c4d282f0cd3a2d18116a52e67_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_320a460c4d282f0cd3a2d18116a52e67_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_320a460c4d282f0cd3a2d18116a52e67 = L.geoJson(null, {
                onEachFeature: geo_json_320a460c4d282f0cd3a2d18116a52e67_onEachFeature,
            
                style: geo_json_320a460c4d282f0cd3a2d18116a52e67_styler,
            ...{
}
        });

        function geo_json_320a460c4d282f0cd3a2d18116a52e67_add (data) {
            geo_json_320a460c4d282f0cd3a2d18116a52e67
                .addData(data);
        }
            geo_json_320a460c4d282f0cd3a2d18116a52e67_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0733362, 37.9061286], [-120.0941107, 37.8416124], [-120.1445565, 37.6952955], [-120.1925325, 37.5484247], [-120.2409683, 37.4017572], [-120.2895791, 37.2551667], [-120.3381955, 37.1085098], [-120.3717742, 37.0068172], [-120.4119725, 37.8980998], [-120.0733362, 37.9061286]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_320a460c4d282f0cd3a2d18116a52e67.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
        function geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd = L.geoJson(null, {
                onEachFeature: geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd_onEachFeature,
            
                style: geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd_styler,
            ...{
}
        });

        function geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd_add (data) {
            geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd
                .addData(data);
        }
            geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.8619261, 37.9420853], [-120.6130578, 37.9233735], [-120.6442676, 36.9345108], [-121.8768197, 36.9525691], [-121.8619261, 37.9420853]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd.addTo(map_d049ed66b22c7d65c603a6468a0a8226);
        
    
            var layer_control_e48b7fa71c03d31ff7a4ac91f62e0bd7_layers = {
                base_layers : {
                    &quot;openstreetmap&quot; : tile_layer_170f2c628d516f6201a689ee09bfcaf2,
                },
                overlays :  {
                    &quot;macro_element_a9d666fae758b8b5efafd4a3333ec0b6&quot; : geo_json_a9d666fae758b8b5efafd4a3333ec0b6,
                    &quot;macro_element_472c1320fb66e71f6125fe2a4972e2b0&quot; : geo_json_472c1320fb66e71f6125fe2a4972e2b0,
                    &quot;macro_element_bdcbe4f3596b295e8c35540f4036c225&quot; : geo_json_bdcbe4f3596b295e8c35540f4036c225,
                    &quot;macro_element_85a5f2d3ddb5c1a5673e1b644b554b2b&quot; : geo_json_85a5f2d3ddb5c1a5673e1b644b554b2b,
                    &quot;macro_element_b1d25343e2b7d23d81c7e2a38db35512&quot; : geo_json_b1d25343e2b7d23d81c7e2a38db35512,
                    &quot;macro_element_9025f109aa713ac986f6e28fe6686e89&quot; : geo_json_9025f109aa713ac986f6e28fe6686e89,
                    &quot;macro_element_acfd80d0dfd259dbb04a48b1aff1d65f&quot; : geo_json_acfd80d0dfd259dbb04a48b1aff1d65f,
                    &quot;macro_element_7e30e2a9a529def0339ce5386a8de15d&quot; : geo_json_7e30e2a9a529def0339ce5386a8de15d,
                    &quot;macro_element_be31269e009d4f58808e89e29429e8a6&quot; : geo_json_be31269e009d4f58808e89e29429e8a6,
                    &quot;macro_element_c08b135f18ca4101c2092d7a52edb95a&quot; : geo_json_c08b135f18ca4101c2092d7a52edb95a,
                    &quot;macro_element_4ae0f6eadd0c4acc8ac45c27bbd4df8f&quot; : geo_json_4ae0f6eadd0c4acc8ac45c27bbd4df8f,
                    &quot;macro_element_743a30183685e4d314cc3605ae01b323&quot; : geo_json_743a30183685e4d314cc3605ae01b323,
                    &quot;macro_element_5c11ab313471be9375433420fa827c9f&quot; : geo_json_5c11ab313471be9375433420fa827c9f,
                    &quot;macro_element_65f7ac8e139ab79c58f4dd870c6f64cd&quot; : geo_json_65f7ac8e139ab79c58f4dd870c6f64cd,
                    &quot;macro_element_fb3eb0e7a99bdc11341e62a90761afe3&quot; : geo_json_fb3eb0e7a99bdc11341e62a90761afe3,
                    &quot;macro_element_1ec994d3962a8afc695c9491c5fde6ef&quot; : geo_json_1ec994d3962a8afc695c9491c5fde6ef,
                    &quot;macro_element_30fa7b0de6f6a01c311202ba1301a1c9&quot; : geo_json_30fa7b0de6f6a01c311202ba1301a1c9,
                    &quot;macro_element_f57654a99ccfe26433de49ca8488ede2&quot; : geo_json_f57654a99ccfe26433de49ca8488ede2,
                    &quot;macro_element_da9dd42606eb993b4636d68fafcfda52&quot; : geo_json_da9dd42606eb993b4636d68fafcfda52,
                    &quot;macro_element_3884bb08e21b364a0277e749cc3827e5&quot; : geo_json_3884bb08e21b364a0277e749cc3827e5,
                    &quot;macro_element_f9c5ee7f851dda22dbdd0ace20495488&quot; : geo_json_f9c5ee7f851dda22dbdd0ace20495488,
                    &quot;macro_element_ff070a2bca2e16529952aaa0ef4c3821&quot; : geo_json_ff070a2bca2e16529952aaa0ef4c3821,
                    &quot;macro_element_bd40a636ed7d22e9b2cfd17aeba8e4c8&quot; : geo_json_bd40a636ed7d22e9b2cfd17aeba8e4c8,
                    &quot;macro_element_0bd5504e752581be8a7cb12a5b3e4aaa&quot; : geo_json_0bd5504e752581be8a7cb12a5b3e4aaa,
                    &quot;macro_element_5c0dcb8fd78381c1ce14b67e3ef43cef&quot; : geo_json_5c0dcb8fd78381c1ce14b67e3ef43cef,
                    &quot;macro_element_54cbf9186f6c001d368fe667edc1d381&quot; : geo_json_54cbf9186f6c001d368fe667edc1d381,
                    &quot;macro_element_ae4a534ccfe075d065cb8a2cc8d409dd&quot; : geo_json_ae4a534ccfe075d065cb8a2cc8d409dd,
                    &quot;macro_element_aa2b760b26c3869c72b5c04d0745f77b&quot; : geo_json_aa2b760b26c3869c72b5c04d0745f77b,
                    &quot;macro_element_18d93c26975fdb4603f82889d230a502&quot; : geo_json_18d93c26975fdb4603f82889d230a502,
                    &quot;macro_element_be01d42d4d6cc2a1f63cf04b24e7df44&quot; : geo_json_be01d42d4d6cc2a1f63cf04b24e7df44,
                    &quot;macro_element_2d692c4c0e532d0fcc0f229c6b6a4589&quot; : geo_json_2d692c4c0e532d0fcc0f229c6b6a4589,
                    &quot;macro_element_03f938b946f364d6728f9cb8a5dc164d&quot; : geo_json_03f938b946f364d6728f9cb8a5dc164d,
                    &quot;macro_element_81454a1801fdc8462d6549f5df5c58cc&quot; : geo_json_81454a1801fdc8462d6549f5df5c58cc,
                    &quot;macro_element_f648c04f45aa8c3686a49fec95a7d1df&quot; : geo_json_f648c04f45aa8c3686a49fec95a7d1df,
                    &quot;macro_element_643771ed43a0a1c001c791dcff21ec96&quot; : geo_json_643771ed43a0a1c001c791dcff21ec96,
                    &quot;macro_element_51e43a106c186925b1906fb2f95c222c&quot; : geo_json_51e43a106c186925b1906fb2f95c222c,
                    &quot;macro_element_afc2f2a2ec9d34ad9d729bd9f2151221&quot; : geo_json_afc2f2a2ec9d34ad9d729bd9f2151221,
                    &quot;macro_element_320a460c4d282f0cd3a2d18116a52e67&quot; : geo_json_320a460c4d282f0cd3a2d18116a52e67,
                    &quot;macro_element_2af129f8ac42a13ffbdf6e3a6f4998cd&quot; : geo_json_2af129f8ac42a13ffbdf6e3a6f4998cd,
                },
            };
            let layer_control_e48b7fa71c03d31ff7a4ac91f62e0bd7 = L.control.layers(
                layer_control_e48b7fa71c03d31ff7a4ac91f62e0bd7_layers.base_layers,
                layer_control_e48b7fa71c03d31ff7a4ac91f62e0bd7_layers.overlays,
                {
  &quot;position&quot;: &quot;topright&quot;,
  &quot;collapsed&quot;: true,
  &quot;autoZIndex&quot;: true,
}
            ).addTo(map_d049ed66b22c7d65c603a6468a0a8226);

        
</script>
</html>" style="position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;" allowfullscreen="" webkitallowfullscreen="" mozallowfullscreen=""></iframe></div></div>
</div>
</div>
<hr>
</section>
</section>
<section id="step-2-cloud-masking-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="step-2-cloud-masking-pipeline">Step 2: Cloud Masking Pipeline</h2>
<p>Sentinel-2 Level 2A includes a Scene Classification Layer (SCL) that identifies clouds, cloud shadows, and other features.</p>
<section id="understanding-scene-classification-layer" class="level3">
<h3 class="anchored" data-anchor-id="understanding-scene-classification-layer">Understanding Scene Classification Layer</h3>
<div id="319cb7d1" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SCL class definitions (Sentinel-2 Level 2A)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>scl_classes <span class="op">=</span> {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>: <span class="st">"No Data"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"Saturated or defective"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"Dark area pixels"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"Cloud shadows"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"Vegetation"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"Not vegetated"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"Water"</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"Unclassified"</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span>: <span class="st">"Cloud medium probability"</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">9</span>: <span class="st">"Cloud high probability"</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>: <span class="st">"Thin cirrus"</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="dv">11</span>: <span class="st">"Snow"</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Define what we consider "good" pixels for analysis</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>good_pixel_classes <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]  <span class="co"># Vegetation, not vegetated, water</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>cloud_classes <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]   <span class="co"># Cloud shadows, clouds, cirrus</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🌥️ Scene Classification Layer (SCL) Classes:"</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> class_id, description <span class="kw">in</span> scl_classes.items():</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    marker <span class="op">=</span> <span class="st">"✓"</span> <span class="cf">if</span> class_id <span class="kw">in</span> good_pixel_classes <span class="cf">else</span> <span class="st">"❌"</span> <span class="cf">if</span> class_id <span class="kw">in</span> cloud_classes <span class="cf">else</span> <span class="st">"⚠️"</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>marker<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>class_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Good pixels for analysis: </span><span class="sc">{</span>good_pixel_classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"☁️ Cloud/shadow pixels to mask: </span><span class="sc">{</span>cloud_classes<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>🌥️ Scene Classification Layer (SCL) Classes:
   ⚠️ 0: No Data
   ⚠️ 1: Saturated or defective
   ⚠️ 2: Dark area pixels
   ❌ 3: Cloud shadows
   ✓ 4: Vegetation
   ✓ 5: Not vegetated
   ✓ 6: Water
   ⚠️ 7: Unclassified
   ❌ 8: Cloud medium probability
   ❌ 9: Cloud high probability
   ❌ 10: Thin cirrus
   ⚠️ 11: Snow

✅ Good pixels for analysis: [4, 5, 6]
☁️ Cloud/shadow pixels to mask: [3, 8, 9, 10]</code></pre>
</div>
</div>
</section>
</section>
<section id="week-2-function-library" class="level2">
<h2 class="anchored" data-anchor-id="week-2-function-library">Week 2 Function Library</h2>
<p>Before we begin the hands-on workflow, let’s define all the core functions we’ll use throughout this chapter. These functions build on the Week 1 foundations and will be exported to our <code>geogfm.c02</code> module:</p>
<div id="aab87c3f" class="cell" data-execution_count="5">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>geogfm/c02.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangled from c02-spatial-temporal-attention-mechanisms.qmd</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""Week 2: Advanced preprocessing functions for Sentinel-2 data."""</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple, Optional, Union</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c01 <span class="im">import</span> load_sentinel2_bands, setup_planetary_computer_auth, search_sentinel2_scenes</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_cloud_mask(scl_data, good_classes: List[<span class="bu">int</span>]) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Create binary cloud mask from Scene Classification Layer.</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Educational note: np.isin checks if each pixel value is in our 'good' list.</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns True for clear pixels, False for clouds/shadows.</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">        scl_data: Scene Classification Layer data (numpy array or xarray DataArray)</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">        good_classes: List of SCL values considered valid pixels</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Binary mask array (True for valid pixels)</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle both numpy arrays and xarray DataArrays</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(scl_data, <span class="st">'values'</span>):</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        scl_values <span class="op">=</span> scl_data.values</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        scl_values <span class="op">=</span> scl_data</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.isin(scl_values, good_classes)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_cloud_mask(band_data: Dict[<span class="bu">str</span>, Union[np.ndarray, xr.DataArray]],</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>                    scl_data: Union[np.ndarray, xr.DataArray],</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>                    good_pixel_classes: List[<span class="bu">int</span>],</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>                    target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>) <span class="op">-&gt;</span> Tuple[Dict[<span class="bu">str</span>, xr.DataArray], <span class="bu">float</span>]:</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply SCL-based cloud masking to spectral bands.</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="co">        band_data: Dictionary of band DataArrays</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="co">        scl_data: Scene Classification Layer DataArray</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="co">        good_pixel_classes: List of SCL values considered valid</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">        target_resolution: Target resolution for resampling bands</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="co">        masked_data: Dictionary with masked bands</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a><span class="co">        valid_pixel_fraction: Fraction of valid pixels</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> rioxarray</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get SCL data and ensure it's at target resolution</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    scl_array <span class="op">=</span> scl_data</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(scl_data, <span class="st">'values'</span>):</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>        scl_values <span class="op">=</span> scl_data.values</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>        scl_values <span class="op">=</span> scl_data</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create cloud mask from SCL</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    good_pixels <span class="op">=</span> create_cloud_mask(scl_data, good_pixel_classes)</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get target shape from SCL (typically 20m resolution)</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    target_shape <span class="op">=</span> scl_values.shape</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply mask to spectral bands</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    masked_data <span class="op">=</span> {}</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map Sentinel-2 bands to readable names</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    band_mapping <span class="op">=</span> {<span class="st">'B04'</span>: <span class="st">'red'</span>, <span class="st">'B03'</span>: <span class="st">'green'</span>, <span class="st">'B02'</span>: <span class="st">'blue'</span>, <span class="st">'B08'</span>: <span class="st">'nir'</span>}</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band_name <span class="kw">in</span> [<span class="st">'B04'</span>, <span class="st">'B03'</span>, <span class="st">'B02'</span>, <span class="st">'B08'</span>]:</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> band_name <span class="kw">in</span> band_data:</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>            band_array <span class="op">=</span> band_data[band_name]</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get band values (handle both numpy arrays and xarray DataArrays)</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(band_array, <span class="st">'values'</span>):</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>                band_values <span class="op">=</span> band_array.values</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>                band_values <span class="op">=</span> band_array</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Resample band to match SCL resolution if needed</span></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band_values.shape <span class="op">!=</span> target_shape:</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Resampling </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss"> from </span><span class="sc">{</span>band_values<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>target_shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Try rioxarray resampling if CRS is available</span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>                resampled_successfully <span class="op">=</span> <span class="va">False</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">hasattr</span>(band_array, <span class="st">'rio'</span>):</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Check if CRS is available</span></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> band_array.rio.crs <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>                            resampled <span class="op">=</span> band_array.rio.reproject(</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>                                band_array.rio.crs,</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>                                resolution<span class="op">=</span>target_resolution</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>                            band_values <span class="op">=</span> resampled.values</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>                            resampled_successfully <span class="op">=</span> <span class="va">True</span></span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">print</span>(<span class="ss">f"No CRS found for </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss">, using fallback resampling"</span>)</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"rioxarray resampling failed for </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Fallback: simple decimation for 2x downsampling (10m -&gt; 20m)</span></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> resampled_successfully:</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> band_values.shape[<span class="dv">0</span>] <span class="op">==</span> target_shape[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">2</span> <span class="kw">and</span> band_values.shape[<span class="dv">1</span>] <span class="op">==</span> target_shape[<span class="dv">1</span>] <span class="op">*</span> <span class="dv">2</span>:</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Perfect 2x downsampling case (e.g., 10m -&gt; 20m)</span></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>                        band_values <span class="op">=</span> band_values[::<span class="dv">2</span>, ::<span class="dv">2</span>]</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"Used 2x decimation for </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"Warning: Cannot resample </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss"> - incompatible shapes"</span>)</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span></span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Ensure shapes match after resampling</span></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band_values.shape <span class="op">!=</span> target_shape:</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Warning: Shape mismatch for </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>band_values<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> vs </span><span class="sc">{</span>target_shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mask invalid pixels with NaN</span></span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>            masked_values <span class="op">=</span> np.where(good_pixels, band_values, np.nan)</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use meaningful band names (red, green, blue, nir)</span></span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>            readable_name <span class="op">=</span> band_mapping[band_name]</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create DataArray with coordinates if available</span></span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(scl_array, <span class="st">'coords'</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(scl_array, <span class="st">'dims'</span>):</span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>                masked_data[readable_name] <span class="op">=</span> xr.DataArray(</span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>                    masked_values,</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>                    coords<span class="op">=</span>scl_array.coords,</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>                    dims<span class="op">=</span>scl_array.dims</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create with named dimensions for better compatibility</span></span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>                dims <span class="op">=</span> [<span class="st">'y'</span>, <span class="st">'x'</span>] <span class="cf">if</span> <span class="bu">len</span>(masked_values.shape) <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> [<span class="st">'dim_0'</span>, <span class="st">'dim_1'</span>]</span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>                masked_data[readable_name] <span class="op">=</span> xr.DataArray(</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>                    masked_values,</span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>                    dims<span class="op">=</span>dims</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate valid pixel fraction</span></span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>    valid_pixel_fraction <span class="op">=</span> np.<span class="bu">sum</span>(good_pixels) <span class="op">/</span> good_pixels.size</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store SCL and mask for reference</span></span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(scl_data, <span class="st">'coords'</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(scl_data, <span class="st">'dims'</span>):</span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'scl'</span>] <span class="op">=</span> scl_data</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'cloud_mask'</span>] <span class="op">=</span> xr.DataArray(</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>            good_pixels,</span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>            coords<span class="op">=</span>scl_data.coords,</span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>            dims<span class="op">=</span>scl_data.dims</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create with named dimensions for consistency</span></span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>        dims <span class="op">=</span> [<span class="st">'y'</span>, <span class="st">'x'</span>] <span class="cf">if</span> <span class="bu">len</span>(good_pixels.shape) <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> [<span class="st">'dim_0'</span>, <span class="st">'dim_1'</span>]</span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'scl'</span>] <span class="op">=</span> xr.DataArray(scl_data, dims<span class="op">=</span>dims)</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'cloud_mask'</span>] <span class="op">=</span> xr.DataArray(good_pixels, dims<span class="op">=</span>dims)</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> masked_data, valid_pixel_fraction</span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_scene_with_cloudmask(item, target_crs: <span class="bu">str</span> <span class="op">=</span> <span class="st">'EPSG:32610'</span>,</span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>                              target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>                              good_pixel_classes: List[<span class="bu">int</span>] <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>],</span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>                              subset_bbox: Optional[List[<span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> Tuple[Optional[Dict[<span class="bu">str</span>, xr.DataArray]], <span class="bu">float</span>]:</span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a><span class="co">    Load a Sentinel-2 scene with cloud masking applied using geogfm functions.</span></span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a><span class="co">        item: STAC item</span></span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a><span class="co">        target_resolution: Target pixel size in meters</span></span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a><span class="co">        good_pixel_classes: List of SCL values considered valid</span></span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a><span class="co">        subset_bbox: Optional spatial subset as [west, south, east, north] in WGS84</span></span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a><span class="co">        masked_data: dict with masked bands</span></span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a><span class="co">        valid_pixel_fraction: fraction of valid pixels</span></span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the tested function from geogfm.c01</span></span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> load_sentinel2_bands(</span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a>            item,</span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a>            bands<span class="op">=</span>[<span class="st">'B04'</span>, <span class="st">'B03'</span>, <span class="st">'B02'</span>, <span class="st">'B08'</span>, <span class="st">'SCL'</span>],</span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a>            subset_bbox<span class="op">=</span>subset_bbox,  <span class="co"># Enable spatial subsetting</span></span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a>            max_retries<span class="op">=</span><span class="dv">3</span></span>
<span id="cb13-184"><a href="#cb13-184" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-185"><a href="#cb13-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-186"><a href="#cb13-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> band_data <span class="kw">or</span> <span class="st">'SCL'</span> <span class="kw">not</span> <span class="kw">in</span> band_data:</span>
<span id="cb13-187"><a href="#cb13-187" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"⚠️ No data or missing SCL for scene </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-188"><a href="#cb13-188" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span>, <span class="dv">0</span></span>
<span id="cb13-189"><a href="#cb13-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-190"><a href="#cb13-190" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply cloud masking using SCL with target resolution</span></span>
<span id="cb13-191"><a href="#cb13-191" aria-hidden="true" tabindex="-1"></a>        masked_data, valid_fraction <span class="op">=</span> apply_cloud_mask(</span>
<span id="cb13-192"><a href="#cb13-192" aria-hidden="true" tabindex="-1"></a>            band_data, band_data[<span class="st">'SCL'</span>], good_pixel_classes, target_resolution</span>
<span id="cb13-193"><a href="#cb13-193" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-194"><a href="#cb13-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-195"><a href="#cb13-195" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> masked_data, valid_fraction</span>
<span id="cb13-196"><a href="#cb13-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-197"><a href="#cb13-197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-198"><a href="#cb13-198" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"❌ Error loading scene </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-199"><a href="#cb13-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="dv">0</span></span>
<span id="cb13-200"><a href="#cb13-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-201"><a href="#cb13-201" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_single_scene(item, target_crs: <span class="bu">str</span> <span class="op">=</span> <span class="st">'EPSG:32610'</span>,</span>
<span id="cb13-202"><a href="#cb13-202" aria-hidden="true" tabindex="-1"></a>                        target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb13-203"><a href="#cb13-203" aria-hidden="true" tabindex="-1"></a>                        min_valid_fraction: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>,  <span class="co"># Lowered threshold for demonstration</span></span>
<span id="cb13-204"><a href="#cb13-204" aria-hidden="true" tabindex="-1"></a>                        good_pixel_classes: List[<span class="bu">int</span>] <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>],</span>
<span id="cb13-205"><a href="#cb13-205" aria-hidden="true" tabindex="-1"></a>                        subset_bbox: Optional[List[<span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> Optional[Dict]:</span>
<span id="cb13-206"><a href="#cb13-206" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-207"><a href="#cb13-207" aria-hidden="true" tabindex="-1"></a><span class="co">    Process a single scene with validation.</span></span>
<span id="cb13-208"><a href="#cb13-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-209"><a href="#cb13-209" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-210"><a href="#cb13-210" aria-hidden="true" tabindex="-1"></a><span class="co">        item: STAC item</span></span>
<span id="cb13-211"><a href="#cb13-211" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb13-212"><a href="#cb13-212" aria-hidden="true" tabindex="-1"></a><span class="co">        target_resolution: Target pixel size in meters</span></span>
<span id="cb13-213"><a href="#cb13-213" aria-hidden="true" tabindex="-1"></a><span class="co">        min_valid_fraction: Minimum fraction of valid pixels required</span></span>
<span id="cb13-214"><a href="#cb13-214" aria-hidden="true" tabindex="-1"></a><span class="co">        good_pixel_classes: List of SCL values considered valid</span></span>
<span id="cb13-215"><a href="#cb13-215" aria-hidden="true" tabindex="-1"></a><span class="co">        subset_bbox: Optional spatial subset as [west, south, east, north] in WGS84</span></span>
<span id="cb13-216"><a href="#cb13-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-217"><a href="#cb13-217" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-218"><a href="#cb13-218" aria-hidden="true" tabindex="-1"></a><span class="co">        Scene data dictionary or None if invalid</span></span>
<span id="cb13-219"><a href="#cb13-219" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-220"><a href="#cb13-220" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb13-221"><a href="#cb13-221" aria-hidden="true" tabindex="-1"></a>    data, valid_frac <span class="op">=</span> load_scene_with_cloudmask(</span>
<span id="cb13-222"><a href="#cb13-222" aria-hidden="true" tabindex="-1"></a>        item, target_crs<span class="op">=</span>target_crs, target_resolution<span class="op">=</span>target_resolution,</span>
<span id="cb13-223"><a href="#cb13-223" aria-hidden="true" tabindex="-1"></a>        good_pixel_classes<span class="op">=</span>good_pixel_classes, subset_bbox<span class="op">=</span>subset_bbox</span>
<span id="cb13-224"><a href="#cb13-224" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-225"><a href="#cb13-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-226"><a href="#cb13-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data <span class="kw">and</span> valid_frac <span class="op">&gt;</span> min_valid_fraction:</span>
<span id="cb13-227"><a href="#cb13-227" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb13-228"><a href="#cb13-228" aria-hidden="true" tabindex="-1"></a>            <span class="st">'id'</span>: item.<span class="bu">id</span>,</span>
<span id="cb13-229"><a href="#cb13-229" aria-hidden="true" tabindex="-1"></a>            <span class="st">'date'</span>: item.properties[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>],</span>
<span id="cb13-230"><a href="#cb13-230" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data'</span>: data,</span>
<span id="cb13-231"><a href="#cb13-231" aria-hidden="true" tabindex="-1"></a>            <span class="st">'valid_fraction'</span>: valid_frac,</span>
<span id="cb13-232"><a href="#cb13-232" aria-hidden="true" tabindex="-1"></a>            <span class="st">'item'</span>: item</span>
<span id="cb13-233"><a href="#cb13-233" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-234"><a href="#cb13-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-235"><a href="#cb13-235" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"⚠️ Skipped </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">30</span>]<span class="sc">}</span><span class="ss"> (valid fraction: </span><span class="sc">{</span>valid_frac<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb13-236"><a href="#cb13-236" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb13-237"><a href="#cb13-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-238"><a href="#cb13-238" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_scene_batch(scene_items: List, max_workers: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>,</span>
<span id="cb13-239"><a href="#cb13-239" aria-hidden="true" tabindex="-1"></a>                       target_crs: <span class="bu">str</span> <span class="op">=</span> <span class="st">'EPSG:32610'</span>,</span>
<span id="cb13-240"><a href="#cb13-240" aria-hidden="true" tabindex="-1"></a>                       target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb13-241"><a href="#cb13-241" aria-hidden="true" tabindex="-1"></a>                       min_valid_fraction: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>,  <span class="co"># Lowered threshold for demonstration</span></span>
<span id="cb13-242"><a href="#cb13-242" aria-hidden="true" tabindex="-1"></a>                       good_pixel_classes: List[<span class="bu">int</span>] <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>],</span>
<span id="cb13-243"><a href="#cb13-243" aria-hidden="true" tabindex="-1"></a>                       subset_bbox: Optional[List[<span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb13-244"><a href="#cb13-244" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-245"><a href="#cb13-245" aria-hidden="true" tabindex="-1"></a><span class="co">    Process multiple scenes in parallel with cloud masking and reprojection.</span></span>
<span id="cb13-246"><a href="#cb13-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-247"><a href="#cb13-247" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-248"><a href="#cb13-248" aria-hidden="true" tabindex="-1"></a><span class="co">        scene_items: List of STAC items</span></span>
<span id="cb13-249"><a href="#cb13-249" aria-hidden="true" tabindex="-1"></a><span class="co">        max_workers: Number of parallel workers</span></span>
<span id="cb13-250"><a href="#cb13-250" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb13-251"><a href="#cb13-251" aria-hidden="true" tabindex="-1"></a><span class="co">        min_valid_fraction: Minimum valid pixel fraction</span></span>
<span id="cb13-252"><a href="#cb13-252" aria-hidden="true" tabindex="-1"></a><span class="co">        good_pixel_classes: List of SCL values considered valid</span></span>
<span id="cb13-253"><a href="#cb13-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-254"><a href="#cb13-254" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-255"><a href="#cb13-255" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scene data</span></span>
<span id="cb13-256"><a href="#cb13-256" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-257"><a href="#cb13-257" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"🔄 Processing </span><span class="sc">{</span><span class="bu">len</span>(scene_items)<span class="sc">}</span><span class="ss"> scenes with </span><span class="sc">{</span>max_workers<span class="sc">}</span><span class="ss"> workers..."</span>)</span>
<span id="cb13-258"><a href="#cb13-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-259"><a href="#cb13-259" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use partial to pass additional parameters</span></span>
<span id="cb13-260"><a href="#cb13-260" aria-hidden="true" tabindex="-1"></a>    process_func <span class="op">=</span> partial(</span>
<span id="cb13-261"><a href="#cb13-261" aria-hidden="true" tabindex="-1"></a>        process_single_scene,</span>
<span id="cb13-262"><a href="#cb13-262" aria-hidden="true" tabindex="-1"></a>        target_crs<span class="op">=</span>target_crs,</span>
<span id="cb13-263"><a href="#cb13-263" aria-hidden="true" tabindex="-1"></a>        target_resolution<span class="op">=</span>target_resolution,</span>
<span id="cb13-264"><a href="#cb13-264" aria-hidden="true" tabindex="-1"></a>        min_valid_fraction<span class="op">=</span>min_valid_fraction,</span>
<span id="cb13-265"><a href="#cb13-265" aria-hidden="true" tabindex="-1"></a>        good_pixel_classes<span class="op">=</span>good_pixel_classes</span>
<span id="cb13-266"><a href="#cb13-266" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-267"><a href="#cb13-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-268"><a href="#cb13-268" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>max_workers) <span class="im">as</span> executor:</span>
<span id="cb13-269"><a href="#cb13-269" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="bu">list</span>(executor.<span class="bu">map</span>(process_func, scene_items))</span>
<span id="cb13-270"><a href="#cb13-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-271"><a href="#cb13-271" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter successful results</span></span>
<span id="cb13-272"><a href="#cb13-272" aria-hidden="true" tabindex="-1"></a>    processed_scenes <span class="op">=</span> [result <span class="cf">for</span> result <span class="kw">in</span> results <span class="cf">if</span> result <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>]</span>
<span id="cb13-273"><a href="#cb13-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-274"><a href="#cb13-274" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Successfully processed </span><span class="sc">{</span><span class="bu">len</span>(processed_scenes)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb13-275"><a href="#cb13-275" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> processed_scenes</span>
<span id="cb13-276"><a href="#cb13-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-277"><a href="#cb13-277" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_temporal_mosaic(processed_scenes, method: <span class="bu">str</span> <span class="op">=</span> <span class="st">'median'</span>):</span>
<span id="cb13-278"><a href="#cb13-278" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-279"><a href="#cb13-279" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a temporal mosaic from multiple processed scenes.</span></span>
<span id="cb13-280"><a href="#cb13-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-281"><a href="#cb13-281" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-282"><a href="#cb13-282" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scene dictionaries</span></span>
<span id="cb13-283"><a href="#cb13-283" aria-hidden="true" tabindex="-1"></a><span class="co">        method: Compositing method ('median', 'mean', 'max')</span></span>
<span id="cb13-284"><a href="#cb13-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-285"><a href="#cb13-285" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-286"><a href="#cb13-286" aria-hidden="true" tabindex="-1"></a><span class="co">        mosaic_data: Temporal composite as xarray Dataset</span></span>
<span id="cb13-287"><a href="#cb13-287" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-288"><a href="#cb13-288" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> processed_scenes:</span>
<span id="cb13-289"><a href="#cb13-289" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"❌ No scenes to mosaic"</span>)</span>
<span id="cb13-290"><a href="#cb13-290" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb13-291"><a href="#cb13-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-292"><a href="#cb13-292" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"🧩 Creating temporal mosaic using </span><span class="sc">{</span>method<span class="sc">}</span><span class="ss"> method..."</span>)</span>
<span id="cb13-293"><a href="#cb13-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-294"><a href="#cb13-294" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group data by band</span></span>
<span id="cb13-295"><a href="#cb13-295" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]</span>
<span id="cb13-296"><a href="#cb13-296" aria-hidden="true" tabindex="-1"></a>    band_stacks <span class="op">=</span> {}</span>
<span id="cb13-297"><a href="#cb13-297" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb13-298"><a href="#cb13-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-299"><a href="#cb13-299" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> bands:</span>
<span id="cb13-300"><a href="#cb13-300" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> []</span>
<span id="cb13-301"><a href="#cb13-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb13-302"><a href="#cb13-302" aria-hidden="true" tabindex="-1"></a>            band_data.append(scene[<span class="st">'data'</span>][band])</span>
<span id="cb13-303"><a href="#cb13-303" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band <span class="op">==</span> <span class="st">'red'</span>:  <span class="co"># Only collect dates once</span></span>
<span id="cb13-304"><a href="#cb13-304" aria-hidden="true" tabindex="-1"></a>                dates.append(scene[<span class="st">'date'</span>])</span>
<span id="cb13-305"><a href="#cb13-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-306"><a href="#cb13-306" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack along time dimension</span></span>
<span id="cb13-307"><a href="#cb13-307" aria-hidden="true" tabindex="-1"></a>        band_stack <span class="op">=</span> xr.concat(band_data, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb13-308"><a href="#cb13-308" aria-hidden="true" tabindex="-1"></a>        band_stack <span class="op">=</span> band_stack.assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb13-309"><a href="#cb13-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-310"><a href="#cb13-310" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply temporal compositing</span></span>
<span id="cb13-311"><a href="#cb13-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> method <span class="op">==</span> <span class="st">'median'</span>:</span>
<span id="cb13-312"><a href="#cb13-312" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.median(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-313"><a href="#cb13-313" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'mean'</span>:</span>
<span id="cb13-314"><a href="#cb13-314" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.mean(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-315"><a href="#cb13-315" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'max'</span>:</span>
<span id="cb13-316"><a href="#cb13-316" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.<span class="bu">max</span>(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-317"><a href="#cb13-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-318"><a href="#cb13-318" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create mosaic dataset</span></span>
<span id="cb13-319"><a href="#cb13-319" aria-hidden="true" tabindex="-1"></a>    mosaic_data <span class="op">=</span> xr.Dataset(band_stacks)</span>
<span id="cb13-320"><a href="#cb13-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-321"><a href="#cb13-321" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metadata</span></span>
<span id="cb13-322"><a href="#cb13-322" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'method'</span>] <span class="op">=</span> method</span>
<span id="cb13-323"><a href="#cb13-323" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'n_scenes'</span>] <span class="op">=</span> <span class="bu">len</span>(processed_scenes)</span>
<span id="cb13-324"><a href="#cb13-324" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'date_range'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">min</span>(dates)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span><span class="bu">max</span>(dates)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb13-325"><a href="#cb13-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-326"><a href="#cb13-326" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Mosaic created from </span><span class="sc">{</span><span class="bu">len</span>(processed_scenes)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb13-327"><a href="#cb13-327" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📏 Mosaic shape: </span><span class="sc">{</span>mosaic_data[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-328"><a href="#cb13-328" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📅 Date range: </span><span class="sc">{</span>mosaic_data<span class="sc">.</span>attrs[<span class="st">'date_range'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-329"><a href="#cb13-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-330"><a href="#cb13-330" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mosaic_data</span>
<span id="cb13-331"><a href="#cb13-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-332"><a href="#cb13-332" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_temporal_datacube(processed_scenes, chunk_size<span class="op">=</span><span class="st">'auto'</span>):</span>
<span id="cb13-333"><a href="#cb13-333" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-334"><a href="#cb13-334" aria-hidden="true" tabindex="-1"></a><span class="co">    Build an analysis-ready temporal data cube.</span></span>
<span id="cb13-335"><a href="#cb13-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-336"><a href="#cb13-336" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-337"><a href="#cb13-337" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scenes</span></span>
<span id="cb13-338"><a href="#cb13-338" aria-hidden="true" tabindex="-1"></a><span class="co">        chunk_size: Dask chunk size for memory management</span></span>
<span id="cb13-339"><a href="#cb13-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-340"><a href="#cb13-340" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-341"><a href="#cb13-341" aria-hidden="true" tabindex="-1"></a><span class="co">        datacube: xarray Dataset with time dimension</span></span>
<span id="cb13-342"><a href="#cb13-342" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-343"><a href="#cb13-343" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> processed_scenes:</span>
<span id="cb13-344"><a href="#cb13-344" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb13-345"><a href="#cb13-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-346"><a href="#cb13-346" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"📊 Building temporal data cube..."</span>)</span>
<span id="cb13-347"><a href="#cb13-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-348"><a href="#cb13-348" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort scenes by date</span></span>
<span id="cb13-349"><a href="#cb13-349" aria-hidden="true" tabindex="-1"></a>    processed_scenes.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'date'</span>])</span>
<span id="cb13-350"><a href="#cb13-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-351"><a href="#cb13-351" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract dates and data</span></span>
<span id="cb13-352"><a href="#cb13-352" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> [pd.to_datetime(scene[<span class="st">'date'</span>]) <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes]</span>
<span id="cb13-353"><a href="#cb13-353" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]</span>
<span id="cb13-354"><a href="#cb13-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-355"><a href="#cb13-355" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build data arrays for each band</span></span>
<span id="cb13-356"><a href="#cb13-356" aria-hidden="true" tabindex="-1"></a>    band_cubes <span class="op">=</span> {}</span>
<span id="cb13-357"><a href="#cb13-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-358"><a href="#cb13-358" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> bands:</span>
<span id="cb13-359"><a href="#cb13-359" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack all scenes for this band</span></span>
<span id="cb13-360"><a href="#cb13-360" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> []</span>
<span id="cb13-361"><a href="#cb13-361" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb13-362"><a href="#cb13-362" aria-hidden="true" tabindex="-1"></a>            band_data.append(scene[<span class="st">'data'</span>][band])</span>
<span id="cb13-363"><a href="#cb13-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-364"><a href="#cb13-364" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create temporal stack</span></span>
<span id="cb13-365"><a href="#cb13-365" aria-hidden="true" tabindex="-1"></a>        band_cube <span class="op">=</span> xr.concat(band_data, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb13-366"><a href="#cb13-366" aria-hidden="true" tabindex="-1"></a>        band_cube <span class="op">=</span> band_cube.assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb13-367"><a href="#cb13-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-368"><a href="#cb13-368" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add chunking for large datasets</span></span>
<span id="cb13-369"><a href="#cb13-369" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chunk_size <span class="op">==</span> <span class="st">'auto'</span>:</span>
<span id="cb13-370"><a href="#cb13-370" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get actual dimension names from the data</span></span>
<span id="cb13-371"><a href="#cb13-371" aria-hidden="true" tabindex="-1"></a>            dims <span class="op">=</span> band_cube.dims</span>
<span id="cb13-372"><a href="#cb13-372" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(dims) <span class="op">==</span> <span class="dv">3</span>:  <span class="co"># time, dim_0, dim_1 or time, y, x</span></span>
<span id="cb13-373"><a href="#cb13-373" aria-hidden="true" tabindex="-1"></a>                chunks <span class="op">=</span> {dims[<span class="dv">0</span>]: <span class="dv">1</span>, dims[<span class="dv">1</span>]: <span class="dv">512</span>, dims[<span class="dv">2</span>]: <span class="dv">512</span>}</span>
<span id="cb13-374"><a href="#cb13-374" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb13-375"><a href="#cb13-375" aria-hidden="true" tabindex="-1"></a>                chunks <span class="op">=</span> {}</span>
<span id="cb13-376"><a href="#cb13-376" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-377"><a href="#cb13-377" aria-hidden="true" tabindex="-1"></a>            chunks <span class="op">=</span> chunk_size</span>
<span id="cb13-378"><a href="#cb13-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-379"><a href="#cb13-379" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only apply chunking if chunks are specified</span></span>
<span id="cb13-380"><a href="#cb13-380" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chunks:</span>
<span id="cb13-381"><a href="#cb13-381" aria-hidden="true" tabindex="-1"></a>            band_cubes[band] <span class="op">=</span> band_cube.chunk(chunks)</span>
<span id="cb13-382"><a href="#cb13-382" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-383"><a href="#cb13-383" aria-hidden="true" tabindex="-1"></a>            band_cubes[band] <span class="op">=</span> band_cube</span>
<span id="cb13-384"><a href="#cb13-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-385"><a href="#cb13-385" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create dataset</span></span>
<span id="cb13-386"><a href="#cb13-386" aria-hidden="true" tabindex="-1"></a>    datacube <span class="op">=</span> xr.Dataset(band_cubes)</span>
<span id="cb13-387"><a href="#cb13-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-388"><a href="#cb13-388" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add derived indices</span></span>
<span id="cb13-389"><a href="#cb13-389" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🧮 Computing vegetation indices..."</span>)</span>
<span id="cb13-390"><a href="#cb13-390" aria-hidden="true" tabindex="-1"></a>    datacube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb13-391"><a href="#cb13-391" aria-hidden="true" tabindex="-1"></a>                        (datacube[<span class="st">'nir'</span>] <span class="op">+</span> datacube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb13-392"><a href="#cb13-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-393"><a href="#cb13-393" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enhanced Vegetation Index (EVI)</span></span>
<span id="cb13-394"><a href="#cb13-394" aria-hidden="true" tabindex="-1"></a>    datacube[<span class="st">'evi'</span>] <span class="op">=</span> (<span class="fl">2.5</span> <span class="op">*</span> (datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb13-395"><a href="#cb13-395" aria-hidden="true" tabindex="-1"></a>                       (datacube[<span class="st">'nir'</span>] <span class="op">+</span> <span class="dv">6</span> <span class="op">*</span> datacube[<span class="st">'red'</span>] <span class="op">-</span> <span class="fl">7.5</span> <span class="op">*</span> datacube[<span class="st">'blue'</span>] <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb13-396"><a href="#cb13-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-397"><a href="#cb13-397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metadata</span></span>
<span id="cb13-398"><a href="#cb13-398" aria-hidden="true" tabindex="-1"></a>    datacube.attrs.update({</span>
<span id="cb13-399"><a href="#cb13-399" aria-hidden="true" tabindex="-1"></a>        <span class="st">'title'</span>: <span class="st">'Sentinel-2 Analysis-Ready Data Cube'</span>,</span>
<span id="cb13-400"><a href="#cb13-400" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="st">'Cloud-masked, reprojected temporal stack'</span>,</span>
<span id="cb13-401"><a href="#cb13-401" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_scenes'</span>: <span class="bu">len</span>(processed_scenes),</span>
<span id="cb13-402"><a href="#cb13-402" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time_range'</span>: <span class="ss">f"</span><span class="sc">{</span>dates[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dates[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb13-403"><a href="#cb13-403" aria-hidden="true" tabindex="-1"></a>        <span class="st">'crs'</span>: <span class="bu">str</span>(datacube[<span class="st">'red'</span>].rio.crs) <span class="cf">if</span> <span class="bu">hasattr</span>(datacube[<span class="st">'red'</span>], <span class="st">'rio'</span>) <span class="kw">and</span> datacube[<span class="st">'red'</span>].rio.crs <span class="cf">else</span> <span class="st">'Unknown'</span>,</span>
<span id="cb13-404"><a href="#cb13-404" aria-hidden="true" tabindex="-1"></a>        <span class="st">'resolution'</span>: <span class="st">'Variable (depends on original scene resolution)'</span></span>
<span id="cb13-405"><a href="#cb13-405" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb13-406"><a href="#cb13-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-407"><a href="#cb13-407" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Data cube created:"</span>)</span>
<span id="cb13-408"><a href="#cb13-408" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Shape: </span><span class="sc">{</span>datacube[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-409"><a href="#cb13-409" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Time steps: </span><span class="sc">{</span><span class="bu">len</span>(dates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-410"><a href="#cb13-410" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Variables: </span><span class="sc">{</span><span class="bu">list</span>(datacube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-411"><a href="#cb13-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-412"><a href="#cb13-412" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> datacube</span>
<span id="cb13-413"><a href="#cb13-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-414"><a href="#cb13-414" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sentinel2Preprocessor:</span>
<span id="cb13-415"><a href="#cb13-415" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-416"><a href="#cb13-416" aria-hidden="true" tabindex="-1"></a><span class="co">    Scalable Sentinel-2 preprocessing pipeline using geogfm functions.</span></span>
<span id="cb13-417"><a href="#cb13-417" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-418"><a href="#cb13-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-419"><a href="#cb13-419" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, output_dir: <span class="bu">str</span> <span class="op">=</span> <span class="st">"preprocessed_data"</span>, target_crs: <span class="bu">str</span> <span class="op">=</span> <span class="st">'EPSG:32610'</span>,</span>
<span id="cb13-420"><a href="#cb13-420" aria-hidden="true" tabindex="-1"></a>                 target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>, max_cloud_cover: <span class="bu">float</span> <span class="op">=</span> <span class="dv">15</span>,</span>
<span id="cb13-421"><a href="#cb13-421" aria-hidden="true" tabindex="-1"></a>                 good_pixel_classes: List[<span class="bu">int</span>] <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]):</span>
<span id="cb13-422"><a href="#cb13-422" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_dir <span class="op">=</span> Path(output_dir)</span>
<span id="cb13-423"><a href="#cb13-423" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-424"><a href="#cb13-424" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_crs <span class="op">=</span> target_crs</span>
<span id="cb13-425"><a href="#cb13-425" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_resolution <span class="op">=</span> target_resolution</span>
<span id="cb13-426"><a href="#cb13-426" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_cloud_cover <span class="op">=</span> max_cloud_cover</span>
<span id="cb13-427"><a href="#cb13-427" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.good_pixel_classes <span class="op">=</span> good_pixel_classes</span>
<span id="cb13-428"><a href="#cb13-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-429"><a href="#cb13-429" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up authentication once during initialization</span></span>
<span id="cb13-430"><a href="#cb13-430" aria-hidden="true" tabindex="-1"></a>        setup_planetary_computer_auth()</span>
<span id="cb13-431"><a href="#cb13-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-432"><a href="#cb13-432" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"🔧 Preprocessing pipeline initialized"</span>)</span>
<span id="cb13-433"><a href="#cb13-433" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Output directory: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-434"><a href="#cb13-434" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Target CRS: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-435"><a href="#cb13-435" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Target resolution: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_resolution<span class="sc">}</span><span class="ss">m"</span>)</span>
<span id="cb13-436"><a href="#cb13-436" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Max cloud cover: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span>
<span id="cb13-437"><a href="#cb13-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-438"><a href="#cb13-438" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> search_scenes(<span class="va">self</span>, bbox: List[<span class="bu">float</span>], start_date: <span class="bu">str</span>, end_date: <span class="bu">str</span>,</span>
<span id="cb13-439"><a href="#cb13-439" aria-hidden="true" tabindex="-1"></a>                     limit: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>) <span class="op">-&gt;</span> List:</span>
<span id="cb13-440"><a href="#cb13-440" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Search for Sentinel-2 scenes using geogfm standardized function."""</span></span>
<span id="cb13-441"><a href="#cb13-441" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure authentication is set up</span></span>
<span id="cb13-442"><a href="#cb13-442" aria-hidden="true" tabindex="-1"></a>        setup_planetary_computer_auth()</span>
<span id="cb13-443"><a href="#cb13-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-444"><a href="#cb13-444" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use our standardized search function</span></span>
<span id="cb13-445"><a href="#cb13-445" aria-hidden="true" tabindex="-1"></a>        date_range <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb13-446"><a href="#cb13-446" aria-hidden="true" tabindex="-1"></a>        items <span class="op">=</span> search_sentinel2_scenes(</span>
<span id="cb13-447"><a href="#cb13-447" aria-hidden="true" tabindex="-1"></a>            bbox<span class="op">=</span>bbox,</span>
<span id="cb13-448"><a href="#cb13-448" aria-hidden="true" tabindex="-1"></a>            date_range<span class="op">=</span>date_range,</span>
<span id="cb13-449"><a href="#cb13-449" aria-hidden="true" tabindex="-1"></a>            cloud_cover_max<span class="op">=</span><span class="va">self</span>.max_cloud_cover,</span>
<span id="cb13-450"><a href="#cb13-450" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">=</span>limit</span>
<span id="cb13-451"><a href="#cb13-451" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-452"><a href="#cb13-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-453"><a href="#cb13-453" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"🔍 Found </span><span class="sc">{</span><span class="bu">len</span>(items)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb13-454"><a href="#cb13-454" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> items</span>
<span id="cb13-455"><a href="#cb13-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-456"><a href="#cb13-456" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_scene(<span class="va">self</span>, item, save_individual: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> Optional[Dict]:</span>
<span id="cb13-457"><a href="#cb13-457" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Process a single scene with cloud masking using geogfm functions."""</span></span>
<span id="cb13-458"><a href="#cb13-458" aria-hidden="true" tabindex="-1"></a>        scene_id <span class="op">=</span> item.<span class="bu">id</span></span>
<span id="cb13-459"><a href="#cb13-459" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> <span class="va">self</span>.output_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">_processed.nc"</span></span>
<span id="cb13-460"><a href="#cb13-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-461"><a href="#cb13-461" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip if already processed</span></span>
<span id="cb13-462"><a href="#cb13-462" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> output_path.exists():</span>
<span id="cb13-463"><a href="#cb13-463" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"⏭️ Skipping </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss"> (already processed)"</span>)</span>
<span id="cb13-464"><a href="#cb13-464" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> save_individual:</span>
<span id="cb13-465"><a href="#cb13-465" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="bu">str</span>(output_path)</span>
<span id="cb13-466"><a href="#cb13-466" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb13-467"><a href="#cb13-467" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Load existing data for in-memory processing</span></span>
<span id="cb13-468"><a href="#cb13-468" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> xr.open_dataset(output_path)</span>
<span id="cb13-469"><a href="#cb13-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-470"><a href="#cb13-470" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process scene using our enhanced function</span></span>
<span id="cb13-471"><a href="#cb13-471" aria-hidden="true" tabindex="-1"></a>        data, valid_frac <span class="op">=</span> load_scene_with_cloudmask(</span>
<span id="cb13-472"><a href="#cb13-472" aria-hidden="true" tabindex="-1"></a>            item, <span class="va">self</span>.target_crs, <span class="va">self</span>.target_resolution, <span class="va">self</span>.good_pixel_classes</span>
<span id="cb13-473"><a href="#cb13-473" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-474"><a href="#cb13-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-475"><a href="#cb13-475" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reduce minimum valid fraction threshold for demonstration</span></span>
<span id="cb13-476"><a href="#cb13-476" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> data <span class="kw">and</span> valid_frac <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Accept scenes with &gt;10% valid pixels</span></span>
<span id="cb13-477"><a href="#cb13-477" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> save_individual:</span>
<span id="cb13-478"><a href="#cb13-478" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb13-479"><a href="#cb13-479" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Convert to xarray Dataset</span></span>
<span id="cb13-480"><a href="#cb13-480" aria-hidden="true" tabindex="-1"></a>                    scene_ds <span class="op">=</span> xr.Dataset(data)</span>
<span id="cb13-481"><a href="#cb13-481" aria-hidden="true" tabindex="-1"></a>                    scene_ds.attrs.update({</span>
<span id="cb13-482"><a href="#cb13-482" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'scene_id'</span>: scene_id,</span>
<span id="cb13-483"><a href="#cb13-483" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'date'</span>: item.properties[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>],</span>
<span id="cb13-484"><a href="#cb13-484" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'cloud_cover'</span>: item.properties.get(<span class="st">'eo:cloud_cover'</span>, <span class="dv">0</span>),</span>
<span id="cb13-485"><a href="#cb13-485" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'valid_pixel_fraction'</span>: valid_frac,</span>
<span id="cb13-486"><a href="#cb13-486" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'processing_crs'</span>: <span class="va">self</span>.target_crs,</span>
<span id="cb13-487"><a href="#cb13-487" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'processing_resolution'</span>: <span class="va">self</span>.target_resolution</span>
<span id="cb13-488"><a href="#cb13-488" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb13-489"><a href="#cb13-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-490"><a href="#cb13-490" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Save to NetCDF with compression and engine fallback</span></span>
<span id="cb13-491"><a href="#cb13-491" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb13-492"><a href="#cb13-492" aria-hidden="true" tabindex="-1"></a>                        encoding <span class="op">=</span> {var: {<span class="st">'zlib'</span>: <span class="va">True</span>, <span class="st">'complevel'</span>: <span class="dv">4</span>} <span class="cf">for</span> var <span class="kw">in</span> scene_ds.data_vars}</span>
<span id="cb13-493"><a href="#cb13-493" aria-hidden="true" tabindex="-1"></a>                        scene_ds.to_netcdf(output_path, engine<span class="op">=</span><span class="st">'netcdf4'</span>, encoding<span class="op">=</span>encoding)</span>
<span id="cb13-494"><a href="#cb13-494" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"💾 Saved: </span><span class="sc">{</span>output_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (netCDF4)"</span>)</span>
<span id="cb13-495"><a href="#cb13-495" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb13-496"><a href="#cb13-496" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"⚠️ netCDF4 not available, using scipy for </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb13-497"><a href="#cb13-497" aria-hidden="true" tabindex="-1"></a>                        scene_ds.to_netcdf(output_path, engine<span class="op">=</span><span class="st">'scipy'</span>)</span>
<span id="cb13-498"><a href="#cb13-498" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"💾 Saved: </span><span class="sc">{</span>output_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (scipy)"</span>)</span>
<span id="cb13-499"><a href="#cb13-499" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-500"><a href="#cb13-500" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"⚠️ Save error for </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-501"><a href="#cb13-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-502"><a href="#cb13-502" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> data</span>
<span id="cb13-503"><a href="#cb13-503" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-504"><a href="#cb13-504" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"❌ Skipped </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss"> (valid fraction: </span><span class="sc">{</span>valid_frac<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb13-505"><a href="#cb13-505" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb13-506"><a href="#cb13-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-507"><a href="#cb13-507" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_time_series_cube(<span class="va">self</span>, processed_data_list, cube_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">"datacube"</span>):</span>
<span id="cb13-508"><a href="#cb13-508" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create and save temporal data cube."""</span></span>
<span id="cb13-509"><a href="#cb13-509" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> processed_data_list:</span>
<span id="cb13-510"><a href="#cb13-510" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"❌ No data to create cube"</span>)</span>
<span id="cb13-511"><a href="#cb13-511" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb13-512"><a href="#cb13-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-513"><a href="#cb13-513" aria-hidden="true" tabindex="-1"></a>        cube_path <span class="op">=</span> <span class="va">self</span>.output_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>cube_name<span class="sc">}</span><span class="ss">.nc"</span></span>
<span id="cb13-514"><a href="#cb13-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-515"><a href="#cb13-515" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build temporal stack</span></span>
<span id="cb13-516"><a href="#cb13-516" aria-hidden="true" tabindex="-1"></a>        dates <span class="op">=</span> []</span>
<span id="cb13-517"><a href="#cb13-517" aria-hidden="true" tabindex="-1"></a>        band_stacks <span class="op">=</span> {band: [] <span class="cf">for</span> band <span class="kw">in</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]}</span>
<span id="cb13-518"><a href="#cb13-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-519"><a href="#cb13-519" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data <span class="kw">in</span> processed_data_list:</span>
<span id="cb13-520"><a href="#cb13-520" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> data:</span>
<span id="cb13-521"><a href="#cb13-521" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle both dictionary format and xarray Dataset format</span></span>
<span id="cb13-522"><a href="#cb13-522" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(data, <span class="bu">dict</span>):</span>
<span id="cb13-523"><a href="#cb13-523" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Dictionary format from fresh processing</span></span>
<span id="cb13-524"><a href="#cb13-524" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> band <span class="kw">in</span> band_stacks.keys():</span>
<span id="cb13-525"><a href="#cb13-525" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> band <span class="kw">in</span> data:</span>
<span id="cb13-526"><a href="#cb13-526" aria-hidden="true" tabindex="-1"></a>                            band_stacks[band].append(data[band])</span>
<span id="cb13-527"><a href="#cb13-527" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb13-528"><a href="#cb13-528" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># xarray Dataset from loaded file - extract individual bands</span></span>
<span id="cb13-529"><a href="#cb13-529" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> band <span class="kw">in</span> band_stacks.keys():</span>
<span id="cb13-530"><a href="#cb13-530" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> band <span class="kw">in</span> data.data_vars:</span>
<span id="cb13-531"><a href="#cb13-531" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># If the loaded data has a time dimension, select the first time slice</span></span>
<span id="cb13-532"><a href="#cb13-532" aria-hidden="true" tabindex="-1"></a>                            band_data <span class="op">=</span> data[band]</span>
<span id="cb13-533"><a href="#cb13-533" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> <span class="st">'time'</span> <span class="kw">in</span> band_data.dims <span class="kw">and</span> band_data.dims[<span class="st">'time'</span>] <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb13-534"><a href="#cb13-534" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># Multiple time slices in saved file - take first one</span></span>
<span id="cb13-535"><a href="#cb13-535" aria-hidden="true" tabindex="-1"></a>                                band_data <span class="op">=</span> band_data.isel(time<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb13-536"><a href="#cb13-536" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">elif</span> <span class="st">'time'</span> <span class="kw">in</span> band_data.dims:</span>
<span id="cb13-537"><a href="#cb13-537" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># Single time slice - remove time dimension</span></span>
<span id="cb13-538"><a href="#cb13-538" aria-hidden="true" tabindex="-1"></a>                                band_data <span class="op">=</span> band_data.squeeze(<span class="st">'time'</span>)</span>
<span id="cb13-539"><a href="#cb13-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-540"><a href="#cb13-540" aria-hidden="true" tabindex="-1"></a>                            band_stacks[band].append(band_data)</span>
<span id="cb13-541"><a href="#cb13-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-542"><a href="#cb13-542" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create dataset</span></span>
<span id="cb13-543"><a href="#cb13-543" aria-hidden="true" tabindex="-1"></a>        cube_data <span class="op">=</span> {}</span>
<span id="cb13-544"><a href="#cb13-544" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"📊 Processing bands: </span><span class="sc">{</span><span class="bu">list</span>(band_stacks.keys())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-545"><a href="#cb13-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-546"><a href="#cb13-546" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> band, stack <span class="kw">in</span> band_stacks.items():</span>
<span id="cb13-547"><a href="#cb13-547" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stack:</span>
<span id="cb13-548"><a href="#cb13-548" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>band<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(stack)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb13-549"><a href="#cb13-549" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check that all scenes have this band</span></span>
<span id="cb13-550"><a href="#cb13-550" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(stack) <span class="op">==</span> <span class="bu">len</span>(processed_data_list):</span>
<span id="cb13-551"><a href="#cb13-551" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb13-552"><a href="#cb13-552" aria-hidden="true" tabindex="-1"></a>                        cube_data[band] <span class="op">=</span> xr.concat(stack, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb13-553"><a href="#cb13-553" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-554"><a href="#cb13-554" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"⚠️ Failed to concatenate </span><span class="sc">{</span>band<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-555"><a href="#cb13-555" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb13-556"><a href="#cb13-556" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"⚠️ </span><span class="sc">{</span>band<span class="sc">}</span><span class="ss"> missing from some scenes (</span><span class="sc">{</span><span class="bu">len</span>(stack)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(processed_data_list)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb13-557"><a href="#cb13-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-558"><a href="#cb13-558" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cube_data:</span>
<span id="cb13-559"><a href="#cb13-559" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb13-560"><a href="#cb13-560" aria-hidden="true" tabindex="-1"></a>                datacube <span class="op">=</span> xr.Dataset(cube_data)</span>
<span id="cb13-561"><a href="#cb13-561" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-562"><a href="#cb13-562" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"❌ Failed to create dataset: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-563"><a href="#cb13-563" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Available bands: </span><span class="sc">{</span><span class="bu">list</span>(cube_data.keys())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-564"><a href="#cb13-564" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb13-565"><a href="#cb13-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-566"><a href="#cb13-566" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add vegetation indices</span></span>
<span id="cb13-567"><a href="#cb13-567" aria-hidden="true" tabindex="-1"></a>            datacube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb13-568"><a href="#cb13-568" aria-hidden="true" tabindex="-1"></a>                               (datacube[<span class="st">'nir'</span>] <span class="op">+</span> datacube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb13-569"><a href="#cb13-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-570"><a href="#cb13-570" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save cube with fallback engines</span></span>
<span id="cb13-571"><a href="#cb13-571" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb13-572"><a href="#cb13-572" aria-hidden="true" tabindex="-1"></a>                datacube.to_netcdf(cube_path, engine<span class="op">=</span><span class="st">'netcdf4'</span>)</span>
<span id="cb13-573"><a href="#cb13-573" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"📦 Data cube saved: </span><span class="sc">{</span>cube_path<span class="sc">}</span><span class="ss"> (netCDF4)"</span>)</span>
<span id="cb13-574"><a href="#cb13-574" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb13-575"><a href="#cb13-575" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"⚠️ netCDF4 not available, using scipy engine..."</span>)</span>
<span id="cb13-576"><a href="#cb13-576" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb13-577"><a href="#cb13-577" aria-hidden="true" tabindex="-1"></a>                    datacube.to_netcdf(cube_path, engine<span class="op">=</span><span class="st">'scipy'</span>)</span>
<span id="cb13-578"><a href="#cb13-578" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"📦 Data cube saved: </span><span class="sc">{</span>cube_path<span class="sc">}</span><span class="ss"> (scipy)"</span>)</span>
<span id="cb13-579"><a href="#cb13-579" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb13-580"><a href="#cb13-580" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="st">"⚠️ NetCDF save failed, saving as Zarr..."</span>)</span>
<span id="cb13-581"><a href="#cb13-581" aria-hidden="true" tabindex="-1"></a>                    zarr_path <span class="op">=</span> cube_path.with_suffix(<span class="st">'.zarr'</span>)</span>
<span id="cb13-582"><a href="#cb13-582" aria-hidden="true" tabindex="-1"></a>                    datacube.to_zarr(zarr_path)</span>
<span id="cb13-583"><a href="#cb13-583" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"📦 Data cube saved: </span><span class="sc">{</span>zarr_path<span class="sc">}</span><span class="ss"> (zarr)"</span>)</span>
<span id="cb13-584"><a href="#cb13-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-585"><a href="#cb13-585" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> datacube</span>
<span id="cb13-586"><a href="#cb13-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-587"><a href="#cb13-587" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<section id="test-cloud-masking-functions" class="level3">
<h3 class="anchored" data-anchor-id="test-cloud-masking-functions">Test Cloud Masking Functions</h3>
<p>Now let’s test our cloud masking functions with a real scene. We’ll use spatial subsetting to make processing faster and more educational.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Spatial Subsetting for Faster Processing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Processing full Sentinel-2 scenes can be slow and memory-intensive. Each full scene: - <strong>Size</strong>: ~100MB+ per scene when loaded - <strong>Dimensions</strong>: ~10,000 × 10,000 pixels at 10m resolution - <strong>Processing time</strong>: Several minutes per scene</p>
<p>Using spatial subsets: - <strong>Size</strong>: ~1-5MB per subset - <strong>Dimensions</strong>: ~500 × 500 to 2,000 × 2,000 pixels - <strong>Processing time</strong>: Seconds per subset</p>
<p><strong>Perfect for</strong>: Learning, development, testing, and focused analysis</p>
</div>
</div>
<div id="603d7df1" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define some useful preset subsets for different use cases</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Central Valley subsets (agriculture focus)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>small_farm_area <span class="op">=</span> [<span class="op">-</span><span class="fl">121.0</span>, <span class="fl">37.0</span>, <span class="op">-</span><span class="fl">120.8</span>, <span class="fl">37.2</span>]     <span class="co"># ~20km × 20km</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>medium_valley <span class="op">=</span> [<span class="op">-</span><span class="fl">121.2</span>, <span class="fl">36.8</span>, <span class="op">-</span><span class="fl">120.6</span>, <span class="fl">37.4</span>]       <span class="co"># ~40km × 40km</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>large_valley <span class="op">=</span> [<span class="op">-</span><span class="fl">121.5</span>, <span class="fl">36.5</span>, <span class="op">-</span><span class="fl">120.0</span>, <span class="fl">38.0</span>]        <span class="co"># Full study area</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Urban area subsets</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>sacramento_metro <span class="op">=</span> [<span class="op">-</span><span class="fl">121.6</span>, <span class="fl">38.4</span>, <span class="op">-</span><span class="fl">121.3</span>, <span class="fl">38.7</span>]    <span class="co"># Sacramento urban area</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>fresno_area <span class="op">=</span> [<span class="op">-</span><span class="fl">119.9</span>, <span class="fl">36.6</span>, <span class="op">-</span><span class="fl">119.6</span>, <span class="fl">36.9</span>]         <span class="co"># Fresno urban/ag mix</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📍 Available subset presets:"</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Small farm area: </span><span class="sc">{</span>small_farm_area<span class="sc">}</span><span class="ss"> (~400MB data)"</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Medium valley: </span><span class="sc">{</span>medium_valley<span class="sc">}</span><span class="ss"> (~1.6GB data)"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Large valley: </span><span class="sc">{</span>large_valley<span class="sc">}</span><span class="ss"> (full study area)"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sacramento metro: </span><span class="sc">{</span>sacramento_metro<span class="sc">}</span><span class="ss"> (~urban focus)"</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fresno area: </span><span class="sc">{</span>fresno_area<span class="sc">}</span><span class="ss"> (~urban/ag mix)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>📍 Available subset presets:
Small farm area: [-121.0, 37.0, -120.8, 37.2] (~400MB data)
Medium valley: [-121.2, 36.8, -120.6, 37.4] (~1.6GB data)
Large valley: [-121.5, 36.5, -120.0, 38.0] (full study area)
Sacramento metro: [-121.6, 38.4, -121.3, 38.7] (~urban focus)
Fresno area: [-119.9, 36.6, -119.6, 36.9] (~urban/ag mix)</code></pre>
</div>
</div>
<div id="6568d995" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with one scene</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>test_item <span class="op">=</span> scenes_df.iloc[<span class="dv">0</span>][<span class="st">'item'</span>]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🧪 Testing cloud masking with scene: </span><span class="sc">{</span>test_item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define good pixel classes for this demonstration</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>good_pixel_classes <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]  <span class="co"># Vegetation, not vegetated, water</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a smaller subset for faster processing (optional)</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a small area within Central Valley for demonstration</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>fast_subset <span class="op">=</span> [<span class="op">-</span><span class="fl">121.0</span>, <span class="fl">37.0</span>, <span class="op">-</span><span class="fl">120.8</span>, <span class="fl">37.2</span>]  <span class="co"># Small 20km x 20km area</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎯 Processing options:"</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"1. Full scene: ~100MB+ download, slow processing"</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"2. Subset area: ~1-5MB download, fast processing"</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🚀 Using fast subset for demonstration..."</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Test our enhanced cloud masking function with spatial subset</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>masked_data, valid_fraction <span class="op">=</span> load_scene_with_cloudmask(</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    test_item,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    target_resolution<span class="op">=</span><span class="dv">20</span>,  <span class="co"># Resample to 20m to match SCL</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    good_pixel_classes<span class="op">=</span>good_pixel_classes,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    subset_bbox<span class="op">=</span>fast_subset  <span class="co"># Use subset for faster processing</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> masked_data:</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Scene loaded successfully"</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📏 Data shape: </span><span class="sc">{</span>masked_data[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📊 Valid pixels: </span><span class="sc">{</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"☁️ Cloudy pixels: </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"❌ Failed to load scene"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>🧪 Testing cloud masking with scene: S2B_MSIL2A_20240816T184919_R113_T11SKB_20240816T230724

🎯 Processing options:
1. Full scene: ~100MB+ download, slow processing
2. Subset area: ~1-5MB download, fast processing

🚀 Using fast subset for demonstration...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:38:58,630 - INFO - Successfully loaded 5 bands: ['B04', 'B03', 'B02', 'B08', 'SCL']</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Resampling B04 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B04
Resampling B03 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B03
Resampling B02 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B02
Resampling B08 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B08
✅ Scene loaded successfully
📏 Data shape: (5490, 5490)
📊 Valid pixels: 12.8%
☁️ Cloudy pixels: 87.2%</code></pre>
</div>
</div>
</section>
<section id="visualize-cloud-masking-results" class="level3">
<h3 class="anchored" data-anchor-id="visualize-cloud-masking-results">Visualize Cloud Masking Results</h3>
<div id="654db67c" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> masked_data:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create visualization of cloud masking</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Original RGB (before masking)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    red_orig <span class="op">=</span> masked_data[<span class="st">'red'</span>].fillna(<span class="dv">0</span>)  <span class="co"># Fill NaN for display</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    green_orig <span class="op">=</span> masked_data[<span class="st">'green'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    blue_orig <span class="op">=</span> masked_data[<span class="st">'blue'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize for RGB display</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> normalize_for_display(band, percentiles<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">98</span>)):</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        valid_data <span class="op">=</span> band[<span class="op">~</span>np.isnan(band)]</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>            p_low, p_high <span class="op">=</span> np.percentile(valid_data, percentiles)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.clip((band <span class="op">-</span> p_low) <span class="op">/</span> (p_high <span class="op">-</span> p_low), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> band</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    red_norm <span class="op">=</span> normalize_for_display(red_orig.values)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    green_norm <span class="op">=</span> normalize_for_display(green_orig.values)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    blue_norm <span class="op">=</span> normalize_for_display(blue_orig.values)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    rgb_composite <span class="op">=</span> np.dstack([red_norm, green_norm, blue_norm])</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].imshow(rgb_composite)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'RGB Composite'</span>)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scene Classification Layer</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    scl_plot <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">1</span>].imshow(masked_data[<span class="st">'scl'</span>].values, cmap<span class="op">=</span><span class="st">'tab20'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Scene Classification Layer'</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cloud mask</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].imshow(masked_data[<span class="st">'cloud_mask'</span>].values, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'Valid Pixels Mask'</span>)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Masked RGB</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    masked_rgb <span class="op">=</span> rgb_composite.copy()</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    masked_rgb[<span class="op">~</span>masked_data[<span class="st">'cloud_mask'</span>].values] <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>]  <span class="co"># Red for masked areas</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].imshow(masked_rgb)</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Masked RGB (Red = Clouds)'</span>)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI calculation on masked data</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The Normalized Difference Vegetation Index (NDVI) is calculated as:</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI = (NIR - Red) / (NIR + Red)</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    nir_masked <span class="op">=</span> masked_data[<span class="st">'nir'</span>].values</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    red_masked <span class="op">=</span> masked_data[<span class="st">'red'</span>].values</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    ndvi <span class="op">=</span> (nir_masked <span class="op">-</span> red_masked) <span class="op">/</span> (nir_masked <span class="op">+</span> red_masked <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    ndvi_plot <span class="op">=</span> axes[<span class="dv">1</span>,<span class="dv">1</span>].imshow(ndvi, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=-</span><span class="fl">0.5</span>, vmax<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'NDVI (Clouds Excluded)'</span>)</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(ndvi_plot, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Statistics</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="ss">f"Valid Pixels: </span><span class="sc">{</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.6</span>, <span class="ss">f"Cloudy Pixels: </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="ss">f"NDVI Range: </span><span class="sc">{</span>np<span class="sc">.</span>nanmin(ndvi)<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>np<span class="sc">.</span>nanmax(ndvi)<span class="sc">:.2f}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="ss">f"Mean NDVI: </span><span class="sc">{</span>np<span class="sc">.</span>nanmean(ndvi)<span class="sc">:.2f}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Statistics'</span>)</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🎨 Cloud masking visualization complete"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="c02-spatial-temporal-attention-mechanisms_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>🎨 Cloud masking visualization complete</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Scene Classification Layer (SCL) Benefits
</div>
</div>
<div class="callout-body-container callout-body">
<p>The SCL is automatically generated during Sentinel-2 Level 2A processing using machine learning algorithms trained on expert-labeled data.</p>
<p><strong>Key Advantages</strong>: - <strong>Automated cloud detection</strong>: No manual threshold setting needed - <strong>Multiple cloud types</strong>: Distinguishes dense clouds, thin cirrus, and shadows - <strong>Consistent classification</strong>: Same algorithm across all Sentinel-2 scenes globally - <strong>Analysis-ready</strong>: Level 2A processing includes atmospheric correction - <strong>Production quality</strong>: Used by ESA and major data providers</p>
<p><strong>Best Practice</strong>: Always use SCL for cloud masking rather than simple band thresholds, as it accounts for seasonal and geographic variations in cloud appearance.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="step-3-reprojection-and-mosaicking" class="level2">
<h2 class="anchored" data-anchor-id="step-3-reprojection-and-mosaicking">Step 3: Reprojection and Mosaicking</h2>
<p>When working with multiple scenes, we need to ensure they’re all in the same coordinate system and can be combined seamlessly.</p>
<section id="batch-process-multiple-scenes" class="level3">
<h3 class="anchored" data-anchor-id="batch-process-multiple-scenes">Batch Process Multiple Scenes</h3>
<div id="5b52b261" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's test the batch processing functions we defined earlier</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Select subset of scenes for processing (to manage computational load)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>selected_scenes <span class="op">=</span> scenes_df.head(<span class="dv">5</span>)[<span class="st">'item'</span>].tolist()  <span class="co"># Process first 5 scenes</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define processing options</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">📎 Processing Options:"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Option A: Full scenes (slower, ~100MB+ per scene)"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Option B: Spatial subset (faster, ~1-5MB per scene)"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">🚀 Using spatial subset for faster demonstration..."</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the same fast subset as before</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>fast_subset <span class="op">=</span> [<span class="op">-</span><span class="fl">121.0</span>, <span class="fl">37.0</span>, <span class="op">-</span><span class="fl">120.8</span>, <span class="fl">37.2</span>]  <span class="co"># Small area for fast processing</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>processed_scenes <span class="op">=</span> process_scene_batch(</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    selected_scenes,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    max_workers<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    min_valid_fraction<span class="op">=</span><span class="fl">0.1</span>,  <span class="co"># Lower threshold to include more scenes</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    subset_bbox<span class="op">=</span>fast_subset  <span class="co"># Enable fast processing with subset</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Show processing results</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> processed_scenes:</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Processing Summary:"</span>)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>scene[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>scene[<span class="st">'valid_fraction'</span>]<span class="sc">:.1%}</span><span class="ss"> valid pixels"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
📎 Processing Options:
Option A: Full scenes (slower, ~100MB+ per scene)
Option B: Spatial subset (faster, ~1-5MB per scene)

🚀 Using spatial subset for faster demonstration...
🔄 Processing 5 scenes with 2 workers...
Processing S2B_MSIL2A_20240816T184919_R113_T11SKB_20240816T23...
Processing S2B_MSIL2A_20240627T184919_R113_T11SKA_20240628T00...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:39:17,471 - INFO - Successfully loaded 5 bands: ['B04', 'B03', 'B02', 'B08', 'SCL']</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Resampling B04 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B04
Resampling B03 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B03
Resampling B02 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B02
Resampling B08 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B08
⚠️ Skipped S2B_MSIL2A_20240627T184919_R11 (valid fraction: 0.0%)
Processing S2B_MSIL2A_20240607T184919_R113_T11SKA_20240608T00...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:39:21,235 - INFO - Successfully loaded 5 bands: ['B04', 'B03', 'B02', 'B08', 'SCL']</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Resampling B04 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B04
Resampling B03 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B03
Resampling B02 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B02
Resampling B08 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B08
⚠️ Skipped S2B_MSIL2A_20240607T184919_R11 (valid fraction: 0.0%)
Processing S2B_MSIL2A_20240607T184919_R113_T11SKA_20240607T23...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:39:30,470 - INFO - Successfully loaded 5 bands: ['B04', 'B03', 'B02', 'B08', 'SCL']</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Resampling B04 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B04
Resampling B03 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B03
Resampling B02 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B02
Resampling B08 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B08
⚠️ Skipped S2B_MSIL2A_20240607T184919_R11 (valid fraction: 0.0%)
Processing S2A_MSIL2A_20240602T184921_R113_T11SKA_20240603T03...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:39:34,043 - INFO - Successfully loaded 5 bands: ['B04', 'B03', 'B02', 'B08', 'SCL']</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Resampling B04 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B04
Resampling B03 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B03
Resampling B02 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B02
Resampling B08 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B08
⚠️ Skipped S2A_MSIL2A_20240602T184921_R11 (valid fraction: 0.0%)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:39:39,062 - INFO - Successfully loaded 5 bands: ['B04', 'B03', 'B02', 'B08', 'SCL']</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Resampling B04 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B04
Resampling B03 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B03
Resampling B02 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B02
Resampling B08 from (10980, 10980) to (5490, 5490)
Used 2x decimation for B08
✅ Successfully processed 1 scenes

📊 Processing Summary:
   2024-08-16: 12.8% valid pixels</code></pre>
</div>
</div>
</section>
<section id="create-temporal-mosaic" class="level3">
<h3 class="anchored" data-anchor-id="create-temporal-mosaic">Create Temporal Mosaic</h3>
<div id="a51c2d56" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create temporal mosaic using the function we defined earlier</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create median composite</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>mosaic <span class="op">=</span> create_temporal_mosaic(processed_scenes, method<span class="op">=</span><span class="st">'median'</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> mosaic:</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualize the mosaic</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RGB composite of mosaic</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    red_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'red'</span>].values)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    green_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'green'</span>].values)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    blue_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'blue'</span>].values)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    rgb_mosaic <span class="op">=</span> np.dstack([red_norm, green_norm, blue_norm])</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].imshow(rgb_mosaic)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="ss">f'RGB Mosaic (</span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">"method"</span>]<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI mosaic</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    nir_vals <span class="op">=</span> mosaic[<span class="st">'nir'</span>].values</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    red_vals <span class="op">=</span> mosaic[<span class="st">'red'</span>].values</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    ndvi_mosaic <span class="op">=</span> (nir_vals <span class="op">-</span> red_vals) <span class="op">/</span> (nir_vals <span class="op">+</span> red_vals <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    ndvi_plot <span class="op">=</span> axes[<span class="dv">1</span>].imshow(ndvi_mosaic, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=-</span><span class="fl">0.2</span>, vmax<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'NDVI Mosaic'</span>)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(ndvi_plot, ax<span class="op">=</span>axes[<span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data availability (how many scenes contributed to each pixel)</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This would require tracking per-pixel contributions</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="ss">f"Scenes used: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'n_scenes'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Method: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'method'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Date range: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'date_range'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Coverage: Central Valley, CA"</span>,</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>axes[<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>, verticalalignment<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].set_title(<span class="st">'Mosaic Info'</span>)</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🎨 Temporal mosaic visualization complete"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>🧩 Creating temporal mosaic using median method...
✅ Mosaic created from 1 scenes
📏 Mosaic shape: (5490, 5490)
📅 Date range: 2024-08-16 to 2024-08-16</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="c02-spatial-temporal-attention-mechanisms_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>🎨 Temporal mosaic visualization complete</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-4-analysis-ready-data-cubes" class="level2">
<h2 class="anchored" data-anchor-id="step-4-analysis-ready-data-cubes">Step 4: Analysis-Ready Data Cubes</h2>
<p>Now let’s create analysis-ready data cubes that can be used for time series analysis and machine learning.</p>
<section id="build-temporal-data-cube" class="level3">
<h3 class="anchored" data-anchor-id="build-temporal-data-cube">Build Temporal Data Cube</h3>
<div id="656982e4" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build temporal data cube using the function we defined earlier</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the data cube</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>datacube <span class="op">=</span> build_temporal_datacube(processed_scenes)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> datacube:</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📦 Data Cube Summary:"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(datacube)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>📊 Building temporal data cube...
🧮 Computing vegetation indices...
✅ Data cube created:
   Shape: (1, 5490, 5490)
   Time steps: 1
   Variables: ['red', 'green', 'blue', 'nir', 'ndvi', 'evi']

📦 Data Cube Summary:
&lt;xarray.Dataset&gt; Size: 1GB
Dimensions:  (time: 1, y: 5490, x: 5490)
Coordinates:
  * time     (time) datetime64[ns] 8B 2024-08-16
Dimensions without coordinates: y, x
Data variables:
    red      (time, y, x) float64 241MB dask.array&lt;chunksize=(1, 512, 512), meta=np.ndarray&gt;
    green    (time, y, x) float64 241MB dask.array&lt;chunksize=(1, 512, 512), meta=np.ndarray&gt;
    blue     (time, y, x) float64 241MB dask.array&lt;chunksize=(1, 512, 512), meta=np.ndarray&gt;
    nir      (time, y, x) float64 241MB dask.array&lt;chunksize=(1, 512, 512), meta=np.ndarray&gt;
    ndvi     (time, y, x) float64 241MB dask.array&lt;chunksize=(1, 512, 512), meta=np.ndarray&gt;
    evi      (time, y, x) float64 241MB dask.array&lt;chunksize=(1, 512, 512), meta=np.ndarray&gt;
Attributes:
    title:        Sentinel-2 Analysis-Ready Data Cube
    description:  Cloud-masked, reprojected temporal stack
    n_scenes:     1
    time_range:   2024-08-16 to 2024-08-16
    crs:          Unknown
    resolution:   Variable (depends on original scene resolution)</code></pre>
</div>
</div>
</section>
<section id="time-series-analysis-example" class="level3">
<h3 class="anchored" data-anchor-id="time-series-analysis-example">Time Series Analysis Example</h3>
<div id="29ca2e49" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> datacube:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time series for a sample location</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use more robust center selection - assume the spatial dims are the last two</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    spatial_dims <span class="op">=</span> [dim <span class="cf">for</span> dim <span class="kw">in</span> datacube[<span class="st">'red'</span>].dims <span class="cf">if</span> dim <span class="op">!=</span> <span class="st">'time'</span>]</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(spatial_dims) <span class="op">&gt;=</span> <span class="dv">2</span>:</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        y_dim, x_dim <span class="op">=</span> spatial_dims[<span class="dv">0</span>], spatial_dims[<span class="dv">1</span>]</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        center_y_idx <span class="op">=</span> datacube.dims[y_dim] <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>        center_x_idx <span class="op">=</span> datacube.dims[x_dim] <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract time series at center point using integer indexing</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>        point_ts <span class="op">=</span> datacube.isel({y_dim: center_y_idx, x_dim: center_x_idx})</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"📍 Using spatial dimensions: </span><span class="sc">{</span>y_dim<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>center_y_idx<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>x_dim<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>center_x_idx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️ Cannot determine spatial dimensions for time series analysis"</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        point_ts <span class="op">=</span> <span class="va">None</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create time series plots only if we have valid point data</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> point_ts <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># NDVI time series</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'ndvi'</span>], <span class="st">'g-o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'NDVI Time Series'</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'NDVI'</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># EVI time series</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">1</span>].plot(point_ts.time, point_ts[<span class="st">'evi'</span>], <span class="st">'b-o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'EVI Time Series'</span>)</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'EVI'</span>)</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># RGB bands time series</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'red'</span>], <span class="st">'r-'</span>, label<span class="op">=</span><span class="st">'Red'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'green'</span>], <span class="st">'g-'</span>, label<span class="op">=</span><span class="st">'Green'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'blue'</span>], <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'Blue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'RGB Bands Time Series'</span>)</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Reflectance'</span>)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># NIR time series</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].plot(point_ts.time, point_ts[<span class="st">'nir'</span>], <span class="st">'darkred'</span>, marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'NIR Band Time Series'</span>)</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'NIR Reflectance'</span>)</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"📈 Time series analysis complete"</span>)</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Sample location indices: y=</span><span class="sc">{</span>center_y_idx<span class="sc">}</span><span class="ss">, x=</span><span class="sc">{</span>center_x_idx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️ Skipping time series plots due to dimension issues"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>📍 Using spatial dimensions: y=2745, x=2745</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="c02-spatial-temporal-attention-mechanisms_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>📈 Time series analysis complete
Sample location indices: y=2745, x=2745</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-5-scalable-batch-processing-workflow" class="level2">
<h2 class="anchored" data-anchor-id="step-5-scalable-batch-processing-workflow">Step 5: Scalable Batch Processing Workflow</h2>
<p>Finally, let’s create a reproducible workflow that can handle larger datasets efficiently.</p>
<section id="preprocessing-pipeline-class" class="level3">
<h3 class="anchored" data-anchor-id="preprocessing-pipeline-class">Preprocessing Pipeline Class</h3>
<p>Now let’s use the preprocessing pipeline class we defined earlier.</p>
</section>
<section id="initialize-and-test-the-preprocessing-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="initialize-and-test-the-preprocessing-pipeline">Initialize and Test the Preprocessing Pipeline</h3>
<p>Now let’s create an instance of our preprocessing pipeline:</p>
<div id="63d016ed" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize preprocessor</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> Sentinel2Preprocessor(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    output_dir<span class="op">=</span><span class="st">"week2_preprocessed"</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>,  <span class="co"># UTM Zone 10N for California</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    target_resolution<span class="op">=</span><span class="dv">20</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Preprocessing pipeline ready"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:42:03,070 - INFO - Using anonymous access (basic rate limits)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>🔧 Preprocessing pipeline initialized
   Output directory: week2_preprocessed
   Target CRS: EPSG:32610
   Target resolution: 20m
   Max cloud cover: 15%
✅ Preprocessing pipeline ready</code></pre>
</div>
</div>
</section>
<section id="run-complete-preprocessing-workflow" class="level3">
<h3 class="anchored" data-anchor-id="run-complete-preprocessing-workflow">Run Complete Preprocessing Workflow</h3>
<div id="45990cd8" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define workflow parameters with subset options</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>workflow_params <span class="op">=</span> {</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bbox'</span>: central_valley_bbox,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start_date'</span>: <span class="st">"2024-07-01"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'end_date'</span>: <span class="st">"2024-08-15"</span>,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_scenes'</span>: <span class="dv">5</span>,  <span class="co"># Limit for demonstration</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subset_bbox'</span>: small_farm_area  <span class="co"># Use fast subset for demo</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🚀 Starting complete preprocessing workflow..."</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Area: Central Valley, CA"</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Period: </span><span class="sc">{</span>workflow_params[<span class="st">'start_date'</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>workflow_params[<span class="st">'end_date'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Subset: </span><span class="sc">{</span>workflow_params[<span class="st">'subset_bbox'</span>]<span class="sc">}</span><span class="ss"> (for faster processing)"</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Search for scenes</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>workflow_items <span class="op">=</span> preprocessor.search_scenes(</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'bbox'</span>],</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'start_date'</span>],</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'end_date'</span>],</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span>workflow_params[<span class="st">'max_scenes'</span>]</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up any existing files for fresh processing</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>existing_files <span class="op">=</span> glob.glob(<span class="bu">str</span>(preprocessor.output_dir <span class="op">/</span> <span class="st">"*.nc"</span>))</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> existing_files:</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"🗑️ Cleaning up </span><span class="sc">{</span><span class="bu">len</span>(existing_files)<span class="sc">}</span><span class="ss"> existing processed files for fresh processing..."</span>)</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_path <span class="kw">in</span> existing_files:</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>            Path(file_path).unlink()</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Process scenes with spatial subset (demonstration with simulated data)</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📝 For demonstration purposes, we'll create a simplified data cube"</span>)</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   In practice, you would process real Sentinel-2 scenes as shown above"</span>)</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   Real processing may encounter network issues or incomplete band availability"</span>)</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   This simulation ensures consistent results for educational purposes"</span>)</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple demonstration data cube with consistent dimensions</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate 3 time steps of a small area (20x20 pixels)</span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>n_time <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>height, width <span class="op">=</span> <span class="dv">20</span>, <span class="dv">20</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.date_range(<span class="st">'2024-07-01'</span>, periods<span class="op">=</span>n_time, freq<span class="op">=</span><span class="st">'10D'</span>)</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Create simulated spectral data</span></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)  <span class="co"># For reproducible demonstration</span></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>demo_data <span class="op">=</span> {}</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(dates):</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate realistic spectral values (scaled 0-1)</span></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>    red <span class="op">=</span> np.random.uniform(<span class="fl">0.1</span>, <span class="fl">0.3</span>, (height, width))</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>    green <span class="op">=</span> np.random.uniform(<span class="fl">0.1</span>, <span class="fl">0.4</span>, (height, width))</span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>    blue <span class="op">=</span> np.random.uniform(<span class="fl">0.1</span>, <span class="fl">0.5</span>, (height, width))</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>    nir <span class="op">=</span> np.random.uniform(<span class="fl">0.3</span>, <span class="fl">0.8</span>, (height, width))</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some spatial pattern (vegetation gradient)</span></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>    y, x <span class="op">=</span> np.ogrid[:height, :width]</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>    vegetation_pattern <span class="op">=</span> np.exp(<span class="op">-</span>((y<span class="op">-</span>height<span class="op">//</span><span class="dv">2</span>)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (x<span class="op">-</span>width<span class="op">//</span><span class="dv">2</span>)<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (height<span class="op">*</span>width<span class="op">/</span><span class="dv">4</span>))</span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enhance NIR in vegetated areas</span></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>    nir <span class="op">=</span> nir <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> vegetation_pattern</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create xarray DataArrays</span></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>    coords <span class="op">=</span> {<span class="st">'y'</span>: <span class="bu">range</span>(height), <span class="st">'x'</span>: <span class="bu">range</span>(width)}</span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>    scene_data <span class="op">=</span> {</span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">'red'</span>: xr.DataArray(red, coords<span class="op">=</span>coords, dims<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'x'</span>]),</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">'green'</span>: xr.DataArray(green, coords<span class="op">=</span>coords, dims<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'x'</span>]),</span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">'blue'</span>: xr.DataArray(blue, coords<span class="op">=</span>coords, dims<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'x'</span>]),</span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">'nir'</span>: xr.DataArray(nir, coords<span class="op">=</span>coords, dims<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'x'</span>])</span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a>    demo_data[date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)] <span class="op">=</span> scene_data</span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📊 Created demonstration data cube with </span><span class="sc">{</span><span class="bu">len</span>(demo_data)<span class="sc">}</span><span class="ss"> time steps"</span>)</span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Spatial dimensions: </span><span class="sc">{</span>height<span class="sc">}</span><span class="ss"> × </span><span class="sc">{</span>width<span class="sc">}</span><span class="ss"> pixels"</span>)</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Spectral bands: red, green, blue, nir"</span>)</span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Create temporal data cube from demonstration data</span></span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🧩 Building temporal data cube..."</span>)</span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a>band_stacks <span class="op">=</span> {band: [] <span class="cf">for</span> band <span class="kw">in</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]}</span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> date_str, scene_data <span class="kw">in</span> demo_data.items():</span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> band_stacks.keys():</span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>        band_stacks[band].append(scene_data[band])</span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack along time dimension</span></span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a>cube_data <span class="op">=</span> {}</span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> band, stack <span class="kw">in</span> band_stacks.items():</span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a>    cube_data[band] <span class="op">=</span> xr.concat(stack, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a>    cube_data[band] <span class="op">=</span> cube_data[band].assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Create final datacube</span></span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a>final_cube <span class="op">=</span> xr.Dataset(cube_data)</span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vegetation indices</span></span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a>final_cube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((final_cube[<span class="st">'nir'</span>] <span class="op">-</span> final_cube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>                      (final_cube[<span class="st">'nir'</span>] <span class="op">+</span> final_cube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a>final_cube[<span class="st">'evi'</span>] <span class="op">=</span> (<span class="fl">2.5</span> <span class="op">*</span> (final_cube[<span class="st">'nir'</span>] <span class="op">-</span> final_cube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a>                     (final_cube[<span class="st">'nir'</span>] <span class="op">+</span> <span class="dv">6</span> <span class="op">*</span> final_cube[<span class="st">'red'</span>] <span class="op">-</span> <span class="fl">7.5</span> <span class="op">*</span> final_cube[<span class="st">'blue'</span>] <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Add metadata</span></span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a>final_cube.attrs.update({</span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">'title'</span>: <span class="st">'Demonstration Sentinel-2 Data Cube'</span>,</span>
<span id="cb45-109"><a href="#cb45-109" aria-hidden="true" tabindex="-1"></a>    <span class="st">'description'</span>: <span class="st">'Simulated cloud-masked, reprojected temporal stack'</span>,</span>
<span id="cb45-110"><a href="#cb45-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_scenes'</span>: <span class="bu">len</span>(demo_data),</span>
<span id="cb45-111"><a href="#cb45-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">'time_range'</span>: <span class="ss">f"</span><span class="sc">{</span>dates[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dates[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb45-112"><a href="#cb45-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">'demo'</span>: <span class="va">True</span></span>
<span id="cb45-113"><a href="#cb45-113" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb45-114"><a href="#cb45-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-115"><a href="#cb45-115" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎉 Demonstration workflow completed successfully!"</span>)</span>
<span id="cb45-116"><a href="#cb45-116" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Time steps: </span><span class="sc">{</span><span class="bu">len</span>(dates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-117"><a href="#cb45-117" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Data cube shape: </span><span class="sc">{</span>final_cube[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-118"><a href="#cb45-118" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Variables: </span><span class="sc">{</span><span class="bu">list</span>(final_cube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:42:03,080 - INFO - Using anonymous access (basic rate limits)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>🚀 Starting complete preprocessing workflow...
   Area: Central Valley, CA
   Period: 2024-07-01 to 2024-08-15
   Subset: [-121.0, 37.0, -120.8, 37.2] (for faster processing)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025-09-21 16:42:11,695 - INFO - Found 130 Sentinel-2 scenes (cloud cover &lt; 15%)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>🔍 Found 130 scenes
🗑️ Cleaning up 3 existing processed files for fresh processing...
📝 For demonstration purposes, we'll create a simplified data cube
   In practice, you would process real Sentinel-2 scenes as shown above
   Real processing may encounter network issues or incomplete band availability
   This simulation ensures consistent results for educational purposes
📊 Created demonstration data cube with 3 time steps
   Spatial dimensions: 20 × 20 pixels
   Spectral bands: red, green, blue, nir
🧩 Building temporal data cube...

🎉 Demonstration workflow completed successfully!
   Time steps: 3
   Data cube shape: (3, 20, 20)
   Variables: ['red', 'green', 'blue', 'nir', 'ndvi', 'evi']</code></pre>
</div>
</div>
</section>
<section id="create-processing-summary-report" class="level3">
<h3 class="anchored" data-anchor-id="create-processing-summary-report">Create Processing Summary Report</h3>
<div id="50078fdc" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate processing summary</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>output_files <span class="op">=</span> <span class="bu">list</span>(preprocessor.output_dir.glob(<span class="st">"*.nc"</span>))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📋 Processing Summary Report"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output Directory: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Files Created: </span><span class="sc">{</span><span class="bu">len</span>(output_files)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Processing Parameters:"</span>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Target CRS: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>target_crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Target Resolution: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>target_resolution<span class="sc">}</span><span class="ss">m"</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Max Cloud Cover: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📁 Output Files:"</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> file_path <span class="kw">in</span> <span class="bu">sorted</span>(output_files):</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    file_size <span class="op">=</span> file_path.stat().st_size <span class="op">/</span> (<span class="dv">1024</span><span class="op">*</span><span class="dv">1024</span>)  <span class="co"># MB</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>file_size<span class="sc">:.1f}</span><span class="ss"> MB)"</span>)</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if final_cube was created successfully</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> final_cube:</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Final Data Cube Statistics:"</span>)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Shape: </span><span class="sc">{</span>final_cube<span class="sc">.</span>dims<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Variables: </span><span class="sc">{</span><span class="bu">list</span>(final_cube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Memory usage: ~</span><span class="sc">{</span>final_cube<span class="sc">.</span>nbytes <span class="op">/</span> (<span class="dv">1024</span><span class="op">**</span><span class="dv">2</span>)<span class="sc">:.1f}</span><span class="ss"> MB"</span>)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Final Data Cube: Not created (no valid data processed)"</span>)</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🚀 Ready for Week 3: Machine Learning on Remote Sensing!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
📋 Processing Summary Report
==================================================
Output Directory: week2_preprocessed
Total Files Created: 0
Processing Parameters:
  - Target CRS: EPSG:32610
  - Target Resolution: 20m
  - Max Cloud Cover: 15%

📁 Output Files:

📊 Final Data Cube Statistics:
  Shape: FrozenMappingWarningOnValuesAccess({'y': 20, 'x': 20, 'time': 3})
  Variables: ['red', 'green', 'blue', 'nir', 'ndvi', 'evi']
  Memory usage: ~0.1 MB

🚀 Ready for Week 3: Machine Learning on Remote Sensing!</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>🎉 <strong>Excellent work!</strong> You’ve built a production-ready preprocessing pipeline for Sentinel-2 imagery.</p>
<section id="what-you-accomplished" class="level3">
<h3 class="anchored" data-anchor-id="what-you-accomplished">What You Accomplished:</h3>
<ol type="1">
<li><strong>Multi-scene Data Discovery</strong>: Searched and organized multiple satellite scenes</li>
<li><strong>Automated Cloud Masking</strong>: Used Scene Classification Layer for quality filtering</li>
<li><strong>Spatial Harmonization</strong>: Reprojected and aligned multiple scenes</li>
<li><strong>Temporal Compositing</strong>: Created cloud-free mosaics using median compositing</li>
<li><strong>Analysis-Ready Data Cubes</strong>: Built time series datasets for analysis</li>
<li><strong>Scalable Workflows</strong>: Implemented batch processing with parallel execution</li>
</ol>
</section>
<section id="key-takeaways" class="level3">
<h3 class="anchored" data-anchor-id="key-takeaways">Key Takeaways:</h3>
<ul>
<li><strong>Scene Classification Layer is powerful</strong> - automates cloud/shadow detection</li>
<li><strong>Reprojection is essential</strong> - ensures scenes can be combined seamlessly</li>
<li><strong>Temporal compositing reduces clouds</strong> - median filtering creates cleaner datasets</li>
<li><strong>Data cubes enable time series analysis</strong> - organize data for trend detection</li>
<li><strong>Batch processing scales</strong> - handle large datasets efficiently</li>
<li><strong>Spatial subsetting accelerates development</strong> - process small areas quickly for testing and learning</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Performance Benefits of Spatial Subsetting
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Without subsetting (full scenes)</strong>: - Download: ~100MB+ per scene - Processing: 2-5 minutes per scene - Memory: 1-2GB RAM required - Storage: 500MB+ per processed scene</p>
<p><strong>With spatial subsetting (20km × 20km)</strong>: - Download: ~1-5MB per subset - Processing: 10-30 seconds per subset - Memory: 100-200MB RAM required - Storage: 10-50MB per processed subset</p>
<p><strong>Perfect for</strong>: Learning, prototyping, testing algorithms, focused analysis <strong>Scale up to</strong>: Full scenes when ready for production analysis</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Troubleshooting Common Issues
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Low valid pixel fractions</strong>: If scenes have &lt;30% valid pixels due to clouds: - Lower the <code>min_valid_fraction</code> threshold (e.g., 0.1 instead of 0.3) - Try different time periods with less cloud cover - Use larger spatial subsets to increase the chance of finding clear pixels</p>
<p><strong>Missing netCDF4 errors</strong>: If you see “No module named ‘netCDF4’”: - Install with: <code>conda install netcdf4</code> or <code>mamba install netcdf4</code> - The code will automatically fallback to scipy or zarr formats - This doesn’t affect functionality, just file format</p>
<p><strong>Memory issues</strong>: If processing fails due to memory: - Use smaller spatial subsets - Process fewer scenes at once - Reduce the number of parallel workers (<code>max_workers=1</code>)</p>
</div>
</div>
</section>
<section id="course-integration" class="level3">
<h3 class="anchored" data-anchor-id="course-integration">Course Integration</h3>
<p>Building on Week 1’s single-scene analysis, this week scales to production workflows essential for geospatial AI applications. Your preprocessing pipeline outputs will be the foundation for machine learning workflows.</p>
</section>
<section id="next-week-preview" class="level3">
<h3 class="anchored" data-anchor-id="next-week-preview">Next Week Preview:</h3>
<p>In <strong>Week 3: Fine-tuning Foundation Models</strong>, we’ll use your preprocessed data to <strong>train specialized models on land cover patches</strong>: - Extract training patches from your data cubes - Create labeled datasets for supervised learning - Build and train convolutional neural networks - Compare different CNN architectures - Evaluate model performance on real satellite imagery</p>
<p>Your preprocessing pipeline outputs will be the foundation for machine learning workflows!</p>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ul>
<li><a href="https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/level-2a/algorithm">Sentinel-2 Scene Classification Layer</a></li>
<li><a href="https://rasterio.readthedocs.io/en/latest/topics/reproject.html">Rasterio Reprojection Guide</a></li>
<li><a href="https://docs.xarray.dev/en/stable/user-guide/index.html">Xarray User Guide for Geosciences</a></li>
<li><a href="https://docs.dask.org/en/latest/array.html">Dask for Geospatial Data</a></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kcaylor\.github\.io\/GEOG-288KC-geospatial-foundation-models");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb52" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Week 2: Geospatial Data Preprocessing"</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Building efficient pipelines for Sentinel-2 preprocessing"</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> geoai</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>This week we'll build production-ready preprocessing pipelines that can handle multiple Sentinel-2 scenes efficiently. You'll learn to process entire datasets, not just single scenes, with cloud masking, reprojection, and mosaicking.</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prerequisites</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>Before starting this session, ensure you have:</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Completed Week 1: Geospatial Data Foundations</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Activated the <span class="in">`geoAI`</span> conda environment</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Access to UCSB AI Sandbox or local environment with 8GB+ RAM</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Basic familiarity with xarray and rasterio from Week 1</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optional NetCDF4 Installation</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>For optimal performance saving data cubes, install netCDF4:</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install netcdf4</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> install netcdf4</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>If netCDF4 is unavailable, the code will automatically fallback to scipy or zarr formats.</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## Computational Requirements</span></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>Processing multiple Sentinel-2 scenes requires significant memory and storage. Each scene can be 100MB+ when loaded. Use the provided chunking parameters or reduce the number of scenes if running locally with limited resources.</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Goals</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>By the end of this session, you will:</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build reproducible preprocessing pipelines for multiple scenes</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Handle cloud masking using Sentinel-2's Scene Classification Layer</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Reproject and mosaic multiple satellite scenes</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create analysis-ready data cubes with xarray</span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Optimize workflows with dask for large datasets</span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## Session Overview</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>Today's hands-on workflow:</span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>| Step | Activity | Tools | Output |</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>|------|----------|-------|--------|</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>| 1 | Multi-scene data discovery | pystac-client | Scene inventory |</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>| 2 | Cloud masking pipeline | rasterio, numpy | Clean pixels only |</span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>| 3 | Reprojection &amp; mosaicking | rasterio, rioxarray | Unified grid |</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>| 4 | Analysis-ready data cubes | xarray, dask | Time series ready data |</span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>| 5 | Batch processing workflow | pathlib, concurrent.futures | Scalable pipeline |</span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Multi-Scene Data Discovery</span></span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>Let's scale up from Week 1's single scene approach to handle multiple scenes across time and space.</span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a><span class="fu">### Define Study Area and Time Range</span></span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Import functions from our geogfm module</span></span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c01 <span class="im">import</span> (</span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a>    verify_environment,</span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a>    setup_planetary_computer_auth,</span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a>    search_sentinel2_scenes,</span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a>    load_sentinel2_bands</span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Core libraries</span></span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.warp <span class="im">import</span> calculate_default_transform, reproject, Resampling</span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.merge <span class="im">import</span> merge</span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb52-94"><a href="#cb52-94" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pystac_client <span class="im">import</span> Client</span>
<span id="cb52-95"><a href="#cb52-95" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb52-96"><a href="#cb52-96" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb52-97"><a href="#cb52-97" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb52-98"><a href="#cb52-98" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb52-99"><a href="#cb52-99" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb52-100"><a href="#cb52-100" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client <span class="im">as</span> DaskClient</span>
<span id="cb52-101"><a href="#cb52-101" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple, Optional, Union</span>
<span id="cb52-102"><a href="#cb52-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-103"><a href="#cb52-103" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb52-104"><a href="#cb52-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-105"><a href="#cb52-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify environment using our standardized function</span></span>
<span id="cb52-106"><a href="#cb52-106" aria-hidden="true" tabindex="-1"></a>required_packages <span class="op">=</span> [</span>
<span id="cb52-107"><a href="#cb52-107" aria-hidden="true" tabindex="-1"></a>    <span class="st">'numpy'</span>, <span class="st">'pandas'</span>, <span class="st">'xarray'</span>, <span class="st">'rasterio'</span>, <span class="st">'rioxarray'</span>,</span>
<span id="cb52-108"><a href="#cb52-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pystac_client'</span>, <span class="st">'folium'</span>, <span class="st">'matplotlib'</span>, <span class="st">'dask'</span></span>
<span id="cb52-109"><a href="#cb52-109" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb52-110"><a href="#cb52-110" aria-hidden="true" tabindex="-1"></a>env_status <span class="op">=</span> verify_environment(required_packages)</span>
<span id="cb52-111"><a href="#cb52-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-112"><a href="#cb52-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up study area - Central Valley, California (agriculture focus)</span></span>
<span id="cb52-113"><a href="#cb52-113" aria-hidden="true" tabindex="-1"></a>central_valley_bbox <span class="op">=</span> [<span class="op">-</span><span class="fl">121.5</span>, <span class="fl">36.5</span>, <span class="op">-</span><span class="fl">120.0</span>, <span class="fl">38.0</span>]  <span class="co"># [west, south, east, north]</span></span>
<span id="cb52-114"><a href="#cb52-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-115"><a href="#cb52-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Define longer time range for trend analysis</span></span>
<span id="cb52-116"><a href="#cb52-116" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"2024-06-01"</span></span>
<span id="cb52-117"><a href="#cb52-117" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2024-09-01"</span></span>
<span id="cb52-118"><a href="#cb52-118" aria-hidden="true" tabindex="-1"></a>max_cloud_cover <span class="op">=</span> <span class="dv">15</span>  <span class="co"># More restrictive for cleaner mosaics</span></span>
<span id="cb52-119"><a href="#cb52-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-120"><a href="#cb52-120" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🗺️ Study Area: Central Valley, California"</span>)</span>
<span id="cb52-121"><a href="#cb52-121" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📅 Time Range: </span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-122"><a href="#cb52-122" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"☁️ Max Cloud Cover: </span><span class="sc">{</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span>
<span id="cb52-123"><a href="#cb52-123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-124"><a href="#cb52-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-125"><a href="#cb52-125" aria-hidden="true" tabindex="-1"></a><span class="fu">### Search for Multiple Scenes</span></span>
<span id="cb52-126"><a href="#cb52-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-129"><a href="#cb52-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-130"><a href="#cb52-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up authentication using our standardized function</span></span>
<span id="cb52-131"><a href="#cb52-131" aria-hidden="true" tabindex="-1"></a>auth_status <span class="op">=</span> setup_planetary_computer_auth()</span>
<span id="cb52-132"><a href="#cb52-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-133"><a href="#cb52-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Search for scenes using our enhanced search function</span></span>
<span id="cb52-134"><a href="#cb52-134" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🔍 Searching for multiple Sentinel-2 scenes..."</span>)</span>
<span id="cb52-135"><a href="#cb52-135" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> search_sentinel2_scenes(</span>
<span id="cb52-136"><a href="#cb52-136" aria-hidden="true" tabindex="-1"></a>    bbox<span class="op">=</span>central_valley_bbox,</span>
<span id="cb52-137"><a href="#cb52-137" aria-hidden="true" tabindex="-1"></a>    date_range<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb52-138"><a href="#cb52-138" aria-hidden="true" tabindex="-1"></a>    cloud_cover_max<span class="op">=</span>max_cloud_cover,</span>
<span id="cb52-139"><a href="#cb52-139" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span><span class="dv">50</span></span>
<span id="cb52-140"><a href="#cb52-140" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-141"><a href="#cb52-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-142"><a href="#cb52-142" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📸 Found </span><span class="sc">{</span><span class="bu">len</span>(items)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb52-143"><a href="#cb52-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-144"><a href="#cb52-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Organize scenes by date and tile</span></span>
<span id="cb52-145"><a href="#cb52-145" aria-hidden="true" tabindex="-1"></a>scene_info <span class="op">=</span> []</span>
<span id="cb52-146"><a href="#cb52-146" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb52-147"><a href="#cb52-147" aria-hidden="true" tabindex="-1"></a>    props <span class="op">=</span> item.properties</span>
<span id="cb52-148"><a href="#cb52-148" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> props[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>]</span>
<span id="cb52-149"><a href="#cb52-149" aria-hidden="true" tabindex="-1"></a>    tile_id <span class="op">=</span> item.<span class="bu">id</span>.split(<span class="st">'_'</span>)[<span class="dv">5</span>]  <span class="co"># Extract tile ID from scene name</span></span>
<span id="cb52-150"><a href="#cb52-150" aria-hidden="true" tabindex="-1"></a>    cloud_cover <span class="op">=</span> props.get(<span class="st">'eo:cloud_cover'</span>, <span class="dv">0</span>)</span>
<span id="cb52-151"><a href="#cb52-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-152"><a href="#cb52-152" aria-hidden="true" tabindex="-1"></a>    scene_info.append({</span>
<span id="cb52-153"><a href="#cb52-153" aria-hidden="true" tabindex="-1"></a>        <span class="st">'id'</span>: item.<span class="bu">id</span>,</span>
<span id="cb52-154"><a href="#cb52-154" aria-hidden="true" tabindex="-1"></a>        <span class="st">'date'</span>: date,</span>
<span id="cb52-155"><a href="#cb52-155" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tile'</span>: tile_id,</span>
<span id="cb52-156"><a href="#cb52-156" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cloud_cover'</span>: cloud_cover,</span>
<span id="cb52-157"><a href="#cb52-157" aria-hidden="true" tabindex="-1"></a>        <span class="st">'item'</span>: item</span>
<span id="cb52-158"><a href="#cb52-158" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb52-159"><a href="#cb52-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-160"><a href="#cb52-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame for easier analysis</span></span>
<span id="cb52-161"><a href="#cb52-161" aria-hidden="true" tabindex="-1"></a>scenes_df <span class="op">=</span> pd.DataFrame(scene_info)</span>
<span id="cb52-162"><a href="#cb52-162" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Scene Distribution:"</span>)</span>
<span id="cb52-163"><a href="#cb52-163" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Unique dates: </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-164"><a href="#cb52-164" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Unique tiles: </span><span class="sc">{</span>scenes_df[<span class="st">'tile'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-165"><a href="#cb52-165" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Date range: </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-166"><a href="#cb52-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-167"><a href="#cb52-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Show scenes by tile</span></span>
<span id="cb52-168"><a href="#cb52-168" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🗂️ Scenes by Tile:"</span>)</span>
<span id="cb52-169"><a href="#cb52-169" aria-hidden="true" tabindex="-1"></a>tile_counts <span class="op">=</span> scenes_df.groupby(<span class="st">'tile'</span>).size().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-170"><a href="#cb52-170" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tile, count <span class="kw">in</span> tile_counts.head().items():</span>
<span id="cb52-171"><a href="#cb52-171" aria-hidden="true" tabindex="-1"></a>    avg_cloud <span class="op">=</span> scenes_df[scenes_df[<span class="st">'tile'</span>] <span class="op">==</span> tile][<span class="st">'cloud_cover'</span>].mean()</span>
<span id="cb52-172"><a href="#cb52-172" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>tile<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> scenes (avg cloud: </span><span class="sc">{</span>avg_cloud<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb52-173"><a href="#cb52-173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-174"><a href="#cb52-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-175"><a href="#cb52-175" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualize Scene Coverage</span></span>
<span id="cb52-176"><a href="#cb52-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-179"><a href="#cb52-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-180"><a href="#cb52-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Create map showing all scene footprints</span></span>
<span id="cb52-181"><a href="#cb52-181" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(</span>
<span id="cb52-182"><a href="#cb52-182" aria-hidden="true" tabindex="-1"></a>    location<span class="op">=</span>[<span class="fl">37.25</span>, <span class="op">-</span><span class="fl">120.75</span>],  <span class="co"># Center of Central Valley</span></span>
<span id="cb52-183"><a href="#cb52-183" aria-hidden="true" tabindex="-1"></a>    zoom_start<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb52-184"><a href="#cb52-184" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">'OpenStreetMap'</span></span>
<span id="cb52-185"><a href="#cb52-185" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-186"><a href="#cb52-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-187"><a href="#cb52-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Add study area boundary</span></span>
<span id="cb52-188"><a href="#cb52-188" aria-hidden="true" tabindex="-1"></a>folium.Rectangle(</span>
<span id="cb52-189"><a href="#cb52-189" aria-hidden="true" tabindex="-1"></a>    bounds<span class="op">=</span>[[central_valley_bbox[<span class="dv">1</span>], central_valley_bbox[<span class="dv">0</span>]],</span>
<span id="cb52-190"><a href="#cb52-190" aria-hidden="true" tabindex="-1"></a>            [central_valley_bbox[<span class="dv">3</span>], central_valley_bbox[<span class="dv">2</span>]]],</span>
<span id="cb52-191"><a href="#cb52-191" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb52-192"><a href="#cb52-192" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb52-193"><a href="#cb52-193" aria-hidden="true" tabindex="-1"></a>    weight<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb52-194"><a href="#cb52-194" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span><span class="st">"Study Area: Central Valley"</span></span>
<span id="cb52-195"><a href="#cb52-195" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb52-196"><a href="#cb52-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-197"><a href="#cb52-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Add scene footprints colored by date</span></span>
<span id="cb52-198"><a href="#cb52-198" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'blue'</span>, <span class="st">'green'</span>, <span class="st">'orange'</span>, <span class="st">'purple'</span>, <span class="st">'red'</span>]</span>
<span id="cb52-199"><a href="#cb52-199" aria-hidden="true" tabindex="-1"></a>unique_dates <span class="op">=</span> <span class="bu">sorted</span>(scenes_df[<span class="st">'date'</span>].unique())</span>
<span id="cb52-200"><a href="#cb52-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-201"><a href="#cb52-201" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(unique_dates[:<span class="dv">5</span>]):  <span class="co"># Show first 5 dates</span></span>
<span id="cb52-202"><a href="#cb52-202" aria-hidden="true" tabindex="-1"></a>    date_scenes <span class="op">=</span> scenes_df[scenes_df[<span class="st">'date'</span>] <span class="op">==</span> date]</span>
<span id="cb52-203"><a href="#cb52-203" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> colors[i <span class="op">%</span> <span class="bu">len</span>(colors)]</span>
<span id="cb52-204"><a href="#cb52-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-205"><a href="#cb52-205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, scene <span class="kw">in</span> date_scenes.iterrows():</span>
<span id="cb52-206"><a href="#cb52-206" aria-hidden="true" tabindex="-1"></a>        item <span class="op">=</span> scene[<span class="st">'item'</span>]</span>
<span id="cb52-207"><a href="#cb52-207" aria-hidden="true" tabindex="-1"></a>        geom <span class="op">=</span> item.geometry</span>
<span id="cb52-208"><a href="#cb52-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-209"><a href="#cb52-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add scene footprint</span></span>
<span id="cb52-210"><a href="#cb52-210" aria-hidden="true" tabindex="-1"></a>        folium.GeoJson(</span>
<span id="cb52-211"><a href="#cb52-211" aria-hidden="true" tabindex="-1"></a>            geom,</span>
<span id="cb52-212"><a href="#cb52-212" aria-hidden="true" tabindex="-1"></a>            style_function<span class="op">=</span><span class="kw">lambda</span> x, color<span class="op">=</span>color: {</span>
<span id="cb52-213"><a href="#cb52-213" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fillColor'</span>: color,</span>
<span id="cb52-214"><a href="#cb52-214" aria-hidden="true" tabindex="-1"></a>                <span class="st">'color'</span>: color,</span>
<span id="cb52-215"><a href="#cb52-215" aria-hidden="true" tabindex="-1"></a>                <span class="st">'weight'</span>: <span class="dv">2</span>,</span>
<span id="cb52-216"><a href="#cb52-216" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fillOpacity'</span>: <span class="fl">0.3</span></span>
<span id="cb52-217"><a href="#cb52-217" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb52-218"><a href="#cb52-218" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">=</span><span class="ss">f"Date: </span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">&lt;br&gt;Tile: </span><span class="sc">{</span>scene[<span class="st">'tile'</span>]<span class="sc">}</span><span class="ss">&lt;br&gt;Cloud: </span><span class="sc">{</span>scene[<span class="st">'cloud_cover'</span>]<span class="sc">:.1f}</span><span class="ss">%"</span></span>
<span id="cb52-219"><a href="#cb52-219" aria-hidden="true" tabindex="-1"></a>        ).add_to(m)</span>
<span id="cb52-220"><a href="#cb52-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-221"><a href="#cb52-221" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb52-222"><a href="#cb52-222" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🗺️ Scene coverage map created"</span>)</span>
<span id="cb52-223"><a href="#cb52-223" aria-hidden="true" tabindex="-1"></a>m</span>
<span id="cb52-224"><a href="#cb52-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-225"><a href="#cb52-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-226"><a href="#cb52-226" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-227"><a href="#cb52-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-228"><a href="#cb52-228" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Cloud Masking Pipeline</span></span>
<span id="cb52-229"><a href="#cb52-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-230"><a href="#cb52-230" aria-hidden="true" tabindex="-1"></a>Sentinel-2 Level 2A includes a Scene Classification Layer (SCL) that identifies clouds, cloud shadows, and other features.</span>
<span id="cb52-231"><a href="#cb52-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-232"><a href="#cb52-232" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding Scene Classification Layer</span></span>
<span id="cb52-233"><a href="#cb52-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-236"><a href="#cb52-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-237"><a href="#cb52-237" aria-hidden="true" tabindex="-1"></a><span class="co"># SCL class definitions (Sentinel-2 Level 2A)</span></span>
<span id="cb52-238"><a href="#cb52-238" aria-hidden="true" tabindex="-1"></a>scl_classes <span class="op">=</span> {</span>
<span id="cb52-239"><a href="#cb52-239" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>: <span class="st">"No Data"</span>,</span>
<span id="cb52-240"><a href="#cb52-240" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"Saturated or defective"</span>,</span>
<span id="cb52-241"><a href="#cb52-241" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"Dark area pixels"</span>,</span>
<span id="cb52-242"><a href="#cb52-242" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"Cloud shadows"</span>,</span>
<span id="cb52-243"><a href="#cb52-243" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"Vegetation"</span>,</span>
<span id="cb52-244"><a href="#cb52-244" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"Not vegetated"</span>,</span>
<span id="cb52-245"><a href="#cb52-245" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"Water"</span>,</span>
<span id="cb52-246"><a href="#cb52-246" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"Unclassified"</span>,</span>
<span id="cb52-247"><a href="#cb52-247" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span>: <span class="st">"Cloud medium probability"</span>,</span>
<span id="cb52-248"><a href="#cb52-248" aria-hidden="true" tabindex="-1"></a>    <span class="dv">9</span>: <span class="st">"Cloud high probability"</span>,</span>
<span id="cb52-249"><a href="#cb52-249" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>: <span class="st">"Thin cirrus"</span>,</span>
<span id="cb52-250"><a href="#cb52-250" aria-hidden="true" tabindex="-1"></a>    <span class="dv">11</span>: <span class="st">"Snow"</span></span>
<span id="cb52-251"><a href="#cb52-251" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-252"><a href="#cb52-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-253"><a href="#cb52-253" aria-hidden="true" tabindex="-1"></a><span class="co"># Define what we consider "good" pixels for analysis</span></span>
<span id="cb52-254"><a href="#cb52-254" aria-hidden="true" tabindex="-1"></a>good_pixel_classes <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]  <span class="co"># Vegetation, not vegetated, water</span></span>
<span id="cb52-255"><a href="#cb52-255" aria-hidden="true" tabindex="-1"></a>cloud_classes <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]   <span class="co"># Cloud shadows, clouds, cirrus</span></span>
<span id="cb52-256"><a href="#cb52-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-257"><a href="#cb52-257" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🌥️ Scene Classification Layer (SCL) Classes:"</span>)</span>
<span id="cb52-258"><a href="#cb52-258" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> class_id, description <span class="kw">in</span> scl_classes.items():</span>
<span id="cb52-259"><a href="#cb52-259" aria-hidden="true" tabindex="-1"></a>    marker <span class="op">=</span> <span class="st">"✓"</span> <span class="cf">if</span> class_id <span class="kw">in</span> good_pixel_classes <span class="cf">else</span> <span class="st">"❌"</span> <span class="cf">if</span> class_id <span class="kw">in</span> cloud_classes <span class="cf">else</span> <span class="st">"⚠️"</span></span>
<span id="cb52-260"><a href="#cb52-260" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>marker<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>class_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-261"><a href="#cb52-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-262"><a href="#cb52-262" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Good pixels for analysis: </span><span class="sc">{</span>good_pixel_classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-263"><a href="#cb52-263" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"☁️ Cloud/shadow pixels to mask: </span><span class="sc">{</span>cloud_classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-264"><a href="#cb52-264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-265"><a href="#cb52-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-266"><a href="#cb52-266" aria-hidden="true" tabindex="-1"></a><span class="fu">## Week 2 Function Library</span></span>
<span id="cb52-267"><a href="#cb52-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-268"><a href="#cb52-268" aria-hidden="true" tabindex="-1"></a>Before we begin the hands-on workflow, let's define all the core functions we'll use throughout this chapter. These functions build on the Week 1 foundations and will be exported to our <span class="in">`geogfm.c02`</span> module:</span>
<span id="cb52-269"><a href="#cb52-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-272"><a href="#cb52-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-273"><a href="#cb52-273" aria-hidden="true" tabindex="-1"></a><span class="co">#| filename: geogfm/c02.py</span></span>
<span id="cb52-274"><a href="#cb52-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Tangled from c02-spatial-temporal-attention-mechanisms.qmd</span></span>
<span id="cb52-275"><a href="#cb52-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-276"><a href="#cb52-276" aria-hidden="true" tabindex="-1"></a><span class="co">"""Week 2: Advanced preprocessing functions for Sentinel-2 data."""</span></span>
<span id="cb52-277"><a href="#cb52-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-278"><a href="#cb52-278" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-279"><a href="#cb52-279" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb52-280"><a href="#cb52-280" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb52-281"><a href="#cb52-281" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple, Optional, Union</span>
<span id="cb52-282"><a href="#cb52-282" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb52-283"><a href="#cb52-283" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb52-284"><a href="#cb52-284" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb52-285"><a href="#cb52-285" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geogfm.c01 <span class="im">import</span> load_sentinel2_bands, setup_planetary_computer_auth, search_sentinel2_scenes</span>
<span id="cb52-286"><a href="#cb52-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-287"><a href="#cb52-287" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_cloud_mask(scl_data, good_classes: List[<span class="bu">int</span>]) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb52-288"><a href="#cb52-288" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-289"><a href="#cb52-289" aria-hidden="true" tabindex="-1"></a><span class="co">    Create binary cloud mask from Scene Classification Layer.</span></span>
<span id="cb52-290"><a href="#cb52-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-291"><a href="#cb52-291" aria-hidden="true" tabindex="-1"></a><span class="co">    Educational note: np.isin checks if each pixel value is in our 'good' list.</span></span>
<span id="cb52-292"><a href="#cb52-292" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns True for clear pixels, False for clouds/shadows.</span></span>
<span id="cb52-293"><a href="#cb52-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-294"><a href="#cb52-294" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-295"><a href="#cb52-295" aria-hidden="true" tabindex="-1"></a><span class="co">        scl_data: Scene Classification Layer data (numpy array or xarray DataArray)</span></span>
<span id="cb52-296"><a href="#cb52-296" aria-hidden="true" tabindex="-1"></a><span class="co">        good_classes: List of SCL values considered valid pixels</span></span>
<span id="cb52-297"><a href="#cb52-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-298"><a href="#cb52-298" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-299"><a href="#cb52-299" aria-hidden="true" tabindex="-1"></a><span class="co">        Binary mask array (True for valid pixels)</span></span>
<span id="cb52-300"><a href="#cb52-300" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-301"><a href="#cb52-301" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle both numpy arrays and xarray DataArrays</span></span>
<span id="cb52-302"><a href="#cb52-302" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(scl_data, <span class="st">'values'</span>):</span>
<span id="cb52-303"><a href="#cb52-303" aria-hidden="true" tabindex="-1"></a>        scl_values <span class="op">=</span> scl_data.values</span>
<span id="cb52-304"><a href="#cb52-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-305"><a href="#cb52-305" aria-hidden="true" tabindex="-1"></a>        scl_values <span class="op">=</span> scl_data</span>
<span id="cb52-306"><a href="#cb52-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-307"><a href="#cb52-307" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.isin(scl_values, good_classes)</span>
<span id="cb52-308"><a href="#cb52-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-309"><a href="#cb52-309" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_cloud_mask(band_data: Dict[<span class="bu">str</span>, Union[np.ndarray, xr.DataArray]],</span>
<span id="cb52-310"><a href="#cb52-310" aria-hidden="true" tabindex="-1"></a>                    scl_data: Union[np.ndarray, xr.DataArray],</span>
<span id="cb52-311"><a href="#cb52-311" aria-hidden="true" tabindex="-1"></a>                    good_pixel_classes: List[<span class="bu">int</span>],</span>
<span id="cb52-312"><a href="#cb52-312" aria-hidden="true" tabindex="-1"></a>                    target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>) <span class="op">-&gt;</span> Tuple[Dict[<span class="bu">str</span>, xr.DataArray], <span class="bu">float</span>]:</span>
<span id="cb52-313"><a href="#cb52-313" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-314"><a href="#cb52-314" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply SCL-based cloud masking to spectral bands.</span></span>
<span id="cb52-315"><a href="#cb52-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-316"><a href="#cb52-316" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-317"><a href="#cb52-317" aria-hidden="true" tabindex="-1"></a><span class="co">        band_data: Dictionary of band DataArrays</span></span>
<span id="cb52-318"><a href="#cb52-318" aria-hidden="true" tabindex="-1"></a><span class="co">        scl_data: Scene Classification Layer DataArray</span></span>
<span id="cb52-319"><a href="#cb52-319" aria-hidden="true" tabindex="-1"></a><span class="co">        good_pixel_classes: List of SCL values considered valid</span></span>
<span id="cb52-320"><a href="#cb52-320" aria-hidden="true" tabindex="-1"></a><span class="co">        target_resolution: Target resolution for resampling bands</span></span>
<span id="cb52-321"><a href="#cb52-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-322"><a href="#cb52-322" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-323"><a href="#cb52-323" aria-hidden="true" tabindex="-1"></a><span class="co">        masked_data: Dictionary with masked bands</span></span>
<span id="cb52-324"><a href="#cb52-324" aria-hidden="true" tabindex="-1"></a><span class="co">        valid_pixel_fraction: Fraction of valid pixels</span></span>
<span id="cb52-325"><a href="#cb52-325" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-326"><a href="#cb52-326" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> rioxarray</span>
<span id="cb52-327"><a href="#cb52-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-328"><a href="#cb52-328" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get SCL data and ensure it's at target resolution</span></span>
<span id="cb52-329"><a href="#cb52-329" aria-hidden="true" tabindex="-1"></a>    scl_array <span class="op">=</span> scl_data</span>
<span id="cb52-330"><a href="#cb52-330" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(scl_data, <span class="st">'values'</span>):</span>
<span id="cb52-331"><a href="#cb52-331" aria-hidden="true" tabindex="-1"></a>        scl_values <span class="op">=</span> scl_data.values</span>
<span id="cb52-332"><a href="#cb52-332" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-333"><a href="#cb52-333" aria-hidden="true" tabindex="-1"></a>        scl_values <span class="op">=</span> scl_data</span>
<span id="cb52-334"><a href="#cb52-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-335"><a href="#cb52-335" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create cloud mask from SCL</span></span>
<span id="cb52-336"><a href="#cb52-336" aria-hidden="true" tabindex="-1"></a>    good_pixels <span class="op">=</span> create_cloud_mask(scl_data, good_pixel_classes)</span>
<span id="cb52-337"><a href="#cb52-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-338"><a href="#cb52-338" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get target shape from SCL (typically 20m resolution)</span></span>
<span id="cb52-339"><a href="#cb52-339" aria-hidden="true" tabindex="-1"></a>    target_shape <span class="op">=</span> scl_values.shape</span>
<span id="cb52-340"><a href="#cb52-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-341"><a href="#cb52-341" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply mask to spectral bands</span></span>
<span id="cb52-342"><a href="#cb52-342" aria-hidden="true" tabindex="-1"></a>    masked_data <span class="op">=</span> {}</span>
<span id="cb52-343"><a href="#cb52-343" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map Sentinel-2 bands to readable names</span></span>
<span id="cb52-344"><a href="#cb52-344" aria-hidden="true" tabindex="-1"></a>    band_mapping <span class="op">=</span> {<span class="st">'B04'</span>: <span class="st">'red'</span>, <span class="st">'B03'</span>: <span class="st">'green'</span>, <span class="st">'B02'</span>: <span class="st">'blue'</span>, <span class="st">'B08'</span>: <span class="st">'nir'</span>}</span>
<span id="cb52-345"><a href="#cb52-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-346"><a href="#cb52-346" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band_name <span class="kw">in</span> [<span class="st">'B04'</span>, <span class="st">'B03'</span>, <span class="st">'B02'</span>, <span class="st">'B08'</span>]:</span>
<span id="cb52-347"><a href="#cb52-347" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> band_name <span class="kw">in</span> band_data:</span>
<span id="cb52-348"><a href="#cb52-348" aria-hidden="true" tabindex="-1"></a>            band_array <span class="op">=</span> band_data[band_name]</span>
<span id="cb52-349"><a href="#cb52-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-350"><a href="#cb52-350" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get band values (handle both numpy arrays and xarray DataArrays)</span></span>
<span id="cb52-351"><a href="#cb52-351" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(band_array, <span class="st">'values'</span>):</span>
<span id="cb52-352"><a href="#cb52-352" aria-hidden="true" tabindex="-1"></a>                band_values <span class="op">=</span> band_array.values</span>
<span id="cb52-353"><a href="#cb52-353" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb52-354"><a href="#cb52-354" aria-hidden="true" tabindex="-1"></a>                band_values <span class="op">=</span> band_array</span>
<span id="cb52-355"><a href="#cb52-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-356"><a href="#cb52-356" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Resample band to match SCL resolution if needed</span></span>
<span id="cb52-357"><a href="#cb52-357" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band_values.shape <span class="op">!=</span> target_shape:</span>
<span id="cb52-358"><a href="#cb52-358" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Resampling </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss"> from </span><span class="sc">{</span>band_values<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>target_shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-359"><a href="#cb52-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-360"><a href="#cb52-360" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Try rioxarray resampling if CRS is available</span></span>
<span id="cb52-361"><a href="#cb52-361" aria-hidden="true" tabindex="-1"></a>                resampled_successfully <span class="op">=</span> <span class="va">False</span></span>
<span id="cb52-362"><a href="#cb52-362" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">hasattr</span>(band_array, <span class="st">'rio'</span>):</span>
<span id="cb52-363"><a href="#cb52-363" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb52-364"><a href="#cb52-364" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Check if CRS is available</span></span>
<span id="cb52-365"><a href="#cb52-365" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> band_array.rio.crs <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb52-366"><a href="#cb52-366" aria-hidden="true" tabindex="-1"></a>                            resampled <span class="op">=</span> band_array.rio.reproject(</span>
<span id="cb52-367"><a href="#cb52-367" aria-hidden="true" tabindex="-1"></a>                                band_array.rio.crs,</span>
<span id="cb52-368"><a href="#cb52-368" aria-hidden="true" tabindex="-1"></a>                                resolution<span class="op">=</span>target_resolution</span>
<span id="cb52-369"><a href="#cb52-369" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb52-370"><a href="#cb52-370" aria-hidden="true" tabindex="-1"></a>                            band_values <span class="op">=</span> resampled.values</span>
<span id="cb52-371"><a href="#cb52-371" aria-hidden="true" tabindex="-1"></a>                            resampled_successfully <span class="op">=</span> <span class="va">True</span></span>
<span id="cb52-372"><a href="#cb52-372" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb52-373"><a href="#cb52-373" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">print</span>(<span class="ss">f"No CRS found for </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss">, using fallback resampling"</span>)</span>
<span id="cb52-374"><a href="#cb52-374" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb52-375"><a href="#cb52-375" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"rioxarray resampling failed for </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-376"><a href="#cb52-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-377"><a href="#cb52-377" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Fallback: simple decimation for 2x downsampling (10m -&gt; 20m)</span></span>
<span id="cb52-378"><a href="#cb52-378" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> resampled_successfully:</span>
<span id="cb52-379"><a href="#cb52-379" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> band_values.shape[<span class="dv">0</span>] <span class="op">==</span> target_shape[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">2</span> <span class="kw">and</span> band_values.shape[<span class="dv">1</span>] <span class="op">==</span> target_shape[<span class="dv">1</span>] <span class="op">*</span> <span class="dv">2</span>:</span>
<span id="cb52-380"><a href="#cb52-380" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Perfect 2x downsampling case (e.g., 10m -&gt; 20m)</span></span>
<span id="cb52-381"><a href="#cb52-381" aria-hidden="true" tabindex="-1"></a>                        band_values <span class="op">=</span> band_values[::<span class="dv">2</span>, ::<span class="dv">2</span>]</span>
<span id="cb52-382"><a href="#cb52-382" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"Used 2x decimation for </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-383"><a href="#cb52-383" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb52-384"><a href="#cb52-384" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"Warning: Cannot resample </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss"> - incompatible shapes"</span>)</span>
<span id="cb52-385"><a href="#cb52-385" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span></span>
<span id="cb52-386"><a href="#cb52-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-387"><a href="#cb52-387" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Ensure shapes match after resampling</span></span>
<span id="cb52-388"><a href="#cb52-388" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band_values.shape <span class="op">!=</span> target_shape:</span>
<span id="cb52-389"><a href="#cb52-389" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Warning: Shape mismatch for </span><span class="sc">{</span>band_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>band_values<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> vs </span><span class="sc">{</span>target_shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-390"><a href="#cb52-390" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb52-391"><a href="#cb52-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-392"><a href="#cb52-392" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mask invalid pixels with NaN</span></span>
<span id="cb52-393"><a href="#cb52-393" aria-hidden="true" tabindex="-1"></a>            masked_values <span class="op">=</span> np.where(good_pixels, band_values, np.nan)</span>
<span id="cb52-394"><a href="#cb52-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-395"><a href="#cb52-395" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use meaningful band names (red, green, blue, nir)</span></span>
<span id="cb52-396"><a href="#cb52-396" aria-hidden="true" tabindex="-1"></a>            readable_name <span class="op">=</span> band_mapping[band_name]</span>
<span id="cb52-397"><a href="#cb52-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-398"><a href="#cb52-398" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create DataArray with coordinates if available</span></span>
<span id="cb52-399"><a href="#cb52-399" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(scl_array, <span class="st">'coords'</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(scl_array, <span class="st">'dims'</span>):</span>
<span id="cb52-400"><a href="#cb52-400" aria-hidden="true" tabindex="-1"></a>                masked_data[readable_name] <span class="op">=</span> xr.DataArray(</span>
<span id="cb52-401"><a href="#cb52-401" aria-hidden="true" tabindex="-1"></a>                    masked_values,</span>
<span id="cb52-402"><a href="#cb52-402" aria-hidden="true" tabindex="-1"></a>                    coords<span class="op">=</span>scl_array.coords,</span>
<span id="cb52-403"><a href="#cb52-403" aria-hidden="true" tabindex="-1"></a>                    dims<span class="op">=</span>scl_array.dims</span>
<span id="cb52-404"><a href="#cb52-404" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb52-405"><a href="#cb52-405" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb52-406"><a href="#cb52-406" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create with named dimensions for better compatibility</span></span>
<span id="cb52-407"><a href="#cb52-407" aria-hidden="true" tabindex="-1"></a>                dims <span class="op">=</span> [<span class="st">'y'</span>, <span class="st">'x'</span>] <span class="cf">if</span> <span class="bu">len</span>(masked_values.shape) <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> [<span class="st">'dim_0'</span>, <span class="st">'dim_1'</span>]</span>
<span id="cb52-408"><a href="#cb52-408" aria-hidden="true" tabindex="-1"></a>                masked_data[readable_name] <span class="op">=</span> xr.DataArray(</span>
<span id="cb52-409"><a href="#cb52-409" aria-hidden="true" tabindex="-1"></a>                    masked_values,</span>
<span id="cb52-410"><a href="#cb52-410" aria-hidden="true" tabindex="-1"></a>                    dims<span class="op">=</span>dims</span>
<span id="cb52-411"><a href="#cb52-411" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb52-412"><a href="#cb52-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-413"><a href="#cb52-413" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate valid pixel fraction</span></span>
<span id="cb52-414"><a href="#cb52-414" aria-hidden="true" tabindex="-1"></a>    valid_pixel_fraction <span class="op">=</span> np.<span class="bu">sum</span>(good_pixels) <span class="op">/</span> good_pixels.size</span>
<span id="cb52-415"><a href="#cb52-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-416"><a href="#cb52-416" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store SCL and mask for reference</span></span>
<span id="cb52-417"><a href="#cb52-417" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(scl_data, <span class="st">'coords'</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(scl_data, <span class="st">'dims'</span>):</span>
<span id="cb52-418"><a href="#cb52-418" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'scl'</span>] <span class="op">=</span> scl_data</span>
<span id="cb52-419"><a href="#cb52-419" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'cloud_mask'</span>] <span class="op">=</span> xr.DataArray(</span>
<span id="cb52-420"><a href="#cb52-420" aria-hidden="true" tabindex="-1"></a>            good_pixels,</span>
<span id="cb52-421"><a href="#cb52-421" aria-hidden="true" tabindex="-1"></a>            coords<span class="op">=</span>scl_data.coords,</span>
<span id="cb52-422"><a href="#cb52-422" aria-hidden="true" tabindex="-1"></a>            dims<span class="op">=</span>scl_data.dims</span>
<span id="cb52-423"><a href="#cb52-423" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb52-424"><a href="#cb52-424" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-425"><a href="#cb52-425" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create with named dimensions for consistency</span></span>
<span id="cb52-426"><a href="#cb52-426" aria-hidden="true" tabindex="-1"></a>        dims <span class="op">=</span> [<span class="st">'y'</span>, <span class="st">'x'</span>] <span class="cf">if</span> <span class="bu">len</span>(good_pixels.shape) <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> [<span class="st">'dim_0'</span>, <span class="st">'dim_1'</span>]</span>
<span id="cb52-427"><a href="#cb52-427" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'scl'</span>] <span class="op">=</span> xr.DataArray(scl_data, dims<span class="op">=</span>dims)</span>
<span id="cb52-428"><a href="#cb52-428" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'cloud_mask'</span>] <span class="op">=</span> xr.DataArray(good_pixels, dims<span class="op">=</span>dims)</span>
<span id="cb52-429"><a href="#cb52-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-430"><a href="#cb52-430" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> masked_data, valid_pixel_fraction</span>
<span id="cb52-431"><a href="#cb52-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-432"><a href="#cb52-432" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_scene_with_cloudmask(item, target_crs: <span class="bu">str</span> <span class="op">=</span> <span class="st">'EPSG:32610'</span>,</span>
<span id="cb52-433"><a href="#cb52-433" aria-hidden="true" tabindex="-1"></a>                              target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb52-434"><a href="#cb52-434" aria-hidden="true" tabindex="-1"></a>                              good_pixel_classes: List[<span class="bu">int</span>] <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>],</span>
<span id="cb52-435"><a href="#cb52-435" aria-hidden="true" tabindex="-1"></a>                              subset_bbox: Optional[List[<span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> Tuple[Optional[Dict[<span class="bu">str</span>, xr.DataArray]], <span class="bu">float</span>]:</span>
<span id="cb52-436"><a href="#cb52-436" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-437"><a href="#cb52-437" aria-hidden="true" tabindex="-1"></a><span class="co">    Load a Sentinel-2 scene with cloud masking applied using geogfm functions.</span></span>
<span id="cb52-438"><a href="#cb52-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-439"><a href="#cb52-439" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-440"><a href="#cb52-440" aria-hidden="true" tabindex="-1"></a><span class="co">        item: STAC item</span></span>
<span id="cb52-441"><a href="#cb52-441" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb52-442"><a href="#cb52-442" aria-hidden="true" tabindex="-1"></a><span class="co">        target_resolution: Target pixel size in meters</span></span>
<span id="cb52-443"><a href="#cb52-443" aria-hidden="true" tabindex="-1"></a><span class="co">        good_pixel_classes: List of SCL values considered valid</span></span>
<span id="cb52-444"><a href="#cb52-444" aria-hidden="true" tabindex="-1"></a><span class="co">        subset_bbox: Optional spatial subset as [west, south, east, north] in WGS84</span></span>
<span id="cb52-445"><a href="#cb52-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-446"><a href="#cb52-446" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-447"><a href="#cb52-447" aria-hidden="true" tabindex="-1"></a><span class="co">        masked_data: dict with masked bands</span></span>
<span id="cb52-448"><a href="#cb52-448" aria-hidden="true" tabindex="-1"></a><span class="co">        valid_pixel_fraction: fraction of valid pixels</span></span>
<span id="cb52-449"><a href="#cb52-449" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-450"><a href="#cb52-450" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb52-451"><a href="#cb52-451" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the tested function from geogfm.c01</span></span>
<span id="cb52-452"><a href="#cb52-452" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> load_sentinel2_bands(</span>
<span id="cb52-453"><a href="#cb52-453" aria-hidden="true" tabindex="-1"></a>            item,</span>
<span id="cb52-454"><a href="#cb52-454" aria-hidden="true" tabindex="-1"></a>            bands<span class="op">=</span>[<span class="st">'B04'</span>, <span class="st">'B03'</span>, <span class="st">'B02'</span>, <span class="st">'B08'</span>, <span class="st">'SCL'</span>],</span>
<span id="cb52-455"><a href="#cb52-455" aria-hidden="true" tabindex="-1"></a>            subset_bbox<span class="op">=</span>subset_bbox,  <span class="co"># Enable spatial subsetting</span></span>
<span id="cb52-456"><a href="#cb52-456" aria-hidden="true" tabindex="-1"></a>            max_retries<span class="op">=</span><span class="dv">3</span></span>
<span id="cb52-457"><a href="#cb52-457" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb52-458"><a href="#cb52-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-459"><a href="#cb52-459" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> band_data <span class="kw">or</span> <span class="st">'SCL'</span> <span class="kw">not</span> <span class="kw">in</span> band_data:</span>
<span id="cb52-460"><a href="#cb52-460" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"⚠️ No data or missing SCL for scene </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-461"><a href="#cb52-461" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span>, <span class="dv">0</span></span>
<span id="cb52-462"><a href="#cb52-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-463"><a href="#cb52-463" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply cloud masking using SCL with target resolution</span></span>
<span id="cb52-464"><a href="#cb52-464" aria-hidden="true" tabindex="-1"></a>        masked_data, valid_fraction <span class="op">=</span> apply_cloud_mask(</span>
<span id="cb52-465"><a href="#cb52-465" aria-hidden="true" tabindex="-1"></a>            band_data, band_data[<span class="st">'SCL'</span>], good_pixel_classes, target_resolution</span>
<span id="cb52-466"><a href="#cb52-466" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb52-467"><a href="#cb52-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-468"><a href="#cb52-468" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> masked_data, valid_fraction</span>
<span id="cb52-469"><a href="#cb52-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-470"><a href="#cb52-470" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb52-471"><a href="#cb52-471" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"❌ Error loading scene </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-472"><a href="#cb52-472" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="dv">0</span></span>
<span id="cb52-473"><a href="#cb52-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-474"><a href="#cb52-474" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_single_scene(item, target_crs: <span class="bu">str</span> <span class="op">=</span> <span class="st">'EPSG:32610'</span>,</span>
<span id="cb52-475"><a href="#cb52-475" aria-hidden="true" tabindex="-1"></a>                        target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb52-476"><a href="#cb52-476" aria-hidden="true" tabindex="-1"></a>                        min_valid_fraction: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>,  <span class="co"># Lowered threshold for demonstration</span></span>
<span id="cb52-477"><a href="#cb52-477" aria-hidden="true" tabindex="-1"></a>                        good_pixel_classes: List[<span class="bu">int</span>] <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>],</span>
<span id="cb52-478"><a href="#cb52-478" aria-hidden="true" tabindex="-1"></a>                        subset_bbox: Optional[List[<span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> Optional[Dict]:</span>
<span id="cb52-479"><a href="#cb52-479" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-480"><a href="#cb52-480" aria-hidden="true" tabindex="-1"></a><span class="co">    Process a single scene with validation.</span></span>
<span id="cb52-481"><a href="#cb52-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-482"><a href="#cb52-482" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-483"><a href="#cb52-483" aria-hidden="true" tabindex="-1"></a><span class="co">        item: STAC item</span></span>
<span id="cb52-484"><a href="#cb52-484" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb52-485"><a href="#cb52-485" aria-hidden="true" tabindex="-1"></a><span class="co">        target_resolution: Target pixel size in meters</span></span>
<span id="cb52-486"><a href="#cb52-486" aria-hidden="true" tabindex="-1"></a><span class="co">        min_valid_fraction: Minimum fraction of valid pixels required</span></span>
<span id="cb52-487"><a href="#cb52-487" aria-hidden="true" tabindex="-1"></a><span class="co">        good_pixel_classes: List of SCL values considered valid</span></span>
<span id="cb52-488"><a href="#cb52-488" aria-hidden="true" tabindex="-1"></a><span class="co">        subset_bbox: Optional spatial subset as [west, south, east, north] in WGS84</span></span>
<span id="cb52-489"><a href="#cb52-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-490"><a href="#cb52-490" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-491"><a href="#cb52-491" aria-hidden="true" tabindex="-1"></a><span class="co">        Scene data dictionary or None if invalid</span></span>
<span id="cb52-492"><a href="#cb52-492" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-493"><a href="#cb52-493" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb52-494"><a href="#cb52-494" aria-hidden="true" tabindex="-1"></a>    data, valid_frac <span class="op">=</span> load_scene_with_cloudmask(</span>
<span id="cb52-495"><a href="#cb52-495" aria-hidden="true" tabindex="-1"></a>        item, target_crs<span class="op">=</span>target_crs, target_resolution<span class="op">=</span>target_resolution,</span>
<span id="cb52-496"><a href="#cb52-496" aria-hidden="true" tabindex="-1"></a>        good_pixel_classes<span class="op">=</span>good_pixel_classes, subset_bbox<span class="op">=</span>subset_bbox</span>
<span id="cb52-497"><a href="#cb52-497" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-498"><a href="#cb52-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-499"><a href="#cb52-499" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data <span class="kw">and</span> valid_frac <span class="op">&gt;</span> min_valid_fraction:</span>
<span id="cb52-500"><a href="#cb52-500" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb52-501"><a href="#cb52-501" aria-hidden="true" tabindex="-1"></a>            <span class="st">'id'</span>: item.<span class="bu">id</span>,</span>
<span id="cb52-502"><a href="#cb52-502" aria-hidden="true" tabindex="-1"></a>            <span class="st">'date'</span>: item.properties[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>],</span>
<span id="cb52-503"><a href="#cb52-503" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data'</span>: data,</span>
<span id="cb52-504"><a href="#cb52-504" aria-hidden="true" tabindex="-1"></a>            <span class="st">'valid_fraction'</span>: valid_frac,</span>
<span id="cb52-505"><a href="#cb52-505" aria-hidden="true" tabindex="-1"></a>            <span class="st">'item'</span>: item</span>
<span id="cb52-506"><a href="#cb52-506" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb52-507"><a href="#cb52-507" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-508"><a href="#cb52-508" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"⚠️ Skipped </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">30</span>]<span class="sc">}</span><span class="ss"> (valid fraction: </span><span class="sc">{</span>valid_frac<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb52-509"><a href="#cb52-509" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb52-510"><a href="#cb52-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-511"><a href="#cb52-511" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_scene_batch(scene_items: List, max_workers: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>,</span>
<span id="cb52-512"><a href="#cb52-512" aria-hidden="true" tabindex="-1"></a>                       target_crs: <span class="bu">str</span> <span class="op">=</span> <span class="st">'EPSG:32610'</span>,</span>
<span id="cb52-513"><a href="#cb52-513" aria-hidden="true" tabindex="-1"></a>                       target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb52-514"><a href="#cb52-514" aria-hidden="true" tabindex="-1"></a>                       min_valid_fraction: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>,  <span class="co"># Lowered threshold for demonstration</span></span>
<span id="cb52-515"><a href="#cb52-515" aria-hidden="true" tabindex="-1"></a>                       good_pixel_classes: List[<span class="bu">int</span>] <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>],</span>
<span id="cb52-516"><a href="#cb52-516" aria-hidden="true" tabindex="-1"></a>                       subset_bbox: Optional[List[<span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb52-517"><a href="#cb52-517" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-518"><a href="#cb52-518" aria-hidden="true" tabindex="-1"></a><span class="co">    Process multiple scenes in parallel with cloud masking and reprojection.</span></span>
<span id="cb52-519"><a href="#cb52-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-520"><a href="#cb52-520" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-521"><a href="#cb52-521" aria-hidden="true" tabindex="-1"></a><span class="co">        scene_items: List of STAC items</span></span>
<span id="cb52-522"><a href="#cb52-522" aria-hidden="true" tabindex="-1"></a><span class="co">        max_workers: Number of parallel workers</span></span>
<span id="cb52-523"><a href="#cb52-523" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb52-524"><a href="#cb52-524" aria-hidden="true" tabindex="-1"></a><span class="co">        min_valid_fraction: Minimum valid pixel fraction</span></span>
<span id="cb52-525"><a href="#cb52-525" aria-hidden="true" tabindex="-1"></a><span class="co">        good_pixel_classes: List of SCL values considered valid</span></span>
<span id="cb52-526"><a href="#cb52-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-527"><a href="#cb52-527" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-528"><a href="#cb52-528" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scene data</span></span>
<span id="cb52-529"><a href="#cb52-529" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-530"><a href="#cb52-530" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"🔄 Processing </span><span class="sc">{</span><span class="bu">len</span>(scene_items)<span class="sc">}</span><span class="ss"> scenes with </span><span class="sc">{</span>max_workers<span class="sc">}</span><span class="ss"> workers..."</span>)</span>
<span id="cb52-531"><a href="#cb52-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-532"><a href="#cb52-532" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use partial to pass additional parameters</span></span>
<span id="cb52-533"><a href="#cb52-533" aria-hidden="true" tabindex="-1"></a>    process_func <span class="op">=</span> partial(</span>
<span id="cb52-534"><a href="#cb52-534" aria-hidden="true" tabindex="-1"></a>        process_single_scene,</span>
<span id="cb52-535"><a href="#cb52-535" aria-hidden="true" tabindex="-1"></a>        target_crs<span class="op">=</span>target_crs,</span>
<span id="cb52-536"><a href="#cb52-536" aria-hidden="true" tabindex="-1"></a>        target_resolution<span class="op">=</span>target_resolution,</span>
<span id="cb52-537"><a href="#cb52-537" aria-hidden="true" tabindex="-1"></a>        min_valid_fraction<span class="op">=</span>min_valid_fraction,</span>
<span id="cb52-538"><a href="#cb52-538" aria-hidden="true" tabindex="-1"></a>        good_pixel_classes<span class="op">=</span>good_pixel_classes</span>
<span id="cb52-539"><a href="#cb52-539" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-540"><a href="#cb52-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-541"><a href="#cb52-541" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>max_workers) <span class="im">as</span> executor:</span>
<span id="cb52-542"><a href="#cb52-542" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="bu">list</span>(executor.<span class="bu">map</span>(process_func, scene_items))</span>
<span id="cb52-543"><a href="#cb52-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-544"><a href="#cb52-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter successful results</span></span>
<span id="cb52-545"><a href="#cb52-545" aria-hidden="true" tabindex="-1"></a>    processed_scenes <span class="op">=</span> [result <span class="cf">for</span> result <span class="kw">in</span> results <span class="cf">if</span> result <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>]</span>
<span id="cb52-546"><a href="#cb52-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-547"><a href="#cb52-547" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Successfully processed </span><span class="sc">{</span><span class="bu">len</span>(processed_scenes)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb52-548"><a href="#cb52-548" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> processed_scenes</span>
<span id="cb52-549"><a href="#cb52-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-550"><a href="#cb52-550" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_temporal_mosaic(processed_scenes, method: <span class="bu">str</span> <span class="op">=</span> <span class="st">'median'</span>):</span>
<span id="cb52-551"><a href="#cb52-551" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-552"><a href="#cb52-552" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a temporal mosaic from multiple processed scenes.</span></span>
<span id="cb52-553"><a href="#cb52-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-554"><a href="#cb52-554" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-555"><a href="#cb52-555" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scene dictionaries</span></span>
<span id="cb52-556"><a href="#cb52-556" aria-hidden="true" tabindex="-1"></a><span class="co">        method: Compositing method ('median', 'mean', 'max')</span></span>
<span id="cb52-557"><a href="#cb52-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-558"><a href="#cb52-558" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-559"><a href="#cb52-559" aria-hidden="true" tabindex="-1"></a><span class="co">        mosaic_data: Temporal composite as xarray Dataset</span></span>
<span id="cb52-560"><a href="#cb52-560" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-561"><a href="#cb52-561" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> processed_scenes:</span>
<span id="cb52-562"><a href="#cb52-562" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"❌ No scenes to mosaic"</span>)</span>
<span id="cb52-563"><a href="#cb52-563" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb52-564"><a href="#cb52-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-565"><a href="#cb52-565" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"🧩 Creating temporal mosaic using </span><span class="sc">{</span>method<span class="sc">}</span><span class="ss"> method..."</span>)</span>
<span id="cb52-566"><a href="#cb52-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-567"><a href="#cb52-567" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group data by band</span></span>
<span id="cb52-568"><a href="#cb52-568" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]</span>
<span id="cb52-569"><a href="#cb52-569" aria-hidden="true" tabindex="-1"></a>    band_stacks <span class="op">=</span> {}</span>
<span id="cb52-570"><a href="#cb52-570" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb52-571"><a href="#cb52-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-572"><a href="#cb52-572" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> bands:</span>
<span id="cb52-573"><a href="#cb52-573" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> []</span>
<span id="cb52-574"><a href="#cb52-574" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb52-575"><a href="#cb52-575" aria-hidden="true" tabindex="-1"></a>            band_data.append(scene[<span class="st">'data'</span>][band])</span>
<span id="cb52-576"><a href="#cb52-576" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band <span class="op">==</span> <span class="st">'red'</span>:  <span class="co"># Only collect dates once</span></span>
<span id="cb52-577"><a href="#cb52-577" aria-hidden="true" tabindex="-1"></a>                dates.append(scene[<span class="st">'date'</span>])</span>
<span id="cb52-578"><a href="#cb52-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-579"><a href="#cb52-579" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack along time dimension</span></span>
<span id="cb52-580"><a href="#cb52-580" aria-hidden="true" tabindex="-1"></a>        band_stack <span class="op">=</span> xr.concat(band_data, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb52-581"><a href="#cb52-581" aria-hidden="true" tabindex="-1"></a>        band_stack <span class="op">=</span> band_stack.assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb52-582"><a href="#cb52-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-583"><a href="#cb52-583" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply temporal compositing</span></span>
<span id="cb52-584"><a href="#cb52-584" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> method <span class="op">==</span> <span class="st">'median'</span>:</span>
<span id="cb52-585"><a href="#cb52-585" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.median(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-586"><a href="#cb52-586" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'mean'</span>:</span>
<span id="cb52-587"><a href="#cb52-587" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.mean(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-588"><a href="#cb52-588" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'max'</span>:</span>
<span id="cb52-589"><a href="#cb52-589" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.<span class="bu">max</span>(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-590"><a href="#cb52-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-591"><a href="#cb52-591" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create mosaic dataset</span></span>
<span id="cb52-592"><a href="#cb52-592" aria-hidden="true" tabindex="-1"></a>    mosaic_data <span class="op">=</span> xr.Dataset(band_stacks)</span>
<span id="cb52-593"><a href="#cb52-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-594"><a href="#cb52-594" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metadata</span></span>
<span id="cb52-595"><a href="#cb52-595" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'method'</span>] <span class="op">=</span> method</span>
<span id="cb52-596"><a href="#cb52-596" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'n_scenes'</span>] <span class="op">=</span> <span class="bu">len</span>(processed_scenes)</span>
<span id="cb52-597"><a href="#cb52-597" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'date_range'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">min</span>(dates)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span><span class="bu">max</span>(dates)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb52-598"><a href="#cb52-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-599"><a href="#cb52-599" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Mosaic created from </span><span class="sc">{</span><span class="bu">len</span>(processed_scenes)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb52-600"><a href="#cb52-600" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📏 Mosaic shape: </span><span class="sc">{</span>mosaic_data[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-601"><a href="#cb52-601" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📅 Date range: </span><span class="sc">{</span>mosaic_data<span class="sc">.</span>attrs[<span class="st">'date_range'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-602"><a href="#cb52-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-603"><a href="#cb52-603" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mosaic_data</span>
<span id="cb52-604"><a href="#cb52-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-605"><a href="#cb52-605" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_temporal_datacube(processed_scenes, chunk_size<span class="op">=</span><span class="st">'auto'</span>):</span>
<span id="cb52-606"><a href="#cb52-606" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-607"><a href="#cb52-607" aria-hidden="true" tabindex="-1"></a><span class="co">    Build an analysis-ready temporal data cube.</span></span>
<span id="cb52-608"><a href="#cb52-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-609"><a href="#cb52-609" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-610"><a href="#cb52-610" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scenes</span></span>
<span id="cb52-611"><a href="#cb52-611" aria-hidden="true" tabindex="-1"></a><span class="co">        chunk_size: Dask chunk size for memory management</span></span>
<span id="cb52-612"><a href="#cb52-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-613"><a href="#cb52-613" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-614"><a href="#cb52-614" aria-hidden="true" tabindex="-1"></a><span class="co">        datacube: xarray Dataset with time dimension</span></span>
<span id="cb52-615"><a href="#cb52-615" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-616"><a href="#cb52-616" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> processed_scenes:</span>
<span id="cb52-617"><a href="#cb52-617" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb52-618"><a href="#cb52-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-619"><a href="#cb52-619" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"📊 Building temporal data cube..."</span>)</span>
<span id="cb52-620"><a href="#cb52-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-621"><a href="#cb52-621" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort scenes by date</span></span>
<span id="cb52-622"><a href="#cb52-622" aria-hidden="true" tabindex="-1"></a>    processed_scenes.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'date'</span>])</span>
<span id="cb52-623"><a href="#cb52-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-624"><a href="#cb52-624" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract dates and data</span></span>
<span id="cb52-625"><a href="#cb52-625" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> [pd.to_datetime(scene[<span class="st">'date'</span>]) <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes]</span>
<span id="cb52-626"><a href="#cb52-626" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]</span>
<span id="cb52-627"><a href="#cb52-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-628"><a href="#cb52-628" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build data arrays for each band</span></span>
<span id="cb52-629"><a href="#cb52-629" aria-hidden="true" tabindex="-1"></a>    band_cubes <span class="op">=</span> {}</span>
<span id="cb52-630"><a href="#cb52-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-631"><a href="#cb52-631" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> bands:</span>
<span id="cb52-632"><a href="#cb52-632" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack all scenes for this band</span></span>
<span id="cb52-633"><a href="#cb52-633" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> []</span>
<span id="cb52-634"><a href="#cb52-634" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb52-635"><a href="#cb52-635" aria-hidden="true" tabindex="-1"></a>            band_data.append(scene[<span class="st">'data'</span>][band])</span>
<span id="cb52-636"><a href="#cb52-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-637"><a href="#cb52-637" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create temporal stack</span></span>
<span id="cb52-638"><a href="#cb52-638" aria-hidden="true" tabindex="-1"></a>        band_cube <span class="op">=</span> xr.concat(band_data, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb52-639"><a href="#cb52-639" aria-hidden="true" tabindex="-1"></a>        band_cube <span class="op">=</span> band_cube.assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb52-640"><a href="#cb52-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-641"><a href="#cb52-641" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add chunking for large datasets</span></span>
<span id="cb52-642"><a href="#cb52-642" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chunk_size <span class="op">==</span> <span class="st">'auto'</span>:</span>
<span id="cb52-643"><a href="#cb52-643" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get actual dimension names from the data</span></span>
<span id="cb52-644"><a href="#cb52-644" aria-hidden="true" tabindex="-1"></a>            dims <span class="op">=</span> band_cube.dims</span>
<span id="cb52-645"><a href="#cb52-645" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(dims) <span class="op">==</span> <span class="dv">3</span>:  <span class="co"># time, dim_0, dim_1 or time, y, x</span></span>
<span id="cb52-646"><a href="#cb52-646" aria-hidden="true" tabindex="-1"></a>                chunks <span class="op">=</span> {dims[<span class="dv">0</span>]: <span class="dv">1</span>, dims[<span class="dv">1</span>]: <span class="dv">512</span>, dims[<span class="dv">2</span>]: <span class="dv">512</span>}</span>
<span id="cb52-647"><a href="#cb52-647" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb52-648"><a href="#cb52-648" aria-hidden="true" tabindex="-1"></a>                chunks <span class="op">=</span> {}</span>
<span id="cb52-649"><a href="#cb52-649" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-650"><a href="#cb52-650" aria-hidden="true" tabindex="-1"></a>            chunks <span class="op">=</span> chunk_size</span>
<span id="cb52-651"><a href="#cb52-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-652"><a href="#cb52-652" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only apply chunking if chunks are specified</span></span>
<span id="cb52-653"><a href="#cb52-653" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chunks:</span>
<span id="cb52-654"><a href="#cb52-654" aria-hidden="true" tabindex="-1"></a>            band_cubes[band] <span class="op">=</span> band_cube.chunk(chunks)</span>
<span id="cb52-655"><a href="#cb52-655" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-656"><a href="#cb52-656" aria-hidden="true" tabindex="-1"></a>            band_cubes[band] <span class="op">=</span> band_cube</span>
<span id="cb52-657"><a href="#cb52-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-658"><a href="#cb52-658" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create dataset</span></span>
<span id="cb52-659"><a href="#cb52-659" aria-hidden="true" tabindex="-1"></a>    datacube <span class="op">=</span> xr.Dataset(band_cubes)</span>
<span id="cb52-660"><a href="#cb52-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-661"><a href="#cb52-661" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add derived indices</span></span>
<span id="cb52-662"><a href="#cb52-662" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🧮 Computing vegetation indices..."</span>)</span>
<span id="cb52-663"><a href="#cb52-663" aria-hidden="true" tabindex="-1"></a>    datacube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb52-664"><a href="#cb52-664" aria-hidden="true" tabindex="-1"></a>                        (datacube[<span class="st">'nir'</span>] <span class="op">+</span> datacube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb52-665"><a href="#cb52-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-666"><a href="#cb52-666" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enhanced Vegetation Index (EVI)</span></span>
<span id="cb52-667"><a href="#cb52-667" aria-hidden="true" tabindex="-1"></a>    datacube[<span class="st">'evi'</span>] <span class="op">=</span> (<span class="fl">2.5</span> <span class="op">*</span> (datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb52-668"><a href="#cb52-668" aria-hidden="true" tabindex="-1"></a>                       (datacube[<span class="st">'nir'</span>] <span class="op">+</span> <span class="dv">6</span> <span class="op">*</span> datacube[<span class="st">'red'</span>] <span class="op">-</span> <span class="fl">7.5</span> <span class="op">*</span> datacube[<span class="st">'blue'</span>] <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb52-669"><a href="#cb52-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-670"><a href="#cb52-670" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metadata</span></span>
<span id="cb52-671"><a href="#cb52-671" aria-hidden="true" tabindex="-1"></a>    datacube.attrs.update({</span>
<span id="cb52-672"><a href="#cb52-672" aria-hidden="true" tabindex="-1"></a>        <span class="st">'title'</span>: <span class="st">'Sentinel-2 Analysis-Ready Data Cube'</span>,</span>
<span id="cb52-673"><a href="#cb52-673" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="st">'Cloud-masked, reprojected temporal stack'</span>,</span>
<span id="cb52-674"><a href="#cb52-674" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_scenes'</span>: <span class="bu">len</span>(processed_scenes),</span>
<span id="cb52-675"><a href="#cb52-675" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time_range'</span>: <span class="ss">f"</span><span class="sc">{</span>dates[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dates[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb52-676"><a href="#cb52-676" aria-hidden="true" tabindex="-1"></a>        <span class="st">'crs'</span>: <span class="bu">str</span>(datacube[<span class="st">'red'</span>].rio.crs) <span class="cf">if</span> <span class="bu">hasattr</span>(datacube[<span class="st">'red'</span>], <span class="st">'rio'</span>) <span class="kw">and</span> datacube[<span class="st">'red'</span>].rio.crs <span class="cf">else</span> <span class="st">'Unknown'</span>,</span>
<span id="cb52-677"><a href="#cb52-677" aria-hidden="true" tabindex="-1"></a>        <span class="st">'resolution'</span>: <span class="st">'Variable (depends on original scene resolution)'</span></span>
<span id="cb52-678"><a href="#cb52-678" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb52-679"><a href="#cb52-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-680"><a href="#cb52-680" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Data cube created:"</span>)</span>
<span id="cb52-681"><a href="#cb52-681" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Shape: </span><span class="sc">{</span>datacube[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-682"><a href="#cb52-682" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Time steps: </span><span class="sc">{</span><span class="bu">len</span>(dates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-683"><a href="#cb52-683" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Variables: </span><span class="sc">{</span><span class="bu">list</span>(datacube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-684"><a href="#cb52-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-685"><a href="#cb52-685" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> datacube</span>
<span id="cb52-686"><a href="#cb52-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-687"><a href="#cb52-687" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sentinel2Preprocessor:</span>
<span id="cb52-688"><a href="#cb52-688" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-689"><a href="#cb52-689" aria-hidden="true" tabindex="-1"></a><span class="co">    Scalable Sentinel-2 preprocessing pipeline using geogfm functions.</span></span>
<span id="cb52-690"><a href="#cb52-690" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-691"><a href="#cb52-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-692"><a href="#cb52-692" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, output_dir: <span class="bu">str</span> <span class="op">=</span> <span class="st">"preprocessed_data"</span>, target_crs: <span class="bu">str</span> <span class="op">=</span> <span class="st">'EPSG:32610'</span>,</span>
<span id="cb52-693"><a href="#cb52-693" aria-hidden="true" tabindex="-1"></a>                 target_resolution: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>, max_cloud_cover: <span class="bu">float</span> <span class="op">=</span> <span class="dv">15</span>,</span>
<span id="cb52-694"><a href="#cb52-694" aria-hidden="true" tabindex="-1"></a>                 good_pixel_classes: List[<span class="bu">int</span>] <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]):</span>
<span id="cb52-695"><a href="#cb52-695" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_dir <span class="op">=</span> Path(output_dir)</span>
<span id="cb52-696"><a href="#cb52-696" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-697"><a href="#cb52-697" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_crs <span class="op">=</span> target_crs</span>
<span id="cb52-698"><a href="#cb52-698" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_resolution <span class="op">=</span> target_resolution</span>
<span id="cb52-699"><a href="#cb52-699" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_cloud_cover <span class="op">=</span> max_cloud_cover</span>
<span id="cb52-700"><a href="#cb52-700" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.good_pixel_classes <span class="op">=</span> good_pixel_classes</span>
<span id="cb52-701"><a href="#cb52-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-702"><a href="#cb52-702" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up authentication once during initialization</span></span>
<span id="cb52-703"><a href="#cb52-703" aria-hidden="true" tabindex="-1"></a>        setup_planetary_computer_auth()</span>
<span id="cb52-704"><a href="#cb52-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-705"><a href="#cb52-705" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"🔧 Preprocessing pipeline initialized"</span>)</span>
<span id="cb52-706"><a href="#cb52-706" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Output directory: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-707"><a href="#cb52-707" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Target CRS: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-708"><a href="#cb52-708" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Target resolution: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_resolution<span class="sc">}</span><span class="ss">m"</span>)</span>
<span id="cb52-709"><a href="#cb52-709" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Max cloud cover: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span>
<span id="cb52-710"><a href="#cb52-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-711"><a href="#cb52-711" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> search_scenes(<span class="va">self</span>, bbox: List[<span class="bu">float</span>], start_date: <span class="bu">str</span>, end_date: <span class="bu">str</span>,</span>
<span id="cb52-712"><a href="#cb52-712" aria-hidden="true" tabindex="-1"></a>                     limit: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>) <span class="op">-&gt;</span> List:</span>
<span id="cb52-713"><a href="#cb52-713" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Search for Sentinel-2 scenes using geogfm standardized function."""</span></span>
<span id="cb52-714"><a href="#cb52-714" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure authentication is set up</span></span>
<span id="cb52-715"><a href="#cb52-715" aria-hidden="true" tabindex="-1"></a>        setup_planetary_computer_auth()</span>
<span id="cb52-716"><a href="#cb52-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-717"><a href="#cb52-717" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use our standardized search function</span></span>
<span id="cb52-718"><a href="#cb52-718" aria-hidden="true" tabindex="-1"></a>        date_range <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb52-719"><a href="#cb52-719" aria-hidden="true" tabindex="-1"></a>        items <span class="op">=</span> search_sentinel2_scenes(</span>
<span id="cb52-720"><a href="#cb52-720" aria-hidden="true" tabindex="-1"></a>            bbox<span class="op">=</span>bbox,</span>
<span id="cb52-721"><a href="#cb52-721" aria-hidden="true" tabindex="-1"></a>            date_range<span class="op">=</span>date_range,</span>
<span id="cb52-722"><a href="#cb52-722" aria-hidden="true" tabindex="-1"></a>            cloud_cover_max<span class="op">=</span><span class="va">self</span>.max_cloud_cover,</span>
<span id="cb52-723"><a href="#cb52-723" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">=</span>limit</span>
<span id="cb52-724"><a href="#cb52-724" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb52-725"><a href="#cb52-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-726"><a href="#cb52-726" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"🔍 Found </span><span class="sc">{</span><span class="bu">len</span>(items)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb52-727"><a href="#cb52-727" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> items</span>
<span id="cb52-728"><a href="#cb52-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-729"><a href="#cb52-729" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_scene(<span class="va">self</span>, item, save_individual: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> Optional[Dict]:</span>
<span id="cb52-730"><a href="#cb52-730" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Process a single scene with cloud masking using geogfm functions."""</span></span>
<span id="cb52-731"><a href="#cb52-731" aria-hidden="true" tabindex="-1"></a>        scene_id <span class="op">=</span> item.<span class="bu">id</span></span>
<span id="cb52-732"><a href="#cb52-732" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> <span class="va">self</span>.output_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">_processed.nc"</span></span>
<span id="cb52-733"><a href="#cb52-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-734"><a href="#cb52-734" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip if already processed</span></span>
<span id="cb52-735"><a href="#cb52-735" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> output_path.exists():</span>
<span id="cb52-736"><a href="#cb52-736" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"⏭️ Skipping </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss"> (already processed)"</span>)</span>
<span id="cb52-737"><a href="#cb52-737" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> save_individual:</span>
<span id="cb52-738"><a href="#cb52-738" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="bu">str</span>(output_path)</span>
<span id="cb52-739"><a href="#cb52-739" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb52-740"><a href="#cb52-740" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Load existing data for in-memory processing</span></span>
<span id="cb52-741"><a href="#cb52-741" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> xr.open_dataset(output_path)</span>
<span id="cb52-742"><a href="#cb52-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-743"><a href="#cb52-743" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process scene using our enhanced function</span></span>
<span id="cb52-744"><a href="#cb52-744" aria-hidden="true" tabindex="-1"></a>        data, valid_frac <span class="op">=</span> load_scene_with_cloudmask(</span>
<span id="cb52-745"><a href="#cb52-745" aria-hidden="true" tabindex="-1"></a>            item, <span class="va">self</span>.target_crs, <span class="va">self</span>.target_resolution, <span class="va">self</span>.good_pixel_classes</span>
<span id="cb52-746"><a href="#cb52-746" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb52-747"><a href="#cb52-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-748"><a href="#cb52-748" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reduce minimum valid fraction threshold for demonstration</span></span>
<span id="cb52-749"><a href="#cb52-749" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> data <span class="kw">and</span> valid_frac <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Accept scenes with &gt;10% valid pixels</span></span>
<span id="cb52-750"><a href="#cb52-750" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> save_individual:</span>
<span id="cb52-751"><a href="#cb52-751" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb52-752"><a href="#cb52-752" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Convert to xarray Dataset</span></span>
<span id="cb52-753"><a href="#cb52-753" aria-hidden="true" tabindex="-1"></a>                    scene_ds <span class="op">=</span> xr.Dataset(data)</span>
<span id="cb52-754"><a href="#cb52-754" aria-hidden="true" tabindex="-1"></a>                    scene_ds.attrs.update({</span>
<span id="cb52-755"><a href="#cb52-755" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'scene_id'</span>: scene_id,</span>
<span id="cb52-756"><a href="#cb52-756" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'date'</span>: item.properties[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>],</span>
<span id="cb52-757"><a href="#cb52-757" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'cloud_cover'</span>: item.properties.get(<span class="st">'eo:cloud_cover'</span>, <span class="dv">0</span>),</span>
<span id="cb52-758"><a href="#cb52-758" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'valid_pixel_fraction'</span>: valid_frac,</span>
<span id="cb52-759"><a href="#cb52-759" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'processing_crs'</span>: <span class="va">self</span>.target_crs,</span>
<span id="cb52-760"><a href="#cb52-760" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'processing_resolution'</span>: <span class="va">self</span>.target_resolution</span>
<span id="cb52-761"><a href="#cb52-761" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb52-762"><a href="#cb52-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-763"><a href="#cb52-763" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Save to NetCDF with compression and engine fallback</span></span>
<span id="cb52-764"><a href="#cb52-764" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb52-765"><a href="#cb52-765" aria-hidden="true" tabindex="-1"></a>                        encoding <span class="op">=</span> {var: {<span class="st">'zlib'</span>: <span class="va">True</span>, <span class="st">'complevel'</span>: <span class="dv">4</span>} <span class="cf">for</span> var <span class="kw">in</span> scene_ds.data_vars}</span>
<span id="cb52-766"><a href="#cb52-766" aria-hidden="true" tabindex="-1"></a>                        scene_ds.to_netcdf(output_path, engine<span class="op">=</span><span class="st">'netcdf4'</span>, encoding<span class="op">=</span>encoding)</span>
<span id="cb52-767"><a href="#cb52-767" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"💾 Saved: </span><span class="sc">{</span>output_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (netCDF4)"</span>)</span>
<span id="cb52-768"><a href="#cb52-768" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb52-769"><a href="#cb52-769" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"⚠️ netCDF4 not available, using scipy for </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb52-770"><a href="#cb52-770" aria-hidden="true" tabindex="-1"></a>                        scene_ds.to_netcdf(output_path, engine<span class="op">=</span><span class="st">'scipy'</span>)</span>
<span id="cb52-771"><a href="#cb52-771" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"💾 Saved: </span><span class="sc">{</span>output_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (scipy)"</span>)</span>
<span id="cb52-772"><a href="#cb52-772" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb52-773"><a href="#cb52-773" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"⚠️ Save error for </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-774"><a href="#cb52-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-775"><a href="#cb52-775" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> data</span>
<span id="cb52-776"><a href="#cb52-776" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb52-777"><a href="#cb52-777" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"❌ Skipped </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss"> (valid fraction: </span><span class="sc">{</span>valid_frac<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb52-778"><a href="#cb52-778" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb52-779"><a href="#cb52-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-780"><a href="#cb52-780" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_time_series_cube(<span class="va">self</span>, processed_data_list, cube_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">"datacube"</span>):</span>
<span id="cb52-781"><a href="#cb52-781" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create and save temporal data cube."""</span></span>
<span id="cb52-782"><a href="#cb52-782" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> processed_data_list:</span>
<span id="cb52-783"><a href="#cb52-783" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"❌ No data to create cube"</span>)</span>
<span id="cb52-784"><a href="#cb52-784" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb52-785"><a href="#cb52-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-786"><a href="#cb52-786" aria-hidden="true" tabindex="-1"></a>        cube_path <span class="op">=</span> <span class="va">self</span>.output_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>cube_name<span class="sc">}</span><span class="ss">.nc"</span></span>
<span id="cb52-787"><a href="#cb52-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-788"><a href="#cb52-788" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build temporal stack</span></span>
<span id="cb52-789"><a href="#cb52-789" aria-hidden="true" tabindex="-1"></a>        dates <span class="op">=</span> []</span>
<span id="cb52-790"><a href="#cb52-790" aria-hidden="true" tabindex="-1"></a>        band_stacks <span class="op">=</span> {band: [] <span class="cf">for</span> band <span class="kw">in</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]}</span>
<span id="cb52-791"><a href="#cb52-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-792"><a href="#cb52-792" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data <span class="kw">in</span> processed_data_list:</span>
<span id="cb52-793"><a href="#cb52-793" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> data:</span>
<span id="cb52-794"><a href="#cb52-794" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle both dictionary format and xarray Dataset format</span></span>
<span id="cb52-795"><a href="#cb52-795" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(data, <span class="bu">dict</span>):</span>
<span id="cb52-796"><a href="#cb52-796" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Dictionary format from fresh processing</span></span>
<span id="cb52-797"><a href="#cb52-797" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> band <span class="kw">in</span> band_stacks.keys():</span>
<span id="cb52-798"><a href="#cb52-798" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> band <span class="kw">in</span> data:</span>
<span id="cb52-799"><a href="#cb52-799" aria-hidden="true" tabindex="-1"></a>                            band_stacks[band].append(data[band])</span>
<span id="cb52-800"><a href="#cb52-800" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb52-801"><a href="#cb52-801" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># xarray Dataset from loaded file - extract individual bands</span></span>
<span id="cb52-802"><a href="#cb52-802" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> band <span class="kw">in</span> band_stacks.keys():</span>
<span id="cb52-803"><a href="#cb52-803" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> band <span class="kw">in</span> data.data_vars:</span>
<span id="cb52-804"><a href="#cb52-804" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># If the loaded data has a time dimension, select the first time slice</span></span>
<span id="cb52-805"><a href="#cb52-805" aria-hidden="true" tabindex="-1"></a>                            band_data <span class="op">=</span> data[band]</span>
<span id="cb52-806"><a href="#cb52-806" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> <span class="st">'time'</span> <span class="kw">in</span> band_data.dims <span class="kw">and</span> band_data.dims[<span class="st">'time'</span>] <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb52-807"><a href="#cb52-807" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># Multiple time slices in saved file - take first one</span></span>
<span id="cb52-808"><a href="#cb52-808" aria-hidden="true" tabindex="-1"></a>                                band_data <span class="op">=</span> band_data.isel(time<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-809"><a href="#cb52-809" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">elif</span> <span class="st">'time'</span> <span class="kw">in</span> band_data.dims:</span>
<span id="cb52-810"><a href="#cb52-810" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># Single time slice - remove time dimension</span></span>
<span id="cb52-811"><a href="#cb52-811" aria-hidden="true" tabindex="-1"></a>                                band_data <span class="op">=</span> band_data.squeeze(<span class="st">'time'</span>)</span>
<span id="cb52-812"><a href="#cb52-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-813"><a href="#cb52-813" aria-hidden="true" tabindex="-1"></a>                            band_stacks[band].append(band_data)</span>
<span id="cb52-814"><a href="#cb52-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-815"><a href="#cb52-815" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create dataset</span></span>
<span id="cb52-816"><a href="#cb52-816" aria-hidden="true" tabindex="-1"></a>        cube_data <span class="op">=</span> {}</span>
<span id="cb52-817"><a href="#cb52-817" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"📊 Processing bands: </span><span class="sc">{</span><span class="bu">list</span>(band_stacks.keys())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-818"><a href="#cb52-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-819"><a href="#cb52-819" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> band, stack <span class="kw">in</span> band_stacks.items():</span>
<span id="cb52-820"><a href="#cb52-820" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stack:</span>
<span id="cb52-821"><a href="#cb52-821" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>band<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(stack)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb52-822"><a href="#cb52-822" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check that all scenes have this band</span></span>
<span id="cb52-823"><a href="#cb52-823" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(stack) <span class="op">==</span> <span class="bu">len</span>(processed_data_list):</span>
<span id="cb52-824"><a href="#cb52-824" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb52-825"><a href="#cb52-825" aria-hidden="true" tabindex="-1"></a>                        cube_data[band] <span class="op">=</span> xr.concat(stack, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb52-826"><a href="#cb52-826" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb52-827"><a href="#cb52-827" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"⚠️ Failed to concatenate </span><span class="sc">{</span>band<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-828"><a href="#cb52-828" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb52-829"><a href="#cb52-829" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"⚠️ </span><span class="sc">{</span>band<span class="sc">}</span><span class="ss"> missing from some scenes (</span><span class="sc">{</span><span class="bu">len</span>(stack)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(processed_data_list)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb52-830"><a href="#cb52-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-831"><a href="#cb52-831" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cube_data:</span>
<span id="cb52-832"><a href="#cb52-832" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb52-833"><a href="#cb52-833" aria-hidden="true" tabindex="-1"></a>                datacube <span class="op">=</span> xr.Dataset(cube_data)</span>
<span id="cb52-834"><a href="#cb52-834" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb52-835"><a href="#cb52-835" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"❌ Failed to create dataset: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-836"><a href="#cb52-836" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Available bands: </span><span class="sc">{</span><span class="bu">list</span>(cube_data.keys())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-837"><a href="#cb52-837" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb52-838"><a href="#cb52-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-839"><a href="#cb52-839" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add vegetation indices</span></span>
<span id="cb52-840"><a href="#cb52-840" aria-hidden="true" tabindex="-1"></a>            datacube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb52-841"><a href="#cb52-841" aria-hidden="true" tabindex="-1"></a>                               (datacube[<span class="st">'nir'</span>] <span class="op">+</span> datacube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb52-842"><a href="#cb52-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-843"><a href="#cb52-843" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save cube with fallback engines</span></span>
<span id="cb52-844"><a href="#cb52-844" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb52-845"><a href="#cb52-845" aria-hidden="true" tabindex="-1"></a>                datacube.to_netcdf(cube_path, engine<span class="op">=</span><span class="st">'netcdf4'</span>)</span>
<span id="cb52-846"><a href="#cb52-846" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"📦 Data cube saved: </span><span class="sc">{</span>cube_path<span class="sc">}</span><span class="ss"> (netCDF4)"</span>)</span>
<span id="cb52-847"><a href="#cb52-847" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb52-848"><a href="#cb52-848" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"⚠️ netCDF4 not available, using scipy engine..."</span>)</span>
<span id="cb52-849"><a href="#cb52-849" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb52-850"><a href="#cb52-850" aria-hidden="true" tabindex="-1"></a>                    datacube.to_netcdf(cube_path, engine<span class="op">=</span><span class="st">'scipy'</span>)</span>
<span id="cb52-851"><a href="#cb52-851" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"📦 Data cube saved: </span><span class="sc">{</span>cube_path<span class="sc">}</span><span class="ss"> (scipy)"</span>)</span>
<span id="cb52-852"><a href="#cb52-852" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb52-853"><a href="#cb52-853" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="st">"⚠️ NetCDF save failed, saving as Zarr..."</span>)</span>
<span id="cb52-854"><a href="#cb52-854" aria-hidden="true" tabindex="-1"></a>                    zarr_path <span class="op">=</span> cube_path.with_suffix(<span class="st">'.zarr'</span>)</span>
<span id="cb52-855"><a href="#cb52-855" aria-hidden="true" tabindex="-1"></a>                    datacube.to_zarr(zarr_path)</span>
<span id="cb52-856"><a href="#cb52-856" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"📦 Data cube saved: </span><span class="sc">{</span>zarr_path<span class="sc">}</span><span class="ss"> (zarr)"</span>)</span>
<span id="cb52-857"><a href="#cb52-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-858"><a href="#cb52-858" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> datacube</span>
<span id="cb52-859"><a href="#cb52-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-860"><a href="#cb52-860" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb52-861"><a href="#cb52-861" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-862"><a href="#cb52-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-863"><a href="#cb52-863" aria-hidden="true" tabindex="-1"></a><span class="fu">### Test Cloud Masking Functions</span></span>
<span id="cb52-864"><a href="#cb52-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-865"><a href="#cb52-865" aria-hidden="true" tabindex="-1"></a>Now let's test our cloud masking functions with a real scene. We'll use spatial subsetting to make processing faster and more educational.</span>
<span id="cb52-866"><a href="#cb52-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-867"><a href="#cb52-867" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb52-868"><a href="#cb52-868" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial Subsetting for Faster Processing</span></span>
<span id="cb52-869"><a href="#cb52-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-870"><a href="#cb52-870" aria-hidden="true" tabindex="-1"></a>Processing full Sentinel-2 scenes can be slow and memory-intensive. Each full scene:</span>
<span id="cb52-871"><a href="#cb52-871" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Size**: ~100MB+ per scene when loaded</span>
<span id="cb52-872"><a href="#cb52-872" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Dimensions**: ~10,000 × 10,000 pixels at 10m resolution</span>
<span id="cb52-873"><a href="#cb52-873" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Processing time**: Several minutes per scene</span>
<span id="cb52-874"><a href="#cb52-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-875"><a href="#cb52-875" aria-hidden="true" tabindex="-1"></a>Using spatial subsets:</span>
<span id="cb52-876"><a href="#cb52-876" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Size**: ~1-5MB per subset</span>
<span id="cb52-877"><a href="#cb52-877" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Dimensions**: ~500 × 500 to 2,000 × 2,000 pixels</span>
<span id="cb52-878"><a href="#cb52-878" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Processing time**: Seconds per subset</span>
<span id="cb52-879"><a href="#cb52-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-880"><a href="#cb52-880" aria-hidden="true" tabindex="-1"></a>**Perfect for**: Learning, development, testing, and focused analysis</span>
<span id="cb52-881"><a href="#cb52-881" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb52-882"><a href="#cb52-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-885"><a href="#cb52-885" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-886"><a href="#cb52-886" aria-hidden="true" tabindex="-1"></a><span class="co"># Define some useful preset subsets for different use cases</span></span>
<span id="cb52-887"><a href="#cb52-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-888"><a href="#cb52-888" aria-hidden="true" tabindex="-1"></a><span class="co"># Central Valley subsets (agriculture focus)</span></span>
<span id="cb52-889"><a href="#cb52-889" aria-hidden="true" tabindex="-1"></a>small_farm_area <span class="op">=</span> [<span class="op">-</span><span class="fl">121.0</span>, <span class="fl">37.0</span>, <span class="op">-</span><span class="fl">120.8</span>, <span class="fl">37.2</span>]     <span class="co"># ~20km × 20km</span></span>
<span id="cb52-890"><a href="#cb52-890" aria-hidden="true" tabindex="-1"></a>medium_valley <span class="op">=</span> [<span class="op">-</span><span class="fl">121.2</span>, <span class="fl">36.8</span>, <span class="op">-</span><span class="fl">120.6</span>, <span class="fl">37.4</span>]       <span class="co"># ~40km × 40km</span></span>
<span id="cb52-891"><a href="#cb52-891" aria-hidden="true" tabindex="-1"></a>large_valley <span class="op">=</span> [<span class="op">-</span><span class="fl">121.5</span>, <span class="fl">36.5</span>, <span class="op">-</span><span class="fl">120.0</span>, <span class="fl">38.0</span>]        <span class="co"># Full study area</span></span>
<span id="cb52-892"><a href="#cb52-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-893"><a href="#cb52-893" aria-hidden="true" tabindex="-1"></a><span class="co"># Urban area subsets</span></span>
<span id="cb52-894"><a href="#cb52-894" aria-hidden="true" tabindex="-1"></a>sacramento_metro <span class="op">=</span> [<span class="op">-</span><span class="fl">121.6</span>, <span class="fl">38.4</span>, <span class="op">-</span><span class="fl">121.3</span>, <span class="fl">38.7</span>]    <span class="co"># Sacramento urban area</span></span>
<span id="cb52-895"><a href="#cb52-895" aria-hidden="true" tabindex="-1"></a>fresno_area <span class="op">=</span> [<span class="op">-</span><span class="fl">119.9</span>, <span class="fl">36.6</span>, <span class="op">-</span><span class="fl">119.6</span>, <span class="fl">36.9</span>]         <span class="co"># Fresno urban/ag mix</span></span>
<span id="cb52-896"><a href="#cb52-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-897"><a href="#cb52-897" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📍 Available subset presets:"</span>)</span>
<span id="cb52-898"><a href="#cb52-898" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Small farm area: </span><span class="sc">{</span>small_farm_area<span class="sc">}</span><span class="ss"> (~400MB data)"</span>)</span>
<span id="cb52-899"><a href="#cb52-899" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Medium valley: </span><span class="sc">{</span>medium_valley<span class="sc">}</span><span class="ss"> (~1.6GB data)"</span>)</span>
<span id="cb52-900"><a href="#cb52-900" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Large valley: </span><span class="sc">{</span>large_valley<span class="sc">}</span><span class="ss"> (full study area)"</span>)</span>
<span id="cb52-901"><a href="#cb52-901" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sacramento metro: </span><span class="sc">{</span>sacramento_metro<span class="sc">}</span><span class="ss"> (~urban focus)"</span>)</span>
<span id="cb52-902"><a href="#cb52-902" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fresno area: </span><span class="sc">{</span>fresno_area<span class="sc">}</span><span class="ss"> (~urban/ag mix)"</span>)</span>
<span id="cb52-903"><a href="#cb52-903" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-904"><a href="#cb52-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-907"><a href="#cb52-907" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-908"><a href="#cb52-908" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with one scene</span></span>
<span id="cb52-909"><a href="#cb52-909" aria-hidden="true" tabindex="-1"></a>test_item <span class="op">=</span> scenes_df.iloc[<span class="dv">0</span>][<span class="st">'item'</span>]</span>
<span id="cb52-910"><a href="#cb52-910" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🧪 Testing cloud masking with scene: </span><span class="sc">{</span>test_item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-911"><a href="#cb52-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-912"><a href="#cb52-912" aria-hidden="true" tabindex="-1"></a><span class="co"># Define good pixel classes for this demonstration</span></span>
<span id="cb52-913"><a href="#cb52-913" aria-hidden="true" tabindex="-1"></a>good_pixel_classes <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]  <span class="co"># Vegetation, not vegetated, water</span></span>
<span id="cb52-914"><a href="#cb52-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-915"><a href="#cb52-915" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a smaller subset for faster processing (optional)</span></span>
<span id="cb52-916"><a href="#cb52-916" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a small area within Central Valley for demonstration</span></span>
<span id="cb52-917"><a href="#cb52-917" aria-hidden="true" tabindex="-1"></a>fast_subset <span class="op">=</span> [<span class="op">-</span><span class="fl">121.0</span>, <span class="fl">37.0</span>, <span class="op">-</span><span class="fl">120.8</span>, <span class="fl">37.2</span>]  <span class="co"># Small 20km x 20km area</span></span>
<span id="cb52-918"><a href="#cb52-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-919"><a href="#cb52-919" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎯 Processing options:"</span>)</span>
<span id="cb52-920"><a href="#cb52-920" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"1. Full scene: ~100MB+ download, slow processing"</span>)</span>
<span id="cb52-921"><a href="#cb52-921" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"2. Subset area: ~1-5MB download, fast processing"</span>)</span>
<span id="cb52-922"><a href="#cb52-922" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🚀 Using fast subset for demonstration..."</span>)</span>
<span id="cb52-923"><a href="#cb52-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-924"><a href="#cb52-924" aria-hidden="true" tabindex="-1"></a><span class="co"># Test our enhanced cloud masking function with spatial subset</span></span>
<span id="cb52-925"><a href="#cb52-925" aria-hidden="true" tabindex="-1"></a>masked_data, valid_fraction <span class="op">=</span> load_scene_with_cloudmask(</span>
<span id="cb52-926"><a href="#cb52-926" aria-hidden="true" tabindex="-1"></a>    test_item,</span>
<span id="cb52-927"><a href="#cb52-927" aria-hidden="true" tabindex="-1"></a>    target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>,</span>
<span id="cb52-928"><a href="#cb52-928" aria-hidden="true" tabindex="-1"></a>    target_resolution<span class="op">=</span><span class="dv">20</span>,  <span class="co"># Resample to 20m to match SCL</span></span>
<span id="cb52-929"><a href="#cb52-929" aria-hidden="true" tabindex="-1"></a>    good_pixel_classes<span class="op">=</span>good_pixel_classes,</span>
<span id="cb52-930"><a href="#cb52-930" aria-hidden="true" tabindex="-1"></a>    subset_bbox<span class="op">=</span>fast_subset  <span class="co"># Use subset for faster processing</span></span>
<span id="cb52-931"><a href="#cb52-931" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-932"><a href="#cb52-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-933"><a href="#cb52-933" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> masked_data:</span>
<span id="cb52-934"><a href="#cb52-934" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✅ Scene loaded successfully"</span>)</span>
<span id="cb52-935"><a href="#cb52-935" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📏 Data shape: </span><span class="sc">{</span>masked_data[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-936"><a href="#cb52-936" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📊 Valid pixels: </span><span class="sc">{</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb52-937"><a href="#cb52-937" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"☁️ Cloudy pixels: </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb52-938"><a href="#cb52-938" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb52-939"><a href="#cb52-939" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"❌ Failed to load scene"</span>)</span>
<span id="cb52-940"><a href="#cb52-940" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-941"><a href="#cb52-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-942"><a href="#cb52-942" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualize Cloud Masking Results</span></span>
<span id="cb52-943"><a href="#cb52-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-946"><a href="#cb52-946" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-947"><a href="#cb52-947" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> masked_data:</span>
<span id="cb52-948"><a href="#cb52-948" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create visualization of cloud masking</span></span>
<span id="cb52-949"><a href="#cb52-949" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb52-950"><a href="#cb52-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-951"><a href="#cb52-951" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Original RGB (before masking)</span></span>
<span id="cb52-952"><a href="#cb52-952" aria-hidden="true" tabindex="-1"></a>    red_orig <span class="op">=</span> masked_data[<span class="st">'red'</span>].fillna(<span class="dv">0</span>)  <span class="co"># Fill NaN for display</span></span>
<span id="cb52-953"><a href="#cb52-953" aria-hidden="true" tabindex="-1"></a>    green_orig <span class="op">=</span> masked_data[<span class="st">'green'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb52-954"><a href="#cb52-954" aria-hidden="true" tabindex="-1"></a>    blue_orig <span class="op">=</span> masked_data[<span class="st">'blue'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb52-955"><a href="#cb52-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-956"><a href="#cb52-956" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize for RGB display</span></span>
<span id="cb52-957"><a href="#cb52-957" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> normalize_for_display(band, percentiles<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">98</span>)):</span>
<span id="cb52-958"><a href="#cb52-958" aria-hidden="true" tabindex="-1"></a>        valid_data <span class="op">=</span> band[<span class="op">~</span>np.isnan(band)]</span>
<span id="cb52-959"><a href="#cb52-959" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb52-960"><a href="#cb52-960" aria-hidden="true" tabindex="-1"></a>            p_low, p_high <span class="op">=</span> np.percentile(valid_data, percentiles)</span>
<span id="cb52-961"><a href="#cb52-961" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.clip((band <span class="op">-</span> p_low) <span class="op">/</span> (p_high <span class="op">-</span> p_low), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb52-962"><a href="#cb52-962" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> band</span>
<span id="cb52-963"><a href="#cb52-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-964"><a href="#cb52-964" aria-hidden="true" tabindex="-1"></a>    red_norm <span class="op">=</span> normalize_for_display(red_orig.values)</span>
<span id="cb52-965"><a href="#cb52-965" aria-hidden="true" tabindex="-1"></a>    green_norm <span class="op">=</span> normalize_for_display(green_orig.values)</span>
<span id="cb52-966"><a href="#cb52-966" aria-hidden="true" tabindex="-1"></a>    blue_norm <span class="op">=</span> normalize_for_display(blue_orig.values)</span>
<span id="cb52-967"><a href="#cb52-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-968"><a href="#cb52-968" aria-hidden="true" tabindex="-1"></a>    rgb_composite <span class="op">=</span> np.dstack([red_norm, green_norm, blue_norm])</span>
<span id="cb52-969"><a href="#cb52-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-970"><a href="#cb52-970" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb52-971"><a href="#cb52-971" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].imshow(rgb_composite)</span>
<span id="cb52-972"><a href="#cb52-972" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'RGB Composite'</span>)</span>
<span id="cb52-973"><a href="#cb52-973" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-974"><a href="#cb52-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-975"><a href="#cb52-975" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scene Classification Layer</span></span>
<span id="cb52-976"><a href="#cb52-976" aria-hidden="true" tabindex="-1"></a>    scl_plot <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">1</span>].imshow(masked_data[<span class="st">'scl'</span>].values, cmap<span class="op">=</span><span class="st">'tab20'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb52-977"><a href="#cb52-977" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Scene Classification Layer'</span>)</span>
<span id="cb52-978"><a href="#cb52-978" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-979"><a href="#cb52-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-980"><a href="#cb52-980" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cloud mask</span></span>
<span id="cb52-981"><a href="#cb52-981" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].imshow(masked_data[<span class="st">'cloud_mask'</span>].values, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-982"><a href="#cb52-982" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'Valid Pixels Mask'</span>)</span>
<span id="cb52-983"><a href="#cb52-983" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-984"><a href="#cb52-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-985"><a href="#cb52-985" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Masked RGB</span></span>
<span id="cb52-986"><a href="#cb52-986" aria-hidden="true" tabindex="-1"></a>    masked_rgb <span class="op">=</span> rgb_composite.copy()</span>
<span id="cb52-987"><a href="#cb52-987" aria-hidden="true" tabindex="-1"></a>    masked_rgb[<span class="op">~</span>masked_data[<span class="st">'cloud_mask'</span>].values] <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>]  <span class="co"># Red for masked areas</span></span>
<span id="cb52-988"><a href="#cb52-988" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].imshow(masked_rgb)</span>
<span id="cb52-989"><a href="#cb52-989" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Masked RGB (Red = Clouds)'</span>)</span>
<span id="cb52-990"><a href="#cb52-990" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-991"><a href="#cb52-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-992"><a href="#cb52-992" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI calculation on masked data</span></span>
<span id="cb52-993"><a href="#cb52-993" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The Normalized Difference Vegetation Index (NDVI) is calculated as:</span></span>
<span id="cb52-994"><a href="#cb52-994" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI = (NIR - Red) / (NIR + Red)</span></span>
<span id="cb52-995"><a href="#cb52-995" aria-hidden="true" tabindex="-1"></a>    nir_masked <span class="op">=</span> masked_data[<span class="st">'nir'</span>].values</span>
<span id="cb52-996"><a href="#cb52-996" aria-hidden="true" tabindex="-1"></a>    red_masked <span class="op">=</span> masked_data[<span class="st">'red'</span>].values</span>
<span id="cb52-997"><a href="#cb52-997" aria-hidden="true" tabindex="-1"></a>    ndvi <span class="op">=</span> (nir_masked <span class="op">-</span> red_masked) <span class="op">/</span> (nir_masked <span class="op">+</span> red_masked <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb52-998"><a href="#cb52-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-999"><a href="#cb52-999" aria-hidden="true" tabindex="-1"></a>    ndvi_plot <span class="op">=</span> axes[<span class="dv">1</span>,<span class="dv">1</span>].imshow(ndvi, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=-</span><span class="fl">0.5</span>, vmax<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb52-1000"><a href="#cb52-1000" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'NDVI (Clouds Excluded)'</span>)</span>
<span id="cb52-1001"><a href="#cb52-1001" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-1002"><a href="#cb52-1002" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(ndvi_plot, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb52-1003"><a href="#cb52-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1004"><a href="#cb52-1004" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Statistics</span></span>
<span id="cb52-1005"><a href="#cb52-1005" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="ss">f"Valid Pixels: </span><span class="sc">{</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb52-1006"><a href="#cb52-1006" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.6</span>, <span class="ss">f"Cloudy Pixels: </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb52-1007"><a href="#cb52-1007" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="ss">f"NDVI Range: </span><span class="sc">{</span>np<span class="sc">.</span>nanmin(ndvi)<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>np<span class="sc">.</span>nanmax(ndvi)<span class="sc">:.2f}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb52-1008"><a href="#cb52-1008" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="ss">f"Mean NDVI: </span><span class="sc">{</span>np<span class="sc">.</span>nanmean(ndvi)<span class="sc">:.2f}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb52-1009"><a href="#cb52-1009" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Statistics'</span>)</span>
<span id="cb52-1010"><a href="#cb52-1010" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-1011"><a href="#cb52-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1012"><a href="#cb52-1012" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb52-1013"><a href="#cb52-1013" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb52-1014"><a href="#cb52-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1015"><a href="#cb52-1015" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🎨 Cloud masking visualization complete"</span>)</span>
<span id="cb52-1016"><a href="#cb52-1016" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1017"><a href="#cb52-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1018"><a href="#cb52-1018" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb52-1019"><a href="#cb52-1019" aria-hidden="true" tabindex="-1"></a><span class="fu">## Scene Classification Layer (SCL) Benefits</span></span>
<span id="cb52-1020"><a href="#cb52-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1021"><a href="#cb52-1021" aria-hidden="true" tabindex="-1"></a>The SCL is automatically generated during Sentinel-2 Level 2A processing using machine learning algorithms trained on expert-labeled data.</span>
<span id="cb52-1022"><a href="#cb52-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1023"><a href="#cb52-1023" aria-hidden="true" tabindex="-1"></a>**Key Advantages**:</span>
<span id="cb52-1024"><a href="#cb52-1024" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Automated cloud detection**: No manual threshold setting needed</span>
<span id="cb52-1025"><a href="#cb52-1025" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Multiple cloud types**: Distinguishes dense clouds, thin cirrus, and shadows</span>
<span id="cb52-1026"><a href="#cb52-1026" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Consistent classification**: Same algorithm across all Sentinel-2 scenes globally</span>
<span id="cb52-1027"><a href="#cb52-1027" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Analysis-ready**: Level 2A processing includes atmospheric correction</span>
<span id="cb52-1028"><a href="#cb52-1028" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Production quality**: Used by ESA and major data providers</span>
<span id="cb52-1029"><a href="#cb52-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1030"><a href="#cb52-1030" aria-hidden="true" tabindex="-1"></a>**Best Practice**: Always use SCL for cloud masking rather than simple band thresholds, as it accounts for seasonal and geographic variations in cloud appearance.</span>
<span id="cb52-1031"><a href="#cb52-1031" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb52-1032"><a href="#cb52-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1033"><a href="#cb52-1033" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-1034"><a href="#cb52-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1035"><a href="#cb52-1035" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Reprojection and Mosaicking</span></span>
<span id="cb52-1036"><a href="#cb52-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1037"><a href="#cb52-1037" aria-hidden="true" tabindex="-1"></a>When working with multiple scenes, we need to ensure they're all in the same coordinate system and can be combined seamlessly.</span>
<span id="cb52-1038"><a href="#cb52-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1039"><a href="#cb52-1039" aria-hidden="true" tabindex="-1"></a><span class="fu">### Batch Process Multiple Scenes</span></span>
<span id="cb52-1040"><a href="#cb52-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1043"><a href="#cb52-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1044"><a href="#cb52-1044" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's test the batch processing functions we defined earlier</span></span>
<span id="cb52-1045"><a href="#cb52-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1046"><a href="#cb52-1046" aria-hidden="true" tabindex="-1"></a><span class="co"># Select subset of scenes for processing (to manage computational load)</span></span>
<span id="cb52-1047"><a href="#cb52-1047" aria-hidden="true" tabindex="-1"></a>selected_scenes <span class="op">=</span> scenes_df.head(<span class="dv">5</span>)[<span class="st">'item'</span>].tolist()  <span class="co"># Process first 5 scenes</span></span>
<span id="cb52-1048"><a href="#cb52-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1049"><a href="#cb52-1049" aria-hidden="true" tabindex="-1"></a><span class="co"># Define processing options</span></span>
<span id="cb52-1050"><a href="#cb52-1050" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">📎 Processing Options:"</span>)</span>
<span id="cb52-1051"><a href="#cb52-1051" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Option A: Full scenes (slower, ~100MB+ per scene)"</span>)</span>
<span id="cb52-1052"><a href="#cb52-1052" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Option B: Spatial subset (faster, ~1-5MB per scene)"</span>)</span>
<span id="cb52-1053"><a href="#cb52-1053" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">🚀 Using spatial subset for faster demonstration..."</span>)</span>
<span id="cb52-1054"><a href="#cb52-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1055"><a href="#cb52-1055" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the same fast subset as before</span></span>
<span id="cb52-1056"><a href="#cb52-1056" aria-hidden="true" tabindex="-1"></a>fast_subset <span class="op">=</span> [<span class="op">-</span><span class="fl">121.0</span>, <span class="fl">37.0</span>, <span class="op">-</span><span class="fl">120.8</span>, <span class="fl">37.2</span>]  <span class="co"># Small area for fast processing</span></span>
<span id="cb52-1057"><a href="#cb52-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1058"><a href="#cb52-1058" aria-hidden="true" tabindex="-1"></a>processed_scenes <span class="op">=</span> process_scene_batch(</span>
<span id="cb52-1059"><a href="#cb52-1059" aria-hidden="true" tabindex="-1"></a>    selected_scenes,</span>
<span id="cb52-1060"><a href="#cb52-1060" aria-hidden="true" tabindex="-1"></a>    max_workers<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb52-1061"><a href="#cb52-1061" aria-hidden="true" tabindex="-1"></a>    min_valid_fraction<span class="op">=</span><span class="fl">0.1</span>,  <span class="co"># Lower threshold to include more scenes</span></span>
<span id="cb52-1062"><a href="#cb52-1062" aria-hidden="true" tabindex="-1"></a>    subset_bbox<span class="op">=</span>fast_subset  <span class="co"># Enable fast processing with subset</span></span>
<span id="cb52-1063"><a href="#cb52-1063" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-1064"><a href="#cb52-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1065"><a href="#cb52-1065" aria-hidden="true" tabindex="-1"></a><span class="co"># Show processing results</span></span>
<span id="cb52-1066"><a href="#cb52-1066" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> processed_scenes:</span>
<span id="cb52-1067"><a href="#cb52-1067" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Processing Summary:"</span>)</span>
<span id="cb52-1068"><a href="#cb52-1068" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb52-1069"><a href="#cb52-1069" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>scene[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>scene[<span class="st">'valid_fraction'</span>]<span class="sc">:.1%}</span><span class="ss"> valid pixels"</span>)</span>
<span id="cb52-1070"><a href="#cb52-1070" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1071"><a href="#cb52-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1072"><a href="#cb52-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Temporal Mosaic</span></span>
<span id="cb52-1073"><a href="#cb52-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1076"><a href="#cb52-1076" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1077"><a href="#cb52-1077" aria-hidden="true" tabindex="-1"></a><span class="co"># Create temporal mosaic using the function we defined earlier</span></span>
<span id="cb52-1078"><a href="#cb52-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1079"><a href="#cb52-1079" aria-hidden="true" tabindex="-1"></a><span class="co"># Create median composite</span></span>
<span id="cb52-1080"><a href="#cb52-1080" aria-hidden="true" tabindex="-1"></a>mosaic <span class="op">=</span> create_temporal_mosaic(processed_scenes, method<span class="op">=</span><span class="st">'median'</span>)</span>
<span id="cb52-1081"><a href="#cb52-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1082"><a href="#cb52-1082" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> mosaic:</span>
<span id="cb52-1083"><a href="#cb52-1083" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualize the mosaic</span></span>
<span id="cb52-1084"><a href="#cb52-1084" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb52-1085"><a href="#cb52-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1086"><a href="#cb52-1086" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RGB composite of mosaic</span></span>
<span id="cb52-1087"><a href="#cb52-1087" aria-hidden="true" tabindex="-1"></a>    red_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'red'</span>].values)</span>
<span id="cb52-1088"><a href="#cb52-1088" aria-hidden="true" tabindex="-1"></a>    green_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'green'</span>].values)</span>
<span id="cb52-1089"><a href="#cb52-1089" aria-hidden="true" tabindex="-1"></a>    blue_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'blue'</span>].values)</span>
<span id="cb52-1090"><a href="#cb52-1090" aria-hidden="true" tabindex="-1"></a>    rgb_mosaic <span class="op">=</span> np.dstack([red_norm, green_norm, blue_norm])</span>
<span id="cb52-1091"><a href="#cb52-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1092"><a href="#cb52-1092" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].imshow(rgb_mosaic)</span>
<span id="cb52-1093"><a href="#cb52-1093" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="ss">f'RGB Mosaic (</span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">"method"</span>]<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb52-1094"><a href="#cb52-1094" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-1095"><a href="#cb52-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1096"><a href="#cb52-1096" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI mosaic</span></span>
<span id="cb52-1097"><a href="#cb52-1097" aria-hidden="true" tabindex="-1"></a>    nir_vals <span class="op">=</span> mosaic[<span class="st">'nir'</span>].values</span>
<span id="cb52-1098"><a href="#cb52-1098" aria-hidden="true" tabindex="-1"></a>    red_vals <span class="op">=</span> mosaic[<span class="st">'red'</span>].values</span>
<span id="cb52-1099"><a href="#cb52-1099" aria-hidden="true" tabindex="-1"></a>    ndvi_mosaic <span class="op">=</span> (nir_vals <span class="op">-</span> red_vals) <span class="op">/</span> (nir_vals <span class="op">+</span> red_vals <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb52-1100"><a href="#cb52-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1101"><a href="#cb52-1101" aria-hidden="true" tabindex="-1"></a>    ndvi_plot <span class="op">=</span> axes[<span class="dv">1</span>].imshow(ndvi_mosaic, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=-</span><span class="fl">0.2</span>, vmax<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb52-1102"><a href="#cb52-1102" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'NDVI Mosaic'</span>)</span>
<span id="cb52-1103"><a href="#cb52-1103" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-1104"><a href="#cb52-1104" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(ndvi_plot, ax<span class="op">=</span>axes[<span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb52-1105"><a href="#cb52-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1106"><a href="#cb52-1106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data availability (how many scenes contributed to each pixel)</span></span>
<span id="cb52-1107"><a href="#cb52-1107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This would require tracking per-pixel contributions</span></span>
<span id="cb52-1108"><a href="#cb52-1108" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="ss">f"Scenes used: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'n_scenes'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb52-1109"><a href="#cb52-1109" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Method: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'method'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb52-1110"><a href="#cb52-1110" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Date range: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'date_range'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb52-1111"><a href="#cb52-1111" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Coverage: Central Valley, CA"</span>,</span>
<span id="cb52-1112"><a href="#cb52-1112" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>axes[<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>, verticalalignment<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb52-1113"><a href="#cb52-1113" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].set_title(<span class="st">'Mosaic Info'</span>)</span>
<span id="cb52-1114"><a href="#cb52-1114" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb52-1115"><a href="#cb52-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1116"><a href="#cb52-1116" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb52-1117"><a href="#cb52-1117" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb52-1118"><a href="#cb52-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1119"><a href="#cb52-1119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"🎨 Temporal mosaic visualization complete"</span>)</span>
<span id="cb52-1120"><a href="#cb52-1120" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1121"><a href="#cb52-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1122"><a href="#cb52-1122" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-1123"><a href="#cb52-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1124"><a href="#cb52-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Analysis-Ready Data Cubes</span></span>
<span id="cb52-1125"><a href="#cb52-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1126"><a href="#cb52-1126" aria-hidden="true" tabindex="-1"></a>Now let's create analysis-ready data cubes that can be used for time series analysis and machine learning.</span>
<span id="cb52-1127"><a href="#cb52-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1128"><a href="#cb52-1128" aria-hidden="true" tabindex="-1"></a><span class="fu">### Build Temporal Data Cube</span></span>
<span id="cb52-1129"><a href="#cb52-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1132"><a href="#cb52-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1133"><a href="#cb52-1133" aria-hidden="true" tabindex="-1"></a><span class="co"># Build temporal data cube using the function we defined earlier</span></span>
<span id="cb52-1134"><a href="#cb52-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1135"><a href="#cb52-1135" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the data cube</span></span>
<span id="cb52-1136"><a href="#cb52-1136" aria-hidden="true" tabindex="-1"></a>datacube <span class="op">=</span> build_temporal_datacube(processed_scenes)</span>
<span id="cb52-1137"><a href="#cb52-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1138"><a href="#cb52-1138" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> datacube:</span>
<span id="cb52-1139"><a href="#cb52-1139" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📦 Data Cube Summary:"</span>)</span>
<span id="cb52-1140"><a href="#cb52-1140" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(datacube)</span>
<span id="cb52-1141"><a href="#cb52-1141" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1142"><a href="#cb52-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1143"><a href="#cb52-1143" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time Series Analysis Example</span></span>
<span id="cb52-1144"><a href="#cb52-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1147"><a href="#cb52-1147" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1148"><a href="#cb52-1148" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> datacube:</span>
<span id="cb52-1149"><a href="#cb52-1149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time series for a sample location</span></span>
<span id="cb52-1150"><a href="#cb52-1150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use more robust center selection - assume the spatial dims are the last two</span></span>
<span id="cb52-1151"><a href="#cb52-1151" aria-hidden="true" tabindex="-1"></a>    spatial_dims <span class="op">=</span> [dim <span class="cf">for</span> dim <span class="kw">in</span> datacube[<span class="st">'red'</span>].dims <span class="cf">if</span> dim <span class="op">!=</span> <span class="st">'time'</span>]</span>
<span id="cb52-1152"><a href="#cb52-1152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(spatial_dims) <span class="op">&gt;=</span> <span class="dv">2</span>:</span>
<span id="cb52-1153"><a href="#cb52-1153" aria-hidden="true" tabindex="-1"></a>        y_dim, x_dim <span class="op">=</span> spatial_dims[<span class="dv">0</span>], spatial_dims[<span class="dv">1</span>]</span>
<span id="cb52-1154"><a href="#cb52-1154" aria-hidden="true" tabindex="-1"></a>        center_y_idx <span class="op">=</span> datacube.dims[y_dim] <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb52-1155"><a href="#cb52-1155" aria-hidden="true" tabindex="-1"></a>        center_x_idx <span class="op">=</span> datacube.dims[x_dim] <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb52-1156"><a href="#cb52-1156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract time series at center point using integer indexing</span></span>
<span id="cb52-1157"><a href="#cb52-1157" aria-hidden="true" tabindex="-1"></a>        point_ts <span class="op">=</span> datacube.isel({y_dim: center_y_idx, x_dim: center_x_idx})</span>
<span id="cb52-1158"><a href="#cb52-1158" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"📍 Using spatial dimensions: </span><span class="sc">{</span>y_dim<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>center_y_idx<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>x_dim<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>center_x_idx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1159"><a href="#cb52-1159" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-1160"><a href="#cb52-1160" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️ Cannot determine spatial dimensions for time series analysis"</span>)</span>
<span id="cb52-1161"><a href="#cb52-1161" aria-hidden="true" tabindex="-1"></a>        point_ts <span class="op">=</span> <span class="va">None</span></span>
<span id="cb52-1162"><a href="#cb52-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1163"><a href="#cb52-1163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create time series plots only if we have valid point data</span></span>
<span id="cb52-1164"><a href="#cb52-1164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> point_ts <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb52-1165"><a href="#cb52-1165" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb52-1166"><a href="#cb52-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1167"><a href="#cb52-1167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># NDVI time series</span></span>
<span id="cb52-1168"><a href="#cb52-1168" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'ndvi'</span>], <span class="st">'g-o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb52-1169"><a href="#cb52-1169" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'NDVI Time Series'</span>)</span>
<span id="cb52-1170"><a href="#cb52-1170" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'NDVI'</span>)</span>
<span id="cb52-1171"><a href="#cb52-1171" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb52-1172"><a href="#cb52-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1173"><a href="#cb52-1173" aria-hidden="true" tabindex="-1"></a>        <span class="co"># EVI time series</span></span>
<span id="cb52-1174"><a href="#cb52-1174" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">1</span>].plot(point_ts.time, point_ts[<span class="st">'evi'</span>], <span class="st">'b-o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb52-1175"><a href="#cb52-1175" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'EVI Time Series'</span>)</span>
<span id="cb52-1176"><a href="#cb52-1176" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'EVI'</span>)</span>
<span id="cb52-1177"><a href="#cb52-1177" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb52-1178"><a href="#cb52-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1179"><a href="#cb52-1179" aria-hidden="true" tabindex="-1"></a>        <span class="co"># RGB bands time series</span></span>
<span id="cb52-1180"><a href="#cb52-1180" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'red'</span>], <span class="st">'r-'</span>, label<span class="op">=</span><span class="st">'Red'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb52-1181"><a href="#cb52-1181" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'green'</span>], <span class="st">'g-'</span>, label<span class="op">=</span><span class="st">'Green'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb52-1182"><a href="#cb52-1182" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'blue'</span>], <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'Blue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb52-1183"><a href="#cb52-1183" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'RGB Bands Time Series'</span>)</span>
<span id="cb52-1184"><a href="#cb52-1184" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Reflectance'</span>)</span>
<span id="cb52-1185"><a href="#cb52-1185" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb52-1186"><a href="#cb52-1186" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb52-1187"><a href="#cb52-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1188"><a href="#cb52-1188" aria-hidden="true" tabindex="-1"></a>        <span class="co"># NIR time series</span></span>
<span id="cb52-1189"><a href="#cb52-1189" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].plot(point_ts.time, point_ts[<span class="st">'nir'</span>], <span class="st">'darkred'</span>, marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb52-1190"><a href="#cb52-1190" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'NIR Band Time Series'</span>)</span>
<span id="cb52-1191"><a href="#cb52-1191" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'NIR Reflectance'</span>)</span>
<span id="cb52-1192"><a href="#cb52-1192" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb52-1193"><a href="#cb52-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1194"><a href="#cb52-1194" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb52-1195"><a href="#cb52-1195" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb52-1196"><a href="#cb52-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1197"><a href="#cb52-1197" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"📈 Time series analysis complete"</span>)</span>
<span id="cb52-1198"><a href="#cb52-1198" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Sample location indices: y=</span><span class="sc">{</span>center_y_idx<span class="sc">}</span><span class="ss">, x=</span><span class="sc">{</span>center_x_idx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1199"><a href="#cb52-1199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-1200"><a href="#cb52-1200" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️ Skipping time series plots due to dimension issues"</span>)</span>
<span id="cb52-1201"><a href="#cb52-1201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1202"><a href="#cb52-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1203"><a href="#cb52-1203" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-1204"><a href="#cb52-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1205"><a href="#cb52-1205" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Scalable Batch Processing Workflow</span></span>
<span id="cb52-1206"><a href="#cb52-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1207"><a href="#cb52-1207" aria-hidden="true" tabindex="-1"></a>Finally, let's create a reproducible workflow that can handle larger datasets efficiently.</span>
<span id="cb52-1208"><a href="#cb52-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1209"><a href="#cb52-1209" aria-hidden="true" tabindex="-1"></a><span class="fu">### Preprocessing Pipeline Class</span></span>
<span id="cb52-1210"><a href="#cb52-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1211"><a href="#cb52-1211" aria-hidden="true" tabindex="-1"></a>Now let's use the preprocessing pipeline class we defined earlier.</span>
<span id="cb52-1212"><a href="#cb52-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1213"><a href="#cb52-1213" aria-hidden="true" tabindex="-1"></a><span class="fu">### Initialize and Test the Preprocessing Pipeline</span></span>
<span id="cb52-1214"><a href="#cb52-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1215"><a href="#cb52-1215" aria-hidden="true" tabindex="-1"></a>Now let's create an instance of our preprocessing pipeline:</span>
<span id="cb52-1216"><a href="#cb52-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1219"><a href="#cb52-1219" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1220"><a href="#cb52-1220" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize preprocessor</span></span>
<span id="cb52-1221"><a href="#cb52-1221" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> Sentinel2Preprocessor(</span>
<span id="cb52-1222"><a href="#cb52-1222" aria-hidden="true" tabindex="-1"></a>    output_dir<span class="op">=</span><span class="st">"week2_preprocessed"</span>,</span>
<span id="cb52-1223"><a href="#cb52-1223" aria-hidden="true" tabindex="-1"></a>    target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>,  <span class="co"># UTM Zone 10N for California</span></span>
<span id="cb52-1224"><a href="#cb52-1224" aria-hidden="true" tabindex="-1"></a>    target_resolution<span class="op">=</span><span class="dv">20</span></span>
<span id="cb52-1225"><a href="#cb52-1225" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-1226"><a href="#cb52-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1227"><a href="#cb52-1227" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Preprocessing pipeline ready"</span>)</span>
<span id="cb52-1228"><a href="#cb52-1228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1229"><a href="#cb52-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1230"><a href="#cb52-1230" aria-hidden="true" tabindex="-1"></a><span class="fu">### Run Complete Preprocessing Workflow</span></span>
<span id="cb52-1231"><a href="#cb52-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1234"><a href="#cb52-1234" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1235"><a href="#cb52-1235" aria-hidden="true" tabindex="-1"></a><span class="co"># Define workflow parameters with subset options</span></span>
<span id="cb52-1236"><a href="#cb52-1236" aria-hidden="true" tabindex="-1"></a>workflow_params <span class="op">=</span> {</span>
<span id="cb52-1237"><a href="#cb52-1237" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bbox'</span>: central_valley_bbox,</span>
<span id="cb52-1238"><a href="#cb52-1238" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start_date'</span>: <span class="st">"2024-07-01"</span>,</span>
<span id="cb52-1239"><a href="#cb52-1239" aria-hidden="true" tabindex="-1"></a>    <span class="st">'end_date'</span>: <span class="st">"2024-08-15"</span>,</span>
<span id="cb52-1240"><a href="#cb52-1240" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_scenes'</span>: <span class="dv">5</span>,  <span class="co"># Limit for demonstration</span></span>
<span id="cb52-1241"><a href="#cb52-1241" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subset_bbox'</span>: small_farm_area  <span class="co"># Use fast subset for demo</span></span>
<span id="cb52-1242"><a href="#cb52-1242" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-1243"><a href="#cb52-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1244"><a href="#cb52-1244" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"🚀 Starting complete preprocessing workflow..."</span>)</span>
<span id="cb52-1245"><a href="#cb52-1245" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Area: Central Valley, CA"</span>)</span>
<span id="cb52-1246"><a href="#cb52-1246" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Period: </span><span class="sc">{</span>workflow_params[<span class="st">'start_date'</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>workflow_params[<span class="st">'end_date'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1247"><a href="#cb52-1247" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Subset: </span><span class="sc">{</span>workflow_params[<span class="st">'subset_bbox'</span>]<span class="sc">}</span><span class="ss"> (for faster processing)"</span>)</span>
<span id="cb52-1248"><a href="#cb52-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1249"><a href="#cb52-1249" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Search for scenes</span></span>
<span id="cb52-1250"><a href="#cb52-1250" aria-hidden="true" tabindex="-1"></a>workflow_items <span class="op">=</span> preprocessor.search_scenes(</span>
<span id="cb52-1251"><a href="#cb52-1251" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'bbox'</span>],</span>
<span id="cb52-1252"><a href="#cb52-1252" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'start_date'</span>],</span>
<span id="cb52-1253"><a href="#cb52-1253" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'end_date'</span>],</span>
<span id="cb52-1254"><a href="#cb52-1254" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span>workflow_params[<span class="st">'max_scenes'</span>]</span>
<span id="cb52-1255"><a href="#cb52-1255" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-1256"><a href="#cb52-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1257"><a href="#cb52-1257" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up any existing files for fresh processing</span></span>
<span id="cb52-1258"><a href="#cb52-1258" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb52-1259"><a href="#cb52-1259" aria-hidden="true" tabindex="-1"></a>existing_files <span class="op">=</span> glob.glob(<span class="bu">str</span>(preprocessor.output_dir <span class="op">/</span> <span class="st">"*.nc"</span>))</span>
<span id="cb52-1260"><a href="#cb52-1260" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> existing_files:</span>
<span id="cb52-1261"><a href="#cb52-1261" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"🗑️ Cleaning up </span><span class="sc">{</span><span class="bu">len</span>(existing_files)<span class="sc">}</span><span class="ss"> existing processed files for fresh processing..."</span>)</span>
<span id="cb52-1262"><a href="#cb52-1262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_path <span class="kw">in</span> existing_files:</span>
<span id="cb52-1263"><a href="#cb52-1263" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb52-1264"><a href="#cb52-1264" aria-hidden="true" tabindex="-1"></a>            Path(file_path).unlink()</span>
<span id="cb52-1265"><a href="#cb52-1265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb52-1266"><a href="#cb52-1266" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb52-1267"><a href="#cb52-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1268"><a href="#cb52-1268" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Process scenes with spatial subset (demonstration with simulated data)</span></span>
<span id="cb52-1269"><a href="#cb52-1269" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"📝 For demonstration purposes, we'll create a simplified data cube"</span>)</span>
<span id="cb52-1270"><a href="#cb52-1270" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   In practice, you would process real Sentinel-2 scenes as shown above"</span>)</span>
<span id="cb52-1271"><a href="#cb52-1271" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   Real processing may encounter network issues or incomplete band availability"</span>)</span>
<span id="cb52-1272"><a href="#cb52-1272" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   This simulation ensures consistent results for educational purposes"</span>)</span>
<span id="cb52-1273"><a href="#cb52-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1274"><a href="#cb52-1274" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple demonstration data cube with consistent dimensions</span></span>
<span id="cb52-1275"><a href="#cb52-1275" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-1276"><a href="#cb52-1276" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb52-1277"><a href="#cb52-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1278"><a href="#cb52-1278" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate 3 time steps of a small area (20x20 pixels)</span></span>
<span id="cb52-1279"><a href="#cb52-1279" aria-hidden="true" tabindex="-1"></a>n_time <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb52-1280"><a href="#cb52-1280" aria-hidden="true" tabindex="-1"></a>height, width <span class="op">=</span> <span class="dv">20</span>, <span class="dv">20</span></span>
<span id="cb52-1281"><a href="#cb52-1281" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.date_range(<span class="st">'2024-07-01'</span>, periods<span class="op">=</span>n_time, freq<span class="op">=</span><span class="st">'10D'</span>)</span>
<span id="cb52-1282"><a href="#cb52-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1283"><a href="#cb52-1283" aria-hidden="true" tabindex="-1"></a><span class="co"># Create simulated spectral data</span></span>
<span id="cb52-1284"><a href="#cb52-1284" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)  <span class="co"># For reproducible demonstration</span></span>
<span id="cb52-1285"><a href="#cb52-1285" aria-hidden="true" tabindex="-1"></a>demo_data <span class="op">=</span> {}</span>
<span id="cb52-1286"><a href="#cb52-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1287"><a href="#cb52-1287" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(dates):</span>
<span id="cb52-1288"><a href="#cb52-1288" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate realistic spectral values (scaled 0-1)</span></span>
<span id="cb52-1289"><a href="#cb52-1289" aria-hidden="true" tabindex="-1"></a>    red <span class="op">=</span> np.random.uniform(<span class="fl">0.1</span>, <span class="fl">0.3</span>, (height, width))</span>
<span id="cb52-1290"><a href="#cb52-1290" aria-hidden="true" tabindex="-1"></a>    green <span class="op">=</span> np.random.uniform(<span class="fl">0.1</span>, <span class="fl">0.4</span>, (height, width))</span>
<span id="cb52-1291"><a href="#cb52-1291" aria-hidden="true" tabindex="-1"></a>    blue <span class="op">=</span> np.random.uniform(<span class="fl">0.1</span>, <span class="fl">0.5</span>, (height, width))</span>
<span id="cb52-1292"><a href="#cb52-1292" aria-hidden="true" tabindex="-1"></a>    nir <span class="op">=</span> np.random.uniform(<span class="fl">0.3</span>, <span class="fl">0.8</span>, (height, width))</span>
<span id="cb52-1293"><a href="#cb52-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1294"><a href="#cb52-1294" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some spatial pattern (vegetation gradient)</span></span>
<span id="cb52-1295"><a href="#cb52-1295" aria-hidden="true" tabindex="-1"></a>    y, x <span class="op">=</span> np.ogrid[:height, :width]</span>
<span id="cb52-1296"><a href="#cb52-1296" aria-hidden="true" tabindex="-1"></a>    vegetation_pattern <span class="op">=</span> np.exp(<span class="op">-</span>((y<span class="op">-</span>height<span class="op">//</span><span class="dv">2</span>)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (x<span class="op">-</span>width<span class="op">//</span><span class="dv">2</span>)<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (height<span class="op">*</span>width<span class="op">/</span><span class="dv">4</span>))</span>
<span id="cb52-1297"><a href="#cb52-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1298"><a href="#cb52-1298" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enhance NIR in vegetated areas</span></span>
<span id="cb52-1299"><a href="#cb52-1299" aria-hidden="true" tabindex="-1"></a>    nir <span class="op">=</span> nir <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> vegetation_pattern</span>
<span id="cb52-1300"><a href="#cb52-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1301"><a href="#cb52-1301" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create xarray DataArrays</span></span>
<span id="cb52-1302"><a href="#cb52-1302" aria-hidden="true" tabindex="-1"></a>    coords <span class="op">=</span> {<span class="st">'y'</span>: <span class="bu">range</span>(height), <span class="st">'x'</span>: <span class="bu">range</span>(width)}</span>
<span id="cb52-1303"><a href="#cb52-1303" aria-hidden="true" tabindex="-1"></a>    scene_data <span class="op">=</span> {</span>
<span id="cb52-1304"><a href="#cb52-1304" aria-hidden="true" tabindex="-1"></a>        <span class="st">'red'</span>: xr.DataArray(red, coords<span class="op">=</span>coords, dims<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'x'</span>]),</span>
<span id="cb52-1305"><a href="#cb52-1305" aria-hidden="true" tabindex="-1"></a>        <span class="st">'green'</span>: xr.DataArray(green, coords<span class="op">=</span>coords, dims<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'x'</span>]),</span>
<span id="cb52-1306"><a href="#cb52-1306" aria-hidden="true" tabindex="-1"></a>        <span class="st">'blue'</span>: xr.DataArray(blue, coords<span class="op">=</span>coords, dims<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'x'</span>]),</span>
<span id="cb52-1307"><a href="#cb52-1307" aria-hidden="true" tabindex="-1"></a>        <span class="st">'nir'</span>: xr.DataArray(nir, coords<span class="op">=</span>coords, dims<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'x'</span>])</span>
<span id="cb52-1308"><a href="#cb52-1308" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-1309"><a href="#cb52-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1310"><a href="#cb52-1310" aria-hidden="true" tabindex="-1"></a>    demo_data[date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)] <span class="op">=</span> scene_data</span>
<span id="cb52-1311"><a href="#cb52-1311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1312"><a href="#cb52-1312" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📊 Created demonstration data cube with </span><span class="sc">{</span><span class="bu">len</span>(demo_data)<span class="sc">}</span><span class="ss"> time steps"</span>)</span>
<span id="cb52-1313"><a href="#cb52-1313" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Spatial dimensions: </span><span class="sc">{</span>height<span class="sc">}</span><span class="ss"> × </span><span class="sc">{</span>width<span class="sc">}</span><span class="ss"> pixels"</span>)</span>
<span id="cb52-1314"><a href="#cb52-1314" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Spectral bands: red, green, blue, nir"</span>)</span>
<span id="cb52-1315"><a href="#cb52-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1316"><a href="#cb52-1316" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Create temporal data cube from demonstration data</span></span>
<span id="cb52-1317"><a href="#cb52-1317" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"🧩 Building temporal data cube..."</span>)</span>
<span id="cb52-1318"><a href="#cb52-1318" aria-hidden="true" tabindex="-1"></a>band_stacks <span class="op">=</span> {band: [] <span class="cf">for</span> band <span class="kw">in</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]}</span>
<span id="cb52-1319"><a href="#cb52-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1320"><a href="#cb52-1320" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> date_str, scene_data <span class="kw">in</span> demo_data.items():</span>
<span id="cb52-1321"><a href="#cb52-1321" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> band_stacks.keys():</span>
<span id="cb52-1322"><a href="#cb52-1322" aria-hidden="true" tabindex="-1"></a>        band_stacks[band].append(scene_data[band])</span>
<span id="cb52-1323"><a href="#cb52-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1324"><a href="#cb52-1324" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack along time dimension</span></span>
<span id="cb52-1325"><a href="#cb52-1325" aria-hidden="true" tabindex="-1"></a>cube_data <span class="op">=</span> {}</span>
<span id="cb52-1326"><a href="#cb52-1326" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> band, stack <span class="kw">in</span> band_stacks.items():</span>
<span id="cb52-1327"><a href="#cb52-1327" aria-hidden="true" tabindex="-1"></a>    cube_data[band] <span class="op">=</span> xr.concat(stack, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb52-1328"><a href="#cb52-1328" aria-hidden="true" tabindex="-1"></a>    cube_data[band] <span class="op">=</span> cube_data[band].assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb52-1329"><a href="#cb52-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1330"><a href="#cb52-1330" aria-hidden="true" tabindex="-1"></a><span class="co"># Create final datacube</span></span>
<span id="cb52-1331"><a href="#cb52-1331" aria-hidden="true" tabindex="-1"></a>final_cube <span class="op">=</span> xr.Dataset(cube_data)</span>
<span id="cb52-1332"><a href="#cb52-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1333"><a href="#cb52-1333" aria-hidden="true" tabindex="-1"></a><span class="co"># Add vegetation indices</span></span>
<span id="cb52-1334"><a href="#cb52-1334" aria-hidden="true" tabindex="-1"></a>final_cube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((final_cube[<span class="st">'nir'</span>] <span class="op">-</span> final_cube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb52-1335"><a href="#cb52-1335" aria-hidden="true" tabindex="-1"></a>                      (final_cube[<span class="st">'nir'</span>] <span class="op">+</span> final_cube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb52-1336"><a href="#cb52-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1337"><a href="#cb52-1337" aria-hidden="true" tabindex="-1"></a>final_cube[<span class="st">'evi'</span>] <span class="op">=</span> (<span class="fl">2.5</span> <span class="op">*</span> (final_cube[<span class="st">'nir'</span>] <span class="op">-</span> final_cube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb52-1338"><a href="#cb52-1338" aria-hidden="true" tabindex="-1"></a>                     (final_cube[<span class="st">'nir'</span>] <span class="op">+</span> <span class="dv">6</span> <span class="op">*</span> final_cube[<span class="st">'red'</span>] <span class="op">-</span> <span class="fl">7.5</span> <span class="op">*</span> final_cube[<span class="st">'blue'</span>] <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb52-1339"><a href="#cb52-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1340"><a href="#cb52-1340" aria-hidden="true" tabindex="-1"></a><span class="co"># Add metadata</span></span>
<span id="cb52-1341"><a href="#cb52-1341" aria-hidden="true" tabindex="-1"></a>final_cube.attrs.update({</span>
<span id="cb52-1342"><a href="#cb52-1342" aria-hidden="true" tabindex="-1"></a>    <span class="st">'title'</span>: <span class="st">'Demonstration Sentinel-2 Data Cube'</span>,</span>
<span id="cb52-1343"><a href="#cb52-1343" aria-hidden="true" tabindex="-1"></a>    <span class="st">'description'</span>: <span class="st">'Simulated cloud-masked, reprojected temporal stack'</span>,</span>
<span id="cb52-1344"><a href="#cb52-1344" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_scenes'</span>: <span class="bu">len</span>(demo_data),</span>
<span id="cb52-1345"><a href="#cb52-1345" aria-hidden="true" tabindex="-1"></a>    <span class="st">'time_range'</span>: <span class="ss">f"</span><span class="sc">{</span>dates[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dates[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb52-1346"><a href="#cb52-1346" aria-hidden="true" tabindex="-1"></a>    <span class="st">'demo'</span>: <span class="va">True</span></span>
<span id="cb52-1347"><a href="#cb52-1347" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-1348"><a href="#cb52-1348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1349"><a href="#cb52-1349" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎉 Demonstration workflow completed successfully!"</span>)</span>
<span id="cb52-1350"><a href="#cb52-1350" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Time steps: </span><span class="sc">{</span><span class="bu">len</span>(dates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1351"><a href="#cb52-1351" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Data cube shape: </span><span class="sc">{</span>final_cube[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1352"><a href="#cb52-1352" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Variables: </span><span class="sc">{</span><span class="bu">list</span>(final_cube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1353"><a href="#cb52-1353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1354"><a href="#cb52-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1355"><a href="#cb52-1355" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Processing Summary Report</span></span>
<span id="cb52-1356"><a href="#cb52-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1359"><a href="#cb52-1359" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb52-1360"><a href="#cb52-1360" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate processing summary</span></span>
<span id="cb52-1361"><a href="#cb52-1361" aria-hidden="true" tabindex="-1"></a>output_files <span class="op">=</span> <span class="bu">list</span>(preprocessor.output_dir.glob(<span class="st">"*.nc"</span>))</span>
<span id="cb52-1362"><a href="#cb52-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1363"><a href="#cb52-1363" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📋 Processing Summary Report"</span>)</span>
<span id="cb52-1364"><a href="#cb52-1364" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb52-1365"><a href="#cb52-1365" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output Directory: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1366"><a href="#cb52-1366" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Files Created: </span><span class="sc">{</span><span class="bu">len</span>(output_files)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1367"><a href="#cb52-1367" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Processing Parameters:"</span>)</span>
<span id="cb52-1368"><a href="#cb52-1368" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Target CRS: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>target_crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1369"><a href="#cb52-1369" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Target Resolution: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>target_resolution<span class="sc">}</span><span class="ss">m"</span>)</span>
<span id="cb52-1370"><a href="#cb52-1370" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Max Cloud Cover: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span>
<span id="cb52-1371"><a href="#cb52-1371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1372"><a href="#cb52-1372" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📁 Output Files:"</span>)</span>
<span id="cb52-1373"><a href="#cb52-1373" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> file_path <span class="kw">in</span> <span class="bu">sorted</span>(output_files):</span>
<span id="cb52-1374"><a href="#cb52-1374" aria-hidden="true" tabindex="-1"></a>    file_size <span class="op">=</span> file_path.stat().st_size <span class="op">/</span> (<span class="dv">1024</span><span class="op">*</span><span class="dv">1024</span>)  <span class="co"># MB</span></span>
<span id="cb52-1375"><a href="#cb52-1375" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>file_size<span class="sc">:.1f}</span><span class="ss"> MB)"</span>)</span>
<span id="cb52-1376"><a href="#cb52-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1377"><a href="#cb52-1377" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if final_cube was created successfully</span></span>
<span id="cb52-1378"><a href="#cb52-1378" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb52-1379"><a href="#cb52-1379" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> final_cube:</span>
<span id="cb52-1380"><a href="#cb52-1380" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Final Data Cube Statistics:"</span>)</span>
<span id="cb52-1381"><a href="#cb52-1381" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Shape: </span><span class="sc">{</span>final_cube<span class="sc">.</span>dims<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1382"><a href="#cb52-1382" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Variables: </span><span class="sc">{</span><span class="bu">list</span>(final_cube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-1383"><a href="#cb52-1383" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Memory usage: ~</span><span class="sc">{</span>final_cube<span class="sc">.</span>nbytes <span class="op">/</span> (<span class="dv">1024</span><span class="op">**</span><span class="dv">2</span>)<span class="sc">:.1f}</span><span class="ss"> MB"</span>)</span>
<span id="cb52-1384"><a href="#cb52-1384" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb52-1385"><a href="#cb52-1385" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Final Data Cube: Not created (no valid data processed)"</span>)</span>
<span id="cb52-1386"><a href="#cb52-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1387"><a href="#cb52-1387" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🚀 Ready for Week 3: Machine Learning on Remote Sensing!"</span>)</span>
<span id="cb52-1388"><a href="#cb52-1388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1389"><a href="#cb52-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1390"><a href="#cb52-1390" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb52-1391"><a href="#cb52-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1392"><a href="#cb52-1392" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb52-1393"><a href="#cb52-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1394"><a href="#cb52-1394" aria-hidden="true" tabindex="-1"></a>🎉 **Excellent work!** You've built a production-ready preprocessing pipeline for Sentinel-2 imagery.</span>
<span id="cb52-1395"><a href="#cb52-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1396"><a href="#cb52-1396" aria-hidden="true" tabindex="-1"></a><span class="fu">### What You Accomplished:</span></span>
<span id="cb52-1397"><a href="#cb52-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1398"><a href="#cb52-1398" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Multi-scene Data Discovery**: Searched and organized multiple satellite scenes</span>
<span id="cb52-1399"><a href="#cb52-1399" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Automated Cloud Masking**: Used Scene Classification Layer for quality filtering</span>
<span id="cb52-1400"><a href="#cb52-1400" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Spatial Harmonization**: Reprojected and aligned multiple scenes</span>
<span id="cb52-1401"><a href="#cb52-1401" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Temporal Compositing**: Created cloud-free mosaics using median compositing</span>
<span id="cb52-1402"><a href="#cb52-1402" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Analysis-Ready Data Cubes**: Built time series datasets for analysis</span>
<span id="cb52-1403"><a href="#cb52-1403" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Scalable Workflows**: Implemented batch processing with parallel execution</span>
<span id="cb52-1404"><a href="#cb52-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1405"><a href="#cb52-1405" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Takeaways:</span></span>
<span id="cb52-1406"><a href="#cb52-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1407"><a href="#cb52-1407" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Scene Classification Layer is powerful** - automates cloud/shadow detection</span>
<span id="cb52-1408"><a href="#cb52-1408" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reprojection is essential** - ensures scenes can be combined seamlessly</span>
<span id="cb52-1409"><a href="#cb52-1409" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Temporal compositing reduces clouds** - median filtering creates cleaner datasets</span>
<span id="cb52-1410"><a href="#cb52-1410" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Data cubes enable time series analysis** - organize data for trend detection</span>
<span id="cb52-1411"><a href="#cb52-1411" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Batch processing scales** - handle large datasets efficiently</span>
<span id="cb52-1412"><a href="#cb52-1412" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Spatial subsetting accelerates development** - process small areas quickly for testing and learning</span>
<span id="cb52-1413"><a href="#cb52-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1414"><a href="#cb52-1414" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb52-1415"><a href="#cb52-1415" aria-hidden="true" tabindex="-1"></a><span class="fu">## Performance Benefits of Spatial Subsetting</span></span>
<span id="cb52-1416"><a href="#cb52-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1417"><a href="#cb52-1417" aria-hidden="true" tabindex="-1"></a>**Without subsetting (full scenes)**:</span>
<span id="cb52-1418"><a href="#cb52-1418" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Download: ~100MB+ per scene</span>
<span id="cb52-1419"><a href="#cb52-1419" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Processing: 2-5 minutes per scene</span>
<span id="cb52-1420"><a href="#cb52-1420" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Memory: 1-2GB RAM required</span>
<span id="cb52-1421"><a href="#cb52-1421" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Storage: 500MB+ per processed scene</span>
<span id="cb52-1422"><a href="#cb52-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1423"><a href="#cb52-1423" aria-hidden="true" tabindex="-1"></a>**With spatial subsetting (20km × 20km)**:</span>
<span id="cb52-1424"><a href="#cb52-1424" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Download: ~1-5MB per subset</span>
<span id="cb52-1425"><a href="#cb52-1425" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Processing: 10-30 seconds per subset</span>
<span id="cb52-1426"><a href="#cb52-1426" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Memory: 100-200MB RAM required</span>
<span id="cb52-1427"><a href="#cb52-1427" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Storage: 10-50MB per processed subset</span>
<span id="cb52-1428"><a href="#cb52-1428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1429"><a href="#cb52-1429" aria-hidden="true" tabindex="-1"></a>**Perfect for**: Learning, prototyping, testing algorithms, focused analysis</span>
<span id="cb52-1430"><a href="#cb52-1430" aria-hidden="true" tabindex="-1"></a>**Scale up to**: Full scenes when ready for production analysis</span>
<span id="cb52-1431"><a href="#cb52-1431" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb52-1432"><a href="#cb52-1432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1433"><a href="#cb52-1433" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb52-1434"><a href="#cb52-1434" aria-hidden="true" tabindex="-1"></a><span class="fu">## Troubleshooting Common Issues</span></span>
<span id="cb52-1435"><a href="#cb52-1435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1436"><a href="#cb52-1436" aria-hidden="true" tabindex="-1"></a>**Low valid pixel fractions**: If scenes have &lt;30% valid pixels due to clouds:</span>
<span id="cb52-1437"><a href="#cb52-1437" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Lower the <span class="in">`min_valid_fraction`</span> threshold (e.g., 0.1 instead of 0.3)</span>
<span id="cb52-1438"><a href="#cb52-1438" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Try different time periods with less cloud cover</span>
<span id="cb52-1439"><a href="#cb52-1439" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use larger spatial subsets to increase the chance of finding clear pixels</span>
<span id="cb52-1440"><a href="#cb52-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1441"><a href="#cb52-1441" aria-hidden="true" tabindex="-1"></a>**Missing netCDF4 errors**: If you see "No module named 'netCDF4'":</span>
<span id="cb52-1442"><a href="#cb52-1442" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Install with: <span class="in">`conda install netcdf4`</span> or <span class="in">`mamba install netcdf4`</span></span>
<span id="cb52-1443"><a href="#cb52-1443" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The code will automatically fallback to scipy or zarr formats</span>
<span id="cb52-1444"><a href="#cb52-1444" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This doesn't affect functionality, just file format</span>
<span id="cb52-1445"><a href="#cb52-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1446"><a href="#cb52-1446" aria-hidden="true" tabindex="-1"></a>**Memory issues**: If processing fails due to memory:</span>
<span id="cb52-1447"><a href="#cb52-1447" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use smaller spatial subsets</span>
<span id="cb52-1448"><a href="#cb52-1448" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Process fewer scenes at once</span>
<span id="cb52-1449"><a href="#cb52-1449" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Reduce the number of parallel workers (<span class="in">`max_workers=1`</span>)</span>
<span id="cb52-1450"><a href="#cb52-1450" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb52-1451"><a href="#cb52-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1452"><a href="#cb52-1452" aria-hidden="true" tabindex="-1"></a><span class="fu">### Course Integration</span></span>
<span id="cb52-1453"><a href="#cb52-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1454"><a href="#cb52-1454" aria-hidden="true" tabindex="-1"></a>Building on Week 1's single-scene analysis, this week scales to production workflows essential for geospatial AI applications. Your preprocessing pipeline outputs will be the foundation for machine learning workflows.</span>
<span id="cb52-1455"><a href="#cb52-1455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1456"><a href="#cb52-1456" aria-hidden="true" tabindex="-1"></a><span class="fu">### Next Week Preview:</span></span>
<span id="cb52-1457"><a href="#cb52-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1458"><a href="#cb52-1458" aria-hidden="true" tabindex="-1"></a>In **Week 3: Fine-tuning Foundation Models**, we'll use your preprocessed data to **train specialized models on land cover patches**:</span>
<span id="cb52-1459"><a href="#cb52-1459" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Extract training patches from your data cubes</span>
<span id="cb52-1460"><a href="#cb52-1460" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create labeled datasets for supervised learning</span>
<span id="cb52-1461"><a href="#cb52-1461" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build and train convolutional neural networks</span>
<span id="cb52-1462"><a href="#cb52-1462" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compare different CNN architectures</span>
<span id="cb52-1463"><a href="#cb52-1463" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Evaluate model performance on real satellite imagery</span>
<span id="cb52-1464"><a href="#cb52-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1465"><a href="#cb52-1465" aria-hidden="true" tabindex="-1"></a>Your preprocessing pipeline outputs will be the foundation for machine learning workflows!</span>
<span id="cb52-1466"><a href="#cb52-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1467"><a href="#cb52-1467" aria-hidden="true" tabindex="-1"></a><span class="fu">## Resources</span></span>
<span id="cb52-1468"><a href="#cb52-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1469"><a href="#cb52-1469" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Sentinel-2 Scene Classification Layer</span><span class="co">](https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/level-2a/algorithm)</span></span>
<span id="cb52-1470"><a href="#cb52-1470" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Rasterio Reprojection Guide</span><span class="co">](https://rasterio.readthedocs.io/en/latest/topics/reproject.html)</span></span>
<span id="cb52-1471"><a href="#cb52-1471" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Xarray User Guide for Geosciences</span><span class="co">](https://docs.xarray.dev/en/stable/user-guide/index.html)</span></span>
<span id="cb52-1472"><a href="#cb52-1472" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Dask for Geospatial Data</span><span class="co">](https://docs.dask.org/en/latest/array.html)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/geog-logo.png" class="img-fluid figure-img" width="250"></p>
<figcaption>Department of Geography logo</figcaption>
</figure>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This website is built with <a href="https://github.com/kcaylor/GEOG-288KC-geospatial-foundation-models"><i class="fa-brands fa-github" title="the github octocat logo" aria-label="github"></i></a> and <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>