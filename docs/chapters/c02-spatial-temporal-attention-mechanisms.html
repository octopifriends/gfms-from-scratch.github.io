<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 2: Rapid Remote Sensing Preprocessing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">GEOG 288KC</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">üè† home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Syllabus.html"> 
<span class="menu-text">üìã syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-sessions" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üíª weekly sessions</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-weekly-sessions">    
        <li>
    <a class="dropdown-item" href="../chapters/c01-geospatial-data-foundations.html">
 <span class="dropdown-text">Week 1 - üöÄ Core Tools and Data Access</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c02-spatial-temporal-attention-mechanisms.html">
 <span class="dropdown-text">Week 2 - ‚ö° Rapid Remote Sensing Preprocessing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c03-complete-gfm-architecture.html">
 <span class="dropdown-text">Week 3 - ü§ñ Machine Learning on Remote Sensing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c04-pretraining-implementation.html">
 <span class="dropdown-text">Week 4 - üèóÔ∏è Foundation Models in Practice</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c05-training-loop-optimization.html">
 <span class="dropdown-text">Week 5 - üîß Fine-Tuning &amp; Transfer Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/c06-model-evaluation-analysis.html">
 <span class="dropdown-text">Week 6 - ‚è∞ Spatiotemporal Modeling &amp; Projects</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cheatsheets" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üëÄ Cheatsheets</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-cheatsheets">    
        <li class="dropdown-header">üèóÔ∏è Foundation Models &amp; AI</li>
        <li>
    <a class="dropdown-item" href="../chapters/c00a-foundation_model_architectures.html">
 <span class="dropdown-text">Foundation Model Architectures</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/gfm_architecture.html">
 <span class="dropdown-text">GFM Architecture Cheatsheet</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/finetuning_basics.html">
 <span class="dropdown-text">Fine-tuning Basics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/multimodal_learning.html">
 <span class="dropdown-text">Multi-modal Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/model_evaluation_validation.html">
 <span class="dropdown-text">Model Evaluation &amp; Validation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/loading_models.html">
 <span class="dropdown-text">Loading Pre-trained Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/model_inference.html">
 <span class="dropdown-text">Model Inference &amp; Feature Extraction</span></a>
  </li>  
        <li class="dropdown-header">üó∫Ô∏è Geospatial Data &amp; Remote Sensing</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/geospatial_data_remote_sensing.html">
 <span class="dropdown-text">Geospatial Data &amp; Remote Sensing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/geobench_datasets.html">
 <span class="dropdown-text">GEO-Bench Datasets</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/stac_apis.html">
 <span class="dropdown-text">STAC APIs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/rasterio_basics.html">
 <span class="dropdown-text">Rasterio Basics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/xarray_basics.html">
 <span class="dropdown-text">Xarray for Multi-dimensional Data</span></a>
  </li>  
        <li class="dropdown-header">üî• PyTorch &amp; Deep Learning</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/pytorch_tensors.html">
 <span class="dropdown-text">PyTorch Tensors</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/torchgeo_basics.html">
 <span class="dropdown-text">TorchGeo Datasets &amp; Transforms</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/dataloader_satellite.html">
 <span class="dropdown-text">Data Loading for Satellite Imagery</span></a>
  </li>  
        <li class="dropdown-header">üìä Visualization &amp; Analysis</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/plotting_satellite.html">
 <span class="dropdown-text">Plotting Satellite Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/folium_basics.html">
 <span class="dropdown-text">Interactive Maps with Folium</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/matplotlib_geospatial.html">
 <span class="dropdown-text">Geospatial Plotting with Matplotlib</span></a>
  </li>  
        <li class="dropdown-header">‚òÅÔ∏è Deployment &amp; Scaling</li>
        <li>
    <a class="dropdown-item" href="../extras/cheatsheets/cloud_scalable_computing.html">
 <span class="dropdown-text">Cloud &amp; Scalable Computing</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-extras" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">üìñ extras</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-extras">    
        <li>
    <a class="dropdown-item" href="../extras/resources/course_resources.html">
 <span class="dropdown-text">üìö Reference Materials</span></a>
  </li>  
        <li class="dropdown-header">üéØ Practical Examples</li>
        <li>
    <a class="dropdown-item" href="../extras/examples/normalization_comparison.html">
 <span class="dropdown-text">Normalization Comparison</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/resnet.html">
 <span class="dropdown-text">ResNet Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/text_encoder.html">
 <span class="dropdown-text">Text Encoder</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/tiling-and-patches.html">
 <span class="dropdown-text">Tiling and Patches</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/examples/terratorch_workflows.html">
 <span class="dropdown-text">TerraTorch Workflows</span></a>
  </li>  
        <li class="dropdown-header">üìÅ Project Templates</li>
        <li>
    <a class="dropdown-item" href="../extras/projects/project-proposal-template.html">
 <span class="dropdown-text">Project Proposal Template</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../extras/projects/mvp-template.html">
 <span class="dropdown-text">Project Results Template</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kcaylor/GEOG-288KC-geospatial-foundation-models" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">Week 2: Rapid Remote Sensing Preprocessing</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead">Building efficient pipelines for Sentinel-2 preprocessing</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#session-overview" id="toc-session-overview" class="nav-link" data-scroll-target="#session-overview">Session Overview</a></li>
  <li><a href="#step-1-multi-scene-data-discovery" id="toc-step-1-multi-scene-data-discovery" class="nav-link" data-scroll-target="#step-1-multi-scene-data-discovery">Step 1: Multi-Scene Data Discovery</a>
  <ul class="collapse">
  <li><a href="#define-study-area-and-time-range" id="toc-define-study-area-and-time-range" class="nav-link" data-scroll-target="#define-study-area-and-time-range">Define Study Area and Time Range</a></li>
  <li><a href="#search-for-multiple-scenes" id="toc-search-for-multiple-scenes" class="nav-link" data-scroll-target="#search-for-multiple-scenes">Search for Multiple Scenes</a></li>
  <li><a href="#visualize-scene-coverage" id="toc-visualize-scene-coverage" class="nav-link" data-scroll-target="#visualize-scene-coverage">Visualize Scene Coverage</a></li>
  </ul></li>
  <li><a href="#step-2-cloud-masking-pipeline" id="toc-step-2-cloud-masking-pipeline" class="nav-link" data-scroll-target="#step-2-cloud-masking-pipeline">Step 2: Cloud Masking Pipeline</a>
  <ul class="collapse">
  <li><a href="#understanding-scene-classification-layer" id="toc-understanding-scene-classification-layer" class="nav-link" data-scroll-target="#understanding-scene-classification-layer">Understanding Scene Classification Layer</a></li>
  <li><a href="#load-scene-with-cloud-mask" id="toc-load-scene-with-cloud-mask" class="nav-link" data-scroll-target="#load-scene-with-cloud-mask">Load Scene with Cloud Mask</a></li>
  <li><a href="#visualize-cloud-masking-results" id="toc-visualize-cloud-masking-results" class="nav-link" data-scroll-target="#visualize-cloud-masking-results">Visualize Cloud Masking Results</a></li>
  </ul></li>
  <li><a href="#step-3-reprojection-and-mosaicking" id="toc-step-3-reprojection-and-mosaicking" class="nav-link" data-scroll-target="#step-3-reprojection-and-mosaicking">Step 3: Reprojection and Mosaicking</a>
  <ul class="collapse">
  <li><a href="#batch-process-multiple-scenes" id="toc-batch-process-multiple-scenes" class="nav-link" data-scroll-target="#batch-process-multiple-scenes">Batch Process Multiple Scenes</a></li>
  <li><a href="#create-temporal-mosaic" id="toc-create-temporal-mosaic" class="nav-link" data-scroll-target="#create-temporal-mosaic">Create Temporal Mosaic</a></li>
  </ul></li>
  <li><a href="#step-4-analysis-ready-data-cubes" id="toc-step-4-analysis-ready-data-cubes" class="nav-link" data-scroll-target="#step-4-analysis-ready-data-cubes">Step 4: Analysis-Ready Data Cubes</a>
  <ul class="collapse">
  <li><a href="#build-temporal-data-cube" id="toc-build-temporal-data-cube" class="nav-link" data-scroll-target="#build-temporal-data-cube">Build Temporal Data Cube</a></li>
  <li><a href="#time-series-analysis-example" id="toc-time-series-analysis-example" class="nav-link" data-scroll-target="#time-series-analysis-example">Time Series Analysis Example</a></li>
  </ul></li>
  <li><a href="#step-5-scalable-batch-processing-workflow" id="toc-step-5-scalable-batch-processing-workflow" class="nav-link" data-scroll-target="#step-5-scalable-batch-processing-workflow">Step 5: Scalable Batch Processing Workflow</a>
  <ul class="collapse">
  <li><a href="#create-preprocessing-pipeline-class" id="toc-create-preprocessing-pipeline-class" class="nav-link" data-scroll-target="#create-preprocessing-pipeline-class">Create Preprocessing Pipeline Class</a></li>
  <li><a href="#run-complete-preprocessing-workflow" id="toc-run-complete-preprocessing-workflow" class="nav-link" data-scroll-target="#run-complete-preprocessing-workflow">Run Complete Preprocessing Workflow</a></li>
  <li><a href="#create-processing-summary-report" id="toc-create-processing-summary-report" class="nav-link" data-scroll-target="#create-processing-summary-report">Create Processing Summary Report</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a>
  <ul class="collapse">
  <li><a href="#what-you-accomplished" id="toc-what-you-accomplished" class="nav-link" data-scroll-target="#what-you-accomplished">What You Accomplished:</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways:</a></li>
  <li><a href="#next-week-preview" id="toc-next-week-preview" class="nav-link" data-scroll-target="#next-week-preview">Next Week Preview:</a></li>
  </ul></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This week we‚Äôll build production-ready preprocessing pipelines that can handle multiple Sentinel-2 scenes efficiently. You‚Äôll learn to process entire datasets, not just single scenes, with cloud masking, reprojection, and mosaicking.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning Goals
</div>
</div>
<div class="callout-body-container callout-body">
<p>By the end of this session, you will: - Build reproducible preprocessing pipelines for multiple scenes - Handle cloud masking using Sentinel-2‚Äôs Scene Classification Layer - Reproject and mosaic multiple satellite scenes - Create analysis-ready data cubes with xarray - Optimize workflows with dask for large datasets</p>
</div>
</div>
</section>
<section id="session-overview" class="level2">
<h2 class="anchored" data-anchor-id="session-overview">Session Overview</h2>
<p>Today‚Äôs hands-on workflow:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 19%">
<col style="width: 32%">
<col style="width: 22%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Activity</th>
<th>Tools</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Multi-scene data discovery</td>
<td>pystac-client</td>
<td>Scene inventory</td>
</tr>
<tr class="even">
<td>2</td>
<td>Cloud masking pipeline</td>
<td>rasterio, numpy</td>
<td>Clean pixels only</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Reprojection &amp; mosaicking</td>
<td>rasterio, rioxarray</td>
<td>Unified grid</td>
</tr>
<tr class="even">
<td>4</td>
<td>Analysis-ready data cubes</td>
<td>xarray, dask</td>
<td>Time series ready data</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Batch processing workflow</td>
<td>pathlib, concurrent.futures</td>
<td>Scalable pipeline</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="step-1-multi-scene-data-discovery" class="level2">
<h2 class="anchored" data-anchor-id="step-1-multi-scene-data-discovery">Step 1: Multi-Scene Data Discovery</h2>
<p>Let‚Äôs scale up from Week 1‚Äôs single scene approach to handle multiple scenes across time and space.</p>
<section id="define-study-area-and-time-range" class="level3">
<h3 class="anchored" data-anchor-id="define-study-area-and-time-range">Define Study Area and Time Range</h3>
<div id="046d3204" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Core libraries</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.warp <span class="im">import</span> calculate_default_transform, reproject, Resampling</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.merge <span class="im">import</span> merge</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pystac_client <span class="im">import</span> Client</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client <span class="im">as</span> DaskClient</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up study area - Central Valley, California (agriculture focus)</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>central_valley_bbox <span class="op">=</span> [<span class="op">-</span><span class="fl">121.5</span>, <span class="fl">36.5</span>, <span class="op">-</span><span class="fl">120.0</span>, <span class="fl">38.0</span>]  <span class="co"># [west, south, east, north]</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Define longer time range for trend analysis</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"2024-06-01"</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2024-09-01"</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>max_cloud_cover <span class="op">=</span> <span class="dv">15</span>  <span class="co"># More restrictive for cleaner mosaics</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üó∫Ô∏è Study Area: Central Valley, California"</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üìÖ Time Range: </span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"‚òÅÔ∏è Max Cloud Cover: </span><span class="sc">{</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>üó∫Ô∏è Study Area: Central Valley, California
üìÖ Time Range: 2024-06-01 to 2024-09-01
‚òÅÔ∏è Max Cloud Cover: 15%</code></pre>
</div>
</div>
</section>
<section id="search-for-multiple-scenes" class="level3">
<h3 class="anchored" data-anchor-id="search-for-multiple-scenes">Search for Multiple Scenes</h3>
<div id="b1542c28" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to Microsoft Planetary Computer</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>catalog <span class="op">=</span> Client.<span class="bu">open</span>(<span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced search parameters for multiple scenes</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>search_params <span class="op">=</span> {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"collections"</span>: [<span class="st">"sentinel-2-l2a"</span>],</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bbox"</span>: central_valley_bbox,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"datetime"</span>: <span class="ss">f"</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"query"</span>: {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eo:cloud_cover"</span>: {<span class="st">"lt"</span>: max_cloud_cover}</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"limit"</span>: <span class="dv">50</span>  <span class="co"># Get more scenes for time series</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üîç Searching for multiple Sentinel-2 scenes..."</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>search_results <span class="op">=</span> catalog.search(<span class="op">**</span>search_params)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> <span class="bu">list</span>(search_results.items())</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üì∏ Found </span><span class="sc">{</span><span class="bu">len</span>(items)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Organize scenes by date and tile</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>scene_info <span class="op">=</span> []</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    props <span class="op">=</span> item.properties</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> props[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>]</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    tile_id <span class="op">=</span> item.<span class="bu">id</span>.split(<span class="st">'_'</span>)[<span class="dv">5</span>]  <span class="co"># Extract tile ID from scene name</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    cloud_cover <span class="op">=</span> props.get(<span class="st">'eo:cloud_cover'</span>, <span class="dv">0</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    scene_info.append({</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'id'</span>: item.<span class="bu">id</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'date'</span>: date,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tile'</span>: tile_id,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cloud_cover'</span>: cloud_cover,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'item'</span>: item</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame for easier analysis</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>scenes_df <span class="op">=</span> pd.DataFrame(scene_info)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìä Scene Distribution:"</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Unique dates: </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Unique tiles: </span><span class="sc">{</span>scenes_df[<span class="st">'tile'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Date range: </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Show scenes by tile</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üóÇÔ∏è Scenes by Tile:"</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>tile_counts <span class="op">=</span> scenes_df.groupby(<span class="st">'tile'</span>).size().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tile, count <span class="kw">in</span> tile_counts.head().items():</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    avg_cloud <span class="op">=</span> scenes_df[scenes_df[<span class="st">'tile'</span>] <span class="op">==</span> tile][<span class="st">'cloud_cover'</span>].mean()</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>tile<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> scenes (avg cloud: </span><span class="sc">{</span>avg_cloud<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>üîç Searching for multiple Sentinel-2 scenes...
üì∏ Found 279 scenes

üìä Scene Distribution:
   Unique dates: 34
   Unique tiles: 181
   Date range: 2024-06-02 to 2024-08-31

üóÇÔ∏è Scenes by Tile:
   20240901T011152: 9 scenes (avg cloud: 1.6%)
   20240829T011944: 9 scenes (avg cloud: 0.0%)
   20240826T222522: 9 scenes (avg cloud: 0.9%)
   20240822T022354: 9 scenes (avg cloud: 0.0%)
   20240819T015050: 9 scenes (avg cloud: 0.0%)</code></pre>
</div>
</div>
</section>
<section id="visualize-scene-coverage" class="level3">
<h3 class="anchored" data-anchor-id="visualize-scene-coverage">Visualize Scene Coverage</h3>
<div id="36af544f" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create map showing all scene footprints</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    location<span class="op">=</span>[<span class="fl">37.25</span>, <span class="op">-</span><span class="fl">120.75</span>],  <span class="co"># Center of Central Valley</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    zoom_start<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">'OpenStreetMap'</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add study area boundary</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>folium.Rectangle(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    bounds<span class="op">=</span>[[central_valley_bbox[<span class="dv">1</span>], central_valley_bbox[<span class="dv">0</span>]],</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            [central_valley_bbox[<span class="dv">3</span>], central_valley_bbox[<span class="dv">2</span>]]],</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    weight<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span><span class="st">"Study Area: Central Valley"</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Add scene footprints colored by date</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'blue'</span>, <span class="st">'green'</span>, <span class="st">'orange'</span>, <span class="st">'purple'</span>, <span class="st">'red'</span>]</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>unique_dates <span class="op">=</span> <span class="bu">sorted</span>(scenes_df[<span class="st">'date'</span>].unique())</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(unique_dates[:<span class="dv">5</span>]):  <span class="co"># Show first 5 dates</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    date_scenes <span class="op">=</span> scenes_df[scenes_df[<span class="st">'date'</span>] <span class="op">==</span> date]</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> colors[i <span class="op">%</span> <span class="bu">len</span>(colors)]</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, scene <span class="kw">in</span> date_scenes.iterrows():</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        item <span class="op">=</span> scene[<span class="st">'item'</span>]</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        geom <span class="op">=</span> item.geometry</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add scene footprint</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        folium.GeoJson(</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            geom,</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            style_function<span class="op">=</span><span class="kw">lambda</span> x, color<span class="op">=</span>color: {</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fillColor'</span>: color,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">'color'</span>: color,</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">'weight'</span>: <span class="dv">2</span>,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fillOpacity'</span>: <span class="fl">0.3</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">=</span><span class="ss">f"Date: </span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">&lt;br&gt;Tile: </span><span class="sc">{</span>scene[<span class="st">'tile'</span>]<span class="sc">}</span><span class="ss">&lt;br&gt;Cloud: </span><span class="sc">{</span>scene[<span class="st">'cloud_cover'</span>]<span class="sc">:.1f}</span><span class="ss">%"</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        ).add_to(m)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üó∫Ô∏è Scene coverage map created"</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>üó∫Ô∏è Scene coverage map created</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div style="width:100%;"><div style="position:relative;width:100%;height:0;padding-bottom:60%;"><span style="color:#565656">Make this Notebook Trusted to load map: File -&gt; Trust Notebook</span><iframe srcdoc="<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot; />
    <script src=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js&quot;></script>
    <script src=&quot;https://code.jquery.com/jquery-3.7.1.min.js&quot;></script>
    <script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js&quot;></script>
    <script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js&quot;></script>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css&quot;/>
    
            <meta name=&quot;viewport&quot; content=&quot;width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot; />
            <style>
                #map_a23a75c0ba4c69243dd1446bf362f75f {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
</head>
<body>
    
    
            <div class=&quot;folium-map&quot; id=&quot;map_a23a75c0ba4c69243dd1446bf362f75f&quot; ></div>
        
</body>
<script>
    
    
            var map_a23a75c0ba4c69243dd1446bf362f75f = L.map(
                &quot;map_a23a75c0ba4c69243dd1446bf362f75f&quot;,
                {
                    center: [37.25, -120.75],
                    crs: L.CRS.EPSG3857,
                    ...{
  &quot;zoom&quot;: 8,
  &quot;zoomControl&quot;: true,
  &quot;preferCanvas&quot;: false,
}

                }
            );

            

        
    
            var tile_layer_c044d86df5484335e2204df48cd78bd4 = L.tileLayer(
                &quot;https://tile.openstreetmap.org/{z}/{x}/{y}.png&quot;,
                {
  &quot;minZoom&quot;: 0,
  &quot;maxZoom&quot;: 19,
  &quot;maxNativeZoom&quot;: 19,
  &quot;noWrap&quot;: false,
  &quot;attribution&quot;: &quot;\u0026copy; \u003ca href=\&quot;https://www.openstreetmap.org/copyright\&quot;\u003eOpenStreetMap\u003c/a\u003e contributors&quot;,
  &quot;subdomains&quot;: &quot;abc&quot;,
  &quot;detectRetina&quot;: false,
  &quot;tms&quot;: false,
  &quot;opacity&quot;: 1,
}

            );
        
    
            tile_layer_c044d86df5484335e2204df48cd78bd4.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
            var rectangle_e521181c956b074b9228afff74ea54b8 = L.rectangle(
                [[36.5, -121.5], [38.0, -120.0]],
                {&quot;bubblingMouseEvents&quot;: true, &quot;color&quot;: &quot;red&quot;, &quot;dashArray&quot;: null, &quot;dashOffset&quot;: null, &quot;fill&quot;: false, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.2, &quot;fillRule&quot;: &quot;evenodd&quot;, &quot;lineCap&quot;: &quot;round&quot;, &quot;lineJoin&quot;: &quot;round&quot;, &quot;noClip&quot;: false, &quot;opacity&quot;: 1.0, &quot;smoothFactor&quot;: 1.0, &quot;stroke&quot;: true, &quot;weight&quot;: 3}
            ).addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        var popup_13448c519bc0d543c413e7355dc3dc89 = L.popup({
  &quot;maxWidth&quot;: &quot;100%&quot;,
});

        
            
                var html_ecf4826632b6e0e9c7cfb75ca97931af = $(`<div id=&quot;html_ecf4826632b6e0e9c7cfb75ca97931af&quot; style=&quot;width: 100.0%; height: 100.0%;&quot;>Study Area: Central Valley</div>`)[0];
                popup_13448c519bc0d543c413e7355dc3dc89.setContent(html_ecf4826632b6e0e9c7cfb75ca97931af);
            
        

        rectangle_e521181c956b074b9228afff74ea54b8.bindPopup(popup_13448c519bc0d543c413e7355dc3dc89)
        ;

        
    
    
        function geo_json_d8e235b10ae7aa75518bc58b483486e4_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;blue&quot;, &quot;fillColor&quot;: &quot;blue&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_d8e235b10ae7aa75518bc58b483486e4_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_d8e235b10ae7aa75518bc58b483486e4 = L.geoJson(null, {
                onEachFeature: geo_json_d8e235b10ae7aa75518bc58b483486e4_onEachFeature,
            
                style: geo_json_d8e235b10ae7aa75518bc58b483486e4_styler,
            ...{
}
        });

        function geo_json_d8e235b10ae7aa75518bc58b483486e4_add (data) {
            geo_json_d8e235b10ae7aa75518bc58b483486e4
                .addData(data);
        }
            geo_json_d8e235b10ae7aa75518bc58b483486e4_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0661728, 37.9062984], [-120.0891186, 37.8352618], [-120.1395301, 37.6888719], [-120.1875779, 37.5418041], [-120.2361422, 37.3947807], [-120.2850237, 37.2478917], [-120.333877, 37.101105], [-120.3709737, 36.9890666], [-120.4119725, 37.8980998], [-120.0661728, 37.9062984]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_d8e235b10ae7aa75518bc58b483486e4.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_5368252a69dcecee151bbaf382bccbea_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;blue&quot;, &quot;fillColor&quot;: &quot;blue&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_5368252a69dcecee151bbaf382bccbea_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_5368252a69dcecee151bbaf382bccbea = L.geoJson(null, {
                onEachFeature: geo_json_5368252a69dcecee151bbaf382bccbea_onEachFeature,
            
                style: geo_json_5368252a69dcecee151bbaf382bccbea_styler,
            ...{
}
        });

        function geo_json_5368252a69dcecee151bbaf382bccbea_add (data) {
            geo_json_5368252a69dcecee151bbaf382bccbea
                .addData(data);
        }
            geo_json_5368252a69dcecee151bbaf382bccbea_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3677672, 36.9987506], [-120.3709121, 36.9892526], [-120.3713182, 36.9986681], [-120.3677672, 36.9987506]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_5368252a69dcecee151bbaf382bccbea.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_16f2abb4379da45e120b4e5766b365de_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;blue&quot;, &quot;fillColor&quot;: &quot;blue&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_16f2abb4379da45e120b4e5766b365de_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_16f2abb4379da45e120b4e5766b365de = L.geoJson(null, {
                onEachFeature: geo_json_16f2abb4379da45e120b4e5766b365de_onEachFeature,
            
                style: geo_json_16f2abb4379da45e120b4e5766b365de_styler,
            ...{
}
        });

        function geo_json_16f2abb4379da45e120b4e5766b365de_add (data) {
            geo_json_16f2abb4379da45e120b4e5766b365de
                .addData(data);
        }
            geo_json_16f2abb4379da45e120b4e5766b365de_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3621005, 37.015865], [-120.3824602, 36.9543753], [-120.4308402, 36.8077022], [-120.4790582, 36.6610691], [-120.5276636, 36.5145963], [-120.5773539, 36.3684335], [-120.6246242, 36.2215667], [-120.6716921, 36.0746527], [-120.6848067, 36.0339168], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843], [-120.3621005, 37.015865]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_16f2abb4379da45e120b4e5766b365de.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_f801f4be7e87f70015b003753607d9b5_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_f801f4be7e87f70015b003753607d9b5_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_f801f4be7e87f70015b003753607d9b5 = L.geoJson(null, {
                onEachFeature: geo_json_f801f4be7e87f70015b003753607d9b5_onEachFeature,
            
                style: geo_json_f801f4be7e87f70015b003753607d9b5_styler,
            ...{
}
        });

        function geo_json_f801f4be7e87f70015b003753607d9b5_add (data) {
            geo_json_f801f4be7e87f70015b003753607d9b5
                .addData(data);
        }
            geo_json_f801f4be7e87f70015b003753607d9b5_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.454503, 38.7978946], [-119.1913473, 38.8284398], [-119.1617522, 37.8395955], [-120.4079147, 37.8101079], [-120.454503, 38.7978946]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_f801f4be7e87f70015b003753607d9b5.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_fbda97b8245bc41b7c766493b4f71357_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_fbda97b8245bc41b7c766493b4f71357_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_fbda97b8245bc41b7c766493b4f71357 = L.geoJson(null, {
                onEachFeature: geo_json_fbda97b8245bc41b7c766493b4f71357_onEachFeature,
            
                style: geo_json_fbda97b8245bc41b7c766493b4f71357_styler,
            ...{
}
        });

        function geo_json_fbda97b8245bc41b7c766493b4f71357_add (data) {
            geo_json_fbda97b8245bc41b7c766493b4f71357
                .addData(data);
        }
            geo_json_fbda97b8245bc41b7c766493b4f71357_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.4119725, 37.8980998], [-119.1643298, 37.9276804], [-119.136025, 36.9386673], [-120.367413, 36.9101192], [-120.4119725, 37.8980998]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_fbda97b8245bc41b7c766493b4f71357.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_ae9eddaed60915bd060d5144d876ffd0_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_ae9eddaed60915bd060d5144d876ffd0_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_ae9eddaed60915bd060d5144d876ffd0 = L.geoJson(null, {
                onEachFeature: geo_json_ae9eddaed60915bd060d5144d876ffd0_onEachFeature,
            
                style: geo_json_ae9eddaed60915bd060d5144d876ffd0_styler,
            ...{
}
        });

        function geo_json_ae9eddaed60915bd060d5144d876ffd0_add (data) {
            geo_json_ae9eddaed60915bd060d5144d876ffd0
                .addData(data);
        }
            geo_json_ae9eddaed60915bd060d5144d876ffd0_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3713182, 36.9986681], [-119.1385056, 37.0273077], [-119.1114312, 36.038128], [-120.3286936, 36.0104973], [-120.3713182, 36.9986681]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_ae9eddaed60915bd060d5144d876ffd0.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_f60acf91d14f6912edb2debc14202d42_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_f60acf91d14f6912edb2debc14202d42_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_f60acf91d14f6912edb2debc14202d42 = L.geoJson(null, {
                onEachFeature: geo_json_f60acf91d14f6912edb2debc14202d42_onEachFeature,
            
                style: geo_json_f60acf91d14f6912edb2debc14202d42_styler,
            ...{
}
        });

        function geo_json_f60acf91d14f6912edb2debc14202d42_add (data) {
            geo_json_f60acf91d14f6912edb2debc14202d42
                .addData(data);
        }
            geo_json_f60acf91d14f6912edb2debc14202d42_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.6965296, 38.8262817], [-119.4335472, 38.7945272], [-119.4816378, 37.806857], [-120.7276358, 37.8375122], [-120.6965296, 38.8262817]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_f60acf91d14f6912edb2debc14202d42.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_b31580f594079ed5e4d8564be93ccec6_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_b31580f594079ed5e4d8564be93ccec6_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_b31580f594079ed5e4d8564be93ccec6 = L.geoJson(null, {
                onEachFeature: geo_json_b31580f594079ed5e4d8564be93ccec6_onEachFeature,
            
                style: geo_json_b31580f594079ed5e4d8564be93ccec6_styler,
            ...{
}
        });

        function geo_json_b31580f594079ed5e4d8564be93ccec6_add (data) {
            geo_json_b31580f594079ed5e4d8564be93ccec6
                .addData(data);
        }
            geo_json_b31580f594079ed5e4d8564be93ccec6_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.7249265, 37.9255905], [-119.4774491, 37.8948387], [-119.5234457, 36.9069718], [-120.7546767, 36.9366504], [-120.7249265, 37.9255905]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_b31580f594079ed5e4d8564be93ccec6.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_a280daeba7510f27742b2ba41b9ace75_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_a280daeba7510f27742b2ba41b9ace75_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_a280daeba7510f27742b2ba41b9ace75 = L.geoJson(null, {
                onEachFeature: geo_json_a280daeba7510f27742b2ba41b9ace75_onEachFeature,
            
                style: geo_json_a280daeba7510f27742b2ba41b9ace75_styler,
            ...{
}
        });

        function geo_json_a280daeba7510f27742b2ba41b9ace75_add (data) {
            geo_json_a280daeba7510f27742b2ba41b9ace75
                .addData(data);
        }
            geo_json_a280daeba7510f27742b2ba41b9ace75_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.7520695, 37.0252843], [-119.5194145, 36.9955107], [-119.563414, 36.007451], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_a280daeba7510f27742b2ba41b9ace75.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_dadc86ec9a1a59b0c563931acc489bbb_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_dadc86ec9a1a59b0c563931acc489bbb_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_dadc86ec9a1a59b0c563931acc489bbb = L.geoJson(null, {
                onEachFeature: geo_json_dadc86ec9a1a59b0c563931acc489bbb_onEachFeature,
            
                style: geo_json_dadc86ec9a1a59b0c563931acc489bbb_styler,
            ...{
}
        });

        function geo_json_dadc86ec9a1a59b0c563931acc489bbb_add (data) {
            geo_json_dadc86ec9a1a59b0c563931acc489bbb
                .addData(data);
        }
            geo_json_dadc86ec9a1a59b0c563931acc489bbb_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.0115329, 37.8412183], [-121.0108995, 37.8434163], [-120.9682952, 37.9908182], [-120.9256071, 38.1381503], [-120.88266, 38.285366], [-120.8393857, 38.4325087], [-120.7959228, 38.5796384], [-120.7522505, 38.726786], [-120.7227048, 38.8261231], [-120.5832678, 38.8239923], [-120.6159, 37.8353021], [-121.0115329, 37.8412183]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_dadc86ec9a1a59b0c563931acc489bbb.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_10f75b9aa98b7e81cb2026171a506baf_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_10f75b9aa98b7e81cb2026171a506baf_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_10f75b9aa98b7e81cb2026171a506baf = L.geoJson(null, {
                onEachFeature: geo_json_10f75b9aa98b7e81cb2026171a506baf_onEachFeature,
            
                style: geo_json_10f75b9aa98b7e81cb2026171a506baf_styler,
            ...{
}
        });

        function geo_json_10f75b9aa98b7e81cb2026171a506baf_add (data) {
            geo_json_10f75b9aa98b7e81cb2026171a506baf
                .addData(data);
        }
            geo_json_10f75b9aa98b7e81cb2026171a506baf_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.267433, 36.9436409], [-121.2632436, 36.9582434], [-121.2212438, 37.1056707], [-121.1796672, 37.2532811], [-121.1380228, 37.4009556], [-121.0958403, 37.5484889], [-121.0533928, 37.6959631], [-121.0108995, 37.8434163], [-120.9861733, 37.9289639], [-120.6130578, 37.9233735], [-120.6442676, 36.9345108], [-121.267433, 36.9436409]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_10f75b9aa98b7e81cb2026171a506baf.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_31dfb451af170c3acdd1224bd79c0165_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;green&quot;, &quot;fillColor&quot;: &quot;green&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_31dfb451af170c3acdd1224bd79c0165_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_31dfb451af170c3acdd1224bd79c0165 = L.geoJson(null, {
                onEachFeature: geo_json_31dfb451af170c3acdd1224bd79c0165_onEachFeature,
            
                style: geo_json_31dfb451af170c3acdd1224bd79c0165_styler,
            ...{
}
        });

        function geo_json_31dfb451af170c3acdd1224bd79c0165_add (data) {
            geo_json_31dfb451af170c3acdd1224bd79c0165
                .addData(data);
        }
            geo_json_31dfb451af170c3acdd1224bd79c0165_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.5183132, 36.0462544], [-121.5103068, 36.0728152], [-121.4707947, 36.2209197], [-121.4281425, 36.3680188], [-121.3888727, 36.516128], [-121.345842, 36.6630775], [-121.3055075, 36.8109287], [-121.2632436, 36.9582434], [-121.2422437, 37.0319569], [-120.6415325, 37.0231378], [-120.6713858, 36.034105], [-121.5183132, 36.0462544]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_31dfb451af170c3acdd1224bd79c0165.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_90be3d17e0e2bde0ca11121aac5f7f5c_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_90be3d17e0e2bde0ca11121aac5f7f5c_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_90be3d17e0e2bde0ca11121aac5f7f5c = L.geoJson(null, {
                onEachFeature: geo_json_90be3d17e0e2bde0ca11121aac5f7f5c_onEachFeature,
            
                style: geo_json_90be3d17e0e2bde0ca11121aac5f7f5c_styler,
            ...{
}
        });

        function geo_json_90be3d17e0e2bde0ca11121aac5f7f5c_add (data) {
            geo_json_90be3d17e0e2bde0ca11121aac5f7f5c
                .addData(data);
        }
            geo_json_90be3d17e0e2bde0ca11121aac5f7f5c_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-119.7551269, 38.8148067], [-119.7571805, 38.8089038], [-119.8083666, 38.6624292], [-119.8602582, 38.5161817], [-119.9095229, 38.3693564], [-119.9595296, 38.2228413], [-120.0085501, 38.0760802], [-120.0569574, 37.929252], [-120.0943548, 37.8175276], [-120.4079147, 37.8101079], [-120.454503, 38.7978946], [-119.7551269, 38.8148067]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_90be3d17e0e2bde0ca11121aac5f7f5c.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_6ddd503d977c260bde6edbb8e0fe0a38_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_6ddd503d977c260bde6edbb8e0fe0a38_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_6ddd503d977c260bde6edbb8e0fe0a38 = L.geoJson(null, {
                onEachFeature: geo_json_6ddd503d977c260bde6edbb8e0fe0a38_onEachFeature,
            
                style: geo_json_6ddd503d977c260bde6edbb8e0fe0a38_styler,
            ...{
}
        });

        function geo_json_6ddd503d977c260bde6edbb8e0fe0a38_add (data) {
            geo_json_6ddd503d977c260bde6edbb8e0fe0a38
                .addData(data);
        }
            geo_json_6ddd503d977c260bde6edbb8e0fe0a38_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0646284, 37.906335], [-120.1060296, 37.7826492], [-120.1541438, 37.6358354], [-120.2028871, 37.4891558], [-120.2514029, 37.3423494], [-120.3002045, 37.1955777], [-120.3488734, 37.0487347], [-120.3706861, 36.9826908], [-120.4119725, 37.8980998], [-120.0646284, 37.906335]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_6ddd503d977c260bde6edbb8e0fe0a38.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_3e814cd734a8d0a17fe793df425c8543_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_3e814cd734a8d0a17fe793df425c8543_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_3e814cd734a8d0a17fe793df425c8543 = L.geoJson(null, {
                onEachFeature: geo_json_3e814cd734a8d0a17fe793df425c8543_onEachFeature,
            
                style: geo_json_3e814cd734a8d0a17fe793df425c8543_styler,
            ...{
}
        });

        function geo_json_3e814cd734a8d0a17fe793df425c8543_add (data) {
            geo_json_3e814cd734a8d0a17fe793df425c8543
                .addData(data);
        }
            geo_json_3e814cd734a8d0a17fe793df425c8543_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0646284, 37.906335], [-120.1060296, 37.7826492], [-120.1541438, 37.6358354], [-120.2028871, 37.4891558], [-120.2514029, 37.3423494], [-120.3002045, 37.1955777], [-120.3488734, 37.0487347], [-120.3706861, 36.9826908], [-120.4119725, 37.8980998], [-120.0646284, 37.906335]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_3e814cd734a8d0a17fe793df425c8543.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_e3de0fd6e786fc0f866f08438764858e_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_e3de0fd6e786fc0f866f08438764858e_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_e3de0fd6e786fc0f866f08438764858e = L.geoJson(null, {
                onEachFeature: geo_json_e3de0fd6e786fc0f866f08438764858e_onEachFeature,
            
                style: geo_json_e3de0fd6e786fc0f866f08438764858e_styler,
            ...{
}
        });

        function geo_json_e3de0fd6e786fc0f866f08438764858e_add (data) {
            geo_json_e3de0fd6e786fc0f866f08438764858e
                .addData(data);
        }
            geo_json_e3de0fd6e786fc0f866f08438764858e_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3653635, 36.9988064], [-120.3706356, 36.9828436], [-120.3713182, 36.9986681], [-120.3653635, 36.9988064]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_e3de0fd6e786fc0f866f08438764858e.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_616067d98d919866436edd690eb6d561_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_616067d98d919866436edd690eb6d561_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_616067d98d919866436edd690eb6d561 = L.geoJson(null, {
                onEachFeature: geo_json_616067d98d919866436edd690eb6d561_onEachFeature,
            
                style: geo_json_616067d98d919866436edd690eb6d561_styler,
            ...{
}
        });

        function geo_json_616067d98d919866436edd690eb6d561_add (data) {
            geo_json_616067d98d919866436edd690eb6d561
                .addData(data);
        }
            geo_json_616067d98d919866436edd690eb6d561_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3653635, 36.9988064], [-120.3706356, 36.9828436], [-120.3713182, 36.9986681], [-120.3653635, 36.9988064]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_616067d98d919866436edd690eb6d561.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_708c92b6821d6cd97a76d81d0e05ac02_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_708c92b6821d6cd97a76d81d0e05ac02_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_708c92b6821d6cd97a76d81d0e05ac02 = L.geoJson(null, {
                onEachFeature: geo_json_708c92b6821d6cd97a76d81d0e05ac02_onEachFeature,
            
                style: geo_json_708c92b6821d6cd97a76d81d0e05ac02_styler,
            ...{
}
        });

        function geo_json_708c92b6821d6cd97a76d81d0e05ac02_add (data) {
            geo_json_708c92b6821d6cd97a76d81d0e05ac02
                .addData(data);
        }
            geo_json_708c92b6821d6cd97a76d81d0e05ac02_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-119.759342, 38.8027185], [-119.8083666, 38.6624292], [-119.8602582, 38.5161817], [-119.9095229, 38.3693564], [-119.9595296, 38.2228413], [-120.0085501, 38.0760802], [-120.0569574, 37.929252], [-120.0928926, 37.8218957], [-120.7276358, 37.8375122], [-120.6965296, 38.8262817], [-119.759342, 38.8027185]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_708c92b6821d6cd97a76d81d0e05ac02.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_1c319ea17de3ed4037c06ff3e05f146a_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_1c319ea17de3ed4037c06ff3e05f146a_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_1c319ea17de3ed4037c06ff3e05f146a = L.geoJson(null, {
                onEachFeature: geo_json_1c319ea17de3ed4037c06ff3e05f146a_onEachFeature,
            
                style: geo_json_1c319ea17de3ed4037c06ff3e05f146a_styler,
            ...{
}
        });

        function geo_json_1c319ea17de3ed4037c06ff3e05f146a_add (data) {
            geo_json_1c319ea17de3ed4037c06ff3e05f146a
                .addData(data);
        }
            geo_json_1c319ea17de3ed4037c06ff3e05f146a_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0636396, 37.909289], [-120.1060296, 37.7826492], [-120.1541438, 37.6358354], [-120.2028871, 37.4891558], [-120.2514029, 37.3423494], [-120.3002045, 37.1955777], [-120.3488734, 37.0487347], [-120.3888049, 36.9278311], [-120.7546767, 36.9366504], [-120.7249265, 37.9255905], [-120.0636396, 37.909289]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_1c319ea17de3ed4037c06ff3e05f146a.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_688c91953de6b91d61229a74adf09694_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_688c91953de6b91d61229a74adf09694_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_688c91953de6b91d61229a74adf09694 = L.geoJson(null, {
                onEachFeature: geo_json_688c91953de6b91d61229a74adf09694_onEachFeature,
            
                style: geo_json_688c91953de6b91d61229a74adf09694_styler,
            ...{
}
        });

        function geo_json_688c91953de6b91d61229a74adf09694_add (data) {
            geo_json_688c91953de6b91d61229a74adf09694
                .addData(data);
        }
            geo_json_688c91953de6b91d61229a74adf09694_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3597483, 37.0158081], [-120.3973688, 36.9019016], [-120.4457834, 36.7550418], [-120.4940714, 36.6082331], [-120.5382225, 36.4767954], [-120.5435159, 36.4610484], [-120.5498634, 36.4420946], [-120.5923575, 36.3152929], [-120.6389721, 36.1682105], [-120.6825712, 36.0338641], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843], [-120.3597483, 37.0158081]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_688c91953de6b91d61229a74adf09694.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_451f245650471d7b26d6742e3808a4ed_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_451f245650471d7b26d6742e3808a4ed_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_451f245650471d7b26d6742e3808a4ed = L.geoJson(null, {
                onEachFeature: geo_json_451f245650471d7b26d6742e3808a4ed_onEachFeature,
            
                style: geo_json_451f245650471d7b26d6742e3808a4ed_styler,
            ...{
}
        });

        function geo_json_451f245650471d7b26d6742e3808a4ed_add (data) {
            geo_json_451f245650471d7b26d6742e3808a4ed
                .addData(data);
        }
            geo_json_451f245650471d7b26d6742e3808a4ed_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.8477095, 38.8433146], [-120.5832678, 38.8239923], [-120.6159, 37.8353021], [-121.8632824, 37.853955], [-121.8477095, 38.8433146]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_451f245650471d7b26d6742e3808a4ed.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_1c794d2aa60fa10551f330029b8641dd_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_1c794d2aa60fa10551f330029b8641dd_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_1c794d2aa60fa10551f330029b8641dd = L.geoJson(null, {
                onEachFeature: geo_json_1c794d2aa60fa10551f330029b8641dd_onEachFeature,
            
                style: geo_json_1c794d2aa60fa10551f330029b8641dd_styler,
            ...{
}
        });

        function geo_json_1c794d2aa60fa10551f330029b8641dd_add (data) {
            geo_json_1c794d2aa60fa10551f330029b8641dd
                .addData(data);
        }
            geo_json_1c794d2aa60fa10551f330029b8641dd_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.8619261, 37.9420853], [-120.6130578, 37.9233735], [-120.6442676, 36.9345108], [-121.8768197, 36.9525691], [-121.8619261, 37.9420853]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_1c794d2aa60fa10551f330029b8641dd.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_5e12841b46d6ed2f805eb76f68876332_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;orange&quot;, &quot;fillColor&quot;: &quot;orange&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_5e12841b46d6ed2f805eb76f68876332_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_5e12841b46d6ed2f805eb76f68876332 = L.geoJson(null, {
                onEachFeature: geo_json_5e12841b46d6ed2f805eb76f68876332_onEachFeature,
            
                style: geo_json_5e12841b46d6ed2f805eb76f68876332_styler,
            ...{
}
        });

        function geo_json_5e12841b46d6ed2f805eb76f68876332_add (data) {
            geo_json_5e12841b46d6ed2f805eb76f68876332
                .addData(data);
        }
            geo_json_5e12841b46d6ed2f805eb76f68876332_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.6702467, 36.0718407], [-120.6824415, 36.0342636], [-121.8897603, 36.0515828], [-121.8755145, 37.041254], [-120.6415325, 37.0231378], [-120.6702467, 36.0718407]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_5e12841b46d6ed2f805eb76f68876332.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_8a543d9da19f4aa6b926b0690d1ca4e8_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_8a543d9da19f4aa6b926b0690d1ca4e8_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_8a543d9da19f4aa6b926b0690d1ca4e8 = L.geoJson(null, {
                onEachFeature: geo_json_8a543d9da19f4aa6b926b0690d1ca4e8_onEachFeature,
            
                style: geo_json_8a543d9da19f4aa6b926b0690d1ca4e8_styler,
            ...{
}
        });

        function geo_json_8a543d9da19f4aa6b926b0690d1ca4e8_add (data) {
            geo_json_8a543d9da19f4aa6b926b0690d1ca4e8
                .addData(data);
        }
            geo_json_8a543d9da19f4aa6b926b0690d1ca4e8_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.454503, 38.7978946], [-119.1913473, 38.8284398], [-119.1617522, 37.8395955], [-120.4079147, 37.8101079], [-120.454503, 38.7978946]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_8a543d9da19f4aa6b926b0690d1ca4e8.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_bb593fc16e0b135b44da042e5949dd71_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_bb593fc16e0b135b44da042e5949dd71_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_bb593fc16e0b135b44da042e5949dd71 = L.geoJson(null, {
                onEachFeature: geo_json_bb593fc16e0b135b44da042e5949dd71_onEachFeature,
            
                style: geo_json_bb593fc16e0b135b44da042e5949dd71_styler,
            ...{
}
        });

        function geo_json_bb593fc16e0b135b44da042e5949dd71_add (data) {
            geo_json_bb593fc16e0b135b44da042e5949dd71
                .addData(data);
        }
            geo_json_bb593fc16e0b135b44da042e5949dd71_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.4119725, 37.8980998], [-119.1643298, 37.9276804], [-119.136025, 36.9386673], [-120.367413, 36.9101192], [-120.4119725, 37.8980998]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_bb593fc16e0b135b44da042e5949dd71.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5 = L.geoJson(null, {
                onEachFeature: geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5_onEachFeature,
            
                style: geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5_styler,
            ...{
}
        });

        function geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5_add (data) {
            geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5
                .addData(data);
        }
            geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3713182, 36.9986681], [-119.1385056, 37.0273077], [-119.1114312, 36.038128], [-120.3286936, 36.0104973], [-120.3713182, 36.9986681]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_ca494a7a0b1829efbb3e53b107c4631c_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_ca494a7a0b1829efbb3e53b107c4631c_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_ca494a7a0b1829efbb3e53b107c4631c = L.geoJson(null, {
                onEachFeature: geo_json_ca494a7a0b1829efbb3e53b107c4631c_onEachFeature,
            
                style: geo_json_ca494a7a0b1829efbb3e53b107c4631c_styler,
            ...{
}
        });

        function geo_json_ca494a7a0b1829efbb3e53b107c4631c_add (data) {
            geo_json_ca494a7a0b1829efbb3e53b107c4631c
                .addData(data);
        }
            geo_json_ca494a7a0b1829efbb3e53b107c4631c_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.6965296, 38.8262817], [-119.4335472, 38.7945272], [-119.4816378, 37.806857], [-120.7276358, 37.8375122], [-120.6965296, 38.8262817]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_ca494a7a0b1829efbb3e53b107c4631c.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_3d7d2ea9cc1f733b118682584930e471_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_3d7d2ea9cc1f733b118682584930e471_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_3d7d2ea9cc1f733b118682584930e471 = L.geoJson(null, {
                onEachFeature: geo_json_3d7d2ea9cc1f733b118682584930e471_onEachFeature,
            
                style: geo_json_3d7d2ea9cc1f733b118682584930e471_styler,
            ...{
}
        });

        function geo_json_3d7d2ea9cc1f733b118682584930e471_add (data) {
            geo_json_3d7d2ea9cc1f733b118682584930e471
                .addData(data);
        }
            geo_json_3d7d2ea9cc1f733b118682584930e471_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.7249265, 37.9255905], [-119.4774491, 37.8948387], [-119.5234457, 36.9069718], [-120.7546767, 36.9366504], [-120.7249265, 37.9255905]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_3d7d2ea9cc1f733b118682584930e471.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_4027f171002524df523051b92d3a8a59_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_4027f171002524df523051b92d3a8a59_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_4027f171002524df523051b92d3a8a59 = L.geoJson(null, {
                onEachFeature: geo_json_4027f171002524df523051b92d3a8a59_onEachFeature,
            
                style: geo_json_4027f171002524df523051b92d3a8a59_styler,
            ...{
}
        });

        function geo_json_4027f171002524df523051b92d3a8a59_add (data) {
            geo_json_4027f171002524df523051b92d3a8a59
                .addData(data);
        }
            geo_json_4027f171002524df523051b92d3a8a59_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.7520695, 37.0252843], [-119.5194145, 36.9955107], [-119.563414, 36.007451], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_4027f171002524df523051b92d3a8a59.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_7744d05be2972455498b54d8a49a3fca_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_7744d05be2972455498b54d8a49a3fca_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_7744d05be2972455498b54d8a49a3fca = L.geoJson(null, {
                onEachFeature: geo_json_7744d05be2972455498b54d8a49a3fca_onEachFeature,
            
                style: geo_json_7744d05be2972455498b54d8a49a3fca_styler,
            ...{
}
        });

        function geo_json_7744d05be2972455498b54d8a49a3fca_add (data) {
            geo_json_7744d05be2972455498b54d8a49a3fca
                .addData(data);
        }
            geo_json_7744d05be2972455498b54d8a49a3fca_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.0210451, 37.8413605], [-120.9891046, 37.9518145], [-120.9464325, 38.0991252], [-120.9035884, 38.2463801], [-120.8603581, 38.3935144], [-120.8170823, 38.5407225], [-120.7735805, 38.6879565], [-120.7327663, 38.8262769], [-120.5832678, 38.8239923], [-120.6159, 37.8353021], [-121.0210451, 37.8413605]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_7744d05be2972455498b54d8a49a3fca.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_d5b27b47e6eb2f3305d8b9cea223c65e_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_d5b27b47e6eb2f3305d8b9cea223c65e_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_d5b27b47e6eb2f3305d8b9cea223c65e = L.geoJson(null, {
                onEachFeature: geo_json_d5b27b47e6eb2f3305d8b9cea223c65e_onEachFeature,
            
                style: geo_json_d5b27b47e6eb2f3305d8b9cea223c65e_styler,
            ...{
}
        });

        function geo_json_d5b27b47e6eb2f3305d8b9cea223c65e_add (data) {
            geo_json_d5b27b47e6eb2f3305d8b9cea223c65e
                .addData(data);
        }
            geo_json_d5b27b47e6eb2f3305d8b9cea223c65e_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.2767402, 36.9437772], [-121.2421417, 37.0667065], [-121.2006849, 37.2144642], [-121.158659, 37.3620975], [-121.1165953, 37.5096497], [-121.0742173, 37.6570801], [-121.0317139, 37.8044668], [-120.9956713, 37.9291062], [-120.6130578, 37.9233735], [-120.6442676, 36.9345108], [-121.2767402, 36.9437772]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_d5b27b47e6eb2f3305d8b9cea223c65e.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_772f47c548473cd8f11206b9891d9c1f_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;purple&quot;, &quot;fillColor&quot;: &quot;purple&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_772f47c548473cd8f11206b9891d9c1f_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_772f47c548473cd8f11206b9891d9c1f = L.geoJson(null, {
                onEachFeature: geo_json_772f47c548473cd8f11206b9891d9c1f_onEachFeature,
            
                style: geo_json_772f47c548473cd8f11206b9891d9c1f_styler,
            ...{
}
        });

        function geo_json_772f47c548473cd8f11206b9891d9c1f_add (data) {
            geo_json_772f47c548473cd8f11206b9891d9c1f
                .addData(data);
        }
            geo_json_772f47c548473cd8f11206b9891d9c1f_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.5287941, 36.0464047], [-121.4905054, 36.1816997], [-121.4495655, 36.3292626], [-121.4096976, 36.4771034], [-121.3673597, 36.6242566], [-121.3261024, 36.771779], [-121.2836932, 36.9190732], [-121.2518821, 37.0320984], [-120.6415325, 37.0231378], [-120.6713858, 36.034105], [-121.5287941, 36.0464047]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_772f47c548473cd8f11206b9891d9c1f.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_cd8058f5082b027a8568688381fa36e9_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_cd8058f5082b027a8568688381fa36e9_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_cd8058f5082b027a8568688381fa36e9 = L.geoJson(null, {
                onEachFeature: geo_json_cd8058f5082b027a8568688381fa36e9_onEachFeature,
            
                style: geo_json_cd8058f5082b027a8568688381fa36e9_styler,
            ...{
}
        });

        function geo_json_cd8058f5082b027a8568688381fa36e9_add (data) {
            geo_json_cd8058f5082b027a8568688381fa36e9
                .addData(data);
        }
            geo_json_cd8058f5082b027a8568688381fa36e9_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-119.7646517, 38.8145763], [-119.7970096, 38.7223655], [-119.8494586, 38.5764196], [-119.8983426, 38.4294608], [-119.9484484, 38.2827416], [-119.9980429, 38.1358844], [-120.0466952, 37.9888634], [-120.0941107, 37.8416124], [-120.1024807, 37.8173353], [-120.4079147, 37.8101079], [-120.454503, 38.7978946], [-119.7646517, 38.8145763]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_cd8058f5082b027a8568688381fa36e9.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_b23f8178947bee3ff7a8dea8004e358b_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_b23f8178947bee3ff7a8dea8004e358b_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_b23f8178947bee3ff7a8dea8004e358b = L.geoJson(null, {
                onEachFeature: geo_json_b23f8178947bee3ff7a8dea8004e358b_onEachFeature,
            
                style: geo_json_b23f8178947bee3ff7a8dea8004e358b_styler,
            ...{
}
        });

        function geo_json_b23f8178947bee3ff7a8dea8004e358b_add (data) {
            geo_json_b23f8178947bee3ff7a8dea8004e358b
                .addData(data);
        }
            geo_json_b23f8178947bee3ff7a8dea8004e358b_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0733362, 37.9061286], [-120.0941107, 37.8416124], [-120.1445565, 37.6952955], [-120.1925325, 37.5484247], [-120.2409683, 37.4017572], [-120.2895791, 37.2551667], [-120.3381955, 37.1085098], [-120.3717742, 37.0068172], [-120.4119725, 37.8980998], [-120.0733362, 37.9061286]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_b23f8178947bee3ff7a8dea8004e358b.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_1f5e7b48e01653550d869feea8fd1a84_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_1f5e7b48e01653550d869feea8fd1a84_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_1f5e7b48e01653550d869feea8fd1a84 = L.geoJson(null, {
                onEachFeature: geo_json_1f5e7b48e01653550d869feea8fd1a84_onEachFeature,
            
                style: geo_json_1f5e7b48e01653550d869feea8fd1a84_styler,
            ...{
}
        });

        function geo_json_1f5e7b48e01653550d869feea8fd1a84_add (data) {
            geo_json_1f5e7b48e01653550d869feea8fd1a84
                .addData(data);
        }
            geo_json_1f5e7b48e01653550d869feea8fd1a84_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-119.7687299, 38.8029546], [-119.7970096, 38.7223655], [-119.8494586, 38.5764196], [-119.8983426, 38.4294608], [-119.9484484, 38.2827416], [-119.9980429, 38.1358844], [-120.0466952, 37.9888634], [-120.0941107, 37.8416124], [-120.100841, 37.8220912], [-120.7276358, 37.8375122], [-120.6965296, 38.8262817], [-119.7687299, 38.8029546]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_1f5e7b48e01653550d869feea8fd1a84.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97 = L.geoJson(null, {
                onEachFeature: geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97_onEachFeature,
            
                style: geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97_styler,
            ...{
}
        });

        function geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97_add (data) {
            geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97
                .addData(data);
        }
            geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.0722502, 37.9095013], [-120.0941107, 37.8416124], [-120.1445565, 37.6952955], [-120.1925325, 37.5484247], [-120.2409683, 37.4017572], [-120.2895791, 37.2551667], [-120.3381955, 37.1085098], [-120.3866369, 36.9618059], [-120.3977734, 36.9280473], [-120.7546767, 36.9366504], [-120.7249265, 37.9255905], [-120.0722502, 37.9095013]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_06aa2c63abf0999f7c20b1dcf1e16725_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_06aa2c63abf0999f7c20b1dcf1e16725_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_06aa2c63abf0999f7c20b1dcf1e16725 = L.geoJson(null, {
                onEachFeature: geo_json_06aa2c63abf0999f7c20b1dcf1e16725_onEachFeature,
            
                style: geo_json_06aa2c63abf0999f7c20b1dcf1e16725_styler,
            ...{
}
        });

        function geo_json_06aa2c63abf0999f7c20b1dcf1e16725_add (data) {
            geo_json_06aa2c63abf0999f7c20b1dcf1e16725
                .addData(data);
        }
            geo_json_06aa2c63abf0999f7c20b1dcf1e16725_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-120.3687338, 37.0160252], [-120.3866369, 36.9618059], [-120.4350484, 36.815055], [-120.4834302, 36.6682811], [-120.5322977, 36.5215755], [-120.5824905, 36.3751423], [-120.629312, 36.2279036], [-120.6766164, 36.0809222], [-120.6916783, 36.034079], [-120.7805265, 36.0361759], [-120.7520695, 37.0252843], [-120.3687338, 37.0160252]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_06aa2c63abf0999f7c20b1dcf1e16725.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_8331d30a2809b234d3c1d8fa73f2f1f4_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_8331d30a2809b234d3c1d8fa73f2f1f4_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_8331d30a2809b234d3c1d8fa73f2f1f4 = L.geoJson(null, {
                onEachFeature: geo_json_8331d30a2809b234d3c1d8fa73f2f1f4_onEachFeature,
            
                style: geo_json_8331d30a2809b234d3c1d8fa73f2f1f4_styler,
            ...{
}
        });

        function geo_json_8331d30a2809b234d3c1d8fa73f2f1f4_add (data) {
            geo_json_8331d30a2809b234d3c1d8fa73f2f1f4
                .addData(data);
        }
            geo_json_8331d30a2809b234d3c1d8fa73f2f1f4_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.8477095, 38.8433146], [-120.5832678, 38.8239923], [-120.6159, 37.8353021], [-121.8632824, 37.853955], [-121.8477095, 38.8433146]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_8331d30a2809b234d3c1d8fa73f2f1f4.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
        function geo_json_6d59c3a5b11bbbff234788a4c0bee15d_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.3, &quot;weight&quot;: 2};
            }
        }

        function geo_json_6d59c3a5b11bbbff234788a4c0bee15d_onEachFeature(feature, layer) {

            layer.on({
            });
        };
        var geo_json_6d59c3a5b11bbbff234788a4c0bee15d = L.geoJson(null, {
                onEachFeature: geo_json_6d59c3a5b11bbbff234788a4c0bee15d_onEachFeature,
            
                style: geo_json_6d59c3a5b11bbbff234788a4c0bee15d_styler,
            ...{
}
        });

        function geo_json_6d59c3a5b11bbbff234788a4c0bee15d_add (data) {
            geo_json_6d59c3a5b11bbbff234788a4c0bee15d
                .addData(data);
        }
            geo_json_6d59c3a5b11bbbff234788a4c0bee15d_add({&quot;features&quot;: [{&quot;geometry&quot;: {&quot;coordinates&quot;: [[[-121.8619261, 37.9420853], [-120.6130578, 37.9233735], [-120.6442676, 36.9345108], [-121.8768197, 36.9525691], [-121.8619261, 37.9420853]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_6d59c3a5b11bbbff234788a4c0bee15d.addTo(map_a23a75c0ba4c69243dd1446bf362f75f);
        
    
            var layer_control_3d01a942a157460cfa036f71e1890075_layers = {
                base_layers : {
                    &quot;openstreetmap&quot; : tile_layer_c044d86df5484335e2204df48cd78bd4,
                },
                overlays :  {
                    &quot;macro_element_d8e235b10ae7aa75518bc58b483486e4&quot; : geo_json_d8e235b10ae7aa75518bc58b483486e4,
                    &quot;macro_element_5368252a69dcecee151bbaf382bccbea&quot; : geo_json_5368252a69dcecee151bbaf382bccbea,
                    &quot;macro_element_16f2abb4379da45e120b4e5766b365de&quot; : geo_json_16f2abb4379da45e120b4e5766b365de,
                    &quot;macro_element_f801f4be7e87f70015b003753607d9b5&quot; : geo_json_f801f4be7e87f70015b003753607d9b5,
                    &quot;macro_element_fbda97b8245bc41b7c766493b4f71357&quot; : geo_json_fbda97b8245bc41b7c766493b4f71357,
                    &quot;macro_element_ae9eddaed60915bd060d5144d876ffd0&quot; : geo_json_ae9eddaed60915bd060d5144d876ffd0,
                    &quot;macro_element_f60acf91d14f6912edb2debc14202d42&quot; : geo_json_f60acf91d14f6912edb2debc14202d42,
                    &quot;macro_element_b31580f594079ed5e4d8564be93ccec6&quot; : geo_json_b31580f594079ed5e4d8564be93ccec6,
                    &quot;macro_element_a280daeba7510f27742b2ba41b9ace75&quot; : geo_json_a280daeba7510f27742b2ba41b9ace75,
                    &quot;macro_element_dadc86ec9a1a59b0c563931acc489bbb&quot; : geo_json_dadc86ec9a1a59b0c563931acc489bbb,
                    &quot;macro_element_10f75b9aa98b7e81cb2026171a506baf&quot; : geo_json_10f75b9aa98b7e81cb2026171a506baf,
                    &quot;macro_element_31dfb451af170c3acdd1224bd79c0165&quot; : geo_json_31dfb451af170c3acdd1224bd79c0165,
                    &quot;macro_element_90be3d17e0e2bde0ca11121aac5f7f5c&quot; : geo_json_90be3d17e0e2bde0ca11121aac5f7f5c,
                    &quot;macro_element_6ddd503d977c260bde6edbb8e0fe0a38&quot; : geo_json_6ddd503d977c260bde6edbb8e0fe0a38,
                    &quot;macro_element_3e814cd734a8d0a17fe793df425c8543&quot; : geo_json_3e814cd734a8d0a17fe793df425c8543,
                    &quot;macro_element_e3de0fd6e786fc0f866f08438764858e&quot; : geo_json_e3de0fd6e786fc0f866f08438764858e,
                    &quot;macro_element_616067d98d919866436edd690eb6d561&quot; : geo_json_616067d98d919866436edd690eb6d561,
                    &quot;macro_element_708c92b6821d6cd97a76d81d0e05ac02&quot; : geo_json_708c92b6821d6cd97a76d81d0e05ac02,
                    &quot;macro_element_1c319ea17de3ed4037c06ff3e05f146a&quot; : geo_json_1c319ea17de3ed4037c06ff3e05f146a,
                    &quot;macro_element_688c91953de6b91d61229a74adf09694&quot; : geo_json_688c91953de6b91d61229a74adf09694,
                    &quot;macro_element_451f245650471d7b26d6742e3808a4ed&quot; : geo_json_451f245650471d7b26d6742e3808a4ed,
                    &quot;macro_element_1c794d2aa60fa10551f330029b8641dd&quot; : geo_json_1c794d2aa60fa10551f330029b8641dd,
                    &quot;macro_element_5e12841b46d6ed2f805eb76f68876332&quot; : geo_json_5e12841b46d6ed2f805eb76f68876332,
                    &quot;macro_element_8a543d9da19f4aa6b926b0690d1ca4e8&quot; : geo_json_8a543d9da19f4aa6b926b0690d1ca4e8,
                    &quot;macro_element_bb593fc16e0b135b44da042e5949dd71&quot; : geo_json_bb593fc16e0b135b44da042e5949dd71,
                    &quot;macro_element_50dc9e3e7b3b9b1e660ae3191cf525b5&quot; : geo_json_50dc9e3e7b3b9b1e660ae3191cf525b5,
                    &quot;macro_element_ca494a7a0b1829efbb3e53b107c4631c&quot; : geo_json_ca494a7a0b1829efbb3e53b107c4631c,
                    &quot;macro_element_3d7d2ea9cc1f733b118682584930e471&quot; : geo_json_3d7d2ea9cc1f733b118682584930e471,
                    &quot;macro_element_4027f171002524df523051b92d3a8a59&quot; : geo_json_4027f171002524df523051b92d3a8a59,
                    &quot;macro_element_7744d05be2972455498b54d8a49a3fca&quot; : geo_json_7744d05be2972455498b54d8a49a3fca,
                    &quot;macro_element_d5b27b47e6eb2f3305d8b9cea223c65e&quot; : geo_json_d5b27b47e6eb2f3305d8b9cea223c65e,
                    &quot;macro_element_772f47c548473cd8f11206b9891d9c1f&quot; : geo_json_772f47c548473cd8f11206b9891d9c1f,
                    &quot;macro_element_cd8058f5082b027a8568688381fa36e9&quot; : geo_json_cd8058f5082b027a8568688381fa36e9,
                    &quot;macro_element_b23f8178947bee3ff7a8dea8004e358b&quot; : geo_json_b23f8178947bee3ff7a8dea8004e358b,
                    &quot;macro_element_1f5e7b48e01653550d869feea8fd1a84&quot; : geo_json_1f5e7b48e01653550d869feea8fd1a84,
                    &quot;macro_element_b74b3957f07ddd65f5b46bdfbc0cfe97&quot; : geo_json_b74b3957f07ddd65f5b46bdfbc0cfe97,
                    &quot;macro_element_06aa2c63abf0999f7c20b1dcf1e16725&quot; : geo_json_06aa2c63abf0999f7c20b1dcf1e16725,
                    &quot;macro_element_8331d30a2809b234d3c1d8fa73f2f1f4&quot; : geo_json_8331d30a2809b234d3c1d8fa73f2f1f4,
                    &quot;macro_element_6d59c3a5b11bbbff234788a4c0bee15d&quot; : geo_json_6d59c3a5b11bbbff234788a4c0bee15d,
                },
            };
            let layer_control_3d01a942a157460cfa036f71e1890075 = L.control.layers(
                layer_control_3d01a942a157460cfa036f71e1890075_layers.base_layers,
                layer_control_3d01a942a157460cfa036f71e1890075_layers.overlays,
                {
  &quot;position&quot;: &quot;topright&quot;,
  &quot;collapsed&quot;: true,
  &quot;autoZIndex&quot;: true,
}
            ).addTo(map_a23a75c0ba4c69243dd1446bf362f75f);

        
</script>
</html>" style="position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;" allowfullscreen="" webkitallowfullscreen="" mozallowfullscreen=""></iframe></div></div>
</div>
</div>
<hr>
</section>
</section>
<section id="step-2-cloud-masking-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="step-2-cloud-masking-pipeline">Step 2: Cloud Masking Pipeline</h2>
<p>Sentinel-2 Level 2A includes a Scene Classification Layer (SCL) that identifies clouds, cloud shadows, and other features.</p>
<section id="understanding-scene-classification-layer" class="level3">
<h3 class="anchored" data-anchor-id="understanding-scene-classification-layer">Understanding Scene Classification Layer</h3>
<div id="8d5703b3" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SCL class definitions (Sentinel-2 Level 2A)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>scl_classes <span class="op">=</span> {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>: <span class="st">"No Data"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"Saturated or defective"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"Dark area pixels"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"Cloud shadows"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"Vegetation"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"Not vegetated"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"Water"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"Unclassified"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span>: <span class="st">"Cloud medium probability"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">9</span>: <span class="st">"Cloud high probability"</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>: <span class="st">"Thin cirrus"</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="dv">11</span>: <span class="st">"Snow"</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Define what we consider "good" pixels for analysis</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>good_pixel_classes <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]  <span class="co"># Vegetation, not vegetated, water</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>cloud_classes <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]   <span class="co"># Cloud shadows, clouds, cirrus</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üå•Ô∏è Scene Classification Layer (SCL) Classes:"</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> class_id, description <span class="kw">in</span> scl_classes.items():</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    marker <span class="op">=</span> <span class="st">"‚úì"</span> <span class="cf">if</span> class_id <span class="kw">in</span> good_pixel_classes <span class="cf">else</span> <span class="st">"‚ùå"</span> <span class="cf">if</span> class_id <span class="kw">in</span> cloud_classes <span class="cf">else</span> <span class="st">"‚ö†Ô∏è"</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>marker<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>class_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">‚úÖ Good pixels for analysis: </span><span class="sc">{</span>good_pixel_classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"‚òÅÔ∏è Cloud/shadow pixels to mask: </span><span class="sc">{</span>cloud_classes<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>üå•Ô∏è Scene Classification Layer (SCL) Classes:
   ‚ö†Ô∏è 0: No Data
   ‚ö†Ô∏è 1: Saturated or defective
   ‚ö†Ô∏è 2: Dark area pixels
   ‚ùå 3: Cloud shadows
   ‚úì 4: Vegetation
   ‚úì 5: Not vegetated
   ‚úì 6: Water
   ‚ö†Ô∏è 7: Unclassified
   ‚ùå 8: Cloud medium probability
   ‚ùå 9: Cloud high probability
   ‚ùå 10: Thin cirrus
   ‚ö†Ô∏è 11: Snow

‚úÖ Good pixels for analysis: [4, 5, 6]
‚òÅÔ∏è Cloud/shadow pixels to mask: [3, 8, 9, 10]</code></pre>
</div>
</div>
</section>
<section id="load-scene-with-cloud-mask" class="level3">
<h3 class="anchored" data-anchor-id="load-scene-with-cloud-mask">Load Scene with Cloud Mask</h3>
<div id="1311f670" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_scene_with_cloudmask(item, target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>, target_resolution<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Load a Sentinel-2 scene with cloud masking applied.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">        item: STAC item</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">        target_resolution: Target pixel size in meters</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">        masked_data: dict with masked bands</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">        valid_pixel_fraction: fraction of valid pixels</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load key bands and SCL</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        bands_to_load <span class="op">=</span> {</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'B04'</span>: <span class="st">'red'</span>,     <span class="co"># 10m resolution</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">'B03'</span>: <span class="st">'green'</span>,   <span class="co"># 10m resolution</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'B02'</span>: <span class="st">'blue'</span>,    <span class="co"># 10m resolution</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'B08'</span>: <span class="st">'nir'</span>,     <span class="co"># 10m resolution</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'SCL'</span>: <span class="st">'scl'</span>      <span class="co"># 20m resolution</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        loaded_data <span class="op">=</span> {}</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load each band</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> band_key, band_name <span class="kw">in</span> bands_to_load.items():</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>            url <span class="op">=</span> item.assets[band_key].href</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Load with rioxarray for automatic CRS handling</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            da <span class="op">=</span> rioxarray.open_rasterio(url).squeeze()</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Reproject to target CRS and resolution if needed</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> da.rio.crs <span class="op">!=</span> target_crs <span class="kw">or</span> <span class="bu">abs</span>(da.rio.resolution()[<span class="dv">0</span>]) <span class="op">!=</span> target_resolution:</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                da <span class="op">=</span> da.rio.reproject(target_crs, resolution<span class="op">=</span>target_resolution)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>            loaded_data[band_name] <span class="op">=</span> da</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create cloud mask from SCL</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        scl_data <span class="op">=</span> loaded_data[<span class="st">'scl'</span>]</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        good_pixels <span class="op">=</span> np.isin(scl_data.values, good_pixel_classes)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply mask to all spectral bands</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        masked_data <span class="op">=</span> {}</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> band_name <span class="kw">in</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]:</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>            band_data <span class="op">=</span> loaded_data[band_name]</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mask invalid pixels with NaN</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>            masked_values <span class="op">=</span> np.where(good_pixels, band_data.values, np.nan)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create new DataArray with same coordinates</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>            masked_data[band_name] <span class="op">=</span> xr.DataArray(</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>                masked_values,</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>                coords<span class="op">=</span>band_data.coords,</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>                dims<span class="op">=</span>band_data.dims,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>                attrs<span class="op">=</span>band_data.attrs</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate valid pixel fraction</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        valid_pixel_fraction <span class="op">=</span> np.<span class="bu">sum</span>(good_pixels) <span class="op">/</span> good_pixels.size</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store SCL for reference</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'scl'</span>] <span class="op">=</span> scl_data</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'cloud_mask'</span>] <span class="op">=</span> xr.DataArray(</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>            good_pixels,</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>            coords<span class="op">=</span>scl_data.coords,</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>            dims<span class="op">=</span>scl_data.dims</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> masked_data, valid_pixel_fraction</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"‚ùå Error loading scene </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="dv">0</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with one scene</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>test_item <span class="op">=</span> scenes_df.iloc[<span class="dv">0</span>][<span class="st">'item'</span>]</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üß™ Testing cloud masking with scene: </span><span class="sc">{</span>test_item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>masked_data, valid_fraction <span class="op">=</span> load_scene_with_cloudmask(test_item)</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> masked_data:</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚úÖ Scene loaded successfully"</span>)</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üìè Data shape: </span><span class="sc">{</span>masked_data[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üó∫Ô∏è CRS: </span><span class="sc">{</span>masked_data[<span class="st">'red'</span>]<span class="sc">.</span>rio<span class="sc">.</span>crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üìä Valid pixels: </span><span class="sc">{</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚òÅÔ∏è Cloudy pixels: </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"‚ùå Failed to load scene"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>üß™ Testing cloud masking with scene: S2A_MSIL2A_20240831T184921_R113_T11SKC_20240901T011152
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T11SKC_20240901T011152: HTTP response code: 409
‚ùå Failed to load scene</code></pre>
</div>
</div>
</section>
<section id="visualize-cloud-masking-results" class="level3">
<h3 class="anchored" data-anchor-id="visualize-cloud-masking-results">Visualize Cloud Masking Results</h3>
<div id="e1d2ae06" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> masked_data:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create visualization of cloud masking</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Original RGB (before masking)</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    red_orig <span class="op">=</span> masked_data[<span class="st">'red'</span>].fillna(<span class="dv">0</span>)  <span class="co"># Fill NaN for display</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    green_orig <span class="op">=</span> masked_data[<span class="st">'green'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    blue_orig <span class="op">=</span> masked_data[<span class="st">'blue'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize for RGB display</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> normalize_for_display(band, percentiles<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">98</span>)):</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        valid_data <span class="op">=</span> band[<span class="op">~</span>np.isnan(band)]</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            p_low, p_high <span class="op">=</span> np.percentile(valid_data, percentiles)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.clip((band <span class="op">-</span> p_low) <span class="op">/</span> (p_high <span class="op">-</span> p_low), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> band</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    red_norm <span class="op">=</span> normalize_for_display(red_orig.values)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    green_norm <span class="op">=</span> normalize_for_display(green_orig.values)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    blue_norm <span class="op">=</span> normalize_for_display(blue_orig.values)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    rgb_composite <span class="op">=</span> np.dstack([red_norm, green_norm, blue_norm])</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].imshow(rgb_composite)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'RGB Composite'</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scene Classification Layer</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    scl_plot <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">1</span>].imshow(masked_data[<span class="st">'scl'</span>].values, cmap<span class="op">=</span><span class="st">'tab20'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Scene Classification Layer'</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cloud mask</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].imshow(masked_data[<span class="st">'cloud_mask'</span>].values, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'Valid Pixels Mask'</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Masked RGB</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    masked_rgb <span class="op">=</span> rgb_composite.copy()</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    masked_rgb[<span class="op">~</span>masked_data[<span class="st">'cloud_mask'</span>].values] <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>]  <span class="co"># Red for masked areas</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].imshow(masked_rgb)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Masked RGB (Red = Clouds)'</span>)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI calculation on masked data</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    nir_masked <span class="op">=</span> masked_data[<span class="st">'nir'</span>].values</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    red_masked <span class="op">=</span> masked_data[<span class="st">'red'</span>].values</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    ndvi <span class="op">=</span> (nir_masked <span class="op">-</span> red_masked) <span class="op">/</span> (nir_masked <span class="op">+</span> red_masked <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    ndvi_plot <span class="op">=</span> axes[<span class="dv">1</span>,<span class="dv">1</span>].imshow(ndvi, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=-</span><span class="fl">0.5</span>, vmax<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'NDVI (Clouds Excluded)'</span>)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(ndvi_plot, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Statistics</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="ss">f"Valid Pixels: </span><span class="sc">{</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.6</span>, <span class="ss">f"Cloudy Pixels: </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="ss">f"NDVI Range: </span><span class="sc">{</span>np<span class="sc">.</span>nanmin(ndvi)<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>np<span class="sc">.</span>nanmax(ndvi)<span class="sc">:.2f}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="ss">f"Mean NDVI: </span><span class="sc">{</span>np<span class="sc">.</span>nanmean(ndvi)<span class="sc">:.2f}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Statistics'</span>)</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üé® Cloud masking visualization complete"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Scene Classification Layer Benefits
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Automated cloud detection</strong>: No manual threshold setting needed</li>
<li><strong>Multiple cloud types</strong>: Distinguishes dense clouds, thin cirrus, and shadows</li>
<li><strong>Consistent classification</strong>: Same algorithm across all Sentinel-2 scenes</li>
<li><strong>Analysis-ready</strong>: Level 2A processing includes atmospheric correction</li>
</ul>
</div>
</div>
<hr>
</section>
</section>
<section id="step-3-reprojection-and-mosaicking" class="level2">
<h2 class="anchored" data-anchor-id="step-3-reprojection-and-mosaicking">Step 3: Reprojection and Mosaicking</h2>
<p>When working with multiple scenes, we need to ensure they‚Äôre all in the same coordinate system and can be combined seamlessly.</p>
<section id="batch-process-multiple-scenes" class="level3">
<h3 class="anchored" data-anchor-id="batch-process-multiple-scenes">Batch Process Multiple Scenes</h3>
<div id="e033b393" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_scene_batch(scene_items, max_workers<span class="op">=</span><span class="dv">4</span>, target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Process multiple scenes in parallel with cloud masking and reprojection.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">        scene_items: List of STAC items</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">        max_workers: Number of parallel workers</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scene data</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    processed_scenes <span class="op">=</span> []</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_single_scene(item):</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        data, valid_frac <span class="op">=</span> load_scene_with_cloudmask(item, target_crs<span class="op">=</span>target_crs)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> data <span class="kw">and</span> valid_frac <span class="op">&gt;</span> <span class="fl">0.3</span>:  <span class="co"># Keep scenes with &gt;30% valid pixels</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">'id'</span>: item.<span class="bu">id</span>,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">'date'</span>: item.properties[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>],</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">'data'</span>: data,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">'valid_fraction'</span>: valid_frac,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">'item'</span>: item</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process scenes in parallel</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üîÑ Processing </span><span class="sc">{</span><span class="bu">len</span>(scene_items)<span class="sc">}</span><span class="ss"> scenes with </span><span class="sc">{</span>max_workers<span class="sc">}</span><span class="ss"> workers..."</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>max_workers) <span class="im">as</span> executor:</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="bu">list</span>(executor.<span class="bu">map</span>(process_single_scene, scene_items))</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter successful results</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    processed_scenes <span class="op">=</span> [result <span class="cf">for</span> result <span class="kw">in</span> results <span class="cf">if</span> result <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>]</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚úÖ Successfully processed </span><span class="sc">{</span><span class="bu">len</span>(processed_scenes)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> processed_scenes</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Select subset of scenes for processing (to manage computational load)</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>selected_scenes <span class="op">=</span> scenes_df.head(<span class="dv">8</span>)[<span class="st">'item'</span>].tolist()  <span class="co"># Process first 8 scenes</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>processed_scenes <span class="op">=</span> process_scene_batch(selected_scenes, max_workers<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Show processing results</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> processed_scenes:</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìä Processing Summary:"</span>)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>scene[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>scene[<span class="st">'valid_fraction'</span>]<span class="sc">:.1%}</span><span class="ss"> valid pixels"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>üîÑ Processing 8 scenes with 2 workers...
Processing S2A_MSIL2A_20240831T184921_R113_T11SKC_20240901T01...
Processing S2A_MSIL2A_20240831T184921_R113_T11SKB_20240901T01...
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T11SKC_20240901T011152: HTTP response code: 409
Processing S2A_MSIL2A_20240831T184921_R113_T11SKA_20240901T01...
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T11SKB_20240901T011152: HTTP response code: 409
Processing S2A_MSIL2A_20240831T184921_R113_T10SGH_20240901T01...
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T11SKA_20240901T011152: HTTP response code: 409
Processing S2A_MSIL2A_20240831T184921_R113_T10SGG_20240901T01...
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T10SGH_20240901T011152: HTTP response code: 409
Processing S2A_MSIL2A_20240831T184921_R113_T10SGF_20240901T01...
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T10SGG_20240901T011152: HTTP response code: 409
Processing S2A_MSIL2A_20240831T184921_R113_T10SFH_20240901T01...
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T10SGF_20240901T011152: HTTP response code: 409
Processing S2A_MSIL2A_20240831T184921_R113_T10SFG_20240901T01...
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T10SFH_20240901T011152: HTTP response code: 409
‚ùå Error loading scene S2A_MSIL2A_20240831T184921_R113_T10SFG_20240901T011152: HTTP response code: 409
‚úÖ Successfully processed 0 scenes</code></pre>
</div>
</div>
</section>
<section id="create-temporal-mosaic" class="level3">
<h3 class="anchored" data-anchor-id="create-temporal-mosaic">Create Temporal Mosaic</h3>
<div id="fc0de1aa" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_temporal_mosaic(processed_scenes, method<span class="op">=</span><span class="st">'median'</span>):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a temporal mosaic from multiple processed scenes.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scene dictionaries</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">        method: Compositing method ('median', 'mean', 'max')</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">        mosaic_data: Temporal composite as xarray Dataset</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> processed_scenes:</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"‚ùå No scenes to mosaic"</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üß© Creating temporal mosaic using </span><span class="sc">{</span>method<span class="sc">}</span><span class="ss"> method..."</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group data by band</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    band_stacks <span class="op">=</span> {}</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> bands:</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> []</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>            band_data.append(scene[<span class="st">'data'</span>][band])</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band <span class="op">==</span> <span class="st">'red'</span>:  <span class="co"># Only collect dates once</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>                dates.append(scene[<span class="st">'date'</span>])</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack along time dimension</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        band_stack <span class="op">=</span> xr.concat(band_data, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        band_stack <span class="op">=</span> band_stack.assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply temporal compositing</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> method <span class="op">==</span> <span class="st">'median'</span>:</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.median(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'mean'</span>:</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.mean(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'max'</span>:</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.<span class="bu">max</span>(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create mosaic dataset</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    mosaic_data <span class="op">=</span> xr.Dataset(band_stacks)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metadata</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'method'</span>] <span class="op">=</span> method</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'n_scenes'</span>] <span class="op">=</span> <span class="bu">len</span>(processed_scenes)</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'date_range'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">min</span>(dates)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span><span class="bu">max</span>(dates)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚úÖ Mosaic created from </span><span class="sc">{</span><span class="bu">len</span>(processed_scenes)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üìè Mosaic shape: </span><span class="sc">{</span>mosaic_data[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üìÖ Date range: </span><span class="sc">{</span>mosaic_data<span class="sc">.</span>attrs[<span class="st">'date_range'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mosaic_data</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Create median composite</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>mosaic <span class="op">=</span> create_temporal_mosaic(processed_scenes, method<span class="op">=</span><span class="st">'median'</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> mosaic:</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualize the mosaic</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RGB composite of mosaic</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    red_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'red'</span>].values)</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    green_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'green'</span>].values)</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    blue_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'blue'</span>].values)</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    rgb_mosaic <span class="op">=</span> np.dstack([red_norm, green_norm, blue_norm])</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].imshow(rgb_mosaic)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="ss">f'RGB Mosaic (</span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">"method"</span>]<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI mosaic</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    nir_vals <span class="op">=</span> mosaic[<span class="st">'nir'</span>].values</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    red_vals <span class="op">=</span> mosaic[<span class="st">'red'</span>].values</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    ndvi_mosaic <span class="op">=</span> (nir_vals <span class="op">-</span> red_vals) <span class="op">/</span> (nir_vals <span class="op">+</span> red_vals <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    ndvi_plot <span class="op">=</span> axes[<span class="dv">1</span>].imshow(ndvi_mosaic, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=-</span><span class="fl">0.2</span>, vmax<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'NDVI Mosaic'</span>)</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(ndvi_plot, ax<span class="op">=</span>axes[<span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data availability (how many scenes contributed to each pixel)</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This would require tracking per-pixel contributions</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="ss">f"Scenes used: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'n_scenes'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Method: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'method'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Date range: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'date_range'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Coverage: Central Valley, CA"</span>,</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>axes[<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>, verticalalignment<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].set_title(<span class="st">'Mosaic Info'</span>)</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üé® Temporal mosaic visualization complete"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>‚ùå No scenes to mosaic</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="step-4-analysis-ready-data-cubes" class="level2">
<h2 class="anchored" data-anchor-id="step-4-analysis-ready-data-cubes">Step 4: Analysis-Ready Data Cubes</h2>
<p>Now let‚Äôs create analysis-ready data cubes that can be used for time series analysis and machine learning.</p>
<section id="build-temporal-data-cube" class="level3">
<h3 class="anchored" data-anchor-id="build-temporal-data-cube">Build Temporal Data Cube</h3>
<div id="ec0a7a4a" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_temporal_datacube(processed_scenes, chunk_size<span class="op">=</span><span class="st">'auto'</span>):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Build an analysis-ready temporal data cube.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scenes</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">        chunk_size: Dask chunk size for memory management</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">        datacube: xarray Dataset with time dimension</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> processed_scenes:</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üìä Building temporal data cube..."</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort scenes by date</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    processed_scenes.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'date'</span>])</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract dates and data</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> [pd.to_datetime(scene[<span class="st">'date'</span>]) <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes]</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build data arrays for each band</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    band_cubes <span class="op">=</span> {}</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> bands:</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack all scenes for this band</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> []</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>            band_data.append(scene[<span class="st">'data'</span>][band])</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create temporal stack</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>        band_cube <span class="op">=</span> xr.concat(band_data, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        band_cube <span class="op">=</span> band_cube.assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add chunking for large datasets</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chunk_size <span class="op">==</span> <span class="st">'auto'</span>:</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>            chunks <span class="op">=</span> {<span class="st">'time'</span>: <span class="dv">1</span>, <span class="st">'y'</span>: <span class="dv">512</span>, <span class="st">'x'</span>: <span class="dv">512</span>}</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>            chunks <span class="op">=</span> chunk_size</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        band_cubes[band] <span class="op">=</span> band_cube.chunk(chunks)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create dataset</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    datacube <span class="op">=</span> xr.Dataset(band_cubes)</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add derived indices</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üßÆ Computing vegetation indices..."</span>)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    datacube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>                        (datacube[<span class="st">'nir'</span>] <span class="op">+</span> datacube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enhanced Vegetation Index (EVI)</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    datacube[<span class="st">'evi'</span>] <span class="op">=</span> (<span class="fl">2.5</span> <span class="op">*</span> (datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>                       (datacube[<span class="st">'nir'</span>] <span class="op">+</span> <span class="dv">6</span> <span class="op">*</span> datacube[<span class="st">'red'</span>] <span class="op">-</span> <span class="fl">7.5</span> <span class="op">*</span> datacube[<span class="st">'blue'</span>] <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metadata</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    datacube.attrs.update({</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'title'</span>: <span class="st">'Sentinel-2 Analysis-Ready Data Cube'</span>,</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="st">'Cloud-masked, reprojected temporal stack'</span>,</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_scenes'</span>: <span class="bu">len</span>(processed_scenes),</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time_range'</span>: <span class="ss">f"</span><span class="sc">{</span>dates[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dates[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">'crs'</span>: <span class="bu">str</span>(datacube[<span class="st">'red'</span>].rio.crs),</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">'resolution'</span>: datacube[<span class="st">'red'</span>].rio.resolution()</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚úÖ Data cube created:"</span>)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Shape: </span><span class="sc">{</span>datacube[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Time steps: </span><span class="sc">{</span><span class="bu">len</span>(dates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Variables: </span><span class="sc">{</span><span class="bu">list</span>(datacube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> datacube</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the data cube</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>datacube <span class="op">=</span> build_temporal_datacube(processed_scenes)</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> datacube:</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üì¶ Data Cube Summary:"</span>)</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(datacube)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="time-series-analysis-example" class="level3">
<h3 class="anchored" data-anchor-id="time-series-analysis-example">Time Series Analysis Example</h3>
<div id="419a272e" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> datacube:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time series for a sample location</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pick center of study area</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    center_y, center_x <span class="op">=</span> datacube.y.values[<span class="bu">len</span>(datacube.y)<span class="op">//</span><span class="dv">2</span>], datacube.x.values[<span class="bu">len</span>(datacube.x)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time series at center point</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    point_ts <span class="op">=</span> datacube.sel(x<span class="op">=</span>center_x, y<span class="op">=</span>center_y, method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create time series plots</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI time series</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'ndvi'</span>], <span class="st">'g-o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'NDVI Time Series'</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'NDVI'</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># EVI time series</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].plot(point_ts.time, point_ts[<span class="st">'evi'</span>], <span class="st">'b-o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'EVI Time Series'</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'EVI'</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RGB bands time series</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'red'</span>], <span class="st">'r-'</span>, label<span class="op">=</span><span class="st">'Red'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'green'</span>], <span class="st">'g-'</span>, label<span class="op">=</span><span class="st">'Green'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'blue'</span>], <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'Blue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'RGB Bands Time Series'</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Reflectance'</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NIR time series</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].plot(point_ts.time, point_ts[<span class="st">'nir'</span>], <span class="st">'darkred'</span>, marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'NIR Band Time Series'</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'NIR Reflectance'</span>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üìà Time series analysis complete"</span>)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sample location: x=</span><span class="sc">{</span>center_x<span class="sc">:.0f}</span><span class="ss">, y=</span><span class="sc">{</span>center_y<span class="sc">:.0f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="step-5-scalable-batch-processing-workflow" class="level2">
<h2 class="anchored" data-anchor-id="step-5-scalable-batch-processing-workflow">Step 5: Scalable Batch Processing Workflow</h2>
<p>Finally, let‚Äôs create a reproducible workflow that can handle larger datasets efficiently.</p>
<section id="create-preprocessing-pipeline-class" class="level3">
<h3 class="anchored" data-anchor-id="create-preprocessing-pipeline-class">Create Preprocessing Pipeline Class</h3>
<div id="68a79a6b" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sentinel2Preprocessor:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Scalable Sentinel-2 preprocessing pipeline.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, output_dir<span class="op">=</span><span class="st">"preprocessed_data"</span>, target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                 target_resolution<span class="op">=</span><span class="dv">20</span>, max_cloud_cover<span class="op">=</span><span class="dv">15</span>):</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_dir <span class="op">=</span> Path(output_dir)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_crs <span class="op">=</span> target_crs</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_resolution <span class="op">=</span> target_resolution</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_cloud_cover <span class="op">=</span> max_cloud_cover</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"üîß Preprocessing pipeline initialized"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Output directory: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Target CRS: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Target resolution: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_resolution<span class="sc">}</span><span class="ss">m"</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> search_scenes(<span class="va">self</span>, bbox, start_date, end_date, limit<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Search for Sentinel-2 scenes."""</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        catalog <span class="op">=</span> Client.<span class="bu">open</span>(<span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        search_params <span class="op">=</span> {</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"collections"</span>: [<span class="st">"sentinel-2-l2a"</span>],</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"bbox"</span>: bbox,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"datetime"</span>: <span class="ss">f"</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"query"</span>: {<span class="st">"eo:cloud_cover"</span>: {<span class="st">"lt"</span>: <span class="va">self</span>.max_cloud_cover}},</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"limit"</span>: limit</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        search_results <span class="op">=</span> catalog.search(<span class="op">**</span>search_params)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        items <span class="op">=</span> <span class="bu">list</span>(search_results.items())</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"üîç Found </span><span class="sc">{</span><span class="bu">len</span>(items)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> items</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_scene(<span class="va">self</span>, item, save_individual<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Process a single scene with cloud masking."""</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        scene_id <span class="op">=</span> item.<span class="bu">id</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> <span class="va">self</span>.output_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">_processed.nc"</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip if already processed</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> output_path.exists():</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"‚è≠Ô∏è Skipping </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss"> (already processed)"</span>)</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">str</span>(output_path)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process scene</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        data, valid_frac <span class="op">=</span> load_scene_with_cloudmask(</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>            item, <span class="va">self</span>.target_crs, <span class="va">self</span>.target_resolution</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> data <span class="kw">and</span> valid_frac <span class="op">&gt;</span> <span class="fl">0.3</span>:</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> save_individual:</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Convert to xarray Dataset</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>                scene_ds <span class="op">=</span> xr.Dataset(data)</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>                scene_ds.attrs.update({</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'scene_id'</span>: scene_id,</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'date'</span>: item.properties[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>],</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'cloud_cover'</span>: item.properties.get(<span class="st">'eo:cloud_cover'</span>, <span class="dv">0</span>),</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'valid_pixel_fraction'</span>: valid_frac</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Save to NetCDF</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>                scene_ds.to_netcdf(output_path, engine<span class="op">=</span><span class="st">'netcdf4'</span>)</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"üíæ Saved: </span><span class="sc">{</span>output_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> data</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"‚ùå Skipped </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss"> (insufficient valid pixels)"</span>)</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_time_series_cube(<span class="va">self</span>, processed_data_list, cube_name<span class="op">=</span><span class="st">"datacube"</span>):</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create and save temporal data cube."""</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> processed_data_list:</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"‚ùå No data to create cube"</span>)</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>        cube_path <span class="op">=</span> <span class="va">self</span>.output_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>cube_name<span class="sc">}</span><span class="ss">.nc"</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build temporal stack</span></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>        dates <span class="op">=</span> []</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>        band_stacks <span class="op">=</span> {band: [] <span class="cf">for</span> band <span class="kw">in</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]}</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data <span class="kw">in</span> processed_data_list:</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> data:</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> band <span class="kw">in</span> band_stacks.keys():</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>                    band_stacks[band].append(data[band])</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create dataset</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>        cube_data <span class="op">=</span> {}</span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> band, stack <span class="kw">in</span> band_stacks.items():</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stack:</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>                cube_data[band] <span class="op">=</span> xr.concat(stack, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cube_data:</span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>            datacube <span class="op">=</span> xr.Dataset(cube_data)</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add vegetation indices</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>            datacube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>                               (datacube[<span class="st">'nir'</span>] <span class="op">+</span> datacube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save cube</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>            datacube.to_netcdf(cube_path, engine<span class="op">=</span><span class="st">'netcdf4'</span>)</span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"üì¶ Data cube saved: </span><span class="sc">{</span>cube_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> datacube</span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize preprocessor</span></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> Sentinel2Preprocessor(</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a>    output_dir<span class="op">=</span><span class="st">"week2_preprocessed"</span>,</span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a>    target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>,  <span class="co"># UTM Zone 10N for California</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a>    target_resolution<span class="op">=</span><span class="dv">20</span></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"‚úÖ Preprocessing pipeline ready"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>üîß Preprocessing pipeline initialized
   Output directory: week2_preprocessed
   Target CRS: EPSG:32610
   Target resolution: 20m
‚úÖ Preprocessing pipeline ready</code></pre>
</div>
</div>
</section>
<section id="run-complete-preprocessing-workflow" class="level3">
<h3 class="anchored" data-anchor-id="run-complete-preprocessing-workflow">Run Complete Preprocessing Workflow</h3>
<div id="77b76bc3" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define workflow parameters</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>workflow_params <span class="op">=</span> {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bbox'</span>: central_valley_bbox,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start_date'</span>: <span class="st">"2024-07-01"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'end_date'</span>: <span class="st">"2024-08-15"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_scenes'</span>: <span class="dv">10</span>  <span class="co"># Limit for demonstration</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üöÄ Starting complete preprocessing workflow..."</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Area: Central Valley, CA"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Period: </span><span class="sc">{</span>workflow_params[<span class="st">'start_date'</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>workflow_params[<span class="st">'end_date'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Search for scenes</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>workflow_items <span class="op">=</span> preprocessor.search_scenes(</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'bbox'</span>],</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'start_date'</span>],</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'end_date'</span>],</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span>workflow_params[<span class="st">'max_scenes'</span>]</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Process scenes</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>processed_data <span class="op">=</span> []</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, item <span class="kw">in</span> <span class="bu">enumerate</span>(workflow_items[:<span class="dv">5</span>]):  <span class="co"># Process first 5 for demo</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing scene </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">min</span>(<span class="dv">5</span>, <span class="bu">len</span>(workflow_items))<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> preprocessor.process_scene(item, save_individual<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data:</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        processed_data.append(data)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Create temporal data cube</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> processed_data:</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    final_cube <span class="op">=</span> preprocessor.create_time_series_cube(</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        processed_data,</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        cube_name<span class="op">=</span><span class="st">"central_valley_cube"</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> final_cube:</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üéâ Workflow completed successfully!"</span>)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Processed scenes: </span><span class="sc">{</span><span class="bu">len</span>(processed_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Output directory: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Data cube shape: </span><span class="sc">{</span>final_cube[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>üöÄ Starting complete preprocessing workflow...
   Area: Central Valley, CA
   Period: 2024-07-01 to 2024-08-15
üîç Found 130 scenes
Processing scene 1/5: S2B_MSIL2A_20240813T183919_R070_T11SKC_20240813T22...
‚ùå Error loading scene S2B_MSIL2A_20240813T183919_R070_T11SKC_20240813T224159: HTTP response code: 409
‚ùå Skipped S2B_MSIL2A_20240813T183919_R070_T11SKC_20240813T224159 (insufficient valid pixels)
Processing scene 2/5: S2B_MSIL2A_20240813T183919_R070_T11SKB_20240813T22...
‚ùå Error loading scene S2B_MSIL2A_20240813T183919_R070_T11SKB_20240813T224159: HTTP response code: 409
‚ùå Skipped S2B_MSIL2A_20240813T183919_R070_T11SKB_20240813T224159 (insufficient valid pixels)
Processing scene 3/5: S2B_MSIL2A_20240813T183919_R070_T11SKA_20240813T22...
‚ùå Error loading scene S2B_MSIL2A_20240813T183919_R070_T11SKA_20240813T224159: HTTP response code: 409
‚ùå Skipped S2B_MSIL2A_20240813T183919_R070_T11SKA_20240813T224159 (insufficient valid pixels)
Processing scene 4/5: S2B_MSIL2A_20240813T183919_R070_T10SGH_20240813T22...
‚ùå Error loading scene S2B_MSIL2A_20240813T183919_R070_T10SGH_20240813T224159: HTTP response code: 409
‚ùå Skipped S2B_MSIL2A_20240813T183919_R070_T10SGH_20240813T224159 (insufficient valid pixels)
Processing scene 5/5: S2B_MSIL2A_20240813T183919_R070_T10SGG_20240813T22...
‚ùå Error loading scene S2B_MSIL2A_20240813T183919_R070_T10SGG_20240813T224159: HTTP response code: 409
‚ùå Skipped S2B_MSIL2A_20240813T183919_R070_T10SGG_20240813T224159 (insufficient valid pixels)</code></pre>
</div>
</div>
</section>
<section id="create-processing-summary-report" class="level3">
<h3 class="anchored" data-anchor-id="create-processing-summary-report">Create Processing Summary Report</h3>
<div id="8f493ecc" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate processing summary</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>output_files <span class="op">=</span> <span class="bu">list</span>(preprocessor.output_dir.glob(<span class="st">"*.nc"</span>))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìã Processing Summary Report"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output Directory: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Files Created: </span><span class="sc">{</span><span class="bu">len</span>(output_files)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Processing Parameters:"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Target CRS: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>target_crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Target Resolution: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>target_resolution<span class="sc">}</span><span class="ss">m"</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Max Cloud Cover: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìÅ Output Files:"</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> file_path <span class="kw">in</span> <span class="bu">sorted</span>(output_files):</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    file_size <span class="op">=</span> file_path.stat().st_size <span class="op">/</span> (<span class="dv">1024</span><span class="op">*</span><span class="dv">1024</span>)  <span class="co"># MB</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>file_size<span class="sc">:.1f}</span><span class="ss"> MB)"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if final_cube was created successfully</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> final_cube:</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìä Final Data Cube Statistics:"</span>)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Shape: </span><span class="sc">{</span>final_cube<span class="sc">.</span>dims<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Variables: </span><span class="sc">{</span><span class="bu">list</span>(final_cube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Memory usage: ~</span><span class="sc">{</span>final_cube<span class="sc">.</span>nbytes <span class="op">/</span> (<span class="dv">1024</span><span class="op">**</span><span class="dv">2</span>)<span class="sc">:.1f}</span><span class="ss"> MB"</span>)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìä Final Data Cube: Not created (no valid data processed)"</span>)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üöÄ Ready for Week 3: Machine Learning on Remote Sensing!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
üìã Processing Summary Report
==================================================
Output Directory: week2_preprocessed
Total Files Created: 0
Processing Parameters:
  - Target CRS: EPSG:32610
  - Target Resolution: 20m
  - Max Cloud Cover: 15%

üìÅ Output Files:

üìä Final Data Cube: Not created (no valid data processed)

üöÄ Ready for Week 3: Machine Learning on Remote Sensing!</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>üéâ <strong>Excellent work!</strong> You‚Äôve built a production-ready preprocessing pipeline for Sentinel-2 imagery.</p>
<section id="what-you-accomplished" class="level3">
<h3 class="anchored" data-anchor-id="what-you-accomplished">What You Accomplished:</h3>
<ol type="1">
<li><strong>Multi-scene Data Discovery</strong>: Searched and organized multiple satellite scenes</li>
<li><strong>Automated Cloud Masking</strong>: Used Scene Classification Layer for quality filtering</li>
<li><strong>Spatial Harmonization</strong>: Reprojected and aligned multiple scenes</li>
<li><strong>Temporal Compositing</strong>: Created cloud-free mosaics using median compositing</li>
<li><strong>Analysis-Ready Data Cubes</strong>: Built time series datasets for analysis</li>
<li><strong>Scalable Workflows</strong>: Implemented batch processing with parallel execution</li>
</ol>
</section>
<section id="key-takeaways" class="level3">
<h3 class="anchored" data-anchor-id="key-takeaways">Key Takeaways:</h3>
<ul>
<li><strong>Scene Classification Layer is powerful</strong> - automates cloud/shadow detection</li>
<li><strong>Reprojection is essential</strong> - ensures scenes can be combined seamlessly</li>
<li><strong>Temporal compositing reduces clouds</strong> - median filtering creates cleaner datasets</li>
<li><strong>Data cubes enable time series analysis</strong> - organize data for trend detection</li>
<li><strong>Batch processing scales</strong> - handle large datasets efficiently</li>
</ul>
</section>
<section id="next-week-preview" class="level3">
<h3 class="anchored" data-anchor-id="next-week-preview">Next Week Preview:</h3>
<p>In <strong>Week 3</strong>, we‚Äôll use your preprocessed data to <strong>train CNNs on land cover patches</strong>: - Extract training patches from your data cubes - Create labeled datasets for supervised learning - Build and train convolutional neural networks - Compare different CNN architectures - Evaluate model performance on real satellite imagery</p>
<p>Your preprocessing pipeline outputs will be the foundation for machine learning workflows!</p>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ul>
<li><a href="https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/level-2a/algorithm">Sentinel-2 Scene Classification Layer</a></li>
<li><a href="https://rasterio.readthedocs.io/en/latest/topics/reproject.html">Rasterio Reprojection Guide</a></li>
<li><a href="https://docs.xarray.dev/en/stable/user-guide/index.html">Xarray User Guide for Geosciences</a></li>
<li><a href="https://docs.dask.org/en/latest/array.html">Dask for Geospatial Data</a></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kcaylor\.github\.io\/GEOG-288KC-geospatial-foundation-models");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Week 2: Rapid Remote Sensing Preprocessing"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Building efficient pipelines for Sentinel-2 preprocessing"</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> geoai</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>This week we'll build production-ready preprocessing pipelines that can handle multiple Sentinel-2 scenes efficiently. You'll learn to process entire datasets, not just single scenes, with cloud masking, reprojection, and mosaicking.</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Goals</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>By the end of this session, you will:</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build reproducible preprocessing pipelines for multiple scenes</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Handle cloud masking using Sentinel-2's Scene Classification Layer</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Reproject and mosaic multiple satellite scenes</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create analysis-ready data cubes with xarray</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Optimize workflows with dask for large datasets</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Session Overview</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>Today's hands-on workflow:</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>| Step | Activity | Tools | Output |</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>|------|----------|-------|--------|</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>| 1 | Multi-scene data discovery | pystac-client | Scene inventory |</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>| 2 | Cloud masking pipeline | rasterio, numpy | Clean pixels only |</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>| 3 | Reprojection &amp; mosaicking | rasterio, rioxarray | Unified grid |</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>| 4 | Analysis-ready data cubes | xarray, dask | Time series ready data |</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>| 5 | Batch processing workflow | pathlib, concurrent.futures | Scalable pipeline |</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Multi-Scene Data Discovery</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>Let's scale up from Week 1's single scene approach to handle multiple scenes across time and space.</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="fu">### Define Study Area and Time Range</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Core libraries</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.warp <span class="im">import</span> calculate_default_transform, reproject, Resampling</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.merge <span class="im">import</span> merge</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pystac_client <span class="im">import</span> Client</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client <span class="im">as</span> DaskClient</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up study area - Central Valley, California (agriculture focus)</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>central_valley_bbox <span class="op">=</span> [<span class="op">-</span><span class="fl">121.5</span>, <span class="fl">36.5</span>, <span class="op">-</span><span class="fl">120.0</span>, <span class="fl">38.0</span>]  <span class="co"># [west, south, east, north]</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Define longer time range for trend analysis</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"2024-06-01"</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2024-09-01"</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>max_cloud_cover <span class="op">=</span> <span class="dv">15</span>  <span class="co"># More restrictive for cleaner mosaics</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üó∫Ô∏è Study Area: Central Valley, California"</span>)</span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üìÖ Time Range: </span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"‚òÅÔ∏è Max Cloud Cover: </span><span class="sc">{</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="fu">### Search for Multiple Scenes</span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to Microsoft Planetary Computer</span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>catalog <span class="op">=</span> Client.<span class="bu">open</span>(<span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span>)</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced search parameters for multiple scenes</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>search_params <span class="op">=</span> {</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">"collections"</span>: [<span class="st">"sentinel-2-l2a"</span>],</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bbox"</span>: central_valley_bbox,</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">"datetime"</span>: <span class="ss">f"</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>    <span class="st">"query"</span>: {</span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eo:cloud_cover"</span>: {<span class="st">"lt"</span>: max_cloud_cover}</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">"limit"</span>: <span class="dv">50</span>  <span class="co"># Get more scenes for time series</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üîç Searching for multiple Sentinel-2 scenes..."</span>)</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>search_results <span class="op">=</span> catalog.search(<span class="op">**</span>search_params)</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> <span class="bu">list</span>(search_results.items())</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üì∏ Found </span><span class="sc">{</span><span class="bu">len</span>(items)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Organize scenes by date and tile</span></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>scene_info <span class="op">=</span> []</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>    props <span class="op">=</span> item.properties</span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> props[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>]</span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>    tile_id <span class="op">=</span> item.<span class="bu">id</span>.split(<span class="st">'_'</span>)[<span class="dv">5</span>]  <span class="co"># Extract tile ID from scene name</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>    cloud_cover <span class="op">=</span> props.get(<span class="st">'eo:cloud_cover'</span>, <span class="dv">0</span>)</span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>    scene_info.append({</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>        <span class="st">'id'</span>: item.<span class="bu">id</span>,</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>        <span class="st">'date'</span>: date,</span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tile'</span>: tile_id,</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cloud_cover'</span>: cloud_cover,</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>        <span class="st">'item'</span>: item</span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame for easier analysis</span></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>scenes_df <span class="op">=</span> pd.DataFrame(scene_info)</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìä Scene Distribution:"</span>)</span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Unique dates: </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Unique tiles: </span><span class="sc">{</span>scenes_df[<span class="st">'tile'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Date range: </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>scenes_df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Show scenes by tile</span></span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üóÇÔ∏è Scenes by Tile:"</span>)</span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>tile_counts <span class="op">=</span> scenes_df.groupby(<span class="st">'tile'</span>).size().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tile, count <span class="kw">in</span> tile_counts.head().items():</span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>    avg_cloud <span class="op">=</span> scenes_df[scenes_df[<span class="st">'tile'</span>] <span class="op">==</span> tile][<span class="st">'cloud_cover'</span>].mean()</span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>tile<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> scenes (avg cloud: </span><span class="sc">{</span>avg_cloud<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualize Scene Coverage</span></span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Create map showing all scene footprints</span></span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(</span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>    location<span class="op">=</span>[<span class="fl">37.25</span>, <span class="op">-</span><span class="fl">120.75</span>],  <span class="co"># Center of Central Valley</span></span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>    zoom_start<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">'OpenStreetMap'</span></span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Add study area boundary</span></span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>folium.Rectangle(</span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>    bounds<span class="op">=</span>[[central_valley_bbox[<span class="dv">1</span>], central_valley_bbox[<span class="dv">0</span>]],</span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>            [central_valley_bbox[<span class="dv">3</span>], central_valley_bbox[<span class="dv">2</span>]]],</span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>    weight<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span><span class="st">"Study Area: Central Valley"</span></span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Add scene footprints colored by date</span></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'blue'</span>, <span class="st">'green'</span>, <span class="st">'orange'</span>, <span class="st">'purple'</span>, <span class="st">'red'</span>]</span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>unique_dates <span class="op">=</span> <span class="bu">sorted</span>(scenes_df[<span class="st">'date'</span>].unique())</span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(unique_dates[:<span class="dv">5</span>]):  <span class="co"># Show first 5 dates</span></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a>    date_scenes <span class="op">=</span> scenes_df[scenes_df[<span class="st">'date'</span>] <span class="op">==</span> date]</span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> colors[i <span class="op">%</span> <span class="bu">len</span>(colors)]</span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, scene <span class="kw">in</span> date_scenes.iterrows():</span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a>        item <span class="op">=</span> scene[<span class="st">'item'</span>]</span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a>        geom <span class="op">=</span> item.geometry</span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add scene footprint</span></span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a>        folium.GeoJson(</span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a>            geom,</span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a>            style_function<span class="op">=</span><span class="kw">lambda</span> x, color<span class="op">=</span>color: {</span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fillColor'</span>: color,</span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>                <span class="st">'color'</span>: color,</span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>                <span class="st">'weight'</span>: <span class="dv">2</span>,</span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fillOpacity'</span>: <span class="fl">0.3</span></span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">=</span><span class="ss">f"Date: </span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">&lt;br&gt;Tile: </span><span class="sc">{</span>scene[<span class="st">'tile'</span>]<span class="sc">}</span><span class="ss">&lt;br&gt;Cloud: </span><span class="sc">{</span>scene[<span class="st">'cloud_cover'</span>]<span class="sc">:.1f}</span><span class="ss">%"</span></span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a>        ).add_to(m)</span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üó∫Ô∏è Scene coverage map created"</span>)</span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a>m</span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Cloud Masking Pipeline</span></span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a>Sentinel-2 Level 2A includes a Scene Classification Layer (SCL) that identifies clouds, cloud shadows, and other features.</span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding Scene Classification Layer</span></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a><span class="co"># SCL class definitions (Sentinel-2 Level 2A)</span></span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a>scl_classes <span class="op">=</span> {</span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>: <span class="st">"No Data"</span>,</span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"Saturated or defective"</span>,</span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"Dark area pixels"</span>,</span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"Cloud shadows"</span>,</span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"Vegetation"</span>,</span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"Not vegetated"</span>,</span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"Water"</span>,</span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"Unclassified"</span>,</span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span>: <span class="st">"Cloud medium probability"</span>,</span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a>    <span class="dv">9</span>: <span class="st">"Cloud high probability"</span>,</span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>: <span class="st">"Thin cirrus"</span>,</span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a>    <span class="dv">11</span>: <span class="st">"Snow"</span></span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Define what we consider "good" pixels for analysis</span></span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a>good_pixel_classes <span class="op">=</span> [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]  <span class="co"># Vegetation, not vegetated, water</span></span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a>cloud_classes <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]   <span class="co"># Cloud shadows, clouds, cirrus</span></span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"üå•Ô∏è Scene Classification Layer (SCL) Classes:"</span>)</span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> class_id, description <span class="kw">in</span> scl_classes.items():</span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a>    marker <span class="op">=</span> <span class="st">"‚úì"</span> <span class="cf">if</span> class_id <span class="kw">in</span> good_pixel_classes <span class="cf">else</span> <span class="st">"‚ùå"</span> <span class="cf">if</span> class_id <span class="kw">in</span> cloud_classes <span class="cf">else</span> <span class="st">"‚ö†Ô∏è"</span></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>marker<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>class_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">‚úÖ Good pixels for analysis: </span><span class="sc">{</span>good_pixel_classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"‚òÅÔ∏è Cloud/shadow pixels to mask: </span><span class="sc">{</span>cloud_classes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load Scene with Cloud Mask</span></span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_scene_with_cloudmask(item, target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>, target_resolution<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a><span class="co">    Load a Sentinel-2 scene with cloud masking applied.</span></span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a><span class="co">        item: STAC item</span></span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a><span class="co">        target_resolution: Target pixel size in meters</span></span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a><span class="co">        masked_data: dict with masked bands</span></span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a><span class="co">        valid_pixel_fraction: fraction of valid pixels</span></span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load key bands and SCL</span></span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a>        bands_to_load <span class="op">=</span> {</span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a>            <span class="st">'B04'</span>: <span class="st">'red'</span>,     <span class="co"># 10m resolution</span></span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a>            <span class="st">'B03'</span>: <span class="st">'green'</span>,   <span class="co"># 10m resolution</span></span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a>            <span class="st">'B02'</span>: <span class="st">'blue'</span>,    <span class="co"># 10m resolution</span></span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a>            <span class="st">'B08'</span>: <span class="st">'nir'</span>,     <span class="co"># 10m resolution</span></span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a>            <span class="st">'SCL'</span>: <span class="st">'scl'</span>      <span class="co"># 20m resolution</span></span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a>        loaded_data <span class="op">=</span> {}</span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load each band</span></span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> band_key, band_name <span class="kw">in</span> bands_to_load.items():</span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a>            url <span class="op">=</span> item.assets[band_key].href</span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Load with rioxarray for automatic CRS handling</span></span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a>            da <span class="op">=</span> rioxarray.open_rasterio(url).squeeze()</span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Reproject to target CRS and resolution if needed</span></span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> da.rio.crs <span class="op">!=</span> target_crs <span class="kw">or</span> <span class="bu">abs</span>(da.rio.resolution()[<span class="dv">0</span>]) <span class="op">!=</span> target_resolution:</span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a>                da <span class="op">=</span> da.rio.reproject(target_crs, resolution<span class="op">=</span>target_resolution)</span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>            loaded_data[band_name] <span class="op">=</span> da</span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create cloud mask from SCL</span></span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a>        scl_data <span class="op">=</span> loaded_data[<span class="st">'scl'</span>]</span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a>        good_pixels <span class="op">=</span> np.isin(scl_data.values, good_pixel_classes)</span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply mask to all spectral bands</span></span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a>        masked_data <span class="op">=</span> {}</span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> band_name <span class="kw">in</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]:</span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a>            band_data <span class="op">=</span> loaded_data[band_name]</span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mask invalid pixels with NaN</span></span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a>            masked_values <span class="op">=</span> np.where(good_pixels, band_data.values, np.nan)</span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create new DataArray with same coordinates</span></span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a>            masked_data[band_name] <span class="op">=</span> xr.DataArray(</span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a>                masked_values,</span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a>                coords<span class="op">=</span>band_data.coords,</span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a>                dims<span class="op">=</span>band_data.dims,</span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a>                attrs<span class="op">=</span>band_data.attrs</span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate valid pixel fraction</span></span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a>        valid_pixel_fraction <span class="op">=</span> np.<span class="bu">sum</span>(good_pixels) <span class="op">/</span> good_pixels.size</span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store SCL for reference</span></span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'scl'</span>] <span class="op">=</span> scl_data</span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a>        masked_data[<span class="st">'cloud_mask'</span>] <span class="op">=</span> xr.DataArray(</span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a>            good_pixels,</span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a>            coords<span class="op">=</span>scl_data.coords,</span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a>            dims<span class="op">=</span>scl_data.dims</span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> masked_data, valid_pixel_fraction</span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"‚ùå Error loading scene </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="dv">0</span></span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with one scene</span></span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a>test_item <span class="op">=</span> scenes_df.iloc[<span class="dv">0</span>][<span class="st">'item'</span>]</span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üß™ Testing cloud masking with scene: </span><span class="sc">{</span>test_item<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a>masked_data, valid_fraction <span class="op">=</span> load_scene_with_cloudmask(test_item)</span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> masked_data:</span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚úÖ Scene loaded successfully"</span>)</span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üìè Data shape: </span><span class="sc">{</span>masked_data[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üó∫Ô∏è CRS: </span><span class="sc">{</span>masked_data[<span class="st">'red'</span>]<span class="sc">.</span>rio<span class="sc">.</span>crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üìä Valid pixels: </span><span class="sc">{</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚òÅÔ∏è Cloudy pixels: </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"‚ùå Failed to load scene"</span>)</span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualize Cloud Masking Results</span></span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> masked_data:</span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create visualization of cloud masking</span></span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Original RGB (before masking)</span></span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a>    red_orig <span class="op">=</span> masked_data[<span class="st">'red'</span>].fillna(<span class="dv">0</span>)  <span class="co"># Fill NaN for display</span></span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a>    green_orig <span class="op">=</span> masked_data[<span class="st">'green'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a>    blue_orig <span class="op">=</span> masked_data[<span class="st">'blue'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize for RGB display</span></span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> normalize_for_display(band, percentiles<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">98</span>)):</span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a>        valid_data <span class="op">=</span> band[<span class="op">~</span>np.isnan(band)]</span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a>            p_low, p_high <span class="op">=</span> np.percentile(valid_data, percentiles)</span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.clip((band <span class="op">-</span> p_low) <span class="op">/</span> (p_high <span class="op">-</span> p_low), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> band</span>
<span id="cb24-345"><a href="#cb24-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-346"><a href="#cb24-346" aria-hidden="true" tabindex="-1"></a>    red_norm <span class="op">=</span> normalize_for_display(red_orig.values)</span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a>    green_norm <span class="op">=</span> normalize_for_display(green_orig.values)</span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a>    blue_norm <span class="op">=</span> normalize_for_display(blue_orig.values)</span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a>    rgb_composite <span class="op">=</span> np.dstack([red_norm, green_norm, blue_norm])</span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot results</span></span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].imshow(rgb_composite)</span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'RGB Composite'</span>)</span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scene Classification Layer</span></span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a>    scl_plot <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">1</span>].imshow(masked_data[<span class="st">'scl'</span>].values, cmap<span class="op">=</span><span class="st">'tab20'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Scene Classification Layer'</span>)</span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cloud mask</span></span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].imshow(masked_data[<span class="st">'cloud_mask'</span>].values, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-364"><a href="#cb24-364" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'Valid Pixels Mask'</span>)</span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Masked RGB</span></span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a>    masked_rgb <span class="op">=</span> rgb_composite.copy()</span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a>    masked_rgb[<span class="op">~</span>masked_data[<span class="st">'cloud_mask'</span>].values] <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>]  <span class="co"># Red for masked areas</span></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].imshow(masked_rgb)</span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Masked RGB (Red = Clouds)'</span>)</span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI calculation on masked data</span></span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a>    nir_masked <span class="op">=</span> masked_data[<span class="st">'nir'</span>].values</span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a>    red_masked <span class="op">=</span> masked_data[<span class="st">'red'</span>].values</span>
<span id="cb24-377"><a href="#cb24-377" aria-hidden="true" tabindex="-1"></a>    ndvi <span class="op">=</span> (nir_masked <span class="op">-</span> red_masked) <span class="op">/</span> (nir_masked <span class="op">+</span> red_masked <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a>    ndvi_plot <span class="op">=</span> axes[<span class="dv">1</span>,<span class="dv">1</span>].imshow(ndvi, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=-</span><span class="fl">0.5</span>, vmax<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'NDVI (Clouds Excluded)'</span>)</span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(ndvi_plot, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Statistics</span></span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="ss">f"Valid Pixels: </span><span class="sc">{</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.6</span>, <span class="ss">f"Cloudy Pixels: </span><span class="sc">{</span><span class="dv">1</span><span class="op">-</span>valid_fraction<span class="sc">:.1%}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="ss">f"NDVI Range: </span><span class="sc">{</span>np<span class="sc">.</span>nanmin(ndvi)<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>np<span class="sc">.</span>nanmax(ndvi)<span class="sc">:.2f}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="ss">f"Mean NDVI: </span><span class="sc">{</span>np<span class="sc">.</span>nanmean(ndvi)<span class="sc">:.2f}</span><span class="ss">"</span>, transform<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Statistics'</span>)</span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üé® Cloud masking visualization complete"</span>)</span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a><span class="fu">## Scene Classification Layer Benefits</span></span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Automated cloud detection**: No manual threshold setting needed</span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Multiple cloud types**: Distinguishes dense clouds, thin cirrus, and shadows</span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Consistent classification**: Same algorithm across all Sentinel-2 scenes</span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Analysis-ready**: Level 2A processing includes atmospheric correction</span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Reprojection and Mosaicking</span></span>
<span id="cb24-409"><a href="#cb24-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-410"><a href="#cb24-410" aria-hidden="true" tabindex="-1"></a>When working with multiple scenes, we need to ensure they're all in the same coordinate system and can be combined seamlessly.</span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a><span class="fu">### Batch Process Multiple Scenes</span></span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_scene_batch(scene_items, max_workers<span class="op">=</span><span class="dv">4</span>, target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>):</span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a><span class="co">    Process multiple scenes in parallel with cloud masking and reprojection.</span></span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a><span class="co">        scene_items: List of STAC items</span></span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a><span class="co">        max_workers: Number of parallel workers</span></span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a><span class="co">        target_crs: Target coordinate reference system</span></span>
<span id="cb24-425"><a href="#cb24-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scene data</span></span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a>    processed_scenes <span class="op">=</span> []</span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_single_scene(item):</span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a>        data, valid_frac <span class="op">=</span> load_scene_with_cloudmask(item, target_crs<span class="op">=</span>target_crs)</span>
<span id="cb24-434"><a href="#cb24-434" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> data <span class="kw">and</span> valid_frac <span class="op">&gt;</span> <span class="fl">0.3</span>:  <span class="co"># Keep scenes with &gt;30% valid pixels</span></span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a>                <span class="st">'id'</span>: item.<span class="bu">id</span>,</span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a>                <span class="st">'date'</span>: item.properties[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>],</span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a>                <span class="st">'data'</span>: data,</span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a>                <span class="st">'valid_fraction'</span>: valid_frac,</span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a>                <span class="st">'item'</span>: item</span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process scenes in parallel</span></span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üîÑ Processing </span><span class="sc">{</span><span class="bu">len</span>(scene_items)<span class="sc">}</span><span class="ss"> scenes with </span><span class="sc">{</span>max_workers<span class="sc">}</span><span class="ss"> workers..."</span>)</span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>max_workers) <span class="im">as</span> executor:</span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="bu">list</span>(executor.<span class="bu">map</span>(process_single_scene, scene_items))</span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter successful results</span></span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a>    processed_scenes <span class="op">=</span> [result <span class="cf">for</span> result <span class="kw">in</span> results <span class="cf">if</span> result <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>]</span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚úÖ Successfully processed </span><span class="sc">{</span><span class="bu">len</span>(processed_scenes)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> processed_scenes</span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a><span class="co"># Select subset of scenes for processing (to manage computational load)</span></span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a>selected_scenes <span class="op">=</span> scenes_df.head(<span class="dv">8</span>)[<span class="st">'item'</span>].tolist()  <span class="co"># Process first 8 scenes</span></span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a>processed_scenes <span class="op">=</span> process_scene_batch(selected_scenes, max_workers<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a><span class="co"># Show processing results</span></span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> processed_scenes:</span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìä Processing Summary:"</span>)</span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>scene[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>scene[<span class="st">'valid_fraction'</span>]<span class="sc">:.1%}</span><span class="ss"> valid pixels"</span>)</span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Temporal Mosaic</span></span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_temporal_mosaic(processed_scenes, method<span class="op">=</span><span class="st">'median'</span>):</span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a temporal mosaic from multiple processed scenes.</span></span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scene dictionaries</span></span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a><span class="co">        method: Compositing method ('median', 'mean', 'max')</span></span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a><span class="co">        mosaic_data: Temporal composite as xarray Dataset</span></span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> processed_scenes:</span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"‚ùå No scenes to mosaic"</span>)</span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üß© Creating temporal mosaic using </span><span class="sc">{</span>method<span class="sc">}</span><span class="ss"> method..."</span>)</span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group data by band</span></span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]</span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a>    band_stacks <span class="op">=</span> {}</span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> bands:</span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> []</span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a>            band_data.append(scene[<span class="st">'data'</span>][band])</span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> band <span class="op">==</span> <span class="st">'red'</span>:  <span class="co"># Only collect dates once</span></span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a>                dates.append(scene[<span class="st">'date'</span>])</span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack along time dimension</span></span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a>        band_stack <span class="op">=</span> xr.concat(band_data, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a>        band_stack <span class="op">=</span> band_stack.assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply temporal compositing</span></span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> method <span class="op">==</span> <span class="st">'median'</span>:</span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.median(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'mean'</span>:</span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.mean(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'max'</span>:</span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a>            band_stacks[band] <span class="op">=</span> band_stack.<span class="bu">max</span>(dim<span class="op">=</span><span class="st">'time'</span>, skipna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create mosaic dataset</span></span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a>    mosaic_data <span class="op">=</span> xr.Dataset(band_stacks)</span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metadata</span></span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'method'</span>] <span class="op">=</span> method</span>
<span id="cb24-518"><a href="#cb24-518" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'n_scenes'</span>] <span class="op">=</span> <span class="bu">len</span>(processed_scenes)</span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a>    mosaic_data.attrs[<span class="st">'date_range'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">min</span>(dates)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span><span class="bu">max</span>(dates)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚úÖ Mosaic created from </span><span class="sc">{</span><span class="bu">len</span>(processed_scenes)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üìè Mosaic shape: </span><span class="sc">{</span>mosaic_data[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"üìÖ Date range: </span><span class="sc">{</span>mosaic_data<span class="sc">.</span>attrs[<span class="st">'date_range'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mosaic_data</span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a><span class="co"># Create median composite</span></span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a>mosaic <span class="op">=</span> create_temporal_mosaic(processed_scenes, method<span class="op">=</span><span class="st">'median'</span>)</span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> mosaic:</span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualize the mosaic</span></span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RGB composite of mosaic</span></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a>    red_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'red'</span>].values)</span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a>    green_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'green'</span>].values)</span>
<span id="cb24-537"><a href="#cb24-537" aria-hidden="true" tabindex="-1"></a>    blue_norm <span class="op">=</span> normalize_for_display(mosaic[<span class="st">'blue'</span>].values)</span>
<span id="cb24-538"><a href="#cb24-538" aria-hidden="true" tabindex="-1"></a>    rgb_mosaic <span class="op">=</span> np.dstack([red_norm, green_norm, blue_norm])</span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-540"><a href="#cb24-540" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].imshow(rgb_mosaic)</span>
<span id="cb24-541"><a href="#cb24-541" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="ss">f'RGB Mosaic (</span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">"method"</span>]<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI mosaic</span></span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a>    nir_vals <span class="op">=</span> mosaic[<span class="st">'nir'</span>].values</span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a>    red_vals <span class="op">=</span> mosaic[<span class="st">'red'</span>].values</span>
<span id="cb24-547"><a href="#cb24-547" aria-hidden="true" tabindex="-1"></a>    ndvi_mosaic <span class="op">=</span> (nir_vals <span class="op">-</span> red_vals) <span class="op">/</span> (nir_vals <span class="op">+</span> red_vals <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb24-548"><a href="#cb24-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a>    ndvi_plot <span class="op">=</span> axes[<span class="dv">1</span>].imshow(ndvi_mosaic, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, vmin<span class="op">=-</span><span class="fl">0.2</span>, vmax<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'NDVI Mosaic'</span>)</span>
<span id="cb24-551"><a href="#cb24-551" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-552"><a href="#cb24-552" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(ndvi_plot, ax<span class="op">=</span>axes[<span class="dv">1</span>], shrink<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data availability (how many scenes contributed to each pixel)</span></span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This would require tracking per-pixel contributions</span></span>
<span id="cb24-556"><a href="#cb24-556" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].text(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="ss">f"Scenes used: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'n_scenes'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Method: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'method'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Date range: </span><span class="sc">{</span>mosaic<span class="sc">.</span>attrs[<span class="st">'date_range'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a>                           <span class="ss">f"Coverage: Central Valley, CA"</span>,</span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>axes[<span class="dv">2</span>].transAxes, fontsize<span class="op">=</span><span class="dv">12</span>, verticalalignment<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].set_title(<span class="st">'Mosaic Info'</span>)</span>
<span id="cb24-562"><a href="#cb24-562" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb24-563"><a href="#cb24-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-564"><a href="#cb24-564" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb24-565"><a href="#cb24-565" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb24-566"><a href="#cb24-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-567"><a href="#cb24-567" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üé® Temporal mosaic visualization complete"</span>)</span>
<span id="cb24-568"><a href="#cb24-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-569"><a href="#cb24-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-570"><a href="#cb24-570" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb24-571"><a href="#cb24-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-572"><a href="#cb24-572" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Analysis-Ready Data Cubes</span></span>
<span id="cb24-573"><a href="#cb24-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-574"><a href="#cb24-574" aria-hidden="true" tabindex="-1"></a>Now let's create analysis-ready data cubes that can be used for time series analysis and machine learning.</span>
<span id="cb24-575"><a href="#cb24-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-576"><a href="#cb24-576" aria-hidden="true" tabindex="-1"></a><span class="fu">### Build Temporal Data Cube</span></span>
<span id="cb24-577"><a href="#cb24-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-580"><a href="#cb24-580" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-581"><a href="#cb24-581" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_temporal_datacube(processed_scenes, chunk_size<span class="op">=</span><span class="st">'auto'</span>):</span>
<span id="cb24-582"><a href="#cb24-582" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-583"><a href="#cb24-583" aria-hidden="true" tabindex="-1"></a><span class="co">    Build an analysis-ready temporal data cube.</span></span>
<span id="cb24-584"><a href="#cb24-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-585"><a href="#cb24-585" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-586"><a href="#cb24-586" aria-hidden="true" tabindex="-1"></a><span class="co">        processed_scenes: List of processed scenes</span></span>
<span id="cb24-587"><a href="#cb24-587" aria-hidden="true" tabindex="-1"></a><span class="co">        chunk_size: Dask chunk size for memory management</span></span>
<span id="cb24-588"><a href="#cb24-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-589"><a href="#cb24-589" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-590"><a href="#cb24-590" aria-hidden="true" tabindex="-1"></a><span class="co">        datacube: xarray Dataset with time dimension</span></span>
<span id="cb24-591"><a href="#cb24-591" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-592"><a href="#cb24-592" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> processed_scenes:</span>
<span id="cb24-593"><a href="#cb24-593" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-594"><a href="#cb24-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-595"><a href="#cb24-595" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üìä Building temporal data cube..."</span>)</span>
<span id="cb24-596"><a href="#cb24-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-597"><a href="#cb24-597" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort scenes by date</span></span>
<span id="cb24-598"><a href="#cb24-598" aria-hidden="true" tabindex="-1"></a>    processed_scenes.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'date'</span>])</span>
<span id="cb24-599"><a href="#cb24-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-600"><a href="#cb24-600" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract dates and data</span></span>
<span id="cb24-601"><a href="#cb24-601" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> [pd.to_datetime(scene[<span class="st">'date'</span>]) <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes]</span>
<span id="cb24-602"><a href="#cb24-602" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]</span>
<span id="cb24-603"><a href="#cb24-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-604"><a href="#cb24-604" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build data arrays for each band</span></span>
<span id="cb24-605"><a href="#cb24-605" aria-hidden="true" tabindex="-1"></a>    band_cubes <span class="op">=</span> {}</span>
<span id="cb24-606"><a href="#cb24-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-607"><a href="#cb24-607" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> band <span class="kw">in</span> bands:</span>
<span id="cb24-608"><a href="#cb24-608" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack all scenes for this band</span></span>
<span id="cb24-609"><a href="#cb24-609" aria-hidden="true" tabindex="-1"></a>        band_data <span class="op">=</span> []</span>
<span id="cb24-610"><a href="#cb24-610" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scene <span class="kw">in</span> processed_scenes:</span>
<span id="cb24-611"><a href="#cb24-611" aria-hidden="true" tabindex="-1"></a>            band_data.append(scene[<span class="st">'data'</span>][band])</span>
<span id="cb24-612"><a href="#cb24-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-613"><a href="#cb24-613" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create temporal stack</span></span>
<span id="cb24-614"><a href="#cb24-614" aria-hidden="true" tabindex="-1"></a>        band_cube <span class="op">=</span> xr.concat(band_data, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb24-615"><a href="#cb24-615" aria-hidden="true" tabindex="-1"></a>        band_cube <span class="op">=</span> band_cube.assign_coords(time<span class="op">=</span>dates)</span>
<span id="cb24-616"><a href="#cb24-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-617"><a href="#cb24-617" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add chunking for large datasets</span></span>
<span id="cb24-618"><a href="#cb24-618" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chunk_size <span class="op">==</span> <span class="st">'auto'</span>:</span>
<span id="cb24-619"><a href="#cb24-619" aria-hidden="true" tabindex="-1"></a>            chunks <span class="op">=</span> {<span class="st">'time'</span>: <span class="dv">1</span>, <span class="st">'y'</span>: <span class="dv">512</span>, <span class="st">'x'</span>: <span class="dv">512</span>}</span>
<span id="cb24-620"><a href="#cb24-620" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb24-621"><a href="#cb24-621" aria-hidden="true" tabindex="-1"></a>            chunks <span class="op">=</span> chunk_size</span>
<span id="cb24-622"><a href="#cb24-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-623"><a href="#cb24-623" aria-hidden="true" tabindex="-1"></a>        band_cubes[band] <span class="op">=</span> band_cube.chunk(chunks)</span>
<span id="cb24-624"><a href="#cb24-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-625"><a href="#cb24-625" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create dataset</span></span>
<span id="cb24-626"><a href="#cb24-626" aria-hidden="true" tabindex="-1"></a>    datacube <span class="op">=</span> xr.Dataset(band_cubes)</span>
<span id="cb24-627"><a href="#cb24-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-628"><a href="#cb24-628" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add derived indices</span></span>
<span id="cb24-629"><a href="#cb24-629" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üßÆ Computing vegetation indices..."</span>)</span>
<span id="cb24-630"><a href="#cb24-630" aria-hidden="true" tabindex="-1"></a>    datacube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb24-631"><a href="#cb24-631" aria-hidden="true" tabindex="-1"></a>                        (datacube[<span class="st">'nir'</span>] <span class="op">+</span> datacube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb24-632"><a href="#cb24-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-633"><a href="#cb24-633" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enhanced Vegetation Index (EVI)</span></span>
<span id="cb24-634"><a href="#cb24-634" aria-hidden="true" tabindex="-1"></a>    datacube[<span class="st">'evi'</span>] <span class="op">=</span> (<span class="fl">2.5</span> <span class="op">*</span> (datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb24-635"><a href="#cb24-635" aria-hidden="true" tabindex="-1"></a>                       (datacube[<span class="st">'nir'</span>] <span class="op">+</span> <span class="dv">6</span> <span class="op">*</span> datacube[<span class="st">'red'</span>] <span class="op">-</span> <span class="fl">7.5</span> <span class="op">*</span> datacube[<span class="st">'blue'</span>] <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb24-636"><a href="#cb24-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-637"><a href="#cb24-637" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add metadata</span></span>
<span id="cb24-638"><a href="#cb24-638" aria-hidden="true" tabindex="-1"></a>    datacube.attrs.update({</span>
<span id="cb24-639"><a href="#cb24-639" aria-hidden="true" tabindex="-1"></a>        <span class="st">'title'</span>: <span class="st">'Sentinel-2 Analysis-Ready Data Cube'</span>,</span>
<span id="cb24-640"><a href="#cb24-640" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="st">'Cloud-masked, reprojected temporal stack'</span>,</span>
<span id="cb24-641"><a href="#cb24-641" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_scenes'</span>: <span class="bu">len</span>(processed_scenes),</span>
<span id="cb24-642"><a href="#cb24-642" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time_range'</span>: <span class="ss">f"</span><span class="sc">{</span>dates[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dates[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb24-643"><a href="#cb24-643" aria-hidden="true" tabindex="-1"></a>        <span class="st">'crs'</span>: <span class="bu">str</span>(datacube[<span class="st">'red'</span>].rio.crs),</span>
<span id="cb24-644"><a href="#cb24-644" aria-hidden="true" tabindex="-1"></a>        <span class="st">'resolution'</span>: datacube[<span class="st">'red'</span>].rio.resolution()</span>
<span id="cb24-645"><a href="#cb24-645" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb24-646"><a href="#cb24-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-647"><a href="#cb24-647" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"‚úÖ Data cube created:"</span>)</span>
<span id="cb24-648"><a href="#cb24-648" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Shape: </span><span class="sc">{</span>datacube[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-649"><a href="#cb24-649" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Time steps: </span><span class="sc">{</span><span class="bu">len</span>(dates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-650"><a href="#cb24-650" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Variables: </span><span class="sc">{</span><span class="bu">list</span>(datacube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-651"><a href="#cb24-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-652"><a href="#cb24-652" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> datacube</span>
<span id="cb24-653"><a href="#cb24-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-654"><a href="#cb24-654" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the data cube</span></span>
<span id="cb24-655"><a href="#cb24-655" aria-hidden="true" tabindex="-1"></a>datacube <span class="op">=</span> build_temporal_datacube(processed_scenes)</span>
<span id="cb24-656"><a href="#cb24-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-657"><a href="#cb24-657" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> datacube:</span>
<span id="cb24-658"><a href="#cb24-658" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üì¶ Data Cube Summary:"</span>)</span>
<span id="cb24-659"><a href="#cb24-659" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(datacube)</span>
<span id="cb24-660"><a href="#cb24-660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-661"><a href="#cb24-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-662"><a href="#cb24-662" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time Series Analysis Example</span></span>
<span id="cb24-663"><a href="#cb24-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-666"><a href="#cb24-666" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-667"><a href="#cb24-667" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> datacube:</span>
<span id="cb24-668"><a href="#cb24-668" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time series for a sample location</span></span>
<span id="cb24-669"><a href="#cb24-669" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pick center of study area</span></span>
<span id="cb24-670"><a href="#cb24-670" aria-hidden="true" tabindex="-1"></a>    center_y, center_x <span class="op">=</span> datacube.y.values[<span class="bu">len</span>(datacube.y)<span class="op">//</span><span class="dv">2</span>], datacube.x.values[<span class="bu">len</span>(datacube.x)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb24-671"><a href="#cb24-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-672"><a href="#cb24-672" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time series at center point</span></span>
<span id="cb24-673"><a href="#cb24-673" aria-hidden="true" tabindex="-1"></a>    point_ts <span class="op">=</span> datacube.sel(x<span class="op">=</span>center_x, y<span class="op">=</span>center_y, method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb24-674"><a href="#cb24-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-675"><a href="#cb24-675" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create time series plots</span></span>
<span id="cb24-676"><a href="#cb24-676" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb24-677"><a href="#cb24-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-678"><a href="#cb24-678" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDVI time series</span></span>
<span id="cb24-679"><a href="#cb24-679" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'ndvi'</span>], <span class="st">'g-o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb24-680"><a href="#cb24-680" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'NDVI Time Series'</span>)</span>
<span id="cb24-681"><a href="#cb24-681" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'NDVI'</span>)</span>
<span id="cb24-682"><a href="#cb24-682" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb24-683"><a href="#cb24-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-684"><a href="#cb24-684" aria-hidden="true" tabindex="-1"></a>    <span class="co"># EVI time series</span></span>
<span id="cb24-685"><a href="#cb24-685" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].plot(point_ts.time, point_ts[<span class="st">'evi'</span>], <span class="st">'b-o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb24-686"><a href="#cb24-686" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'EVI Time Series'</span>)</span>
<span id="cb24-687"><a href="#cb24-687" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'EVI'</span>)</span>
<span id="cb24-688"><a href="#cb24-688" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb24-689"><a href="#cb24-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-690"><a href="#cb24-690" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RGB bands time series</span></span>
<span id="cb24-691"><a href="#cb24-691" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'red'</span>], <span class="st">'r-'</span>, label<span class="op">=</span><span class="st">'Red'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb24-692"><a href="#cb24-692" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'green'</span>], <span class="st">'g-'</span>, label<span class="op">=</span><span class="st">'Green'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb24-693"><a href="#cb24-693" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(point_ts.time, point_ts[<span class="st">'blue'</span>], <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'Blue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb24-694"><a href="#cb24-694" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'RGB Bands Time Series'</span>)</span>
<span id="cb24-695"><a href="#cb24-695" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Reflectance'</span>)</span>
<span id="cb24-696"><a href="#cb24-696" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb24-697"><a href="#cb24-697" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb24-698"><a href="#cb24-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-699"><a href="#cb24-699" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NIR time series</span></span>
<span id="cb24-700"><a href="#cb24-700" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].plot(point_ts.time, point_ts[<span class="st">'nir'</span>], <span class="st">'darkred'</span>, marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb24-701"><a href="#cb24-701" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'NIR Band Time Series'</span>)</span>
<span id="cb24-702"><a href="#cb24-702" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'NIR Reflectance'</span>)</span>
<span id="cb24-703"><a href="#cb24-703" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb24-704"><a href="#cb24-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-705"><a href="#cb24-705" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb24-706"><a href="#cb24-706" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb24-707"><a href="#cb24-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-708"><a href="#cb24-708" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"üìà Time series analysis complete"</span>)</span>
<span id="cb24-709"><a href="#cb24-709" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sample location: x=</span><span class="sc">{</span>center_x<span class="sc">:.0f}</span><span class="ss">, y=</span><span class="sc">{</span>center_y<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb24-710"><a href="#cb24-710" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-711"><a href="#cb24-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-712"><a href="#cb24-712" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb24-713"><a href="#cb24-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-714"><a href="#cb24-714" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Scalable Batch Processing Workflow</span></span>
<span id="cb24-715"><a href="#cb24-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-716"><a href="#cb24-716" aria-hidden="true" tabindex="-1"></a>Finally, let's create a reproducible workflow that can handle larger datasets efficiently.</span>
<span id="cb24-717"><a href="#cb24-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-718"><a href="#cb24-718" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Preprocessing Pipeline Class</span></span>
<span id="cb24-719"><a href="#cb24-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-722"><a href="#cb24-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-723"><a href="#cb24-723" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sentinel2Preprocessor:</span>
<span id="cb24-724"><a href="#cb24-724" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-725"><a href="#cb24-725" aria-hidden="true" tabindex="-1"></a><span class="co">    Scalable Sentinel-2 preprocessing pipeline.</span></span>
<span id="cb24-726"><a href="#cb24-726" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-727"><a href="#cb24-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-728"><a href="#cb24-728" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, output_dir<span class="op">=</span><span class="st">"preprocessed_data"</span>, target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>,</span>
<span id="cb24-729"><a href="#cb24-729" aria-hidden="true" tabindex="-1"></a>                 target_resolution<span class="op">=</span><span class="dv">20</span>, max_cloud_cover<span class="op">=</span><span class="dv">15</span>):</span>
<span id="cb24-730"><a href="#cb24-730" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_dir <span class="op">=</span> Path(output_dir)</span>
<span id="cb24-731"><a href="#cb24-731" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-732"><a href="#cb24-732" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_crs <span class="op">=</span> target_crs</span>
<span id="cb24-733"><a href="#cb24-733" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_resolution <span class="op">=</span> target_resolution</span>
<span id="cb24-734"><a href="#cb24-734" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_cloud_cover <span class="op">=</span> max_cloud_cover</span>
<span id="cb24-735"><a href="#cb24-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-736"><a href="#cb24-736" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"üîß Preprocessing pipeline initialized"</span>)</span>
<span id="cb24-737"><a href="#cb24-737" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Output directory: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-738"><a href="#cb24-738" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Target CRS: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-739"><a href="#cb24-739" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Target resolution: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_resolution<span class="sc">}</span><span class="ss">m"</span>)</span>
<span id="cb24-740"><a href="#cb24-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-741"><a href="#cb24-741" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> search_scenes(<span class="va">self</span>, bbox, start_date, end_date, limit<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb24-742"><a href="#cb24-742" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Search for Sentinel-2 scenes."""</span></span>
<span id="cb24-743"><a href="#cb24-743" aria-hidden="true" tabindex="-1"></a>        catalog <span class="op">=</span> Client.<span class="bu">open</span>(<span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span>)</span>
<span id="cb24-744"><a href="#cb24-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-745"><a href="#cb24-745" aria-hidden="true" tabindex="-1"></a>        search_params <span class="op">=</span> {</span>
<span id="cb24-746"><a href="#cb24-746" aria-hidden="true" tabindex="-1"></a>            <span class="st">"collections"</span>: [<span class="st">"sentinel-2-l2a"</span>],</span>
<span id="cb24-747"><a href="#cb24-747" aria-hidden="true" tabindex="-1"></a>            <span class="st">"bbox"</span>: bbox,</span>
<span id="cb24-748"><a href="#cb24-748" aria-hidden="true" tabindex="-1"></a>            <span class="st">"datetime"</span>: <span class="ss">f"</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb24-749"><a href="#cb24-749" aria-hidden="true" tabindex="-1"></a>            <span class="st">"query"</span>: {<span class="st">"eo:cloud_cover"</span>: {<span class="st">"lt"</span>: <span class="va">self</span>.max_cloud_cover}},</span>
<span id="cb24-750"><a href="#cb24-750" aria-hidden="true" tabindex="-1"></a>            <span class="st">"limit"</span>: limit</span>
<span id="cb24-751"><a href="#cb24-751" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-752"><a href="#cb24-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-753"><a href="#cb24-753" aria-hidden="true" tabindex="-1"></a>        search_results <span class="op">=</span> catalog.search(<span class="op">**</span>search_params)</span>
<span id="cb24-754"><a href="#cb24-754" aria-hidden="true" tabindex="-1"></a>        items <span class="op">=</span> <span class="bu">list</span>(search_results.items())</span>
<span id="cb24-755"><a href="#cb24-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-756"><a href="#cb24-756" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"üîç Found </span><span class="sc">{</span><span class="bu">len</span>(items)<span class="sc">}</span><span class="ss"> scenes"</span>)</span>
<span id="cb24-757"><a href="#cb24-757" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> items</span>
<span id="cb24-758"><a href="#cb24-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-759"><a href="#cb24-759" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_scene(<span class="va">self</span>, item, save_individual<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb24-760"><a href="#cb24-760" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Process a single scene with cloud masking."""</span></span>
<span id="cb24-761"><a href="#cb24-761" aria-hidden="true" tabindex="-1"></a>        scene_id <span class="op">=</span> item.<span class="bu">id</span></span>
<span id="cb24-762"><a href="#cb24-762" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> <span class="va">self</span>.output_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">_processed.nc"</span></span>
<span id="cb24-763"><a href="#cb24-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-764"><a href="#cb24-764" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip if already processed</span></span>
<span id="cb24-765"><a href="#cb24-765" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> output_path.exists():</span>
<span id="cb24-766"><a href="#cb24-766" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"‚è≠Ô∏è Skipping </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss"> (already processed)"</span>)</span>
<span id="cb24-767"><a href="#cb24-767" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">str</span>(output_path)</span>
<span id="cb24-768"><a href="#cb24-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-769"><a href="#cb24-769" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process scene</span></span>
<span id="cb24-770"><a href="#cb24-770" aria-hidden="true" tabindex="-1"></a>        data, valid_frac <span class="op">=</span> load_scene_with_cloudmask(</span>
<span id="cb24-771"><a href="#cb24-771" aria-hidden="true" tabindex="-1"></a>            item, <span class="va">self</span>.target_crs, <span class="va">self</span>.target_resolution</span>
<span id="cb24-772"><a href="#cb24-772" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-773"><a href="#cb24-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-774"><a href="#cb24-774" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> data <span class="kw">and</span> valid_frac <span class="op">&gt;</span> <span class="fl">0.3</span>:</span>
<span id="cb24-775"><a href="#cb24-775" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> save_individual:</span>
<span id="cb24-776"><a href="#cb24-776" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Convert to xarray Dataset</span></span>
<span id="cb24-777"><a href="#cb24-777" aria-hidden="true" tabindex="-1"></a>                scene_ds <span class="op">=</span> xr.Dataset(data)</span>
<span id="cb24-778"><a href="#cb24-778" aria-hidden="true" tabindex="-1"></a>                scene_ds.attrs.update({</span>
<span id="cb24-779"><a href="#cb24-779" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'scene_id'</span>: scene_id,</span>
<span id="cb24-780"><a href="#cb24-780" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'date'</span>: item.properties[<span class="st">'datetime'</span>].split(<span class="st">'T'</span>)[<span class="dv">0</span>],</span>
<span id="cb24-781"><a href="#cb24-781" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'cloud_cover'</span>: item.properties.get(<span class="st">'eo:cloud_cover'</span>, <span class="dv">0</span>),</span>
<span id="cb24-782"><a href="#cb24-782" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'valid_pixel_fraction'</span>: valid_frac</span>
<span id="cb24-783"><a href="#cb24-783" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb24-784"><a href="#cb24-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-785"><a href="#cb24-785" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Save to NetCDF</span></span>
<span id="cb24-786"><a href="#cb24-786" aria-hidden="true" tabindex="-1"></a>                scene_ds.to_netcdf(output_path, engine<span class="op">=</span><span class="st">'netcdf4'</span>)</span>
<span id="cb24-787"><a href="#cb24-787" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"üíæ Saved: </span><span class="sc">{</span>output_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-788"><a href="#cb24-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-789"><a href="#cb24-789" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> data</span>
<span id="cb24-790"><a href="#cb24-790" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb24-791"><a href="#cb24-791" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"‚ùå Skipped </span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss"> (insufficient valid pixels)"</span>)</span>
<span id="cb24-792"><a href="#cb24-792" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-793"><a href="#cb24-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-794"><a href="#cb24-794" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_time_series_cube(<span class="va">self</span>, processed_data_list, cube_name<span class="op">=</span><span class="st">"datacube"</span>):</span>
<span id="cb24-795"><a href="#cb24-795" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create and save temporal data cube."""</span></span>
<span id="cb24-796"><a href="#cb24-796" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> processed_data_list:</span>
<span id="cb24-797"><a href="#cb24-797" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"‚ùå No data to create cube"</span>)</span>
<span id="cb24-798"><a href="#cb24-798" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-799"><a href="#cb24-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-800"><a href="#cb24-800" aria-hidden="true" tabindex="-1"></a>        cube_path <span class="op">=</span> <span class="va">self</span>.output_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>cube_name<span class="sc">}</span><span class="ss">.nc"</span></span>
<span id="cb24-801"><a href="#cb24-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-802"><a href="#cb24-802" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build temporal stack</span></span>
<span id="cb24-803"><a href="#cb24-803" aria-hidden="true" tabindex="-1"></a>        dates <span class="op">=</span> []</span>
<span id="cb24-804"><a href="#cb24-804" aria-hidden="true" tabindex="-1"></a>        band_stacks <span class="op">=</span> {band: [] <span class="cf">for</span> band <span class="kw">in</span> [<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'nir'</span>]}</span>
<span id="cb24-805"><a href="#cb24-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-806"><a href="#cb24-806" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data <span class="kw">in</span> processed_data_list:</span>
<span id="cb24-807"><a href="#cb24-807" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> data:</span>
<span id="cb24-808"><a href="#cb24-808" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> band <span class="kw">in</span> band_stacks.keys():</span>
<span id="cb24-809"><a href="#cb24-809" aria-hidden="true" tabindex="-1"></a>                    band_stacks[band].append(data[band])</span>
<span id="cb24-810"><a href="#cb24-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-811"><a href="#cb24-811" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create dataset</span></span>
<span id="cb24-812"><a href="#cb24-812" aria-hidden="true" tabindex="-1"></a>        cube_data <span class="op">=</span> {}</span>
<span id="cb24-813"><a href="#cb24-813" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> band, stack <span class="kw">in</span> band_stacks.items():</span>
<span id="cb24-814"><a href="#cb24-814" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stack:</span>
<span id="cb24-815"><a href="#cb24-815" aria-hidden="true" tabindex="-1"></a>                cube_data[band] <span class="op">=</span> xr.concat(stack, dim<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb24-816"><a href="#cb24-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-817"><a href="#cb24-817" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cube_data:</span>
<span id="cb24-818"><a href="#cb24-818" aria-hidden="true" tabindex="-1"></a>            datacube <span class="op">=</span> xr.Dataset(cube_data)</span>
<span id="cb24-819"><a href="#cb24-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-820"><a href="#cb24-820" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add vegetation indices</span></span>
<span id="cb24-821"><a href="#cb24-821" aria-hidden="true" tabindex="-1"></a>            datacube[<span class="st">'ndvi'</span>] <span class="op">=</span> ((datacube[<span class="st">'nir'</span>] <span class="op">-</span> datacube[<span class="st">'red'</span>]) <span class="op">/</span></span>
<span id="cb24-822"><a href="#cb24-822" aria-hidden="true" tabindex="-1"></a>                               (datacube[<span class="st">'nir'</span>] <span class="op">+</span> datacube[<span class="st">'red'</span>] <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb24-823"><a href="#cb24-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-824"><a href="#cb24-824" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save cube</span></span>
<span id="cb24-825"><a href="#cb24-825" aria-hidden="true" tabindex="-1"></a>            datacube.to_netcdf(cube_path, engine<span class="op">=</span><span class="st">'netcdf4'</span>)</span>
<span id="cb24-826"><a href="#cb24-826" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"üì¶ Data cube saved: </span><span class="sc">{</span>cube_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-827"><a href="#cb24-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-828"><a href="#cb24-828" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> datacube</span>
<span id="cb24-829"><a href="#cb24-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-830"><a href="#cb24-830" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-831"><a href="#cb24-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-832"><a href="#cb24-832" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize preprocessor</span></span>
<span id="cb24-833"><a href="#cb24-833" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> Sentinel2Preprocessor(</span>
<span id="cb24-834"><a href="#cb24-834" aria-hidden="true" tabindex="-1"></a>    output_dir<span class="op">=</span><span class="st">"week2_preprocessed"</span>,</span>
<span id="cb24-835"><a href="#cb24-835" aria-hidden="true" tabindex="-1"></a>    target_crs<span class="op">=</span><span class="st">'EPSG:32610'</span>,  <span class="co"># UTM Zone 10N for California</span></span>
<span id="cb24-836"><a href="#cb24-836" aria-hidden="true" tabindex="-1"></a>    target_resolution<span class="op">=</span><span class="dv">20</span></span>
<span id="cb24-837"><a href="#cb24-837" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-838"><a href="#cb24-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-839"><a href="#cb24-839" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"‚úÖ Preprocessing pipeline ready"</span>)</span>
<span id="cb24-840"><a href="#cb24-840" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-841"><a href="#cb24-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-842"><a href="#cb24-842" aria-hidden="true" tabindex="-1"></a><span class="fu">### Run Complete Preprocessing Workflow</span></span>
<span id="cb24-843"><a href="#cb24-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-846"><a href="#cb24-846" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-847"><a href="#cb24-847" aria-hidden="true" tabindex="-1"></a><span class="co"># Define workflow parameters</span></span>
<span id="cb24-848"><a href="#cb24-848" aria-hidden="true" tabindex="-1"></a>workflow_params <span class="op">=</span> {</span>
<span id="cb24-849"><a href="#cb24-849" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bbox'</span>: central_valley_bbox,</span>
<span id="cb24-850"><a href="#cb24-850" aria-hidden="true" tabindex="-1"></a>    <span class="st">'start_date'</span>: <span class="st">"2024-07-01"</span>,</span>
<span id="cb24-851"><a href="#cb24-851" aria-hidden="true" tabindex="-1"></a>    <span class="st">'end_date'</span>: <span class="st">"2024-08-15"</span>,</span>
<span id="cb24-852"><a href="#cb24-852" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_scenes'</span>: <span class="dv">10</span>  <span class="co"># Limit for demonstration</span></span>
<span id="cb24-853"><a href="#cb24-853" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-854"><a href="#cb24-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-855"><a href="#cb24-855" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"üöÄ Starting complete preprocessing workflow..."</span>)</span>
<span id="cb24-856"><a href="#cb24-856" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Area: Central Valley, CA"</span>)</span>
<span id="cb24-857"><a href="#cb24-857" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Period: </span><span class="sc">{</span>workflow_params[<span class="st">'start_date'</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>workflow_params[<span class="st">'end_date'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-858"><a href="#cb24-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-859"><a href="#cb24-859" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Search for scenes</span></span>
<span id="cb24-860"><a href="#cb24-860" aria-hidden="true" tabindex="-1"></a>workflow_items <span class="op">=</span> preprocessor.search_scenes(</span>
<span id="cb24-861"><a href="#cb24-861" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'bbox'</span>],</span>
<span id="cb24-862"><a href="#cb24-862" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'start_date'</span>],</span>
<span id="cb24-863"><a href="#cb24-863" aria-hidden="true" tabindex="-1"></a>    workflow_params[<span class="st">'end_date'</span>],</span>
<span id="cb24-864"><a href="#cb24-864" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span>workflow_params[<span class="st">'max_scenes'</span>]</span>
<span id="cb24-865"><a href="#cb24-865" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-866"><a href="#cb24-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-867"><a href="#cb24-867" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Process scenes</span></span>
<span id="cb24-868"><a href="#cb24-868" aria-hidden="true" tabindex="-1"></a>processed_data <span class="op">=</span> []</span>
<span id="cb24-869"><a href="#cb24-869" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, item <span class="kw">in</span> <span class="bu">enumerate</span>(workflow_items[:<span class="dv">5</span>]):  <span class="co"># Process first 5 for demo</span></span>
<span id="cb24-870"><a href="#cb24-870" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing scene </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">min</span>(<span class="dv">5</span>, <span class="bu">len</span>(workflow_items))<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>item<span class="sc">.</span><span class="bu">id</span>[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb24-871"><a href="#cb24-871" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> preprocessor.process_scene(item, save_individual<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-872"><a href="#cb24-872" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data:</span>
<span id="cb24-873"><a href="#cb24-873" aria-hidden="true" tabindex="-1"></a>        processed_data.append(data)</span>
<span id="cb24-874"><a href="#cb24-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-875"><a href="#cb24-875" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Create temporal data cube</span></span>
<span id="cb24-876"><a href="#cb24-876" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> processed_data:</span>
<span id="cb24-877"><a href="#cb24-877" aria-hidden="true" tabindex="-1"></a>    final_cube <span class="op">=</span> preprocessor.create_time_series_cube(</span>
<span id="cb24-878"><a href="#cb24-878" aria-hidden="true" tabindex="-1"></a>        processed_data,</span>
<span id="cb24-879"><a href="#cb24-879" aria-hidden="true" tabindex="-1"></a>        cube_name<span class="op">=</span><span class="st">"central_valley_cube"</span></span>
<span id="cb24-880"><a href="#cb24-880" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-881"><a href="#cb24-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-882"><a href="#cb24-882" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> final_cube:</span>
<span id="cb24-883"><a href="#cb24-883" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üéâ Workflow completed successfully!"</span>)</span>
<span id="cb24-884"><a href="#cb24-884" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Processed scenes: </span><span class="sc">{</span><span class="bu">len</span>(processed_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-885"><a href="#cb24-885" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Output directory: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-886"><a href="#cb24-886" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Data cube shape: </span><span class="sc">{</span>final_cube[<span class="st">'red'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-887"><a href="#cb24-887" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-888"><a href="#cb24-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-889"><a href="#cb24-889" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create Processing Summary Report</span></span>
<span id="cb24-890"><a href="#cb24-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-893"><a href="#cb24-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-894"><a href="#cb24-894" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate processing summary</span></span>
<span id="cb24-895"><a href="#cb24-895" aria-hidden="true" tabindex="-1"></a>output_files <span class="op">=</span> <span class="bu">list</span>(preprocessor.output_dir.glob(<span class="st">"*.nc"</span>))</span>
<span id="cb24-896"><a href="#cb24-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-897"><a href="#cb24-897" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìã Processing Summary Report"</span>)</span>
<span id="cb24-898"><a href="#cb24-898" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb24-899"><a href="#cb24-899" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Output Directory: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-900"><a href="#cb24-900" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Files Created: </span><span class="sc">{</span><span class="bu">len</span>(output_files)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-901"><a href="#cb24-901" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Processing Parameters:"</span>)</span>
<span id="cb24-902"><a href="#cb24-902" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Target CRS: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>target_crs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-903"><a href="#cb24-903" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Target Resolution: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>target_resolution<span class="sc">}</span><span class="ss">m"</span>)</span>
<span id="cb24-904"><a href="#cb24-904" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Max Cloud Cover: </span><span class="sc">{</span>preprocessor<span class="sc">.</span>max_cloud_cover<span class="sc">}</span><span class="ss">%"</span>)</span>
<span id="cb24-905"><a href="#cb24-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-906"><a href="#cb24-906" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìÅ Output Files:"</span>)</span>
<span id="cb24-907"><a href="#cb24-907" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> file_path <span class="kw">in</span> <span class="bu">sorted</span>(output_files):</span>
<span id="cb24-908"><a href="#cb24-908" aria-hidden="true" tabindex="-1"></a>    file_size <span class="op">=</span> file_path.stat().st_size <span class="op">/</span> (<span class="dv">1024</span><span class="op">*</span><span class="dv">1024</span>)  <span class="co"># MB</span></span>
<span id="cb24-909"><a href="#cb24-909" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>file_size<span class="sc">:.1f}</span><span class="ss"> MB)"</span>)</span>
<span id="cb24-910"><a href="#cb24-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-911"><a href="#cb24-911" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if final_cube was created successfully</span></span>
<span id="cb24-912"><a href="#cb24-912" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb24-913"><a href="#cb24-913" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> final_cube:</span>
<span id="cb24-914"><a href="#cb24-914" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìä Final Data Cube Statistics:"</span>)</span>
<span id="cb24-915"><a href="#cb24-915" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Shape: </span><span class="sc">{</span>final_cube<span class="sc">.</span>dims<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-916"><a href="#cb24-916" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Variables: </span><span class="sc">{</span><span class="bu">list</span>(final_cube.data_vars)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-917"><a href="#cb24-917" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Memory usage: ~</span><span class="sc">{</span>final_cube<span class="sc">.</span>nbytes <span class="op">/</span> (<span class="dv">1024</span><span class="op">**</span><span class="dv">2</span>)<span class="sc">:.1f}</span><span class="ss"> MB"</span>)</span>
<span id="cb24-918"><a href="#cb24-918" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb24-919"><a href="#cb24-919" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üìä Final Data Cube: Not created (no valid data processed)"</span>)</span>
<span id="cb24-920"><a href="#cb24-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-921"><a href="#cb24-921" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">üöÄ Ready for Week 3: Machine Learning on Remote Sensing!"</span>)</span>
<span id="cb24-922"><a href="#cb24-922" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-923"><a href="#cb24-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-924"><a href="#cb24-924" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb24-925"><a href="#cb24-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-926"><a href="#cb24-926" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb24-927"><a href="#cb24-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-928"><a href="#cb24-928" aria-hidden="true" tabindex="-1"></a>üéâ **Excellent work!** You've built a production-ready preprocessing pipeline for Sentinel-2 imagery.</span>
<span id="cb24-929"><a href="#cb24-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-930"><a href="#cb24-930" aria-hidden="true" tabindex="-1"></a><span class="fu">### What You Accomplished:</span></span>
<span id="cb24-931"><a href="#cb24-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-932"><a href="#cb24-932" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Multi-scene Data Discovery**: Searched and organized multiple satellite scenes</span>
<span id="cb24-933"><a href="#cb24-933" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Automated Cloud Masking**: Used Scene Classification Layer for quality filtering</span>
<span id="cb24-934"><a href="#cb24-934" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Spatial Harmonization**: Reprojected and aligned multiple scenes</span>
<span id="cb24-935"><a href="#cb24-935" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Temporal Compositing**: Created cloud-free mosaics using median compositing</span>
<span id="cb24-936"><a href="#cb24-936" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Analysis-Ready Data Cubes**: Built time series datasets for analysis</span>
<span id="cb24-937"><a href="#cb24-937" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Scalable Workflows**: Implemented batch processing with parallel execution</span>
<span id="cb24-938"><a href="#cb24-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-939"><a href="#cb24-939" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Takeaways:</span></span>
<span id="cb24-940"><a href="#cb24-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-941"><a href="#cb24-941" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Scene Classification Layer is powerful** - automates cloud/shadow detection</span>
<span id="cb24-942"><a href="#cb24-942" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reprojection is essential** - ensures scenes can be combined seamlessly</span>
<span id="cb24-943"><a href="#cb24-943" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Temporal compositing reduces clouds** - median filtering creates cleaner datasets</span>
<span id="cb24-944"><a href="#cb24-944" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Data cubes enable time series analysis** - organize data for trend detection</span>
<span id="cb24-945"><a href="#cb24-945" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Batch processing scales** - handle large datasets efficiently</span>
<span id="cb24-946"><a href="#cb24-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-947"><a href="#cb24-947" aria-hidden="true" tabindex="-1"></a><span class="fu">### Next Week Preview:</span></span>
<span id="cb24-948"><a href="#cb24-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-949"><a href="#cb24-949" aria-hidden="true" tabindex="-1"></a>In **Week 3**, we'll use your preprocessed data to **train CNNs on land cover patches**:</span>
<span id="cb24-950"><a href="#cb24-950" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Extract training patches from your data cubes</span>
<span id="cb24-951"><a href="#cb24-951" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create labeled datasets for supervised learning</span>
<span id="cb24-952"><a href="#cb24-952" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build and train convolutional neural networks</span>
<span id="cb24-953"><a href="#cb24-953" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compare different CNN architectures</span>
<span id="cb24-954"><a href="#cb24-954" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Evaluate model performance on real satellite imagery</span>
<span id="cb24-955"><a href="#cb24-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-956"><a href="#cb24-956" aria-hidden="true" tabindex="-1"></a>Your preprocessing pipeline outputs will be the foundation for machine learning workflows!</span>
<span id="cb24-957"><a href="#cb24-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-958"><a href="#cb24-958" aria-hidden="true" tabindex="-1"></a><span class="fu">## Resources</span></span>
<span id="cb24-959"><a href="#cb24-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-960"><a href="#cb24-960" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Sentinel-2 Scene Classification Layer</span><span class="co">](https://sentinels.copernicus.eu/web/sentinel/technical-guides/sentinel-2-msi/level-2a/algorithm)</span></span>
<span id="cb24-961"><a href="#cb24-961" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Rasterio Reprojection Guide</span><span class="co">](https://rasterio.readthedocs.io/en/latest/topics/reproject.html)</span></span>
<span id="cb24-962"><a href="#cb24-962" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Xarray User Guide for Geosciences</span><span class="co">](https://docs.xarray.dev/en/stable/user-guide/index.html)</span></span>
<span id="cb24-963"><a href="#cb24-963" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Dask for Geospatial Data</span><span class="co">](https://docs.dask.org/en/latest/array.html)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/geog-logo.png" class="img-fluid figure-img" width="250"></p>
<figcaption>Department of Geography logo</figcaption>
</figure>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This website is built with <a href="https://github.com/kcaylor/GEOG-288KC-geospatial-foundation-models"><i class="fa-brands fa-github" title="the github octocat logo" aria-label="github"></i></a> and <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>