<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Model Evaluation &amp; Validation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">GEOG 288KC</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">🏠 home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Syllabus.html"> 
<span class="menu-text">📋 syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-sessions" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">💻 weekly sessions</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-weekly-sessions">    
        <li>
    <a class="dropdown-item" href="../../chapters/c01-geospatial-data-foundations.html">
 <span class="dropdown-text">Week 1 - 🚀 Core Tools and Data Access</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c02-spatial-temporal-attention-mechanisms.html">
 <span class="dropdown-text">Week 2 - ⚡ Rapid Remote Sensing Preprocessing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c03-complete-gfm-architecture.html">
 <span class="dropdown-text">Week 3 - 🤖 Machine Learning on Remote Sensing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c04-pretraining-implementation.html">
 <span class="dropdown-text">Week 4 - 🏗️ Foundation Models in Practice</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c05-training-loop-optimization.html">
 <span class="dropdown-text">Week 5 - 🔧 Fine-Tuning &amp; Transfer Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c06-model-evaluation-analysis.html">
 <span class="dropdown-text">Week 6 - ⏰ Spatiotemporal Modeling &amp; Projects</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cheatsheets" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">👀 cheatsheets</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-cheatsheets">    
        <li>
    <a class="dropdown-item" href="../../cheatsheets.html">
 <span class="dropdown-text">📋 All Cheatsheets</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">⚡ Quick Starts</li>
        <li>
    <a class="dropdown-item" href="../../extras/cheatsheets/week01_imports.html">
 <span class="dropdown-text">Week 01: Import Guide</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-explainers" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">🧩 explainers</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-explainers">    
        <li class="dropdown-header">1️⃣ Week 1</li>
        <li>
    <a class="dropdown-item" href="../../extras/ai-ml-dl-fm-hierarchy.html">
 <span class="dropdown-text">🤖 AI/ML/DL/FM Hierarchy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/geospatial-foundation-model-predictions-standalone.html">
 <span class="dropdown-text">🎯 GFM Predictions (Standalone)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/geospatial-prediction-hierarchy.html">
 <span class="dropdown-text">✅ Geospatial Task/Prediction Types</span></a>
  </li>  
        <li class="dropdown-header">2️⃣ Week 2</li>
        <li>
    <a class="dropdown-item" href="../../chapters/c00a-foundation_model_architectures.html">
 <span class="dropdown-text">🏗️ Foundation Model Architectures</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../chapters/c00b-introduction-to-deeplearning-architecture.html">
 <span class="dropdown-text">🎓 Introduction to Deep Learning Architecture</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-extras" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">📖 extras</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-extras">    
        <li class="dropdown-header">🎯 Practical Examples</li>
        <li>
    <a class="dropdown-item" href="../../extras/examples/normalization_comparison.html">
 <span class="dropdown-text">Normalization Comparison</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/resnet.html">
 <span class="dropdown-text">ResNet Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/text_encoder.html">
 <span class="dropdown-text">Text Encoder</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/tiling-and-patches.html">
 <span class="dropdown-text">Tiling and Patches</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/examples/terratorch_workflows.html">
 <span class="dropdown-text">TerraTorch Workflows</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/resources/course_resources.html">
 <span class="dropdown-text">📚 Reference Materials</span></a>
  </li>  
        <li class="dropdown-header">📁 Project Templates</li>
        <li>
    <a class="dropdown-item" href="../../extras/projects/project-proposal-template.html">
 <span class="dropdown-text">Project Proposal Template</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../extras/projects/mvp-template.html">
 <span class="dropdown-text">Project Results Template</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gfms-from-scratch/gfms-from-scratch.github.io" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">Model Evaluation &amp; Validation</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead">Comprehensive evaluation strategies for geospatial models</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-left">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction-to-model-evaluation" id="toc-introduction-to-model-evaluation" class="nav-link active" data-scroll-target="#introduction-to-model-evaluation">Introduction to Model Evaluation</a></li>
  <li><a href="#evaluation-metrics-for-different-task-types" id="toc-evaluation-metrics-for-different-task-types" class="nav-link" data-scroll-target="#evaluation-metrics-for-different-task-types">Evaluation Metrics for Different Task Types</a>
  <ul class="collapse">
  <li><a href="#classification-metrics" id="toc-classification-metrics" class="nav-link" data-scroll-target="#classification-metrics">Classification Metrics</a></li>
  <li><a href="#regression-metrics" id="toc-regression-metrics" class="nav-link" data-scroll-target="#regression-metrics">Regression Metrics</a></li>
  <li><a href="#segmentation-metrics" id="toc-segmentation-metrics" class="nav-link" data-scroll-target="#segmentation-metrics">Segmentation Metrics</a></li>
  </ul></li>
  <li><a href="#spatial-validation-strategies" id="toc-spatial-validation-strategies" class="nav-link" data-scroll-target="#spatial-validation-strategies">Spatial Validation Strategies</a>
  <ul class="collapse">
  <li><a href="#cross-validation-with-spatial-awareness" id="toc-cross-validation-with-spatial-awareness" class="nav-link" data-scroll-target="#cross-validation-with-spatial-awareness">Cross-Validation with Spatial Awareness</a></li>
  </ul></li>
  <li><a href="#temporal-validation" id="toc-temporal-validation" class="nav-link" data-scroll-target="#temporal-validation">Temporal Validation</a>
  <ul class="collapse">
  <li><a href="#time-series-cross-validation" id="toc-time-series-cross-validation" class="nav-link" data-scroll-target="#time-series-cross-validation">Time Series Cross-Validation</a></li>
  </ul></li>
  <li><a href="#model-uncertainty-quantification" id="toc-model-uncertainty-quantification" class="nav-link" data-scroll-target="#model-uncertainty-quantification">Model Uncertainty Quantification</a>
  <ul class="collapse">
  <li><a href="#uncertainty-estimation-methods" id="toc-uncertainty-estimation-methods" class="nav-link" data-scroll-target="#uncertainty-estimation-methods">Uncertainty Estimation Methods</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">





<section id="introduction-to-model-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-model-evaluation">Introduction to Model Evaluation</h2>
<p>Model evaluation in geospatial AI requires specialized metrics and validation strategies that account for spatial dependencies, temporal variations, and domain-specific requirements. This cheatsheet covers comprehensive evaluation approaches.</p>
<div id="cf31c48d" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, precision_recall_fscore_support, confusion_matrix</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, mean_absolute_error, r2_score</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"PyTorch version: </span><span class="sc">{</span>torch<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PyTorch version: 2.7.1</code></pre>
</div>
</div>
</section>
<section id="evaluation-metrics-for-different-task-types" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-metrics-for-different-task-types">Evaluation Metrics for Different Task Types</h2>
<section id="classification-metrics" class="level3">
<h3 class="anchored" data-anchor-id="classification-metrics">Classification Metrics</h3>
<div id="37017103" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> comprehensive_classification_evaluation():</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate comprehensive classification evaluation metrics"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate classification results for land cover classification</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    num_samples <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    num_classes <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> [<span class="st">'Water'</span>, <span class="st">'Forest'</span>, <span class="st">'Urban'</span>, <span class="st">'Agriculture'</span>, <span class="st">'Grassland'</span>, <span class="st">'Bareland'</span>]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate realistic predictions (imbalanced classes)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    class_probs <span class="op">=</span> [<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="fl">0.1</span>, <span class="fl">0.05</span>]  <span class="co"># Different class frequencies</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.random.choice(num_classes, size<span class="op">=</span>num_samples, p<span class="op">=</span>class_probs)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate predictions with class-dependent accuracy</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> y_true.copy()</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    class_accuracies <span class="op">=</span> [<span class="fl">0.95</span>, <span class="fl">0.88</span>, <span class="fl">0.82</span>, <span class="fl">0.85</span>, <span class="fl">0.78</span>, <span class="fl">0.70</span>]  <span class="co"># Different per-class accuracies</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_classes):</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        class_mask <span class="op">=</span> y_true <span class="op">==</span> i</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        num_class_samples <span class="op">=</span> class_mask.<span class="bu">sum</span>()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        num_errors <span class="op">=</span> <span class="bu">int</span>(num_class_samples <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> class_accuracies[i]))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_errors <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            error_indices <span class="op">=</span> np.random.choice(np.where(class_mask)[<span class="dv">0</span>], num_errors, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create confusion: assign to other classes</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            other_classes <span class="op">=</span> [j <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(num_classes) <span class="cf">if</span> j <span class="op">!=</span> i]</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>            y_pred[error_indices] <span class="op">=</span> np.random.choice(other_classes, num_errors)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate prediction probabilities</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    y_probs <span class="op">=</span> np.zeros((num_samples, num_classes))</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_samples):</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create realistic probability distributions</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        true_class <span class="op">=</span> y_true[i]</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        pred_class <span class="op">=</span> y_pred[i]</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Base probabilities</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        base_probs <span class="op">=</span> np.random.dirichlet([<span class="fl">0.5</span>] <span class="op">*</span> num_classes)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Boost true class probability</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        base_probs[true_class] <span class="op">+=</span> <span class="fl">0.5</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If prediction is correct, boost predicted class</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> true_class <span class="op">==</span> pred_class:</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>            base_probs[pred_class] <span class="op">+=</span> <span class="fl">0.3</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        y_probs[i] <span class="op">=</span> base_probs <span class="op">/</span> base_probs.<span class="bu">sum</span>()</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate comprehensive metrics</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> (accuracy_score, precision_recall_fscore_support, </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>                                classification_report, confusion_matrix,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>                                roc_auc_score, average_precision_score)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic metrics</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> accuracy_score(y_true, y_pred)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    precision, recall, f1, support <span class="op">=</span> precision_recall_fscore_support(y_true, y_pred, average<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    macro_precision, macro_recall, macro_f1, _ <span class="op">=</span> precision_recall_fscore_support(y_true, y_pred, average<span class="op">=</span><span class="st">'macro'</span>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    weighted_precision, weighted_recall, weighted_f1, _ <span class="op">=</span> precision_recall_fscore_support(y_true, y_pred, average<span class="op">=</span><span class="st">'weighted'</span>)</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confusion matrix</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_true, y_pred)</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Per-class accuracy</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    per_class_accuracy <span class="op">=</span> cm.diagonal() <span class="op">/</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiclass AUC (one-vs-rest)</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    auc_scores <span class="op">=</span> []</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_classes):</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>        y_true_binary <span class="op">=</span> (y_true <span class="op">==</span> i).astype(<span class="bu">int</span>)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>        auc <span class="op">=</span> roc_auc_score(y_true_binary, y_probs[:, i])</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>        auc_scores.append(auc)</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Classification Evaluation Results:"</span>)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Overall Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Macro F1-Score: </span><span class="sc">{</span>macro_f1<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Weighted F1-Score: </span><span class="sc">{</span>weighted_f1<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Per-Class Metrics:"</span>)</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Class'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Precision'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Recall'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'F1-Score'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Accuracy'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'AUC'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Support'</span><span class="sc">:&lt;10}</span><span class="ss">"</span>)</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(class_names):</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>class_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>precision[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>recall[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>f1[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>per_class_accuracy[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>auc_scores[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>support[i]<span class="sc">:&lt;10.0f}</span><span class="ss">"</span>)</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">12</span>))</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confusion Matrix</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span><span class="st">'Blues'</span>, </span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>                xticklabels<span class="op">=</span>class_names, yticklabels<span class="op">=</span>class_names, ax<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">0</span>])</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Confusion Matrix'</span>)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Predicted'</span>)</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'True'</span>)</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Per-class metrics</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Precision'</span>: precision,</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Recall'</span>: recall,</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">'F1-Score'</span>: f1,</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Accuracy'</span>: per_class_accuracy</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>class_names)</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>    metrics_df.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">1</span>], alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Per-Class Performance Metrics'</span>)</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Score'</span>)</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].legend(bbox_to_anchor<span class="op">=</span>(<span class="fl">1.05</span>, <span class="dv">1</span>), loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Class distribution</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    unique, counts <span class="op">=</span> np.unique(y_true, return_counts<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].bar(class_names, counts, color<span class="op">=</span><span class="st">'skyblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Class Distribution (Ground Truth)'</span>)</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Samples'</span>)</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AUC scores</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].bar(class_names, auc_scores, color<span class="op">=</span><span class="st">'lightcoral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'AUC Scores per Class'</span>)</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'AUC Score'</span>)</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>        <span class="st">'accuracy'</span>: accuracy,</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">'precision'</span>: precision,</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">'recall'</span>: recall,</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">'f1'</span>: f1,</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>        <span class="st">'confusion_matrix'</span>: cm,</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>        <span class="st">'auc_scores'</span>: auc_scores,</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_true'</span>: y_true,</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_pred'</span>: y_pred,</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_probs'</span>: y_probs</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>classification_results <span class="op">=</span> comprehensive_classification_evaluation()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classification Evaluation Results:
==================================================
Overall Accuracy: 0.853
Macro F1-Score: 0.812
Weighted F1-Score: 0.856

Per-Class Metrics:
--------------------------------------------------------------------------------
Class        Precision  Recall     F1-Score   Accuracy   AUC        Support   
--------------------------------------------------------------------------------
Water        0.792      0.954      0.866      0.954      0.996      108       
Forest       0.929      0.882      0.905      0.882      0.994      313       
Urban        0.878      0.823      0.849      0.823      0.990      192       
Agriculture  0.917      0.850      0.882      0.850      0.994      234       
Grassland    0.737      0.785      0.760      0.785      0.993      107       
Bareland     0.532      0.717      0.611      0.717      0.985      46        </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="model_evaluation_validation_files/figure-html/cell-3-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="regression-metrics" class="level3">
<h3 class="anchored" data-anchor-id="regression-metrics">Regression Metrics</h3>
<div id="dccccbde" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> comprehensive_regression_evaluation():</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate comprehensive regression evaluation metrics"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate regression results for vegetation index prediction</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    num_samples <span class="op">=</span> <span class="dv">800</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate realistic NDVI values (target)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate seasonal pattern with spatial variation</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    time_component <span class="op">=</span> np.sin(np.linspace(<span class="dv">0</span>, <span class="dv">4</span><span class="op">*</span>np.pi, num_samples)) <span class="op">*</span> <span class="fl">0.3</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    spatial_component <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.2</span>, num_samples)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.1</span>, num_samples)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> <span class="fl">0.5</span> <span class="op">+</span> time_component <span class="op">+</span> spatial_component <span class="op">+</span> noise</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.clip(y_true, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)  <span class="co"># NDVI range</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate predictions with realistic errors</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add heteroscedastic noise (error depends on true value)</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    prediction_noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.05</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> np.<span class="bu">abs</span>(y_true))</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    bias <span class="op">=</span> <span class="op">-</span><span class="fl">0.02</span>  <span class="co"># Slight systematic bias</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> y_true <span class="op">+</span> prediction_noise <span class="op">+</span> bias</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.clip(y_pred, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate comprehensive regression metrics</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(y_true, y_pred)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> mean_squared_error(y_true, y_pred)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(y_true, y_pred)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional metrics</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mean_absolute_percentage_error(y_true, y_pred):</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate MAPE, handling near-zero values"""</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> np.<span class="bu">abs</span>(y_true) <span class="op">&gt;</span> <span class="fl">1e-6</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.mean(np.<span class="bu">abs</span>((y_true[mask] <span class="op">-</span> y_pred[mask]) <span class="op">/</span> y_true[mask])) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> symmetric_mean_absolute_percentage_error(y_true, y_pred):</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate symmetric MAPE"""</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.mean(<span class="dv">2</span> <span class="op">*</span> np.<span class="bu">abs</span>(y_true <span class="op">-</span> y_pred) <span class="op">/</span> (np.<span class="bu">abs</span>(y_true) <span class="op">+</span> np.<span class="bu">abs</span>(y_pred))) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    mape <span class="op">=</span> mean_absolute_percentage_error(y_true, y_pred)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    smape <span class="op">=</span> symmetric_mean_absolute_percentage_error(y_true, y_pred)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residual analysis</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> y_true <span class="op">-</span> y_pred</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Statistical tests</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shapiro-Wilk test for normality of residuals</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    shapiro_stat, shapiro_p <span class="op">=</span> stats.shapiro(residuals[:<span class="dv">100</span>])  <span class="co"># Sample for computational efficiency</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Durbin-Watson test for autocorrelation (simplified)</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> durbin_watson(residuals):</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate Durbin-Watson statistic"""</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        diff <span class="op">=</span> np.diff(residuals)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>(diff<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> np.<span class="bu">sum</span>(residuals<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    dw_stat <span class="op">=</span> durbin_watson(residuals)</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile-based metrics</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    q25_error <span class="op">=</span> np.percentile(np.<span class="bu">abs</span>(residuals), <span class="dv">25</span>)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    median_error <span class="op">=</span> np.median(np.<span class="bu">abs</span>(residuals))</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    q75_error <span class="op">=</span> np.percentile(np.<span class="bu">abs</span>(residuals), <span class="dv">75</span>)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    q95_error <span class="op">=</span> np.percentile(np.<span class="bu">abs</span>(residuals), <span class="dv">95</span>)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Regression Evaluation Results:"</span>)</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Absolute Error (MAE): </span><span class="sc">{</span>mae<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Squared Error (MSE): </span><span class="sc">{</span>mse<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Root Mean Squared Error (RMSE): </span><span class="sc">{</span>rmse<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"R² Score: </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Absolute Percentage Error (MAPE): </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Symmetric MAPE: </span><span class="sc">{</span>smape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Residual Analysis:"</span>)</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Residual (Bias): </span><span class="sc">{</span>residuals<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Std of Residuals: </span><span class="sc">{</span>residuals<span class="sc">.</span>std()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Residual Skewness: </span><span class="sc">{</span>stats<span class="sc">.</span>skew(residuals)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Residual Kurtosis: </span><span class="sc">{</span>stats<span class="sc">.</span>kurtosis(residuals)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Shapiro-Wilk p-value: </span><span class="sc">{</span>shapiro_p<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Durbin-Watson statistic: </span><span class="sc">{</span>dw_stat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Quantile-based Error Analysis:"</span>)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"25th percentile error: </span><span class="sc">{</span>q25_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Median error: </span><span class="sc">{</span>median_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"75th percentile error: </span><span class="sc">{</span>q75_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"95th percentile error: </span><span class="sc">{</span>q95_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scatter plot: True vs Predicted</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].scatter(y_true, y_pred, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].plot([<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>], [<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>], <span class="st">'r--'</span>, lw<span class="op">=</span><span class="dv">2</span>)  <span class="co"># Perfect prediction line</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'True Values'</span>)</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Predicted Values'</span>)</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="ss">f'True vs Predicted (R² = </span><span class="sc">{</span>r2<span class="sc">:.3f}</span><span class="ss">)'</span>)</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residual plot</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].scatter(y_pred, residuals, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted Values'</span>)</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Residuals'</span>)</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Residual Plot'</span>)</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Q-Q plot for residual normality</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    stats.probplot(residuals, dist<span class="op">=</span><span class="st">"norm"</span>, plot<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">2</span>])</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'Q-Q Plot (Residual Normality)'</span>)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residual histogram</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].hist(residuals, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'skyblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].axvline(residuals.mean(), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="ss">f'Mean = </span><span class="sc">{</span>residuals<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Residuals'</span>)</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Residual Distribution'</span>)</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Error distribution by predicted value ranges</span></span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>    pred_ranges <span class="op">=</span> np.linspace(y_pred.<span class="bu">min</span>(), y_pred.<span class="bu">max</span>(), <span class="dv">10</span>)</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>    range_errors <span class="op">=</span> []</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>    range_labels <span class="op">=</span> []</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(pred_ranges)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (y_pred <span class="op">&gt;=</span> pred_ranges[i]) <span class="op">&amp;</span> (y_pred <span class="op">&lt;</span> pred_ranges[i<span class="op">+</span><span class="dv">1</span>])</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>            range_errors.append(np.<span class="bu">abs</span>(residuals[mask]))</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>            range_labels.append(<span class="ss">f'</span><span class="sc">{</span>pred_ranges[i]<span class="sc">:.2f}</span><span class="ss">-</span><span class="sc">{</span>pred_ranges[i<span class="op">+</span><span class="dv">1</span>]<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].boxplot(range_errors, labels<span class="op">=</span>range_labels)</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted Value Range'</span>)</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Absolute Error'</span>)</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'Error Distribution by Prediction Range'</span>)</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time series of residuals (if applicable)</span></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].plot(residuals, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_xlabel(<span class="st">'Sample Index'</span>)</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Residuals'</span>)</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Residuals over Time/Space'</span>)</span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae'</span>: mae, <span class="st">'mse'</span>: mse, <span class="st">'rmse'</span>: rmse, <span class="st">'r2'</span>: r2,</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mape'</span>: mape, <span class="st">'smape'</span>: smape,</span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>        <span class="st">'residuals'</span>: residuals,</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_true'</span>: y_true, <span class="st">'y_pred'</span>: y_pred</span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>regression_results <span class="op">=</span> comprehensive_regression_evaluation()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Regression Evaluation Results:
==================================================
Mean Absolute Error (MAE): 0.0757
Mean Squared Error (MSE): 0.0098
Root Mean Squared Error (RMSE): 0.0990
R² Score: 0.8835
Mean Absolute Percentage Error (MAPE): 23.17%
Symmetric MAPE: 23.04%

Residual Analysis:
Mean Residual (Bias): 0.0226
Std of Residuals: 0.0964
Residual Skewness: 0.2393
Residual Kurtosis: 0.6648
Shapiro-Wilk p-value: 0.3088
Durbin-Watson statistic: 1.9282

Quantile-based Error Analysis:
25th percentile error: 0.0259
Median error: 0.0596
75th percentile error: 0.1100
95th percentile error: 0.1929</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/bs/x9tn9jz91cv6hb3q6p4djbmw0000gn/T/ipykernel_53516/1856061205.py:133: MatplotlibDeprecationWarning:

The 'labels' parameter of boxplot() has been renamed 'tick_labels' since Matplotlib 3.9; support for the old name will be dropped in 3.11.
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="model_evaluation_validation_files/figure-html/cell-4-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="segmentation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="segmentation-metrics">Segmentation Metrics</h3>
<div id="c6bd53f0" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> comprehensive_segmentation_evaluation():</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate comprehensive segmentation evaluation metrics"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate segmentation results</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    height, width <span class="op">=</span> <span class="dv">128</span>, <span class="dv">128</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    num_classes <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> [<span class="st">'Background'</span>, <span class="st">'Water'</span>, <span class="st">'Vegetation'</span>, <span class="st">'Urban'</span>]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate realistic ground truth segmentation mask</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.zeros((height, width), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create regions for different classes</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Water body (circular)</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    center_x, center_y <span class="op">=</span> width<span class="op">//</span><span class="dv">3</span>, height<span class="op">//</span><span class="dv">3</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    y_indices, x_indices <span class="op">=</span> np.ogrid[:height, :width]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    water_mask <span class="op">=</span> (x_indices <span class="op">-</span> center_x)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (y_indices <span class="op">-</span> center_y)<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> (width<span class="op">//</span><span class="dv">6</span>)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    y_true[water_mask] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vegetation (upper right)</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    y_true[<span class="dv">20</span>:<span class="dv">60</span>, <span class="dv">80</span>:<span class="dv">120</span>] <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Urban (lower region)</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    y_true[<span class="dv">80</span>:<span class="dv">120</span>, <span class="dv">20</span>:<span class="dv">100</span>] <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate predictions with realistic errors</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> y_true.copy()</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add boundary errors</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy <span class="im">import</span> ndimage</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    edges <span class="op">=</span> ndimage.binary_dilation(ndimage.laplace(y_true) <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly flip some edge pixels</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    edge_indices <span class="op">=</span> np.where(edges)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    num_edge_errors <span class="op">=</span> <span class="bu">len</span>(edge_indices[<span class="dv">0</span>]) <span class="op">//</span> <span class="dv">4</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    error_indices <span class="op">=</span> np.random.choice(<span class="bu">len</span>(edge_indices[<span class="dv">0</span>]), num_edge_errors, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> error_indices:</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        y, x <span class="op">=</span> edge_indices[<span class="dv">0</span>][idx], edge_indices[<span class="dv">1</span>][idx]</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign to random neighboring class</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        neighbors <span class="op">=</span> [y_true[<span class="bu">max</span>(<span class="dv">0</span>,y<span class="op">-</span><span class="dv">1</span>):<span class="bu">min</span>(height,y<span class="op">+</span><span class="dv">2</span>), <span class="bu">max</span>(<span class="dv">0</span>,x<span class="op">-</span><span class="dv">1</span>):<span class="bu">min</span>(width,x<span class="op">+</span><span class="dv">2</span>)]]</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        unique_neighbors <span class="op">=</span> np.unique(neighbors)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        other_classes <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> unique_neighbors <span class="cf">if</span> c <span class="op">!=</span> y_true[y, x]]</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> other_classes:</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            y_pred[y, x] <span class="op">=</span> np.random.choice(other_classes)</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some random noise</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    num_random_errors <span class="op">=</span> (height <span class="op">*</span> width) <span class="op">//</span> <span class="dv">50</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    error_y <span class="op">=</span> np.random.randint(<span class="dv">0</span>, height, num_random_errors)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    error_x <span class="op">=</span> np.random.randint(<span class="dv">0</span>, width, num_random_errors)</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y, x <span class="kw">in</span> <span class="bu">zip</span>(error_y, error_x):</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        y_pred[y, x] <span class="op">=</span> np.random.randint(<span class="dv">0</span>, num_classes)</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate segmentation metrics</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_segmentation_metrics(y_true, y_pred, num_classes):</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate comprehensive segmentation metrics"""</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Flatten arrays</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        y_true_flat <span class="op">=</span> y_true.flatten()</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        y_pred_flat <span class="op">=</span> y_pred.flatten()</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Basic accuracy</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> accuracy_score(y_true_flat, y_pred_flat)</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Per-class metrics</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        precision, recall, f1, support <span class="op">=</span> precision_recall_fscore_support(</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>            y_true_flat, y_pred_flat, average<span class="op">=</span><span class="va">None</span>, zero_division<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Confusion matrix</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        cm <span class="op">=</span> confusion_matrix(y_true_flat, y_pred_flat)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># IoU (Intersection over Union) per class</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        iou_scores <span class="op">=</span> []</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>        dice_scores <span class="op">=</span> []</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_classes):</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># True positives, false positives, false negatives</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>            tp <span class="op">=</span> cm[i, i]</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>            fp <span class="op">=</span> cm[:, i].<span class="bu">sum</span>() <span class="op">-</span> tp</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>            fn <span class="op">=</span> cm[i, :].<span class="bu">sum</span>() <span class="op">-</span> tp</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>            <span class="co"># IoU</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>            iou <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> fp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>            iou_scores.append(iou)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Dice coefficient</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>            dice <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> tp <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> tp <span class="op">+</span> fp <span class="op">+</span> fn) <span class="cf">if</span> (<span class="dv">2</span> <span class="op">*</span> tp <span class="op">+</span> fp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>            dice_scores.append(dice)</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mean IoU</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>        mean_iou <span class="op">=</span> np.mean(iou_scores)</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pixel accuracy (same as overall accuracy)</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>        pixel_accuracy <span class="op">=</span> accuracy</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mean accuracy (average of per-class accuracies)</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>        class_accuracies <span class="op">=</span> cm.diagonal() <span class="op">/</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>        mean_accuracy <span class="op">=</span> np.mean(class_accuracies)</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Frequency weighted IoU</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>        class_frequencies <span class="op">=</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> cm.<span class="bu">sum</span>()</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>        freq_weighted_iou <span class="op">=</span> np.<span class="bu">sum</span>(class_frequencies <span class="op">*</span> iou_scores)</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pixel_accuracy'</span>: pixel_accuracy,</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_accuracy'</span>: mean_accuracy,</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_iou'</span>: mean_iou,</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">'freq_weighted_iou'</span>: freq_weighted_iou,</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>            <span class="st">'iou_scores'</span>: iou_scores,</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">'dice_scores'</span>: dice_scores,</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>            <span class="st">'precision'</span>: precision,</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recall'</span>: recall,</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>            <span class="st">'f1'</span>: f1,</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>            <span class="st">'confusion_matrix'</span>: cm</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> calculate_segmentation_metrics(y_true, y_pred, num_classes)</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Segmentation Evaluation Results:"</span>)</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Pixel Accuracy: </span><span class="sc">{</span>metrics[<span class="st">'pixel_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Accuracy: </span><span class="sc">{</span>metrics[<span class="st">'mean_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean IoU: </span><span class="sc">{</span>metrics[<span class="st">'mean_iou'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Frequency Weighted IoU: </span><span class="sc">{</span>metrics[<span class="st">'freq_weighted_iou'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Per-Class Metrics:"</span>)</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Class'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'IoU'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Dice'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Precision'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Recall'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'F1'</span><span class="sc">:&lt;8}</span><span class="ss">"</span>)</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(class_names):</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>class_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'iou_scores'</span>][i]<span class="sc">:&lt;8.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'dice_scores'</span>][i]<span class="sc">:&lt;8.3f}</span><span class="ss"> "</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>metrics[<span class="st">'precision'</span>][i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'recall'</span>][i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'f1'</span>][i]<span class="sc">:&lt;8.3f}</span><span class="ss">"</span>)</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ground truth</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>    im1 <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">0</span>].imshow(y_true, cmap<span class="op">=</span><span class="st">'tab10'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span>num_classes<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Ground Truth'</span>)</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predictions</span></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>    im2 <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">1</span>].imshow(y_pred, cmap<span class="op">=</span><span class="st">'tab10'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span>num_classes<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Predictions'</span>)</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Error map</span></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>    error_map <span class="op">=</span> (y_true <span class="op">!=</span> y_pred).astype(<span class="bu">int</span>)</span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].imshow(error_map, cmap<span class="op">=</span><span class="st">'Reds'</span>)</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="ss">f'Error Map (</span><span class="sc">{</span>error_map<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> errors)'</span>)</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confusion matrix</span></span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(metrics[<span class="st">'confusion_matrix'</span>], annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span><span class="st">'Blues'</span>,</span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>                xticklabels<span class="op">=</span>class_names, yticklabels<span class="op">=</span>class_names, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">0</span>])</span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Confusion Matrix'</span>)</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Predicted'</span>)</span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'True'</span>)</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Per-class IoU</span></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].bar(class_names, metrics[<span class="st">'iou_scores'</span>], color<span class="op">=</span><span class="st">'skyblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'IoU Scores per Class'</span>)</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'IoU Score'</span>)</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Metrics comparison</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>    metrics_comparison <span class="op">=</span> pd.DataFrame({</span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>        <span class="st">'IoU'</span>: metrics[<span class="st">'iou_scores'</span>],</span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Dice'</span>: metrics[<span class="st">'dice_scores'</span>],</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>        <span class="st">'F1'</span>: metrics[<span class="st">'f1'</span>]</span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>class_names)</span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>    metrics_comparison.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>], alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Metric Comparison per Class'</span>)</span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Score'</span>)</span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].legend()</span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metrics, y_true, y_pred</span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a>segmentation_metrics, gt_mask, pred_mask <span class="op">=</span> comprehensive_segmentation_evaluation()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Segmentation Evaluation Results:
==================================================
Pixel Accuracy: 0.9681
Mean Accuracy: 0.9634
Mean IoU: 0.9164
Frequency Weighted IoU: 0.9387

Per-Class Metrics:
----------------------------------------------------------------------
Class        IoU      Dice     Precision  Recall     F1      
----------------------------------------------------------------------
Background   0.955    0.977    0.983      0.971      0.977   
Water        0.884    0.939    0.924      0.953      0.939   
Vegetation   0.894    0.944    0.929      0.959      0.944   
Urban        0.932    0.965    0.960      0.970      0.965   </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="model_evaluation_validation_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="spatial-validation-strategies" class="level2">
<h2 class="anchored" data-anchor-id="spatial-validation-strategies">Spatial Validation Strategies</h2>
<section id="cross-validation-with-spatial-awareness" class="level3">
<h3 class="anchored" data-anchor-id="cross-validation-with-spatial-awareness">Cross-Validation with Spatial Awareness</h3>
<div id="b0e6563d" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demonstrate_spatial_cross_validation():</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate spatial cross-validation strategies"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate spatial data with coordinates</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate spatial grid</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    grid_size <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    x_coords <span class="op">=</span> np.repeat(np.arange(grid_size), grid_size)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    y_coords <span class="op">=</span> np.tile(np.arange(grid_size), grid_size)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="bu">len</span>(x_coords)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate spatially correlated features and target</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create spatial autocorrelation structure</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> spatial_correlation(x1, y1, x2, y2, correlation_range<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate spatial correlation based on distance"""</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> np.sqrt((x1 <span class="op">-</span> x2)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (y1 <span class="op">-</span> y2)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>distance <span class="op">/</span> correlation_range)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate correlated target variable</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.zeros(n_samples)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    base_trend <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (x_coords <span class="op">/</span> grid_size) <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> (y_coords <span class="op">/</span> grid_size)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add spatially correlated noise</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        spatial_component <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">min</span>(<span class="dv">50</span>, n_samples)):  <span class="co"># Limit for computational efficiency</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">!=</span> j:</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                weight <span class="op">=</span> spatial_correlation(x_coords[i], y_coords[i], x_coords[j], y_coords[j])</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>                spatial_component <span class="op">+=</span> weight <span class="op">*</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.1</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">=</span> base_trend[i] <span class="op">+</span> spatial_component <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.2</span>)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate features</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> np.column_stack([</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        x_coords <span class="op">/</span> grid_size,  <span class="co"># Normalized x coordinate</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        y_coords <span class="op">/</span> grid_size,  <span class="co"># Normalized y coordinate</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        np.random.normal(<span class="dv">0</span>, <span class="dv">1</span>, n_samples),  <span class="co"># Random feature 1</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        np.random.normal(<span class="dv">0</span>, <span class="dv">1</span>, n_samples),  <span class="co"># Random feature 2</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Different cross-validation strategies</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> random_cv_split(X, y, n_folds<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Standard random cross-validation"""</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        kfold <span class="op">=</span> KFold(n_splits<span class="op">=</span>n_folds, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">list</span>(kfold.split(X))</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> spatial_block_cv_split(x_coords, y_coords, n_blocks<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Spatial block cross-validation"""</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Divide space into blocks</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        x_blocks <span class="op">=</span> np.linspace(x_coords.<span class="bu">min</span>(), x_coords.<span class="bu">max</span>(), <span class="bu">int</span>(np.sqrt(n_blocks))<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>        y_blocks <span class="op">=</span> np.linspace(y_coords.<span class="bu">min</span>(), y_coords.<span class="bu">max</span>(), <span class="bu">int</span>(np.sqrt(n_blocks))<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        folds <span class="op">=</span> []</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x_blocks)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(y_blocks)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Test block</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>                test_mask <span class="op">=</span> ((x_coords <span class="op">&gt;=</span> x_blocks[i]) <span class="op">&amp;</span> (x_coords <span class="op">&lt;</span> x_blocks[i<span class="op">+</span><span class="dv">1</span>]) <span class="op">&amp;</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>                           (y_coords <span class="op">&gt;=</span> y_blocks[j]) <span class="op">&amp;</span> (y_coords <span class="op">&lt;</span> y_blocks[j<span class="op">+</span><span class="dv">1</span>]))</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Training set is everything else</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>                train_mask <span class="op">=</span> <span class="op">~</span>test_mask</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> test_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> train_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>                    train_indices <span class="op">=</span> np.where(train_mask)[<span class="dv">0</span>]</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>                    test_indices <span class="op">=</span> np.where(test_mask)[<span class="dv">0</span>]</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>                    folds.append((train_indices, test_indices))</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> folds</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> spatial_buffer_cv_split(x_coords, y_coords, n_folds<span class="op">=</span><span class="dv">5</span>, buffer_distance<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Spatial cross-validation with buffer zones"""</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># First, get random splits</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>        kfold <span class="op">=</span> KFold(n_splits<span class="op">=</span>n_folds, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        random_splits <span class="op">=</span> <span class="bu">list</span>(kfold.split(<span class="bu">range</span>(<span class="bu">len</span>(x_coords))))</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        buffered_splits <span class="op">=</span> []</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> train_idx, test_idx <span class="kw">in</span> random_splits:</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remove training samples too close to test samples</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>            filtered_train_idx <span class="op">=</span> []</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> train_i <span class="kw">in</span> train_idx:</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>                min_dist_to_test <span class="op">=</span> <span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> test_i <span class="kw">in</span> test_idx:</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>                    dist <span class="op">=</span> np.sqrt((x_coords[train_i] <span class="op">-</span> x_coords[test_i])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>                                 (y_coords[train_i] <span class="op">-</span> y_coords[test_i])<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>                    min_dist_to_test <span class="op">=</span> <span class="bu">min</span>(min_dist_to_test, dist)</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> min_dist_to_test <span class="op">&gt;=</span> buffer_distance:</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>                    filtered_train_idx.append(train_i)</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(filtered_train_idx) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>                buffered_splits.append((np.array(filtered_train_idx), test_idx))</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> buffered_splits</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate different CV strategies</span></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_cv_strategy(X, y, cv_splits, strategy_name):</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Evaluate a cross-validation strategy"""</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>        r2_scores <span class="op">=</span> []</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>        mse_scores <span class="op">=</span> []</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> fold, (train_idx, test_idx) <span class="kw">in</span> <span class="bu">enumerate</span>(cv_splits):</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train model</span></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> LinearRegression()</span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>            model.fit(X[train_idx], y[train_idx])</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict on test set</span></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model.predict(X[test_idx])</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate metrics</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>            r2 <span class="op">=</span> r2_score(y[test_idx], y_pred)</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>            mse <span class="op">=</span> mean_squared_error(y[test_idx], y_pred)</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>            r2_scores.append(r2)</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>            mse_scores.append(mse)</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>            <span class="st">'strategy'</span>: strategy_name,</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2_mean'</span>: np.mean(r2_scores),</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2_std'</span>: np.std(r2_scores),</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mse_mean'</span>: np.mean(mse_scores),</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mse_std'</span>: np.std(mse_scores),</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_folds'</span>: <span class="bu">len</span>(cv_splits)</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply different CV strategies</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>    random_splits <span class="op">=</span> random_cv_split(X, y, n_folds<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>    block_splits <span class="op">=</span> spatial_block_cv_split(x_coords, y_coords, n_blocks<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>    buffer_splits <span class="op">=</span> spatial_buffer_cv_split(x_coords, y_coords, n_folds<span class="op">=</span><span class="dv">5</span>, buffer_distance<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate strategies</span></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>    results.append(evaluate_cv_strategy(X, y, random_splits, <span class="st">'Random CV'</span>))</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>    results.append(evaluate_cv_strategy(X, y, block_splits, <span class="st">'Spatial Block CV'</span>))</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>    results.append(evaluate_cv_strategy(X, y, buffer_splits, <span class="st">'Spatial Buffer CV'</span>))</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display results</span></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Spatial Cross-Validation Comparison:"</span>)</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Strategy'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R² Mean'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R² Std'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MSE Mean'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MSE Std'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Folds'</span><span class="sc">:&lt;6}</span><span class="ss">"</span>)</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> results:</span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'strategy'</span>]<span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'r2_mean'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'r2_std'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> "</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'mse_mean'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'mse_std'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'n_folds'</span>]<span class="sc">:&lt;6}</span><span class="ss">"</span>)</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data distribution</span></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>    scatter <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">0</span>].scatter(x_coords, y_coords, c<span class="op">=</span>y, cmap<span class="op">=</span><span class="st">'viridis'</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Spatial Distribution of Target Variable'</span>)</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'X Coordinate'</span>)</span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Y Coordinate'</span>)</span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(scatter, ax<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">0</span>])</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random CV example (first fold)</span></span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>    train_idx, test_idx <span class="op">=</span> random_splits[<span class="dv">0</span>]</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].scatter(x_coords[train_idx], y_coords[train_idx], c<span class="op">=</span><span class="st">'blue'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].scatter(x_coords[test_idx], y_coords[test_idx], c<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Test'</span>)</span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Random CV (Fold 1)'</span>)</span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'X Coordinate'</span>)</span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Y Coordinate'</span>)</span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].legend()</span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Block CV example (first fold)</span></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> block_splits:</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>        train_idx, test_idx <span class="op">=</span> block_splits[<span class="dv">0</span>]</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].scatter(x_coords[train_idx], y_coords[train_idx], c<span class="op">=</span><span class="st">'blue'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].scatter(x_coords[test_idx], y_coords[test_idx], c<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Test'</span>)</span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'Spatial Block CV (Block 1)'</span>)</span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].set_xlabel(<span class="st">'X Coordinate'</span>)</span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Y Coordinate'</span>)</span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].legend()</span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buffer CV example (first fold)</span></span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> buffer_splits:</span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>        train_idx, test_idx <span class="op">=</span> buffer_splits[<span class="dv">0</span>]</span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].scatter(x_coords[train_idx], y_coords[train_idx], c<span class="op">=</span><span class="st">'blue'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].scatter(x_coords[test_idx], y_coords[test_idx], c<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Test'</span>)</span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Spatial Buffer CV (Fold 1)'</span>)</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'X Coordinate'</span>)</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Y Coordinate'</span>)</span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Performance comparison</span></span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>    strategies <span class="op">=</span> [r[<span class="st">'strategy'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>    r2_means <span class="op">=</span> [r[<span class="st">'r2_mean'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>    r2_stds <span class="op">=</span> [r[<span class="st">'r2_std'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> axes[<span class="dv">1</span>,<span class="dv">1</span>].bar(strategies, r2_means, yerr<span class="op">=</span>r2_stds, capsize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'Cross-Validation Performance Comparison'</span>)</span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'R² Score'</span>)</span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MSE comparison</span></span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>    mse_means <span class="op">=</span> [r[<span class="st">'mse_mean'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>    mse_stds <span class="op">=</span> [r[<span class="st">'mse_std'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> axes[<span class="dv">1</span>,<span class="dv">2</span>].bar(strategies, mse_means, yerr<span class="op">=</span>mse_stds, capsize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'lightcoral'</span>)</span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'MSE Comparison'</span>)</span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Mean Squared Error'</span>)</span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results, X, y, x_coords, y_coords</span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a>spatial_cv_results, spatial_X, spatial_y, spatial_x, spatial_y <span class="op">=</span> demonstrate_spatial_cross_validation()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spatial Cross-Validation Comparison:
============================================================
Strategy             R² Mean    R² Std     MSE Mean   MSE Std    Folds 
------------------------------------------------------------
Random CV            0.301      0.065      0.064      0.011      5     
Spatial Block CV     -0.023     0.065      0.062      0.036      16    
Spatial Buffer CV    0.268      0.079      0.067      0.012      5     </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="model_evaluation_validation_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="temporal-validation" class="level2">
<h2 class="anchored" data-anchor-id="temporal-validation">Temporal Validation</h2>
<section id="time-series-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="time-series-cross-validation">Time Series Cross-Validation</h3>
<div id="b028ee4d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demonstrate_temporal_validation():</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate temporal validation strategies for time series data"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate temporal dataset</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create time series with trend, seasonality, and noise</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    n_timesteps <span class="op">=</span> <span class="dv">365</span> <span class="op">*</span> <span class="dv">3</span>  <span class="co"># 3 years of daily data</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    time_index <span class="op">=</span> pd.date_range(<span class="st">'2020-01-01'</span>, periods<span class="op">=</span>n_timesteps, freq<span class="op">=</span><span class="st">'D'</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate synthetic time series</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.arange(n_timesteps)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trend component</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    trend <span class="op">=</span> <span class="fl">0.001</span> <span class="op">*</span> t</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Seasonal components</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    annual_cycle <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> <span class="dv">365</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    weekly_cycle <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> <span class="dv">7</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random noise</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.2</span>, n_timesteps)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine components</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> trend <span class="op">+</span> annual_cycle <span class="op">+</span> weekly_cycle <span class="op">+</span> noise</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some extreme events</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    extreme_events <span class="op">=</span> np.random.choice(n_timesteps, <span class="dv">10</span>, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    y[extreme_events] <span class="op">+=</span> np.random.normal(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">10</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create features (lagged values, moving averages, etc.)</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_temporal_features(y, lookback_window<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create temporal features for time series prediction"""</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> []</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        targets <span class="op">=</span> []</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(lookback_window, <span class="bu">len</span>(y)):</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Lagged values</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>            lag_features <span class="op">=</span> y[i<span class="op">-</span>lookback_window:i]</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Statistical features</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>            stat_features <span class="op">=</span> [</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>                np.mean(lag_features),</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>                np.std(lag_features),</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>                np.<span class="bu">min</span>(lag_features),</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>                np.<span class="bu">max</span>(lag_features),</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>                lag_features[<span class="op">-</span><span class="dv">1</span>],  <span class="co"># Most recent value</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>                lag_features[<span class="op">-</span><span class="dv">7</span>]   <span class="co"># Value from a week ago</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Time features</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>            day_of_year <span class="op">=</span> (i <span class="op">%</span> <span class="dv">365</span>) <span class="op">/</span> <span class="dv">365</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>            day_of_week <span class="op">=</span> (i <span class="op">%</span> <span class="dv">7</span>) <span class="op">/</span> <span class="dv">7</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Combine all features</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>            all_features <span class="op">=</span> <span class="bu">list</span>(lag_features) <span class="op">+</span> stat_features <span class="op">+</span> [day_of_year, day_of_week]</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>            features.append(all_features)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>            targets.append(y[i])</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.array(features), np.array(targets)</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    X, y_target <span class="op">=</span> create_temporal_features(y, lookback_window<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temporal validation strategies</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> walk_forward_validation(X, y, n_splits<span class="op">=</span><span class="dv">5</span>, test_size<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Walk-forward (expanding window) validation"""</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        n_samples <span class="op">=</span> <span class="bu">len</span>(X)</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>        min_train_size <span class="op">=</span> n_samples <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>        splits <span class="op">=</span> []</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_splits):</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Expanding training set</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>            train_end <span class="op">=</span> min_train_size <span class="op">+</span> i <span class="op">*</span> test_size</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>            test_start <span class="op">=</span> train_end</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>            test_end <span class="op">=</span> <span class="bu">min</span>(test_start <span class="op">+</span> test_size, n_samples)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> test_end <span class="op">&gt;</span> test_start:</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>                train_idx <span class="op">=</span> np.arange(<span class="dv">0</span>, train_end)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>                test_idx <span class="op">=</span> np.arange(test_start, test_end)</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>                splits.append((train_idx, test_idx))</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> splits</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> time_series_split_validation(X, y, n_splits<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Time series split validation (rolling window)"""</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>        tss <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span>n_splits)</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">list</span>(tss.split(X))</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> seasonal_validation(X, y, season_length<span class="op">=</span><span class="dv">365</span>):</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Seasonal validation - train on some seasons, test on others"""</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>        n_samples <span class="op">=</span> <span class="bu">len</span>(X)</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>        n_seasons <span class="op">=</span> n_samples <span class="op">//</span> season_length</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>        splits <span class="op">=</span> []</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> test_season <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_seasons):  <span class="co"># Skip first season for training</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Training: all seasons except test season</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>            train_idx <span class="op">=</span> []</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> season <span class="kw">in</span> <span class="bu">range</span>(n_seasons):</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> season <span class="op">!=</span> test_season:</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>                    season_start <span class="op">=</span> season <span class="op">*</span> season_length</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>                    season_end <span class="op">=</span> <span class="bu">min</span>((season <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> season_length, n_samples)</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>                    train_idx.extend(<span class="bu">range</span>(season_start, season_end))</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Test: specific season</span></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>            test_start <span class="op">=</span> test_season <span class="op">*</span> season_length</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>            test_end <span class="op">=</span> <span class="bu">min</span>((test_season <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> season_length, n_samples)</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>            test_idx <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(test_start, test_end))</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(train_idx) <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(test_idx) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>                splits.append((np.array(train_idx), np.array(test_idx)))</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> splits</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate different temporal validation strategies</span></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_temporal_strategy(X, y, cv_splits, strategy_name):</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Evaluate temporal validation strategy"""</span></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>        r2_scores <span class="op">=</span> []</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>        mae_scores <span class="op">=</span> []</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>        predictions_all <span class="op">=</span> []</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> fold, (train_idx, test_idx) <span class="kw">in</span> <span class="bu">enumerate</span>(cv_splits):</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train model</span></span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>            model.fit(X[train_idx], y[train_idx])</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict</span></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model.predict(X[test_idx])</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Metrics</span></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>            r2 <span class="op">=</span> r2_score(y[test_idx], y_pred)</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>            mae <span class="op">=</span> mean_absolute_error(y[test_idx], y_pred)</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>            r2_scores.append(r2)</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>            mae_scores.append(mae)</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>            predictions_all.append((test_idx, y[test_idx], y_pred))</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>            <span class="st">'strategy'</span>: strategy_name,</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2_mean'</span>: np.mean(r2_scores),</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2_std'</span>: np.std(r2_scores),</span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mae_mean'</span>: np.mean(mae_scores),</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mae_std'</span>: np.std(mae_scores),</span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predictions'</span>: predictions_all,</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_folds'</span>: <span class="bu">len</span>(cv_splits)</span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply different strategies</span></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>    walk_forward_splits <span class="op">=</span> walk_forward_validation(X, y_target, n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>    ts_splits <span class="op">=</span> time_series_split_validation(X, y_target, n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>    seasonal_splits <span class="op">=</span> seasonal_validation(X, y_target, season_length<span class="op">=</span><span class="dv">365</span>)</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate strategies</span></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>    temporal_results <span class="op">=</span> []</span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>    temporal_results.append(evaluate_temporal_strategy(X, y_target, walk_forward_splits, <span class="st">'Walk Forward'</span>))</span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>    temporal_results.append(evaluate_temporal_strategy(X, y_target, ts_splits, <span class="st">'Time Series Split'</span>))</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>    temporal_results.append(evaluate_temporal_strategy(X, y_target, seasonal_splits, <span class="st">'Seasonal Validation'</span>))</span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display results</span></span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Temporal Validation Comparison:"</span>)</span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Strategy'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R² Mean'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R² Std'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MAE Mean'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MAE Std'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Folds'</span><span class="sc">:&lt;6}</span><span class="ss">"</span>)</span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> temporal_results:</span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'strategy'</span>]<span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'r2_mean'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'r2_std'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> "</span></span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'mae_mean'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'mae_std'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'n_folds'</span>]<span class="sc">:&lt;6}</span><span class="ss">"</span>)</span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Original time series</span></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(time_index[:<span class="bu">len</span>(y)], y, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Original Time Series'</span>)</span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Value'</span>)</span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Performance comparison</span></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a>    strategies <span class="op">=</span> [r[<span class="st">'strategy'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>    r2_means <span class="op">=</span> [r[<span class="st">'r2_mean'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>    r2_stds <span class="op">=</span> [r[<span class="st">'r2_std'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">1</span>].bar(strategies, r2_means, yerr<span class="op">=</span>r2_stds, capsize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Temporal Validation Performance'</span>)</span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'R² Score'</span>)</span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MAE comparison</span></span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a>    mae_means <span class="op">=</span> [r[<span class="st">'mae_mean'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a>    mae_stds <span class="op">=</span> [r[<span class="st">'mae_std'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">2</span>].bar(strategies, mae_means, yerr<span class="op">=</span>mae_stds, capsize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'lightcoral'</span>)</span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'MAE Comparison'</span>)</span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Mean Absolute Error'</span>)</span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example predictions for first strategy only (to fit in 2x3 grid)</span></span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> temporal_results:</span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> temporal_results[<span class="dv">0</span>]  <span class="co"># Show only first strategy</span></span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>        test_idx, y_true_fold, y_pred_fold <span class="op">=</span> result[<span class="st">'predictions'</span>][<span class="dv">0</span>]</span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(y_true_fold, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(y_pred_fold, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Predicted'</span>)</span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="ss">f'</span><span class="sc">{</span>result[<span class="st">"strategy"</span>]<span class="sc">}</span><span class="ss"> - Example Predictions'</span>)</span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Value'</span>)</span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Residuals for first strategy</span></span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>        residuals <span class="op">=</span> y_true_fold <span class="op">-</span> y_pred_fold</span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].plot(residuals, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="ss">f'</span><span class="sc">{</span>result[<span class="st">"strategy"</span>]<span class="sc">}</span><span class="ss"> - Residuals'</span>)</span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Residual'</span>)</span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Residual histogram</span></span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].hist(residuals, bins<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'skyblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Residual Distribution'</span>)</span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].set_xlabel(<span class="st">'Residual'</span>)</span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> temporal_results, X, y_target, time_index</span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a>temporal_results, temp_X, temp_y, temp_time <span class="op">=</span> demonstrate_temporal_validation()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Temporal Validation Comparison:
============================================================
Strategy             R² Mean    R² Std     MAE Mean   MAE Std    Folds 
------------------------------------------------------------
Walk Forward         -0.204     0.138      0.199      0.015      5     
Time Series Split    -0.688     1.055      0.291      0.095      5     
Seasonal Validation  -0.213     0.000      0.306      0.000      1     </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="model_evaluation_validation_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="model-uncertainty-quantification" class="level2">
<h2 class="anchored" data-anchor-id="model-uncertainty-quantification">Model Uncertainty Quantification</h2>
<section id="uncertainty-estimation-methods" class="level3">
<h3 class="anchored" data-anchor-id="uncertainty-estimation-methods">Uncertainty Estimation Methods</h3>
<div id="77de2ab6" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demonstrate_uncertainty_quantification():</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate uncertainty quantification methods"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate dataset with varying noise levels</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">10</span>, n_samples).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create heteroscedastic data (varying uncertainty)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    noise_levels <span class="op">=</span> <span class="fl">0.1</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> np.<span class="bu">abs</span>(np.sin(X.flatten()))</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> np.sin(X.flatten()) <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> X.flatten() <span class="op">+</span> np.random.normal(<span class="dv">0</span>, noise_levels)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split data</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    train_idx <span class="op">=</span> np.random.choice(n_samples, <span class="bu">int</span>(<span class="fl">0.7</span> <span class="op">*</span> n_samples), replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    test_idx <span class="op">=</span> np.setdiff1d(np.arange(n_samples), train_idx)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    X_train, X_test <span class="op">=</span> X[train_idx], X[test_idx]</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    y_train, y_test <span class="op">=</span> y[train_idx], y[test_idx]</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 1: Bootstrap Aggregation</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bootstrap_uncertainty(X_train, y_train, X_test, n_bootstrap<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Estimate uncertainty using bootstrap aggregation"""</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> []</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_bootstrap):</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Bootstrap sample</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>            n_train <span class="op">=</span> <span class="bu">len</span>(X_train)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>            bootstrap_idx <span class="op">=</span> np.random.choice(n_train, n_train, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            X_boot <span class="op">=</span> X_train[bootstrap_idx]</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>            y_boot <span class="op">=</span> y_train[bootstrap_idx]</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train model</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">20</span>, random_state<span class="op">=</span>i)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>            model.fit(X_boot, y_boot)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>            pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>            predictions.append(pred)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> np.array(predictions)</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate statistics</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>        mean_pred <span class="op">=</span> np.mean(predictions, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>        std_pred <span class="op">=</span> np.std(predictions, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Confidence intervals</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>        ci_lower <span class="op">=</span> np.percentile(predictions, <span class="fl">2.5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        ci_upper <span class="op">=</span> np.percentile(predictions, <span class="fl">97.5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mean_pred, std_pred, ci_lower, ci_upper</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 2: Quantile Regression</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> quantile_regression_uncertainty(X_train, y_train, X_test, quantiles<span class="op">=</span>[<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>]):</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Estimate uncertainty using quantile regression"""</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.ensemble <span class="im">import</span> GradientBoostingRegressor</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> {}</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> q <span class="kw">in</span> quantiles:</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> GradientBoostingRegressor(loss<span class="op">=</span><span class="st">'quantile'</span>, alpha<span class="op">=</span>q, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>            model.fit(X_train, y_train)</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>            predictions[q] <span class="op">=</span> model.predict(X_test)</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predictions</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 3: Monte Carlo Dropout (simplified)</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> MCDropoutModel(nn.Module):</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Simple neural network with Monte Carlo Dropout"""</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_dim<span class="op">=</span><span class="dv">1</span>, hidden_dim<span class="op">=</span><span class="dv">50</span>, dropout_rate<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>            <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers <span class="op">=</span> nn.Sequential(</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>                nn.Linear(input_dim, hidden_dim),</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(dropout_rate),</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim, hidden_dim),</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(), </span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(dropout_rate),</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim, <span class="dv">1</span>)</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.dropout_rate <span class="op">=</span> dropout_rate</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.layers(x)</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> predict_with_uncertainty(<span class="va">self</span>, x, n_samples<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>            <span class="co">"""Predict with MC Dropout uncertainty"""</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.train()  <span class="co"># Keep in training mode for dropout</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> []</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>                    pred <span class="op">=</span> <span class="va">self</span>(x)</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>                    predictions.append(pred.numpy())</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> np.array(predictions).squeeze()</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> predictions.ndim <span class="op">==</span> <span class="dv">1</span>:  <span class="co"># Single prediction</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> predictions.mean(), predictions.std()</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:  <span class="co"># Multiple predictions</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> predictions.mean(axis<span class="op">=</span><span class="dv">0</span>), predictions.std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mc_dropout_uncertainty(X_train, y_train, X_test):</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Train MC Dropout model and get uncertainty estimates"""</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert to tensors</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>        X_train_tensor <span class="op">=</span> torch.FloatTensor(X_train)</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>        y_train_tensor <span class="op">=</span> torch.FloatTensor(y_train).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>        X_test_tensor <span class="op">=</span> torch.FloatTensor(X_test)</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train model</span></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> MCDropoutModel()</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>        criterion <span class="op">=</span> nn.MSELoss()</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Simple training loop</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(X_train_tensor)</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(outputs, y_train_tensor)</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get predictions with uncertainty</span></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>        mean_pred, std_pred <span class="op">=</span> model.predict_with_uncertainty(X_test_tensor)</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mean_pred, std_pred</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply different uncertainty methods</span></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Uncertainty Quantification Methods:"</span>)</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap</span></span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Running Bootstrap Aggregation..."</span>)</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>    boot_mean, boot_std, boot_lower, boot_upper <span class="op">=</span> bootstrap_uncertainty(X_train, y_train, X_test)</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile regression</span></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Running Quantile Regression..."</span>)</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>    quantile_preds <span class="op">=</span> quantile_regression_uncertainty(X_train, y_train, X_test)</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MC Dropout</span></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Running MC Dropout..."</span>)</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>    mc_mean, mc_std <span class="op">=</span> mc_dropout_uncertainty(X_train, y_train, X_test)</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate uncertainty metrics</span></span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_uncertainty(y_true, mean_pred, std_pred<span class="op">=</span><span class="va">None</span>, ci_lower<span class="op">=</span><span class="va">None</span>, ci_upper<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Evaluate uncertainty estimation quality"""</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prediction accuracy</span></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>        mae <span class="op">=</span> mean_absolute_error(y_true, mean_pred)</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_true, mean_pred))</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> r2_score(y_true, mean_pred)</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> {<span class="st">'mae'</span>: mae, <span class="st">'rmse'</span>: rmse, <span class="st">'r2'</span>: r2}</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> std_pred <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Uncertainty calibration</span></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>            residuals <span class="op">=</span> np.<span class="bu">abs</span>(y_true <span class="op">-</span> mean_pred)</span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Correlation between predicted uncertainty and actual errors</span></span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>            uncertainty_correlation <span class="op">=</span> np.corrcoef(std_pred, residuals)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>            metrics[<span class="st">'uncertainty_correlation'</span>] <span class="op">=</span> uncertainty_correlation</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ci_lower <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> ci_upper <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Coverage probability (should be ~95% for 95% CI)</span></span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>            in_interval <span class="op">=</span> (y_true <span class="op">&gt;=</span> ci_lower) <span class="op">&amp;</span> (y_true <span class="op">&lt;=</span> ci_upper)</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>            coverage <span class="op">=</span> np.mean(in_interval)</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>            metrics[<span class="st">'coverage'</span>] <span class="op">=</span> coverage</span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Interval width</span></span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>            interval_width <span class="op">=</span> np.mean(ci_upper <span class="op">-</span> ci_lower)</span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>            metrics[<span class="st">'mean_interval_width'</span>] <span class="op">=</span> interval_width</span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> metrics</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate methods</span></span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>    boot_metrics <span class="op">=</span> evaluate_uncertainty(y_test, boot_mean, boot_std, boot_lower, boot_upper)</span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>    quantile_metrics <span class="op">=</span> evaluate_uncertainty(y_test, quantile_preds[<span class="fl">0.5</span>], </span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>                                          ci_lower<span class="op">=</span>quantile_preds[<span class="fl">0.025</span>], </span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>                                          ci_upper<span class="op">=</span>quantile_preds[<span class="fl">0.975</span>])</span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>    mc_metrics <span class="op">=</span> evaluate_uncertainty(y_test, mc_mean, mc_std)</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Uncertainty Evaluation Results:"</span>)</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Method'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MAE'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'RMSE'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R²'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Coverage'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Uncert.Corr'</span><span class="sc">:&lt;12}</span><span class="ss">"</span>)</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>    methods_data <span class="op">=</span> [</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'Bootstrap'</span>, boot_metrics),</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'Quantile Reg.'</span>, quantile_metrics),</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'MC Dropout'</span>, mc_metrics)</span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> method_name, metrics <span class="kw">in</span> methods_data:</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>        coverage <span class="op">=</span> metrics.get(<span class="st">'coverage'</span>, <span class="dv">0</span>)</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>        uncert_corr <span class="op">=</span> metrics.get(<span class="st">'uncertainty_correlation'</span>, <span class="dv">0</span>)</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>method_name<span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'mae'</span>]<span class="sc">:&lt;8.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'rmse'</span>]<span class="sc">:&lt;8.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'r2'</span>]<span class="sc">:&lt;8.3f}</span><span class="ss"> "</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>coverage<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>uncert_corr<span class="sc">:&lt;12.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">12</span>))</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort test data for plotting</span></span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>    sort_idx <span class="op">=</span> np.argsort(X_test.flatten())</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>    X_test_sorted <span class="op">=</span> X_test[sort_idx]</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>    y_test_sorted <span class="op">=</span> y_test[sort_idx]</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap results</span></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].scatter(X_test, y_test, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>, label<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(X_test_sorted, boot_mean[sort_idx], <span class="st">'r-'</span>, label<span class="op">=</span><span class="st">'Prediction'</span>)</span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].fill_between(X_test_sorted.flatten(), </span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>                          boot_lower[sort_idx], boot_upper[sort_idx], </span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>                          alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>)</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Bootstrap Aggregation'</span>)</span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].legend()</span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile regression</span></span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].scatter(X_test, y_test, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>, label<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].plot(X_test_sorted, quantile_preds[<span class="fl">0.5</span>][sort_idx], <span class="st">'g-'</span>, label<span class="op">=</span><span class="st">'Median'</span>)</span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].fill_between(X_test_sorted.flatten(),</span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>                          quantile_preds[<span class="fl">0.025</span>][sort_idx], quantile_preds[<span class="fl">0.975</span>][sort_idx],</span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>                          alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'green'</span>, label<span class="op">=</span><span class="st">'95% PI'</span>)</span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Quantile Regression'</span>)</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].legend()</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MC Dropout</span></span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].scatter(X_test, y_test, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>, label<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(X_test_sorted, mc_mean[sort_idx], <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'Mean'</span>)</span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate confidence intervals for MC Dropout</span></span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>    mc_lower <span class="op">=</span> mc_mean <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> mc_std</span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>    mc_upper <span class="op">=</span> mc_mean <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> mc_std</span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].fill_between(X_test_sorted.flatten(),</span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>                          mc_lower[sort_idx], mc_upper[sort_idx],</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>                          alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'blue'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>)</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'MC Dropout'</span>)</span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Uncertainty comparison</span></span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>    residuals_boot <span class="op">=</span> np.<span class="bu">abs</span>(y_test <span class="op">-</span> boot_mean)</span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>    residuals_mc <span class="op">=</span> np.<span class="bu">abs</span>(y_test <span class="op">-</span> mc_mean)</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].scatter(boot_std, residuals_boot, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Bootstrap'</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].scatter(mc_std, residuals_mc, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'MC Dropout'</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted Uncertainty'</span>)</span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Absolute Error'</span>)</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'Uncertainty vs Actual Error'</span>)</span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].legend()</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> methods_data</span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>uncertainty_methods <span class="op">=</span> demonstrate_uncertainty_quantification()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Uncertainty Quantification Methods:
==================================================
Running Bootstrap Aggregation...
Running Quantile Regression...
Running MC Dropout...

Uncertainty Evaluation Results:
------------------------------------------------------------
Method               MAE      RMSE     R²       Coverage   Uncert.Corr 
------------------------------------------------------------
Bootstrap            0.289    0.380    0.960    0.633      0.207       
Quantile Reg.        0.279    0.366    0.963    0.900      0.000       
MC Dropout           0.899    1.103    0.667    0.000      0.233       </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="model_evaluation_validation_files/figure-html/cell-8-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Key concepts for model evaluation and validation: - <strong>Classification Metrics</strong>: Accuracy, precision, recall, F1, AUC, confusion matrices - <strong>Regression Metrics</strong>: MAE, MSE, RMSE, R², residual analysis - <strong>Segmentation Metrics</strong>: IoU, Dice coefficient, pixel accuracy, mean accuracy - <strong>Spatial Validation</strong>: Block CV, buffer zones, spatial independence - <strong>Temporal Validation</strong>: Walk-forward, time series splits, seasonal validation - <strong>Uncertainty Quantification</strong>: Bootstrap, quantile regression, Monte Carlo dropout - <strong>Domain-Specific Considerations</strong>: Spatial autocorrelation, temporal dependencies - <strong>Comprehensive Evaluation</strong>: Multiple metrics, visualization, statistical testing</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/kcaylor\.github\.io\/GEOG-288KC-geospatial-foundation-models");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb16" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Model Evaluation &amp; Validation"</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Comprehensive evaluation strategies for geospatial models"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> geoai</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction to Model Evaluation</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>Model evaluation in geospatial AI requires specialized metrics and validation strategies that account for spatial dependencies, temporal variations, and domain-specific requirements. This cheatsheet covers comprehensive evaluation approaches.</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, precision_recall_fscore_support, confusion_matrix</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, mean_absolute_error, r2_score</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"PyTorch version: </span><span class="sc">{</span>torch<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## Evaluation Metrics for Different Task Types</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="fu">### Classification Metrics</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> comprehensive_classification_evaluation():</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate comprehensive classification evaluation metrics"""</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate classification results for land cover classification</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    num_samples <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    num_classes <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> [<span class="st">'Water'</span>, <span class="st">'Forest'</span>, <span class="st">'Urban'</span>, <span class="st">'Agriculture'</span>, <span class="st">'Grassland'</span>, <span class="st">'Bareland'</span>]</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate realistic predictions (imbalanced classes)</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    class_probs <span class="op">=</span> [<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="fl">0.1</span>, <span class="fl">0.05</span>]  <span class="co"># Different class frequencies</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.random.choice(num_classes, size<span class="op">=</span>num_samples, p<span class="op">=</span>class_probs)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate predictions with class-dependent accuracy</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> y_true.copy()</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    class_accuracies <span class="op">=</span> [<span class="fl">0.95</span>, <span class="fl">0.88</span>, <span class="fl">0.82</span>, <span class="fl">0.85</span>, <span class="fl">0.78</span>, <span class="fl">0.70</span>]  <span class="co"># Different per-class accuracies</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_classes):</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        class_mask <span class="op">=</span> y_true <span class="op">==</span> i</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        num_class_samples <span class="op">=</span> class_mask.<span class="bu">sum</span>()</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        num_errors <span class="op">=</span> <span class="bu">int</span>(num_class_samples <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> class_accuracies[i]))</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_errors <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>            error_indices <span class="op">=</span> np.random.choice(np.where(class_mask)[<span class="dv">0</span>], num_errors, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create confusion: assign to other classes</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>            other_classes <span class="op">=</span> [j <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(num_classes) <span class="cf">if</span> j <span class="op">!=</span> i]</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>            y_pred[error_indices] <span class="op">=</span> np.random.choice(other_classes, num_errors)</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate prediction probabilities</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    y_probs <span class="op">=</span> np.zeros((num_samples, num_classes))</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_samples):</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create realistic probability distributions</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>        true_class <span class="op">=</span> y_true[i]</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>        pred_class <span class="op">=</span> y_pred[i]</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Base probabilities</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>        base_probs <span class="op">=</span> np.random.dirichlet([<span class="fl">0.5</span>] <span class="op">*</span> num_classes)</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Boost true class probability</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>        base_probs[true_class] <span class="op">+=</span> <span class="fl">0.5</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If prediction is correct, boost predicted class</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> true_class <span class="op">==</span> pred_class:</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>            base_probs[pred_class] <span class="op">+=</span> <span class="fl">0.3</span></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize</span></span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>        y_probs[i] <span class="op">=</span> base_probs <span class="op">/</span> base_probs.<span class="bu">sum</span>()</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate comprehensive metrics</span></span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> (accuracy_score, precision_recall_fscore_support, </span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>                                classification_report, confusion_matrix,</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>                                roc_auc_score, average_precision_score)</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic metrics</span></span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> accuracy_score(y_true, y_pred)</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>    precision, recall, f1, support <span class="op">=</span> precision_recall_fscore_support(y_true, y_pred, average<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>    macro_precision, macro_recall, macro_f1, _ <span class="op">=</span> precision_recall_fscore_support(y_true, y_pred, average<span class="op">=</span><span class="st">'macro'</span>)</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>    weighted_precision, weighted_recall, weighted_f1, _ <span class="op">=</span> precision_recall_fscore_support(y_true, y_pred, average<span class="op">=</span><span class="st">'weighted'</span>)</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confusion matrix</span></span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_true, y_pred)</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Per-class accuracy</span></span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>    per_class_accuracy <span class="op">=</span> cm.diagonal() <span class="op">/</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiclass AUC (one-vs-rest)</span></span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>    auc_scores <span class="op">=</span> []</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_classes):</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>        y_true_binary <span class="op">=</span> (y_true <span class="op">==</span> i).astype(<span class="bu">int</span>)</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>        auc <span class="op">=</span> roc_auc_score(y_true_binary, y_probs[:, i])</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>        auc_scores.append(auc)</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Classification Evaluation Results:"</span>)</span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Overall Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Macro F1-Score: </span><span class="sc">{</span>macro_f1<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Weighted F1-Score: </span><span class="sc">{</span>weighted_f1<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Per-Class Metrics:"</span>)</span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Class'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Precision'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Recall'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'F1-Score'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Accuracy'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'AUC'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Support'</span><span class="sc">:&lt;10}</span><span class="ss">"</span>)</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(class_names):</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>class_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>precision[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>recall[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>f1[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>per_class_accuracy[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>auc_scores[i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>support[i]<span class="sc">:&lt;10.0f}</span><span class="ss">"</span>)</span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">12</span>))</span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confusion Matrix</span></span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span><span class="st">'Blues'</span>, </span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>                xticklabels<span class="op">=</span>class_names, yticklabels<span class="op">=</span>class_names, ax<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">0</span>])</span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Confusion Matrix'</span>)</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Predicted'</span>)</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'True'</span>)</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Per-class metrics</span></span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>    metrics_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Precision'</span>: precision,</span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Recall'</span>: recall,</span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>        <span class="st">'F1-Score'</span>: f1,</span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Accuracy'</span>: per_class_accuracy</span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>class_names)</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>    metrics_df.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">1</span>], alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Per-Class Performance Metrics'</span>)</span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Score'</span>)</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].legend(bbox_to_anchor<span class="op">=</span>(<span class="fl">1.05</span>, <span class="dv">1</span>), loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Class distribution</span></span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>    unique, counts <span class="op">=</span> np.unique(y_true, return_counts<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].bar(class_names, counts, color<span class="op">=</span><span class="st">'skyblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Class Distribution (Ground Truth)'</span>)</span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Samples'</span>)</span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AUC scores</span></span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].bar(class_names, auc_scores, color<span class="op">=</span><span class="st">'lightcoral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'AUC Scores per Class'</span>)</span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'AUC Score'</span>)</span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a>        <span class="st">'accuracy'</span>: accuracy,</span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a>        <span class="st">'precision'</span>: precision,</span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a>        <span class="st">'recall'</span>: recall,</span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a>        <span class="st">'f1'</span>: f1,</span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a>        <span class="st">'confusion_matrix'</span>: cm,</span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a>        <span class="st">'auc_scores'</span>: auc_scores,</span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_true'</span>: y_true,</span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_pred'</span>: y_pred,</span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_probs'</span>: y_probs</span>
<span id="cb16-175"><a href="#cb16-175" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-176"><a href="#cb16-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a>classification_results <span class="op">=</span> comprehensive_classification_evaluation()</span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regression Metrics</span></span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> comprehensive_regression_evaluation():</span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate comprehensive regression evaluation metrics"""</span></span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-187"><a href="#cb16-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate regression results for vegetation index prediction</span></span>
<span id="cb16-188"><a href="#cb16-188" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a>    num_samples <span class="op">=</span> <span class="dv">800</span></span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate realistic NDVI values (target)</span></span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate seasonal pattern with spatial variation</span></span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a>    time_component <span class="op">=</span> np.sin(np.linspace(<span class="dv">0</span>, <span class="dv">4</span><span class="op">*</span>np.pi, num_samples)) <span class="op">*</span> <span class="fl">0.3</span></span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a>    spatial_component <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.2</span>, num_samples)</span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a>    noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.1</span>, num_samples)</span>
<span id="cb16-197"><a href="#cb16-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-198"><a href="#cb16-198" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> <span class="fl">0.5</span> <span class="op">+</span> time_component <span class="op">+</span> spatial_component <span class="op">+</span> noise</span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.clip(y_true, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)  <span class="co"># NDVI range</span></span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate predictions with realistic errors</span></span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add heteroscedastic noise (error depends on true value)</span></span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a>    prediction_noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.05</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> np.<span class="bu">abs</span>(y_true))</span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a>    bias <span class="op">=</span> <span class="op">-</span><span class="fl">0.02</span>  <span class="co"># Slight systematic bias</span></span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> y_true <span class="op">+</span> prediction_noise <span class="op">+</span> bias</span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.clip(y_pred, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate comprehensive regression metrics</span></span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(y_true, y_pred)</span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> mean_squared_error(y_true, y_pred)</span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(y_true, y_pred)</span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional metrics</span></span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mean_absolute_percentage_error(y_true, y_pred):</span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate MAPE, handling near-zero values"""</span></span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> np.<span class="bu">abs</span>(y_true) <span class="op">&gt;</span> <span class="fl">1e-6</span></span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.mean(np.<span class="bu">abs</span>((y_true[mask] <span class="op">-</span> y_pred[mask]) <span class="op">/</span> y_true[mask])) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> symmetric_mean_absolute_percentage_error(y_true, y_pred):</span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate symmetric MAPE"""</span></span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.mean(<span class="dv">2</span> <span class="op">*</span> np.<span class="bu">abs</span>(y_true <span class="op">-</span> y_pred) <span class="op">/</span> (np.<span class="bu">abs</span>(y_true) <span class="op">+</span> np.<span class="bu">abs</span>(y_pred))) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-225"><a href="#cb16-225" aria-hidden="true" tabindex="-1"></a>    mape <span class="op">=</span> mean_absolute_percentage_error(y_true, y_pred)</span>
<span id="cb16-226"><a href="#cb16-226" aria-hidden="true" tabindex="-1"></a>    smape <span class="op">=</span> symmetric_mean_absolute_percentage_error(y_true, y_pred)</span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residual analysis</span></span>
<span id="cb16-229"><a href="#cb16-229" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> y_true <span class="op">-</span> y_pred</span>
<span id="cb16-230"><a href="#cb16-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Statistical tests</span></span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shapiro-Wilk test for normality of residuals</span></span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a>    shapiro_stat, shapiro_p <span class="op">=</span> stats.shapiro(residuals[:<span class="dv">100</span>])  <span class="co"># Sample for computational efficiency</span></span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Durbin-Watson test for autocorrelation (simplified)</span></span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> durbin_watson(residuals):</span>
<span id="cb16-237"><a href="#cb16-237" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate Durbin-Watson statistic"""</span></span>
<span id="cb16-238"><a href="#cb16-238" aria-hidden="true" tabindex="-1"></a>        diff <span class="op">=</span> np.diff(residuals)</span>
<span id="cb16-239"><a href="#cb16-239" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>(diff<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> np.<span class="bu">sum</span>(residuals<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb16-240"><a href="#cb16-240" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-241"><a href="#cb16-241" aria-hidden="true" tabindex="-1"></a>    dw_stat <span class="op">=</span> durbin_watson(residuals)</span>
<span id="cb16-242"><a href="#cb16-242" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-243"><a href="#cb16-243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile-based metrics</span></span>
<span id="cb16-244"><a href="#cb16-244" aria-hidden="true" tabindex="-1"></a>    q25_error <span class="op">=</span> np.percentile(np.<span class="bu">abs</span>(residuals), <span class="dv">25</span>)</span>
<span id="cb16-245"><a href="#cb16-245" aria-hidden="true" tabindex="-1"></a>    median_error <span class="op">=</span> np.median(np.<span class="bu">abs</span>(residuals))</span>
<span id="cb16-246"><a href="#cb16-246" aria-hidden="true" tabindex="-1"></a>    q75_error <span class="op">=</span> np.percentile(np.<span class="bu">abs</span>(residuals), <span class="dv">75</span>)</span>
<span id="cb16-247"><a href="#cb16-247" aria-hidden="true" tabindex="-1"></a>    q95_error <span class="op">=</span> np.percentile(np.<span class="bu">abs</span>(residuals), <span class="dv">95</span>)</span>
<span id="cb16-248"><a href="#cb16-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-249"><a href="#cb16-249" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Regression Evaluation Results:"</span>)</span>
<span id="cb16-250"><a href="#cb16-250" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb16-251"><a href="#cb16-251" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Absolute Error (MAE): </span><span class="sc">{</span>mae<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-252"><a href="#cb16-252" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Squared Error (MSE): </span><span class="sc">{</span>mse<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-253"><a href="#cb16-253" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Root Mean Squared Error (RMSE): </span><span class="sc">{</span>rmse<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-254"><a href="#cb16-254" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"R² Score: </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-255"><a href="#cb16-255" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Absolute Percentage Error (MAPE): </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb16-256"><a href="#cb16-256" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Symmetric MAPE: </span><span class="sc">{</span>smape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb16-257"><a href="#cb16-257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-258"><a href="#cb16-258" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Residual Analysis:"</span>)</span>
<span id="cb16-259"><a href="#cb16-259" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Residual (Bias): </span><span class="sc">{</span>residuals<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-260"><a href="#cb16-260" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Std of Residuals: </span><span class="sc">{</span>residuals<span class="sc">.</span>std()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-261"><a href="#cb16-261" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Residual Skewness: </span><span class="sc">{</span>stats<span class="sc">.</span>skew(residuals)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-262"><a href="#cb16-262" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Residual Kurtosis: </span><span class="sc">{</span>stats<span class="sc">.</span>kurtosis(residuals)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-263"><a href="#cb16-263" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Shapiro-Wilk p-value: </span><span class="sc">{</span>shapiro_p<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-264"><a href="#cb16-264" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Durbin-Watson statistic: </span><span class="sc">{</span>dw_stat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-265"><a href="#cb16-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-266"><a href="#cb16-266" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Quantile-based Error Analysis:"</span>)</span>
<span id="cb16-267"><a href="#cb16-267" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"25th percentile error: </span><span class="sc">{</span>q25_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-268"><a href="#cb16-268" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Median error: </span><span class="sc">{</span>median_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-269"><a href="#cb16-269" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"75th percentile error: </span><span class="sc">{</span>q75_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-270"><a href="#cb16-270" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"95th percentile error: </span><span class="sc">{</span>q95_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-271"><a href="#cb16-271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-272"><a href="#cb16-272" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb16-273"><a href="#cb16-273" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb16-274"><a href="#cb16-274" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-275"><a href="#cb16-275" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scatter plot: True vs Predicted</span></span>
<span id="cb16-276"><a href="#cb16-276" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].scatter(y_true, y_pred, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb16-277"><a href="#cb16-277" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].plot([<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>], [<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>], <span class="st">'r--'</span>, lw<span class="op">=</span><span class="dv">2</span>)  <span class="co"># Perfect prediction line</span></span>
<span id="cb16-278"><a href="#cb16-278" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'True Values'</span>)</span>
<span id="cb16-279"><a href="#cb16-279" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Predicted Values'</span>)</span>
<span id="cb16-280"><a href="#cb16-280" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="ss">f'True vs Predicted (R² = </span><span class="sc">{</span>r2<span class="sc">:.3f}</span><span class="ss">)'</span>)</span>
<span id="cb16-281"><a href="#cb16-281" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-282"><a href="#cb16-282" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-283"><a href="#cb16-283" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residual plot</span></span>
<span id="cb16-284"><a href="#cb16-284" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].scatter(y_pred, residuals, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb16-285"><a href="#cb16-285" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb16-286"><a href="#cb16-286" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted Values'</span>)</span>
<span id="cb16-287"><a href="#cb16-287" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Residuals'</span>)</span>
<span id="cb16-288"><a href="#cb16-288" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Residual Plot'</span>)</span>
<span id="cb16-289"><a href="#cb16-289" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-290"><a href="#cb16-290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-291"><a href="#cb16-291" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Q-Q plot for residual normality</span></span>
<span id="cb16-292"><a href="#cb16-292" aria-hidden="true" tabindex="-1"></a>    stats.probplot(residuals, dist<span class="op">=</span><span class="st">"norm"</span>, plot<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">2</span>])</span>
<span id="cb16-293"><a href="#cb16-293" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'Q-Q Plot (Residual Normality)'</span>)</span>
<span id="cb16-294"><a href="#cb16-294" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-295"><a href="#cb16-295" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-296"><a href="#cb16-296" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residual histogram</span></span>
<span id="cb16-297"><a href="#cb16-297" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].hist(residuals, bins<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'skyblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb16-298"><a href="#cb16-298" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].axvline(residuals.mean(), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="ss">f'Mean = </span><span class="sc">{</span>residuals<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb16-299"><a href="#cb16-299" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Residuals'</span>)</span>
<span id="cb16-300"><a href="#cb16-300" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb16-301"><a href="#cb16-301" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Residual Distribution'</span>)</span>
<span id="cb16-302"><a href="#cb16-302" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb16-303"><a href="#cb16-303" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-304"><a href="#cb16-304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-305"><a href="#cb16-305" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Error distribution by predicted value ranges</span></span>
<span id="cb16-306"><a href="#cb16-306" aria-hidden="true" tabindex="-1"></a>    pred_ranges <span class="op">=</span> np.linspace(y_pred.<span class="bu">min</span>(), y_pred.<span class="bu">max</span>(), <span class="dv">10</span>)</span>
<span id="cb16-307"><a href="#cb16-307" aria-hidden="true" tabindex="-1"></a>    range_errors <span class="op">=</span> []</span>
<span id="cb16-308"><a href="#cb16-308" aria-hidden="true" tabindex="-1"></a>    range_labels <span class="op">=</span> []</span>
<span id="cb16-309"><a href="#cb16-309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-310"><a href="#cb16-310" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(pred_ranges)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb16-311"><a href="#cb16-311" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (y_pred <span class="op">&gt;=</span> pred_ranges[i]) <span class="op">&amp;</span> (y_pred <span class="op">&lt;</span> pred_ranges[i<span class="op">+</span><span class="dv">1</span>])</span>
<span id="cb16-312"><a href="#cb16-312" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-313"><a href="#cb16-313" aria-hidden="true" tabindex="-1"></a>            range_errors.append(np.<span class="bu">abs</span>(residuals[mask]))</span>
<span id="cb16-314"><a href="#cb16-314" aria-hidden="true" tabindex="-1"></a>            range_labels.append(<span class="ss">f'</span><span class="sc">{</span>pred_ranges[i]<span class="sc">:.2f}</span><span class="ss">-</span><span class="sc">{</span>pred_ranges[i<span class="op">+</span><span class="dv">1</span>]<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb16-315"><a href="#cb16-315" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-316"><a href="#cb16-316" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].boxplot(range_errors, labels<span class="op">=</span>range_labels)</span>
<span id="cb16-317"><a href="#cb16-317" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted Value Range'</span>)</span>
<span id="cb16-318"><a href="#cb16-318" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Absolute Error'</span>)</span>
<span id="cb16-319"><a href="#cb16-319" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'Error Distribution by Prediction Range'</span>)</span>
<span id="cb16-320"><a href="#cb16-320" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-321"><a href="#cb16-321" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-322"><a href="#cb16-322" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time series of residuals (if applicable)</span></span>
<span id="cb16-323"><a href="#cb16-323" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].plot(residuals, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb16-324"><a href="#cb16-324" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb16-325"><a href="#cb16-325" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_xlabel(<span class="st">'Sample Index'</span>)</span>
<span id="cb16-326"><a href="#cb16-326" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Residuals'</span>)</span>
<span id="cb16-327"><a href="#cb16-327" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Residuals over Time/Space'</span>)</span>
<span id="cb16-328"><a href="#cb16-328" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-329"><a href="#cb16-329" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-330"><a href="#cb16-330" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-331"><a href="#cb16-331" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb16-332"><a href="#cb16-332" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-333"><a href="#cb16-333" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb16-334"><a href="#cb16-334" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae'</span>: mae, <span class="st">'mse'</span>: mse, <span class="st">'rmse'</span>: rmse, <span class="st">'r2'</span>: r2,</span>
<span id="cb16-335"><a href="#cb16-335" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mape'</span>: mape, <span class="st">'smape'</span>: smape,</span>
<span id="cb16-336"><a href="#cb16-336" aria-hidden="true" tabindex="-1"></a>        <span class="st">'residuals'</span>: residuals,</span>
<span id="cb16-337"><a href="#cb16-337" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_true'</span>: y_true, <span class="st">'y_pred'</span>: y_pred</span>
<span id="cb16-338"><a href="#cb16-338" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-339"><a href="#cb16-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-340"><a href="#cb16-340" aria-hidden="true" tabindex="-1"></a>regression_results <span class="op">=</span> comprehensive_regression_evaluation()</span>
<span id="cb16-341"><a href="#cb16-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-342"><a href="#cb16-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-343"><a href="#cb16-343" aria-hidden="true" tabindex="-1"></a><span class="fu">### Segmentation Metrics</span></span>
<span id="cb16-346"><a href="#cb16-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb16-347"><a href="#cb16-347" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> comprehensive_segmentation_evaluation():</span>
<span id="cb16-348"><a href="#cb16-348" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate comprehensive segmentation evaluation metrics"""</span></span>
<span id="cb16-349"><a href="#cb16-349" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-350"><a href="#cb16-350" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate segmentation results</span></span>
<span id="cb16-351"><a href="#cb16-351" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb16-352"><a href="#cb16-352" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-353"><a href="#cb16-353" aria-hidden="true" tabindex="-1"></a>    height, width <span class="op">=</span> <span class="dv">128</span>, <span class="dv">128</span></span>
<span id="cb16-354"><a href="#cb16-354" aria-hidden="true" tabindex="-1"></a>    num_classes <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb16-355"><a href="#cb16-355" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> [<span class="st">'Background'</span>, <span class="st">'Water'</span>, <span class="st">'Vegetation'</span>, <span class="st">'Urban'</span>]</span>
<span id="cb16-356"><a href="#cb16-356" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-357"><a href="#cb16-357" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate realistic ground truth segmentation mask</span></span>
<span id="cb16-358"><a href="#cb16-358" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.zeros((height, width), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb16-359"><a href="#cb16-359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-360"><a href="#cb16-360" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create regions for different classes</span></span>
<span id="cb16-361"><a href="#cb16-361" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Water body (circular)</span></span>
<span id="cb16-362"><a href="#cb16-362" aria-hidden="true" tabindex="-1"></a>    center_x, center_y <span class="op">=</span> width<span class="op">//</span><span class="dv">3</span>, height<span class="op">//</span><span class="dv">3</span></span>
<span id="cb16-363"><a href="#cb16-363" aria-hidden="true" tabindex="-1"></a>    y_indices, x_indices <span class="op">=</span> np.ogrid[:height, :width]</span>
<span id="cb16-364"><a href="#cb16-364" aria-hidden="true" tabindex="-1"></a>    water_mask <span class="op">=</span> (x_indices <span class="op">-</span> center_x)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (y_indices <span class="op">-</span> center_y)<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span> (width<span class="op">//</span><span class="dv">6</span>)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb16-365"><a href="#cb16-365" aria-hidden="true" tabindex="-1"></a>    y_true[water_mask] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb16-366"><a href="#cb16-366" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-367"><a href="#cb16-367" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vegetation (upper right)</span></span>
<span id="cb16-368"><a href="#cb16-368" aria-hidden="true" tabindex="-1"></a>    y_true[<span class="dv">20</span>:<span class="dv">60</span>, <span class="dv">80</span>:<span class="dv">120</span>] <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb16-369"><a href="#cb16-369" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-370"><a href="#cb16-370" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Urban (lower region)</span></span>
<span id="cb16-371"><a href="#cb16-371" aria-hidden="true" tabindex="-1"></a>    y_true[<span class="dv">80</span>:<span class="dv">120</span>, <span class="dv">20</span>:<span class="dv">100</span>] <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb16-372"><a href="#cb16-372" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-373"><a href="#cb16-373" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate predictions with realistic errors</span></span>
<span id="cb16-374"><a href="#cb16-374" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> y_true.copy()</span>
<span id="cb16-375"><a href="#cb16-375" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-376"><a href="#cb16-376" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add boundary errors</span></span>
<span id="cb16-377"><a href="#cb16-377" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy <span class="im">import</span> ndimage</span>
<span id="cb16-378"><a href="#cb16-378" aria-hidden="true" tabindex="-1"></a>    edges <span class="op">=</span> ndimage.binary_dilation(ndimage.laplace(y_true) <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb16-379"><a href="#cb16-379" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-380"><a href="#cb16-380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly flip some edge pixels</span></span>
<span id="cb16-381"><a href="#cb16-381" aria-hidden="true" tabindex="-1"></a>    edge_indices <span class="op">=</span> np.where(edges)</span>
<span id="cb16-382"><a href="#cb16-382" aria-hidden="true" tabindex="-1"></a>    num_edge_errors <span class="op">=</span> <span class="bu">len</span>(edge_indices[<span class="dv">0</span>]) <span class="op">//</span> <span class="dv">4</span></span>
<span id="cb16-383"><a href="#cb16-383" aria-hidden="true" tabindex="-1"></a>    error_indices <span class="op">=</span> np.random.choice(<span class="bu">len</span>(edge_indices[<span class="dv">0</span>]), num_edge_errors, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-384"><a href="#cb16-384" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-385"><a href="#cb16-385" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> error_indices:</span>
<span id="cb16-386"><a href="#cb16-386" aria-hidden="true" tabindex="-1"></a>        y, x <span class="op">=</span> edge_indices[<span class="dv">0</span>][idx], edge_indices[<span class="dv">1</span>][idx]</span>
<span id="cb16-387"><a href="#cb16-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign to random neighboring class</span></span>
<span id="cb16-388"><a href="#cb16-388" aria-hidden="true" tabindex="-1"></a>        neighbors <span class="op">=</span> [y_true[<span class="bu">max</span>(<span class="dv">0</span>,y<span class="op">-</span><span class="dv">1</span>):<span class="bu">min</span>(height,y<span class="op">+</span><span class="dv">2</span>), <span class="bu">max</span>(<span class="dv">0</span>,x<span class="op">-</span><span class="dv">1</span>):<span class="bu">min</span>(width,x<span class="op">+</span><span class="dv">2</span>)]]</span>
<span id="cb16-389"><a href="#cb16-389" aria-hidden="true" tabindex="-1"></a>        unique_neighbors <span class="op">=</span> np.unique(neighbors)</span>
<span id="cb16-390"><a href="#cb16-390" aria-hidden="true" tabindex="-1"></a>        other_classes <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> unique_neighbors <span class="cf">if</span> c <span class="op">!=</span> y_true[y, x]]</span>
<span id="cb16-391"><a href="#cb16-391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> other_classes:</span>
<span id="cb16-392"><a href="#cb16-392" aria-hidden="true" tabindex="-1"></a>            y_pred[y, x] <span class="op">=</span> np.random.choice(other_classes)</span>
<span id="cb16-393"><a href="#cb16-393" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-394"><a href="#cb16-394" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some random noise</span></span>
<span id="cb16-395"><a href="#cb16-395" aria-hidden="true" tabindex="-1"></a>    num_random_errors <span class="op">=</span> (height <span class="op">*</span> width) <span class="op">//</span> <span class="dv">50</span></span>
<span id="cb16-396"><a href="#cb16-396" aria-hidden="true" tabindex="-1"></a>    error_y <span class="op">=</span> np.random.randint(<span class="dv">0</span>, height, num_random_errors)</span>
<span id="cb16-397"><a href="#cb16-397" aria-hidden="true" tabindex="-1"></a>    error_x <span class="op">=</span> np.random.randint(<span class="dv">0</span>, width, num_random_errors)</span>
<span id="cb16-398"><a href="#cb16-398" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y, x <span class="kw">in</span> <span class="bu">zip</span>(error_y, error_x):</span>
<span id="cb16-399"><a href="#cb16-399" aria-hidden="true" tabindex="-1"></a>        y_pred[y, x] <span class="op">=</span> np.random.randint(<span class="dv">0</span>, num_classes)</span>
<span id="cb16-400"><a href="#cb16-400" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-401"><a href="#cb16-401" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate segmentation metrics</span></span>
<span id="cb16-402"><a href="#cb16-402" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_segmentation_metrics(y_true, y_pred, num_classes):</span>
<span id="cb16-403"><a href="#cb16-403" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate comprehensive segmentation metrics"""</span></span>
<span id="cb16-404"><a href="#cb16-404" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-405"><a href="#cb16-405" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Flatten arrays</span></span>
<span id="cb16-406"><a href="#cb16-406" aria-hidden="true" tabindex="-1"></a>        y_true_flat <span class="op">=</span> y_true.flatten()</span>
<span id="cb16-407"><a href="#cb16-407" aria-hidden="true" tabindex="-1"></a>        y_pred_flat <span class="op">=</span> y_pred.flatten()</span>
<span id="cb16-408"><a href="#cb16-408" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-409"><a href="#cb16-409" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Basic accuracy</span></span>
<span id="cb16-410"><a href="#cb16-410" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> accuracy_score(y_true_flat, y_pred_flat)</span>
<span id="cb16-411"><a href="#cb16-411" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-412"><a href="#cb16-412" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Per-class metrics</span></span>
<span id="cb16-413"><a href="#cb16-413" aria-hidden="true" tabindex="-1"></a>        precision, recall, f1, support <span class="op">=</span> precision_recall_fscore_support(</span>
<span id="cb16-414"><a href="#cb16-414" aria-hidden="true" tabindex="-1"></a>            y_true_flat, y_pred_flat, average<span class="op">=</span><span class="va">None</span>, zero_division<span class="op">=</span><span class="dv">0</span></span>
<span id="cb16-415"><a href="#cb16-415" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-416"><a href="#cb16-416" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-417"><a href="#cb16-417" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Confusion matrix</span></span>
<span id="cb16-418"><a href="#cb16-418" aria-hidden="true" tabindex="-1"></a>        cm <span class="op">=</span> confusion_matrix(y_true_flat, y_pred_flat)</span>
<span id="cb16-419"><a href="#cb16-419" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-420"><a href="#cb16-420" aria-hidden="true" tabindex="-1"></a>        <span class="co"># IoU (Intersection over Union) per class</span></span>
<span id="cb16-421"><a href="#cb16-421" aria-hidden="true" tabindex="-1"></a>        iou_scores <span class="op">=</span> []</span>
<span id="cb16-422"><a href="#cb16-422" aria-hidden="true" tabindex="-1"></a>        dice_scores <span class="op">=</span> []</span>
<span id="cb16-423"><a href="#cb16-423" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-424"><a href="#cb16-424" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_classes):</span>
<span id="cb16-425"><a href="#cb16-425" aria-hidden="true" tabindex="-1"></a>            <span class="co"># True positives, false positives, false negatives</span></span>
<span id="cb16-426"><a href="#cb16-426" aria-hidden="true" tabindex="-1"></a>            tp <span class="op">=</span> cm[i, i]</span>
<span id="cb16-427"><a href="#cb16-427" aria-hidden="true" tabindex="-1"></a>            fp <span class="op">=</span> cm[:, i].<span class="bu">sum</span>() <span class="op">-</span> tp</span>
<span id="cb16-428"><a href="#cb16-428" aria-hidden="true" tabindex="-1"></a>            fn <span class="op">=</span> cm[i, :].<span class="bu">sum</span>() <span class="op">-</span> tp</span>
<span id="cb16-429"><a href="#cb16-429" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-430"><a href="#cb16-430" aria-hidden="true" tabindex="-1"></a>            <span class="co"># IoU</span></span>
<span id="cb16-431"><a href="#cb16-431" aria-hidden="true" tabindex="-1"></a>            iou <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> fp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb16-432"><a href="#cb16-432" aria-hidden="true" tabindex="-1"></a>            iou_scores.append(iou)</span>
<span id="cb16-433"><a href="#cb16-433" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-434"><a href="#cb16-434" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Dice coefficient</span></span>
<span id="cb16-435"><a href="#cb16-435" aria-hidden="true" tabindex="-1"></a>            dice <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> tp <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> tp <span class="op">+</span> fp <span class="op">+</span> fn) <span class="cf">if</span> (<span class="dv">2</span> <span class="op">*</span> tp <span class="op">+</span> fp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb16-436"><a href="#cb16-436" aria-hidden="true" tabindex="-1"></a>            dice_scores.append(dice)</span>
<span id="cb16-437"><a href="#cb16-437" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-438"><a href="#cb16-438" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mean IoU</span></span>
<span id="cb16-439"><a href="#cb16-439" aria-hidden="true" tabindex="-1"></a>        mean_iou <span class="op">=</span> np.mean(iou_scores)</span>
<span id="cb16-440"><a href="#cb16-440" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-441"><a href="#cb16-441" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pixel accuracy (same as overall accuracy)</span></span>
<span id="cb16-442"><a href="#cb16-442" aria-hidden="true" tabindex="-1"></a>        pixel_accuracy <span class="op">=</span> accuracy</span>
<span id="cb16-443"><a href="#cb16-443" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-444"><a href="#cb16-444" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mean accuracy (average of per-class accuracies)</span></span>
<span id="cb16-445"><a href="#cb16-445" aria-hidden="true" tabindex="-1"></a>        class_accuracies <span class="op">=</span> cm.diagonal() <span class="op">/</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-446"><a href="#cb16-446" aria-hidden="true" tabindex="-1"></a>        mean_accuracy <span class="op">=</span> np.mean(class_accuracies)</span>
<span id="cb16-447"><a href="#cb16-447" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-448"><a href="#cb16-448" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Frequency weighted IoU</span></span>
<span id="cb16-449"><a href="#cb16-449" aria-hidden="true" tabindex="-1"></a>        class_frequencies <span class="op">=</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> cm.<span class="bu">sum</span>()</span>
<span id="cb16-450"><a href="#cb16-450" aria-hidden="true" tabindex="-1"></a>        freq_weighted_iou <span class="op">=</span> np.<span class="bu">sum</span>(class_frequencies <span class="op">*</span> iou_scores)</span>
<span id="cb16-451"><a href="#cb16-451" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-452"><a href="#cb16-452" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb16-453"><a href="#cb16-453" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pixel_accuracy'</span>: pixel_accuracy,</span>
<span id="cb16-454"><a href="#cb16-454" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_accuracy'</span>: mean_accuracy,</span>
<span id="cb16-455"><a href="#cb16-455" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_iou'</span>: mean_iou,</span>
<span id="cb16-456"><a href="#cb16-456" aria-hidden="true" tabindex="-1"></a>            <span class="st">'freq_weighted_iou'</span>: freq_weighted_iou,</span>
<span id="cb16-457"><a href="#cb16-457" aria-hidden="true" tabindex="-1"></a>            <span class="st">'iou_scores'</span>: iou_scores,</span>
<span id="cb16-458"><a href="#cb16-458" aria-hidden="true" tabindex="-1"></a>            <span class="st">'dice_scores'</span>: dice_scores,</span>
<span id="cb16-459"><a href="#cb16-459" aria-hidden="true" tabindex="-1"></a>            <span class="st">'precision'</span>: precision,</span>
<span id="cb16-460"><a href="#cb16-460" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recall'</span>: recall,</span>
<span id="cb16-461"><a href="#cb16-461" aria-hidden="true" tabindex="-1"></a>            <span class="st">'f1'</span>: f1,</span>
<span id="cb16-462"><a href="#cb16-462" aria-hidden="true" tabindex="-1"></a>            <span class="st">'confusion_matrix'</span>: cm</span>
<span id="cb16-463"><a href="#cb16-463" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-464"><a href="#cb16-464" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-465"><a href="#cb16-465" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> calculate_segmentation_metrics(y_true, y_pred, num_classes)</span>
<span id="cb16-466"><a href="#cb16-466" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-467"><a href="#cb16-467" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Segmentation Evaluation Results:"</span>)</span>
<span id="cb16-468"><a href="#cb16-468" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb16-469"><a href="#cb16-469" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Pixel Accuracy: </span><span class="sc">{</span>metrics[<span class="st">'pixel_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-470"><a href="#cb16-470" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Accuracy: </span><span class="sc">{</span>metrics[<span class="st">'mean_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-471"><a href="#cb16-471" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean IoU: </span><span class="sc">{</span>metrics[<span class="st">'mean_iou'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-472"><a href="#cb16-472" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Frequency Weighted IoU: </span><span class="sc">{</span>metrics[<span class="st">'freq_weighted_iou'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-473"><a href="#cb16-473" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-474"><a href="#cb16-474" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Per-Class Metrics:"</span>)</span>
<span id="cb16-475"><a href="#cb16-475" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb16-476"><a href="#cb16-476" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Class'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'IoU'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Dice'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Precision'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Recall'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'F1'</span><span class="sc">:&lt;8}</span><span class="ss">"</span>)</span>
<span id="cb16-477"><a href="#cb16-477" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb16-478"><a href="#cb16-478" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-479"><a href="#cb16-479" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, class_name <span class="kw">in</span> <span class="bu">enumerate</span>(class_names):</span>
<span id="cb16-480"><a href="#cb16-480" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>class_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'iou_scores'</span>][i]<span class="sc">:&lt;8.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'dice_scores'</span>][i]<span class="sc">:&lt;8.3f}</span><span class="ss"> "</span></span>
<span id="cb16-481"><a href="#cb16-481" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>metrics[<span class="st">'precision'</span>][i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'recall'</span>][i]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'f1'</span>][i]<span class="sc">:&lt;8.3f}</span><span class="ss">"</span>)</span>
<span id="cb16-482"><a href="#cb16-482" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-483"><a href="#cb16-483" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb16-484"><a href="#cb16-484" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb16-485"><a href="#cb16-485" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-486"><a href="#cb16-486" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ground truth</span></span>
<span id="cb16-487"><a href="#cb16-487" aria-hidden="true" tabindex="-1"></a>    im1 <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">0</span>].imshow(y_true, cmap<span class="op">=</span><span class="st">'tab10'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span>num_classes<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb16-488"><a href="#cb16-488" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Ground Truth'</span>)</span>
<span id="cb16-489"><a href="#cb16-489" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb16-490"><a href="#cb16-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-491"><a href="#cb16-491" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predictions</span></span>
<span id="cb16-492"><a href="#cb16-492" aria-hidden="true" tabindex="-1"></a>    im2 <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">1</span>].imshow(y_pred, cmap<span class="op">=</span><span class="st">'tab10'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span>num_classes<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb16-493"><a href="#cb16-493" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Predictions'</span>)</span>
<span id="cb16-494"><a href="#cb16-494" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb16-495"><a href="#cb16-495" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-496"><a href="#cb16-496" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Error map</span></span>
<span id="cb16-497"><a href="#cb16-497" aria-hidden="true" tabindex="-1"></a>    error_map <span class="op">=</span> (y_true <span class="op">!=</span> y_pred).astype(<span class="bu">int</span>)</span>
<span id="cb16-498"><a href="#cb16-498" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].imshow(error_map, cmap<span class="op">=</span><span class="st">'Reds'</span>)</span>
<span id="cb16-499"><a href="#cb16-499" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="ss">f'Error Map (</span><span class="sc">{</span>error_map<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> errors)'</span>)</span>
<span id="cb16-500"><a href="#cb16-500" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb16-501"><a href="#cb16-501" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-502"><a href="#cb16-502" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confusion matrix</span></span>
<span id="cb16-503"><a href="#cb16-503" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(metrics[<span class="st">'confusion_matrix'</span>], annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span><span class="st">'Blues'</span>,</span>
<span id="cb16-504"><a href="#cb16-504" aria-hidden="true" tabindex="-1"></a>                xticklabels<span class="op">=</span>class_names, yticklabels<span class="op">=</span>class_names, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">0</span>])</span>
<span id="cb16-505"><a href="#cb16-505" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Confusion Matrix'</span>)</span>
<span id="cb16-506"><a href="#cb16-506" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Predicted'</span>)</span>
<span id="cb16-507"><a href="#cb16-507" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'True'</span>)</span>
<span id="cb16-508"><a href="#cb16-508" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-509"><a href="#cb16-509" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Per-class IoU</span></span>
<span id="cb16-510"><a href="#cb16-510" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].bar(class_names, metrics[<span class="st">'iou_scores'</span>], color<span class="op">=</span><span class="st">'skyblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb16-511"><a href="#cb16-511" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'IoU Scores per Class'</span>)</span>
<span id="cb16-512"><a href="#cb16-512" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'IoU Score'</span>)</span>
<span id="cb16-513"><a href="#cb16-513" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-514"><a href="#cb16-514" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb16-515"><a href="#cb16-515" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-516"><a href="#cb16-516" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Metrics comparison</span></span>
<span id="cb16-517"><a href="#cb16-517" aria-hidden="true" tabindex="-1"></a>    metrics_comparison <span class="op">=</span> pd.DataFrame({</span>
<span id="cb16-518"><a href="#cb16-518" aria-hidden="true" tabindex="-1"></a>        <span class="st">'IoU'</span>: metrics[<span class="st">'iou_scores'</span>],</span>
<span id="cb16-519"><a href="#cb16-519" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Dice'</span>: metrics[<span class="st">'dice_scores'</span>],</span>
<span id="cb16-520"><a href="#cb16-520" aria-hidden="true" tabindex="-1"></a>        <span class="st">'F1'</span>: metrics[<span class="st">'f1'</span>]</span>
<span id="cb16-521"><a href="#cb16-521" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>class_names)</span>
<span id="cb16-522"><a href="#cb16-522" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-523"><a href="#cb16-523" aria-hidden="true" tabindex="-1"></a>    metrics_comparison.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>,<span class="dv">2</span>], alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb16-524"><a href="#cb16-524" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Metric Comparison per Class'</span>)</span>
<span id="cb16-525"><a href="#cb16-525" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Score'</span>)</span>
<span id="cb16-526"><a href="#cb16-526" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-527"><a href="#cb16-527" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].legend()</span>
<span id="cb16-528"><a href="#cb16-528" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb16-529"><a href="#cb16-529" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-530"><a href="#cb16-530" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-531"><a href="#cb16-531" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb16-532"><a href="#cb16-532" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-533"><a href="#cb16-533" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metrics, y_true, y_pred</span>
<span id="cb16-534"><a href="#cb16-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-535"><a href="#cb16-535" aria-hidden="true" tabindex="-1"></a>segmentation_metrics, gt_mask, pred_mask <span class="op">=</span> comprehensive_segmentation_evaluation()</span>
<span id="cb16-536"><a href="#cb16-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-537"><a href="#cb16-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-538"><a href="#cb16-538" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial Validation Strategies</span></span>
<span id="cb16-539"><a href="#cb16-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-540"><a href="#cb16-540" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cross-Validation with Spatial Awareness</span></span>
<span id="cb16-543"><a href="#cb16-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb16-544"><a href="#cb16-544" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demonstrate_spatial_cross_validation():</span>
<span id="cb16-545"><a href="#cb16-545" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate spatial cross-validation strategies"""</span></span>
<span id="cb16-546"><a href="#cb16-546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-547"><a href="#cb16-547" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate spatial data with coordinates</span></span>
<span id="cb16-548"><a href="#cb16-548" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb16-549"><a href="#cb16-549" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-550"><a href="#cb16-550" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate spatial grid</span></span>
<span id="cb16-551"><a href="#cb16-551" aria-hidden="true" tabindex="-1"></a>    grid_size <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb16-552"><a href="#cb16-552" aria-hidden="true" tabindex="-1"></a>    x_coords <span class="op">=</span> np.repeat(np.arange(grid_size), grid_size)</span>
<span id="cb16-553"><a href="#cb16-553" aria-hidden="true" tabindex="-1"></a>    y_coords <span class="op">=</span> np.tile(np.arange(grid_size), grid_size)</span>
<span id="cb16-554"><a href="#cb16-554" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-555"><a href="#cb16-555" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="bu">len</span>(x_coords)</span>
<span id="cb16-556"><a href="#cb16-556" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-557"><a href="#cb16-557" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate spatially correlated features and target</span></span>
<span id="cb16-558"><a href="#cb16-558" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create spatial autocorrelation structure</span></span>
<span id="cb16-559"><a href="#cb16-559" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> spatial_correlation(x1, y1, x2, y2, correlation_range<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb16-560"><a href="#cb16-560" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate spatial correlation based on distance"""</span></span>
<span id="cb16-561"><a href="#cb16-561" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> np.sqrt((x1 <span class="op">-</span> x2)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (y1 <span class="op">-</span> y2)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb16-562"><a href="#cb16-562" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.exp(<span class="op">-</span>distance <span class="op">/</span> correlation_range)</span>
<span id="cb16-563"><a href="#cb16-563" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-564"><a href="#cb16-564" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate correlated target variable</span></span>
<span id="cb16-565"><a href="#cb16-565" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.zeros(n_samples)</span>
<span id="cb16-566"><a href="#cb16-566" aria-hidden="true" tabindex="-1"></a>    base_trend <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (x_coords <span class="op">/</span> grid_size) <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> (y_coords <span class="op">/</span> grid_size)</span>
<span id="cb16-567"><a href="#cb16-567" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-568"><a href="#cb16-568" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb16-569"><a href="#cb16-569" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add spatially correlated noise</span></span>
<span id="cb16-570"><a href="#cb16-570" aria-hidden="true" tabindex="-1"></a>        spatial_component <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-571"><a href="#cb16-571" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">min</span>(<span class="dv">50</span>, n_samples)):  <span class="co"># Limit for computational efficiency</span></span>
<span id="cb16-572"><a href="#cb16-572" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">!=</span> j:</span>
<span id="cb16-573"><a href="#cb16-573" aria-hidden="true" tabindex="-1"></a>                weight <span class="op">=</span> spatial_correlation(x_coords[i], y_coords[i], x_coords[j], y_coords[j])</span>
<span id="cb16-574"><a href="#cb16-574" aria-hidden="true" tabindex="-1"></a>                spatial_component <span class="op">+=</span> weight <span class="op">*</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.1</span>)</span>
<span id="cb16-575"><a href="#cb16-575" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-576"><a href="#cb16-576" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">=</span> base_trend[i] <span class="op">+</span> spatial_component <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.2</span>)</span>
<span id="cb16-577"><a href="#cb16-577" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-578"><a href="#cb16-578" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate features</span></span>
<span id="cb16-579"><a href="#cb16-579" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> np.column_stack([</span>
<span id="cb16-580"><a href="#cb16-580" aria-hidden="true" tabindex="-1"></a>        x_coords <span class="op">/</span> grid_size,  <span class="co"># Normalized x coordinate</span></span>
<span id="cb16-581"><a href="#cb16-581" aria-hidden="true" tabindex="-1"></a>        y_coords <span class="op">/</span> grid_size,  <span class="co"># Normalized y coordinate</span></span>
<span id="cb16-582"><a href="#cb16-582" aria-hidden="true" tabindex="-1"></a>        np.random.normal(<span class="dv">0</span>, <span class="dv">1</span>, n_samples),  <span class="co"># Random feature 1</span></span>
<span id="cb16-583"><a href="#cb16-583" aria-hidden="true" tabindex="-1"></a>        np.random.normal(<span class="dv">0</span>, <span class="dv">1</span>, n_samples),  <span class="co"># Random feature 2</span></span>
<span id="cb16-584"><a href="#cb16-584" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb16-585"><a href="#cb16-585" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-586"><a href="#cb16-586" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Different cross-validation strategies</span></span>
<span id="cb16-587"><a href="#cb16-587" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> random_cv_split(X, y, n_folds<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb16-588"><a href="#cb16-588" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Standard random cross-validation"""</span></span>
<span id="cb16-589"><a href="#cb16-589" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold</span>
<span id="cb16-590"><a href="#cb16-590" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-591"><a href="#cb16-591" aria-hidden="true" tabindex="-1"></a>        kfold <span class="op">=</span> KFold(n_splits<span class="op">=</span>n_folds, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb16-592"><a href="#cb16-592" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">list</span>(kfold.split(X))</span>
<span id="cb16-593"><a href="#cb16-593" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-594"><a href="#cb16-594" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> spatial_block_cv_split(x_coords, y_coords, n_blocks<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb16-595"><a href="#cb16-595" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Spatial block cross-validation"""</span></span>
<span id="cb16-596"><a href="#cb16-596" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-597"><a href="#cb16-597" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Divide space into blocks</span></span>
<span id="cb16-598"><a href="#cb16-598" aria-hidden="true" tabindex="-1"></a>        x_blocks <span class="op">=</span> np.linspace(x_coords.<span class="bu">min</span>(), x_coords.<span class="bu">max</span>(), <span class="bu">int</span>(np.sqrt(n_blocks))<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb16-599"><a href="#cb16-599" aria-hidden="true" tabindex="-1"></a>        y_blocks <span class="op">=</span> np.linspace(y_coords.<span class="bu">min</span>(), y_coords.<span class="bu">max</span>(), <span class="bu">int</span>(np.sqrt(n_blocks))<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb16-600"><a href="#cb16-600" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-601"><a href="#cb16-601" aria-hidden="true" tabindex="-1"></a>        folds <span class="op">=</span> []</span>
<span id="cb16-602"><a href="#cb16-602" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x_blocks)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb16-603"><a href="#cb16-603" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(y_blocks)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb16-604"><a href="#cb16-604" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Test block</span></span>
<span id="cb16-605"><a href="#cb16-605" aria-hidden="true" tabindex="-1"></a>                test_mask <span class="op">=</span> ((x_coords <span class="op">&gt;=</span> x_blocks[i]) <span class="op">&amp;</span> (x_coords <span class="op">&lt;</span> x_blocks[i<span class="op">+</span><span class="dv">1</span>]) <span class="op">&amp;</span></span>
<span id="cb16-606"><a href="#cb16-606" aria-hidden="true" tabindex="-1"></a>                           (y_coords <span class="op">&gt;=</span> y_blocks[j]) <span class="op">&amp;</span> (y_coords <span class="op">&lt;</span> y_blocks[j<span class="op">+</span><span class="dv">1</span>]))</span>
<span id="cb16-607"><a href="#cb16-607" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb16-608"><a href="#cb16-608" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Training set is everything else</span></span>
<span id="cb16-609"><a href="#cb16-609" aria-hidden="true" tabindex="-1"></a>                train_mask <span class="op">=</span> <span class="op">~</span>test_mask</span>
<span id="cb16-610"><a href="#cb16-610" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb16-611"><a href="#cb16-611" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> test_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> train_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-612"><a href="#cb16-612" aria-hidden="true" tabindex="-1"></a>                    train_indices <span class="op">=</span> np.where(train_mask)[<span class="dv">0</span>]</span>
<span id="cb16-613"><a href="#cb16-613" aria-hidden="true" tabindex="-1"></a>                    test_indices <span class="op">=</span> np.where(test_mask)[<span class="dv">0</span>]</span>
<span id="cb16-614"><a href="#cb16-614" aria-hidden="true" tabindex="-1"></a>                    folds.append((train_indices, test_indices))</span>
<span id="cb16-615"><a href="#cb16-615" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-616"><a href="#cb16-616" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> folds</span>
<span id="cb16-617"><a href="#cb16-617" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-618"><a href="#cb16-618" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> spatial_buffer_cv_split(x_coords, y_coords, n_folds<span class="op">=</span><span class="dv">5</span>, buffer_distance<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb16-619"><a href="#cb16-619" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Spatial cross-validation with buffer zones"""</span></span>
<span id="cb16-620"><a href="#cb16-620" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold</span>
<span id="cb16-621"><a href="#cb16-621" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-622"><a href="#cb16-622" aria-hidden="true" tabindex="-1"></a>        <span class="co"># First, get random splits</span></span>
<span id="cb16-623"><a href="#cb16-623" aria-hidden="true" tabindex="-1"></a>        kfold <span class="op">=</span> KFold(n_splits<span class="op">=</span>n_folds, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb16-624"><a href="#cb16-624" aria-hidden="true" tabindex="-1"></a>        random_splits <span class="op">=</span> <span class="bu">list</span>(kfold.split(<span class="bu">range</span>(<span class="bu">len</span>(x_coords))))</span>
<span id="cb16-625"><a href="#cb16-625" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-626"><a href="#cb16-626" aria-hidden="true" tabindex="-1"></a>        buffered_splits <span class="op">=</span> []</span>
<span id="cb16-627"><a href="#cb16-627" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> train_idx, test_idx <span class="kw">in</span> random_splits:</span>
<span id="cb16-628"><a href="#cb16-628" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Remove training samples too close to test samples</span></span>
<span id="cb16-629"><a href="#cb16-629" aria-hidden="true" tabindex="-1"></a>            filtered_train_idx <span class="op">=</span> []</span>
<span id="cb16-630"><a href="#cb16-630" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-631"><a href="#cb16-631" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> train_i <span class="kw">in</span> train_idx:</span>
<span id="cb16-632"><a href="#cb16-632" aria-hidden="true" tabindex="-1"></a>                min_dist_to_test <span class="op">=</span> <span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb16-633"><a href="#cb16-633" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> test_i <span class="kw">in</span> test_idx:</span>
<span id="cb16-634"><a href="#cb16-634" aria-hidden="true" tabindex="-1"></a>                    dist <span class="op">=</span> np.sqrt((x_coords[train_i] <span class="op">-</span> x_coords[test_i])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb16-635"><a href="#cb16-635" aria-hidden="true" tabindex="-1"></a>                                 (y_coords[train_i] <span class="op">-</span> y_coords[test_i])<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb16-636"><a href="#cb16-636" aria-hidden="true" tabindex="-1"></a>                    min_dist_to_test <span class="op">=</span> <span class="bu">min</span>(min_dist_to_test, dist)</span>
<span id="cb16-637"><a href="#cb16-637" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb16-638"><a href="#cb16-638" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> min_dist_to_test <span class="op">&gt;=</span> buffer_distance:</span>
<span id="cb16-639"><a href="#cb16-639" aria-hidden="true" tabindex="-1"></a>                    filtered_train_idx.append(train_i)</span>
<span id="cb16-640"><a href="#cb16-640" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-641"><a href="#cb16-641" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(filtered_train_idx) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-642"><a href="#cb16-642" aria-hidden="true" tabindex="-1"></a>                buffered_splits.append((np.array(filtered_train_idx), test_idx))</span>
<span id="cb16-643"><a href="#cb16-643" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-644"><a href="#cb16-644" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> buffered_splits</span>
<span id="cb16-645"><a href="#cb16-645" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-646"><a href="#cb16-646" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate different CV strategies</span></span>
<span id="cb16-647"><a href="#cb16-647" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb16-648"><a href="#cb16-648" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb16-649"><a href="#cb16-649" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-650"><a href="#cb16-650" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_cv_strategy(X, y, cv_splits, strategy_name):</span>
<span id="cb16-651"><a href="#cb16-651" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Evaluate a cross-validation strategy"""</span></span>
<span id="cb16-652"><a href="#cb16-652" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-653"><a href="#cb16-653" aria-hidden="true" tabindex="-1"></a>        r2_scores <span class="op">=</span> []</span>
<span id="cb16-654"><a href="#cb16-654" aria-hidden="true" tabindex="-1"></a>        mse_scores <span class="op">=</span> []</span>
<span id="cb16-655"><a href="#cb16-655" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-656"><a href="#cb16-656" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> fold, (train_idx, test_idx) <span class="kw">in</span> <span class="bu">enumerate</span>(cv_splits):</span>
<span id="cb16-657"><a href="#cb16-657" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train model</span></span>
<span id="cb16-658"><a href="#cb16-658" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> LinearRegression()</span>
<span id="cb16-659"><a href="#cb16-659" aria-hidden="true" tabindex="-1"></a>            model.fit(X[train_idx], y[train_idx])</span>
<span id="cb16-660"><a href="#cb16-660" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-661"><a href="#cb16-661" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict on test set</span></span>
<span id="cb16-662"><a href="#cb16-662" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model.predict(X[test_idx])</span>
<span id="cb16-663"><a href="#cb16-663" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-664"><a href="#cb16-664" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate metrics</span></span>
<span id="cb16-665"><a href="#cb16-665" aria-hidden="true" tabindex="-1"></a>            r2 <span class="op">=</span> r2_score(y[test_idx], y_pred)</span>
<span id="cb16-666"><a href="#cb16-666" aria-hidden="true" tabindex="-1"></a>            mse <span class="op">=</span> mean_squared_error(y[test_idx], y_pred)</span>
<span id="cb16-667"><a href="#cb16-667" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-668"><a href="#cb16-668" aria-hidden="true" tabindex="-1"></a>            r2_scores.append(r2)</span>
<span id="cb16-669"><a href="#cb16-669" aria-hidden="true" tabindex="-1"></a>            mse_scores.append(mse)</span>
<span id="cb16-670"><a href="#cb16-670" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-671"><a href="#cb16-671" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb16-672"><a href="#cb16-672" aria-hidden="true" tabindex="-1"></a>            <span class="st">'strategy'</span>: strategy_name,</span>
<span id="cb16-673"><a href="#cb16-673" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2_mean'</span>: np.mean(r2_scores),</span>
<span id="cb16-674"><a href="#cb16-674" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2_std'</span>: np.std(r2_scores),</span>
<span id="cb16-675"><a href="#cb16-675" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mse_mean'</span>: np.mean(mse_scores),</span>
<span id="cb16-676"><a href="#cb16-676" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mse_std'</span>: np.std(mse_scores),</span>
<span id="cb16-677"><a href="#cb16-677" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_folds'</span>: <span class="bu">len</span>(cv_splits)</span>
<span id="cb16-678"><a href="#cb16-678" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-679"><a href="#cb16-679" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-680"><a href="#cb16-680" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply different CV strategies</span></span>
<span id="cb16-681"><a href="#cb16-681" aria-hidden="true" tabindex="-1"></a>    random_splits <span class="op">=</span> random_cv_split(X, y, n_folds<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb16-682"><a href="#cb16-682" aria-hidden="true" tabindex="-1"></a>    block_splits <span class="op">=</span> spatial_block_cv_split(x_coords, y_coords, n_blocks<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb16-683"><a href="#cb16-683" aria-hidden="true" tabindex="-1"></a>    buffer_splits <span class="op">=</span> spatial_buffer_cv_split(x_coords, y_coords, n_folds<span class="op">=</span><span class="dv">5</span>, buffer_distance<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-684"><a href="#cb16-684" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-685"><a href="#cb16-685" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate strategies</span></span>
<span id="cb16-686"><a href="#cb16-686" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb16-687"><a href="#cb16-687" aria-hidden="true" tabindex="-1"></a>    results.append(evaluate_cv_strategy(X, y, random_splits, <span class="st">'Random CV'</span>))</span>
<span id="cb16-688"><a href="#cb16-688" aria-hidden="true" tabindex="-1"></a>    results.append(evaluate_cv_strategy(X, y, block_splits, <span class="st">'Spatial Block CV'</span>))</span>
<span id="cb16-689"><a href="#cb16-689" aria-hidden="true" tabindex="-1"></a>    results.append(evaluate_cv_strategy(X, y, buffer_splits, <span class="st">'Spatial Buffer CV'</span>))</span>
<span id="cb16-690"><a href="#cb16-690" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-691"><a href="#cb16-691" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display results</span></span>
<span id="cb16-692"><a href="#cb16-692" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Spatial Cross-Validation Comparison:"</span>)</span>
<span id="cb16-693"><a href="#cb16-693" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb16-694"><a href="#cb16-694" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Strategy'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R² Mean'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R² Std'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MSE Mean'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MSE Std'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Folds'</span><span class="sc">:&lt;6}</span><span class="ss">"</span>)</span>
<span id="cb16-695"><a href="#cb16-695" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb16-696"><a href="#cb16-696" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-697"><a href="#cb16-697" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> results:</span>
<span id="cb16-698"><a href="#cb16-698" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'strategy'</span>]<span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'r2_mean'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'r2_std'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> "</span></span>
<span id="cb16-699"><a href="#cb16-699" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'mse_mean'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'mse_std'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'n_folds'</span>]<span class="sc">:&lt;6}</span><span class="ss">"</span>)</span>
<span id="cb16-700"><a href="#cb16-700" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-701"><a href="#cb16-701" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb16-702"><a href="#cb16-702" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb16-703"><a href="#cb16-703" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-704"><a href="#cb16-704" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data distribution</span></span>
<span id="cb16-705"><a href="#cb16-705" aria-hidden="true" tabindex="-1"></a>    scatter <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">0</span>].scatter(x_coords, y_coords, c<span class="op">=</span>y, cmap<span class="op">=</span><span class="st">'viridis'</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb16-706"><a href="#cb16-706" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Spatial Distribution of Target Variable'</span>)</span>
<span id="cb16-707"><a href="#cb16-707" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'X Coordinate'</span>)</span>
<span id="cb16-708"><a href="#cb16-708" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Y Coordinate'</span>)</span>
<span id="cb16-709"><a href="#cb16-709" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(scatter, ax<span class="op">=</span>axes[<span class="dv">0</span>,<span class="dv">0</span>])</span>
<span id="cb16-710"><a href="#cb16-710" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-711"><a href="#cb16-711" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random CV example (first fold)</span></span>
<span id="cb16-712"><a href="#cb16-712" aria-hidden="true" tabindex="-1"></a>    train_idx, test_idx <span class="op">=</span> random_splits[<span class="dv">0</span>]</span>
<span id="cb16-713"><a href="#cb16-713" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].scatter(x_coords[train_idx], y_coords[train_idx], c<span class="op">=</span><span class="st">'blue'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb16-714"><a href="#cb16-714" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].scatter(x_coords[test_idx], y_coords[test_idx], c<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Test'</span>)</span>
<span id="cb16-715"><a href="#cb16-715" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Random CV (Fold 1)'</span>)</span>
<span id="cb16-716"><a href="#cb16-716" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'X Coordinate'</span>)</span>
<span id="cb16-717"><a href="#cb16-717" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Y Coordinate'</span>)</span>
<span id="cb16-718"><a href="#cb16-718" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].legend()</span>
<span id="cb16-719"><a href="#cb16-719" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-720"><a href="#cb16-720" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Block CV example (first fold)</span></span>
<span id="cb16-721"><a href="#cb16-721" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> block_splits:</span>
<span id="cb16-722"><a href="#cb16-722" aria-hidden="true" tabindex="-1"></a>        train_idx, test_idx <span class="op">=</span> block_splits[<span class="dv">0</span>]</span>
<span id="cb16-723"><a href="#cb16-723" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].scatter(x_coords[train_idx], y_coords[train_idx], c<span class="op">=</span><span class="st">'blue'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb16-724"><a href="#cb16-724" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].scatter(x_coords[test_idx], y_coords[test_idx], c<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Test'</span>)</span>
<span id="cb16-725"><a href="#cb16-725" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'Spatial Block CV (Block 1)'</span>)</span>
<span id="cb16-726"><a href="#cb16-726" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].set_xlabel(<span class="st">'X Coordinate'</span>)</span>
<span id="cb16-727"><a href="#cb16-727" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Y Coordinate'</span>)</span>
<span id="cb16-728"><a href="#cb16-728" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>,<span class="dv">2</span>].legend()</span>
<span id="cb16-729"><a href="#cb16-729" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-730"><a href="#cb16-730" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buffer CV example (first fold)</span></span>
<span id="cb16-731"><a href="#cb16-731" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> buffer_splits:</span>
<span id="cb16-732"><a href="#cb16-732" aria-hidden="true" tabindex="-1"></a>        train_idx, test_idx <span class="op">=</span> buffer_splits[<span class="dv">0</span>]</span>
<span id="cb16-733"><a href="#cb16-733" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].scatter(x_coords[train_idx], y_coords[train_idx], c<span class="op">=</span><span class="st">'blue'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Train'</span>)</span>
<span id="cb16-734"><a href="#cb16-734" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].scatter(x_coords[test_idx], y_coords[test_idx], c<span class="op">=</span><span class="st">'red'</span>, s<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Test'</span>)</span>
<span id="cb16-735"><a href="#cb16-735" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'Spatial Buffer CV (Fold 1)'</span>)</span>
<span id="cb16-736"><a href="#cb16-736" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'X Coordinate'</span>)</span>
<span id="cb16-737"><a href="#cb16-737" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Y Coordinate'</span>)</span>
<span id="cb16-738"><a href="#cb16-738" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb16-739"><a href="#cb16-739" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-740"><a href="#cb16-740" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Performance comparison</span></span>
<span id="cb16-741"><a href="#cb16-741" aria-hidden="true" tabindex="-1"></a>    strategies <span class="op">=</span> [r[<span class="st">'strategy'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb16-742"><a href="#cb16-742" aria-hidden="true" tabindex="-1"></a>    r2_means <span class="op">=</span> [r[<span class="st">'r2_mean'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb16-743"><a href="#cb16-743" aria-hidden="true" tabindex="-1"></a>    r2_stds <span class="op">=</span> [r[<span class="st">'r2_std'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb16-744"><a href="#cb16-744" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-745"><a href="#cb16-745" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> axes[<span class="dv">1</span>,<span class="dv">1</span>].bar(strategies, r2_means, yerr<span class="op">=</span>r2_stds, capsize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb16-746"><a href="#cb16-746" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'Cross-Validation Performance Comparison'</span>)</span>
<span id="cb16-747"><a href="#cb16-747" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'R² Score'</span>)</span>
<span id="cb16-748"><a href="#cb16-748" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-749"><a href="#cb16-749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-750"><a href="#cb16-750" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MSE comparison</span></span>
<span id="cb16-751"><a href="#cb16-751" aria-hidden="true" tabindex="-1"></a>    mse_means <span class="op">=</span> [r[<span class="st">'mse_mean'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb16-752"><a href="#cb16-752" aria-hidden="true" tabindex="-1"></a>    mse_stds <span class="op">=</span> [r[<span class="st">'mse_std'</span>] <span class="cf">for</span> r <span class="kw">in</span> results]</span>
<span id="cb16-753"><a href="#cb16-753" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-754"><a href="#cb16-754" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> axes[<span class="dv">1</span>,<span class="dv">2</span>].bar(strategies, mse_means, yerr<span class="op">=</span>mse_stds, capsize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'lightcoral'</span>)</span>
<span id="cb16-755"><a href="#cb16-755" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'MSE Comparison'</span>)</span>
<span id="cb16-756"><a href="#cb16-756" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Mean Squared Error'</span>)</span>
<span id="cb16-757"><a href="#cb16-757" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">2</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-758"><a href="#cb16-758" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-759"><a href="#cb16-759" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-760"><a href="#cb16-760" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb16-761"><a href="#cb16-761" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-762"><a href="#cb16-762" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results, X, y, x_coords, y_coords</span>
<span id="cb16-763"><a href="#cb16-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-764"><a href="#cb16-764" aria-hidden="true" tabindex="-1"></a>spatial_cv_results, spatial_X, spatial_y, spatial_x, spatial_y <span class="op">=</span> demonstrate_spatial_cross_validation()</span>
<span id="cb16-765"><a href="#cb16-765" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-766"><a href="#cb16-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-767"><a href="#cb16-767" aria-hidden="true" tabindex="-1"></a><span class="fu">## Temporal Validation</span></span>
<span id="cb16-768"><a href="#cb16-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-769"><a href="#cb16-769" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time Series Cross-Validation</span></span>
<span id="cb16-772"><a href="#cb16-772" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb16-773"><a href="#cb16-773" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demonstrate_temporal_validation():</span>
<span id="cb16-774"><a href="#cb16-774" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate temporal validation strategies for time series data"""</span></span>
<span id="cb16-775"><a href="#cb16-775" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-776"><a href="#cb16-776" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate temporal dataset</span></span>
<span id="cb16-777"><a href="#cb16-777" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb16-778"><a href="#cb16-778" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-779"><a href="#cb16-779" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create time series with trend, seasonality, and noise</span></span>
<span id="cb16-780"><a href="#cb16-780" aria-hidden="true" tabindex="-1"></a>    n_timesteps <span class="op">=</span> <span class="dv">365</span> <span class="op">*</span> <span class="dv">3</span>  <span class="co"># 3 years of daily data</span></span>
<span id="cb16-781"><a href="#cb16-781" aria-hidden="true" tabindex="-1"></a>    time_index <span class="op">=</span> pd.date_range(<span class="st">'2020-01-01'</span>, periods<span class="op">=</span>n_timesteps, freq<span class="op">=</span><span class="st">'D'</span>)</span>
<span id="cb16-782"><a href="#cb16-782" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-783"><a href="#cb16-783" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate synthetic time series</span></span>
<span id="cb16-784"><a href="#cb16-784" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.arange(n_timesteps)</span>
<span id="cb16-785"><a href="#cb16-785" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-786"><a href="#cb16-786" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trend component</span></span>
<span id="cb16-787"><a href="#cb16-787" aria-hidden="true" tabindex="-1"></a>    trend <span class="op">=</span> <span class="fl">0.001</span> <span class="op">*</span> t</span>
<span id="cb16-788"><a href="#cb16-788" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-789"><a href="#cb16-789" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Seasonal components</span></span>
<span id="cb16-790"><a href="#cb16-790" aria-hidden="true" tabindex="-1"></a>    annual_cycle <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> <span class="dv">365</span>)</span>
<span id="cb16-791"><a href="#cb16-791" aria-hidden="true" tabindex="-1"></a>    weekly_cycle <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> <span class="dv">7</span>)</span>
<span id="cb16-792"><a href="#cb16-792" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-793"><a href="#cb16-793" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random noise</span></span>
<span id="cb16-794"><a href="#cb16-794" aria-hidden="true" tabindex="-1"></a>    noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.2</span>, n_timesteps)</span>
<span id="cb16-795"><a href="#cb16-795" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-796"><a href="#cb16-796" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine components</span></span>
<span id="cb16-797"><a href="#cb16-797" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> trend <span class="op">+</span> annual_cycle <span class="op">+</span> weekly_cycle <span class="op">+</span> noise</span>
<span id="cb16-798"><a href="#cb16-798" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-799"><a href="#cb16-799" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some extreme events</span></span>
<span id="cb16-800"><a href="#cb16-800" aria-hidden="true" tabindex="-1"></a>    extreme_events <span class="op">=</span> np.random.choice(n_timesteps, <span class="dv">10</span>, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-801"><a href="#cb16-801" aria-hidden="true" tabindex="-1"></a>    y[extreme_events] <span class="op">+=</span> np.random.normal(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">10</span>)</span>
<span id="cb16-802"><a href="#cb16-802" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-803"><a href="#cb16-803" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create features (lagged values, moving averages, etc.)</span></span>
<span id="cb16-804"><a href="#cb16-804" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_temporal_features(y, lookback_window<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb16-805"><a href="#cb16-805" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create temporal features for time series prediction"""</span></span>
<span id="cb16-806"><a href="#cb16-806" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-807"><a href="#cb16-807" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> []</span>
<span id="cb16-808"><a href="#cb16-808" aria-hidden="true" tabindex="-1"></a>        targets <span class="op">=</span> []</span>
<span id="cb16-809"><a href="#cb16-809" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-810"><a href="#cb16-810" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(lookback_window, <span class="bu">len</span>(y)):</span>
<span id="cb16-811"><a href="#cb16-811" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Lagged values</span></span>
<span id="cb16-812"><a href="#cb16-812" aria-hidden="true" tabindex="-1"></a>            lag_features <span class="op">=</span> y[i<span class="op">-</span>lookback_window:i]</span>
<span id="cb16-813"><a href="#cb16-813" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-814"><a href="#cb16-814" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Statistical features</span></span>
<span id="cb16-815"><a href="#cb16-815" aria-hidden="true" tabindex="-1"></a>            stat_features <span class="op">=</span> [</span>
<span id="cb16-816"><a href="#cb16-816" aria-hidden="true" tabindex="-1"></a>                np.mean(lag_features),</span>
<span id="cb16-817"><a href="#cb16-817" aria-hidden="true" tabindex="-1"></a>                np.std(lag_features),</span>
<span id="cb16-818"><a href="#cb16-818" aria-hidden="true" tabindex="-1"></a>                np.<span class="bu">min</span>(lag_features),</span>
<span id="cb16-819"><a href="#cb16-819" aria-hidden="true" tabindex="-1"></a>                np.<span class="bu">max</span>(lag_features),</span>
<span id="cb16-820"><a href="#cb16-820" aria-hidden="true" tabindex="-1"></a>                lag_features[<span class="op">-</span><span class="dv">1</span>],  <span class="co"># Most recent value</span></span>
<span id="cb16-821"><a href="#cb16-821" aria-hidden="true" tabindex="-1"></a>                lag_features[<span class="op">-</span><span class="dv">7</span>]   <span class="co"># Value from a week ago</span></span>
<span id="cb16-822"><a href="#cb16-822" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb16-823"><a href="#cb16-823" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-824"><a href="#cb16-824" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Time features</span></span>
<span id="cb16-825"><a href="#cb16-825" aria-hidden="true" tabindex="-1"></a>            day_of_year <span class="op">=</span> (i <span class="op">%</span> <span class="dv">365</span>) <span class="op">/</span> <span class="dv">365</span></span>
<span id="cb16-826"><a href="#cb16-826" aria-hidden="true" tabindex="-1"></a>            day_of_week <span class="op">=</span> (i <span class="op">%</span> <span class="dv">7</span>) <span class="op">/</span> <span class="dv">7</span></span>
<span id="cb16-827"><a href="#cb16-827" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-828"><a href="#cb16-828" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Combine all features</span></span>
<span id="cb16-829"><a href="#cb16-829" aria-hidden="true" tabindex="-1"></a>            all_features <span class="op">=</span> <span class="bu">list</span>(lag_features) <span class="op">+</span> stat_features <span class="op">+</span> [day_of_year, day_of_week]</span>
<span id="cb16-830"><a href="#cb16-830" aria-hidden="true" tabindex="-1"></a>            features.append(all_features)</span>
<span id="cb16-831"><a href="#cb16-831" aria-hidden="true" tabindex="-1"></a>            targets.append(y[i])</span>
<span id="cb16-832"><a href="#cb16-832" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-833"><a href="#cb16-833" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.array(features), np.array(targets)</span>
<span id="cb16-834"><a href="#cb16-834" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-835"><a href="#cb16-835" aria-hidden="true" tabindex="-1"></a>    X, y_target <span class="op">=</span> create_temporal_features(y, lookback_window<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb16-836"><a href="#cb16-836" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-837"><a href="#cb16-837" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temporal validation strategies</span></span>
<span id="cb16-838"><a href="#cb16-838" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> walk_forward_validation(X, y, n_splits<span class="op">=</span><span class="dv">5</span>, test_size<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb16-839"><a href="#cb16-839" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Walk-forward (expanding window) validation"""</span></span>
<span id="cb16-840"><a href="#cb16-840" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-841"><a href="#cb16-841" aria-hidden="true" tabindex="-1"></a>        n_samples <span class="op">=</span> <span class="bu">len</span>(X)</span>
<span id="cb16-842"><a href="#cb16-842" aria-hidden="true" tabindex="-1"></a>        min_train_size <span class="op">=</span> n_samples <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb16-843"><a href="#cb16-843" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-844"><a href="#cb16-844" aria-hidden="true" tabindex="-1"></a>        splits <span class="op">=</span> []</span>
<span id="cb16-845"><a href="#cb16-845" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_splits):</span>
<span id="cb16-846"><a href="#cb16-846" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Expanding training set</span></span>
<span id="cb16-847"><a href="#cb16-847" aria-hidden="true" tabindex="-1"></a>            train_end <span class="op">=</span> min_train_size <span class="op">+</span> i <span class="op">*</span> test_size</span>
<span id="cb16-848"><a href="#cb16-848" aria-hidden="true" tabindex="-1"></a>            test_start <span class="op">=</span> train_end</span>
<span id="cb16-849"><a href="#cb16-849" aria-hidden="true" tabindex="-1"></a>            test_end <span class="op">=</span> <span class="bu">min</span>(test_start <span class="op">+</span> test_size, n_samples)</span>
<span id="cb16-850"><a href="#cb16-850" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-851"><a href="#cb16-851" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> test_end <span class="op">&gt;</span> test_start:</span>
<span id="cb16-852"><a href="#cb16-852" aria-hidden="true" tabindex="-1"></a>                train_idx <span class="op">=</span> np.arange(<span class="dv">0</span>, train_end)</span>
<span id="cb16-853"><a href="#cb16-853" aria-hidden="true" tabindex="-1"></a>                test_idx <span class="op">=</span> np.arange(test_start, test_end)</span>
<span id="cb16-854"><a href="#cb16-854" aria-hidden="true" tabindex="-1"></a>                splits.append((train_idx, test_idx))</span>
<span id="cb16-855"><a href="#cb16-855" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-856"><a href="#cb16-856" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> splits</span>
<span id="cb16-857"><a href="#cb16-857" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-858"><a href="#cb16-858" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> time_series_split_validation(X, y, n_splits<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb16-859"><a href="#cb16-859" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Time series split validation (rolling window)"""</span></span>
<span id="cb16-860"><a href="#cb16-860" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb16-861"><a href="#cb16-861" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-862"><a href="#cb16-862" aria-hidden="true" tabindex="-1"></a>        tss <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span>n_splits)</span>
<span id="cb16-863"><a href="#cb16-863" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">list</span>(tss.split(X))</span>
<span id="cb16-864"><a href="#cb16-864" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-865"><a href="#cb16-865" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> seasonal_validation(X, y, season_length<span class="op">=</span><span class="dv">365</span>):</span>
<span id="cb16-866"><a href="#cb16-866" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Seasonal validation - train on some seasons, test on others"""</span></span>
<span id="cb16-867"><a href="#cb16-867" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-868"><a href="#cb16-868" aria-hidden="true" tabindex="-1"></a>        n_samples <span class="op">=</span> <span class="bu">len</span>(X)</span>
<span id="cb16-869"><a href="#cb16-869" aria-hidden="true" tabindex="-1"></a>        n_seasons <span class="op">=</span> n_samples <span class="op">//</span> season_length</span>
<span id="cb16-870"><a href="#cb16-870" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-871"><a href="#cb16-871" aria-hidden="true" tabindex="-1"></a>        splits <span class="op">=</span> []</span>
<span id="cb16-872"><a href="#cb16-872" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> test_season <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_seasons):  <span class="co"># Skip first season for training</span></span>
<span id="cb16-873"><a href="#cb16-873" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Training: all seasons except test season</span></span>
<span id="cb16-874"><a href="#cb16-874" aria-hidden="true" tabindex="-1"></a>            train_idx <span class="op">=</span> []</span>
<span id="cb16-875"><a href="#cb16-875" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> season <span class="kw">in</span> <span class="bu">range</span>(n_seasons):</span>
<span id="cb16-876"><a href="#cb16-876" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> season <span class="op">!=</span> test_season:</span>
<span id="cb16-877"><a href="#cb16-877" aria-hidden="true" tabindex="-1"></a>                    season_start <span class="op">=</span> season <span class="op">*</span> season_length</span>
<span id="cb16-878"><a href="#cb16-878" aria-hidden="true" tabindex="-1"></a>                    season_end <span class="op">=</span> <span class="bu">min</span>((season <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> season_length, n_samples)</span>
<span id="cb16-879"><a href="#cb16-879" aria-hidden="true" tabindex="-1"></a>                    train_idx.extend(<span class="bu">range</span>(season_start, season_end))</span>
<span id="cb16-880"><a href="#cb16-880" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-881"><a href="#cb16-881" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Test: specific season</span></span>
<span id="cb16-882"><a href="#cb16-882" aria-hidden="true" tabindex="-1"></a>            test_start <span class="op">=</span> test_season <span class="op">*</span> season_length</span>
<span id="cb16-883"><a href="#cb16-883" aria-hidden="true" tabindex="-1"></a>            test_end <span class="op">=</span> <span class="bu">min</span>((test_season <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> season_length, n_samples)</span>
<span id="cb16-884"><a href="#cb16-884" aria-hidden="true" tabindex="-1"></a>            test_idx <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(test_start, test_end))</span>
<span id="cb16-885"><a href="#cb16-885" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-886"><a href="#cb16-886" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(train_idx) <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(test_idx) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-887"><a href="#cb16-887" aria-hidden="true" tabindex="-1"></a>                splits.append((np.array(train_idx), np.array(test_idx)))</span>
<span id="cb16-888"><a href="#cb16-888" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-889"><a href="#cb16-889" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> splits</span>
<span id="cb16-890"><a href="#cb16-890" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-891"><a href="#cb16-891" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate different temporal validation strategies</span></span>
<span id="cb16-892"><a href="#cb16-892" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb16-893"><a href="#cb16-893" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-894"><a href="#cb16-894" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_temporal_strategy(X, y, cv_splits, strategy_name):</span>
<span id="cb16-895"><a href="#cb16-895" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Evaluate temporal validation strategy"""</span></span>
<span id="cb16-896"><a href="#cb16-896" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-897"><a href="#cb16-897" aria-hidden="true" tabindex="-1"></a>        r2_scores <span class="op">=</span> []</span>
<span id="cb16-898"><a href="#cb16-898" aria-hidden="true" tabindex="-1"></a>        mae_scores <span class="op">=</span> []</span>
<span id="cb16-899"><a href="#cb16-899" aria-hidden="true" tabindex="-1"></a>        predictions_all <span class="op">=</span> []</span>
<span id="cb16-900"><a href="#cb16-900" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-901"><a href="#cb16-901" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> fold, (train_idx, test_idx) <span class="kw">in</span> <span class="bu">enumerate</span>(cv_splits):</span>
<span id="cb16-902"><a href="#cb16-902" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train model</span></span>
<span id="cb16-903"><a href="#cb16-903" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb16-904"><a href="#cb16-904" aria-hidden="true" tabindex="-1"></a>            model.fit(X[train_idx], y[train_idx])</span>
<span id="cb16-905"><a href="#cb16-905" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-906"><a href="#cb16-906" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict</span></span>
<span id="cb16-907"><a href="#cb16-907" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model.predict(X[test_idx])</span>
<span id="cb16-908"><a href="#cb16-908" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-909"><a href="#cb16-909" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Metrics</span></span>
<span id="cb16-910"><a href="#cb16-910" aria-hidden="true" tabindex="-1"></a>            r2 <span class="op">=</span> r2_score(y[test_idx], y_pred)</span>
<span id="cb16-911"><a href="#cb16-911" aria-hidden="true" tabindex="-1"></a>            mae <span class="op">=</span> mean_absolute_error(y[test_idx], y_pred)</span>
<span id="cb16-912"><a href="#cb16-912" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-913"><a href="#cb16-913" aria-hidden="true" tabindex="-1"></a>            r2_scores.append(r2)</span>
<span id="cb16-914"><a href="#cb16-914" aria-hidden="true" tabindex="-1"></a>            mae_scores.append(mae)</span>
<span id="cb16-915"><a href="#cb16-915" aria-hidden="true" tabindex="-1"></a>            predictions_all.append((test_idx, y[test_idx], y_pred))</span>
<span id="cb16-916"><a href="#cb16-916" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-917"><a href="#cb16-917" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb16-918"><a href="#cb16-918" aria-hidden="true" tabindex="-1"></a>            <span class="st">'strategy'</span>: strategy_name,</span>
<span id="cb16-919"><a href="#cb16-919" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2_mean'</span>: np.mean(r2_scores),</span>
<span id="cb16-920"><a href="#cb16-920" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r2_std'</span>: np.std(r2_scores),</span>
<span id="cb16-921"><a href="#cb16-921" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mae_mean'</span>: np.mean(mae_scores),</span>
<span id="cb16-922"><a href="#cb16-922" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mae_std'</span>: np.std(mae_scores),</span>
<span id="cb16-923"><a href="#cb16-923" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predictions'</span>: predictions_all,</span>
<span id="cb16-924"><a href="#cb16-924" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_folds'</span>: <span class="bu">len</span>(cv_splits)</span>
<span id="cb16-925"><a href="#cb16-925" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-926"><a href="#cb16-926" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-927"><a href="#cb16-927" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply different strategies</span></span>
<span id="cb16-928"><a href="#cb16-928" aria-hidden="true" tabindex="-1"></a>    walk_forward_splits <span class="op">=</span> walk_forward_validation(X, y_target, n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb16-929"><a href="#cb16-929" aria-hidden="true" tabindex="-1"></a>    ts_splits <span class="op">=</span> time_series_split_validation(X, y_target, n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb16-930"><a href="#cb16-930" aria-hidden="true" tabindex="-1"></a>    seasonal_splits <span class="op">=</span> seasonal_validation(X, y_target, season_length<span class="op">=</span><span class="dv">365</span>)</span>
<span id="cb16-931"><a href="#cb16-931" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-932"><a href="#cb16-932" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate strategies</span></span>
<span id="cb16-933"><a href="#cb16-933" aria-hidden="true" tabindex="-1"></a>    temporal_results <span class="op">=</span> []</span>
<span id="cb16-934"><a href="#cb16-934" aria-hidden="true" tabindex="-1"></a>    temporal_results.append(evaluate_temporal_strategy(X, y_target, walk_forward_splits, <span class="st">'Walk Forward'</span>))</span>
<span id="cb16-935"><a href="#cb16-935" aria-hidden="true" tabindex="-1"></a>    temporal_results.append(evaluate_temporal_strategy(X, y_target, ts_splits, <span class="st">'Time Series Split'</span>))</span>
<span id="cb16-936"><a href="#cb16-936" aria-hidden="true" tabindex="-1"></a>    temporal_results.append(evaluate_temporal_strategy(X, y_target, seasonal_splits, <span class="st">'Seasonal Validation'</span>))</span>
<span id="cb16-937"><a href="#cb16-937" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-938"><a href="#cb16-938" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display results</span></span>
<span id="cb16-939"><a href="#cb16-939" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Temporal Validation Comparison:"</span>)</span>
<span id="cb16-940"><a href="#cb16-940" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb16-941"><a href="#cb16-941" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Strategy'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R² Mean'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R² Std'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MAE Mean'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MAE Std'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Folds'</span><span class="sc">:&lt;6}</span><span class="ss">"</span>)</span>
<span id="cb16-942"><a href="#cb16-942" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb16-943"><a href="#cb16-943" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-944"><a href="#cb16-944" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> temporal_results:</span>
<span id="cb16-945"><a href="#cb16-945" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'strategy'</span>]<span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'r2_mean'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'r2_std'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> "</span></span>
<span id="cb16-946"><a href="#cb16-946" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'mae_mean'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'mae_std'</span>]<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'n_folds'</span>]<span class="sc">:&lt;6}</span><span class="ss">"</span>)</span>
<span id="cb16-947"><a href="#cb16-947" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-948"><a href="#cb16-948" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb16-949"><a href="#cb16-949" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb16-950"><a href="#cb16-950" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-951"><a href="#cb16-951" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Original time series</span></span>
<span id="cb16-952"><a href="#cb16-952" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(time_index[:<span class="bu">len</span>(y)], y, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb16-953"><a href="#cb16-953" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Original Time Series'</span>)</span>
<span id="cb16-954"><a href="#cb16-954" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb16-955"><a href="#cb16-955" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Value'</span>)</span>
<span id="cb16-956"><a href="#cb16-956" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-957"><a href="#cb16-957" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-958"><a href="#cb16-958" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Performance comparison</span></span>
<span id="cb16-959"><a href="#cb16-959" aria-hidden="true" tabindex="-1"></a>    strategies <span class="op">=</span> [r[<span class="st">'strategy'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb16-960"><a href="#cb16-960" aria-hidden="true" tabindex="-1"></a>    r2_means <span class="op">=</span> [r[<span class="st">'r2_mean'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb16-961"><a href="#cb16-961" aria-hidden="true" tabindex="-1"></a>    r2_stds <span class="op">=</span> [r[<span class="st">'r2_std'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb16-962"><a href="#cb16-962" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-963"><a href="#cb16-963" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">1</span>].bar(strategies, r2_means, yerr<span class="op">=</span>r2_stds, capsize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb16-964"><a href="#cb16-964" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Temporal Validation Performance'</span>)</span>
<span id="cb16-965"><a href="#cb16-965" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'R² Score'</span>)</span>
<span id="cb16-966"><a href="#cb16-966" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-967"><a href="#cb16-967" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-968"><a href="#cb16-968" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MAE comparison</span></span>
<span id="cb16-969"><a href="#cb16-969" aria-hidden="true" tabindex="-1"></a>    mae_means <span class="op">=</span> [r[<span class="st">'mae_mean'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb16-970"><a href="#cb16-970" aria-hidden="true" tabindex="-1"></a>    mae_stds <span class="op">=</span> [r[<span class="st">'mae_std'</span>] <span class="cf">for</span> r <span class="kw">in</span> temporal_results]</span>
<span id="cb16-971"><a href="#cb16-971" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-972"><a href="#cb16-972" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> axes[<span class="dv">0</span>,<span class="dv">2</span>].bar(strategies, mae_means, yerr<span class="op">=</span>mae_stds, capsize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'lightcoral'</span>)</span>
<span id="cb16-973"><a href="#cb16-973" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_title(<span class="st">'MAE Comparison'</span>)</span>
<span id="cb16-974"><a href="#cb16-974" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Mean Absolute Error'</span>)</span>
<span id="cb16-975"><a href="#cb16-975" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">2</span>].tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb16-976"><a href="#cb16-976" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-977"><a href="#cb16-977" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example predictions for first strategy only (to fit in 2x3 grid)</span></span>
<span id="cb16-978"><a href="#cb16-978" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> temporal_results:</span>
<span id="cb16-979"><a href="#cb16-979" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> temporal_results[<span class="dv">0</span>]  <span class="co"># Show only first strategy</span></span>
<span id="cb16-980"><a href="#cb16-980" aria-hidden="true" tabindex="-1"></a>        test_idx, y_true_fold, y_pred_fold <span class="op">=</span> result[<span class="st">'predictions'</span>][<span class="dv">0</span>]</span>
<span id="cb16-981"><a href="#cb16-981" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-982"><a href="#cb16-982" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(y_true_fold, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb16-983"><a href="#cb16-983" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(y_pred_fold, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Predicted'</span>)</span>
<span id="cb16-984"><a href="#cb16-984" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="ss">f'</span><span class="sc">{</span>result[<span class="st">"strategy"</span>]<span class="sc">}</span><span class="ss"> - Example Predictions'</span>)</span>
<span id="cb16-985"><a href="#cb16-985" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'Value'</span>)</span>
<span id="cb16-986"><a href="#cb16-986" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb16-987"><a href="#cb16-987" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-988"><a href="#cb16-988" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-989"><a href="#cb16-989" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Residuals for first strategy</span></span>
<span id="cb16-990"><a href="#cb16-990" aria-hidden="true" tabindex="-1"></a>        residuals <span class="op">=</span> y_true_fold <span class="op">-</span> y_pred_fold</span>
<span id="cb16-991"><a href="#cb16-991" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].plot(residuals, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb16-992"><a href="#cb16-992" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb16-993"><a href="#cb16-993" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="ss">f'</span><span class="sc">{</span>result[<span class="st">"strategy"</span>]<span class="sc">}</span><span class="ss"> - Residuals'</span>)</span>
<span id="cb16-994"><a href="#cb16-994" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Residual'</span>)</span>
<span id="cb16-995"><a href="#cb16-995" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-996"><a href="#cb16-996" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-997"><a href="#cb16-997" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Residual histogram</span></span>
<span id="cb16-998"><a href="#cb16-998" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].hist(residuals, bins<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'skyblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb16-999"><a href="#cb16-999" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].set_title(<span class="st">'Residual Distribution'</span>)</span>
<span id="cb16-1000"><a href="#cb16-1000" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].set_xlabel(<span class="st">'Residual'</span>)</span>
<span id="cb16-1001"><a href="#cb16-1001" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb16-1002"><a href="#cb16-1002" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>,<span class="dv">2</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-1003"><a href="#cb16-1003" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1004"><a href="#cb16-1004" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-1005"><a href="#cb16-1005" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb16-1006"><a href="#cb16-1006" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1007"><a href="#cb16-1007" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> temporal_results, X, y_target, time_index</span>
<span id="cb16-1008"><a href="#cb16-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1009"><a href="#cb16-1009" aria-hidden="true" tabindex="-1"></a>temporal_results, temp_X, temp_y, temp_time <span class="op">=</span> demonstrate_temporal_validation()</span>
<span id="cb16-1010"><a href="#cb16-1010" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-1011"><a href="#cb16-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1012"><a href="#cb16-1012" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Uncertainty Quantification</span></span>
<span id="cb16-1013"><a href="#cb16-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1014"><a href="#cb16-1014" aria-hidden="true" tabindex="-1"></a><span class="fu">### Uncertainty Estimation Methods</span></span>
<span id="cb16-1017"><a href="#cb16-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb16-1018"><a href="#cb16-1018" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demonstrate_uncertainty_quantification():</span>
<span id="cb16-1019"><a href="#cb16-1019" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Demonstrate uncertainty quantification methods"""</span></span>
<span id="cb16-1020"><a href="#cb16-1020" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1021"><a href="#cb16-1021" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate dataset with varying noise levels</span></span>
<span id="cb16-1022"><a href="#cb16-1022" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb16-1023"><a href="#cb16-1023" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1024"><a href="#cb16-1024" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb16-1025"><a href="#cb16-1025" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">10</span>, n_samples).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb16-1026"><a href="#cb16-1026" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1027"><a href="#cb16-1027" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create heteroscedastic data (varying uncertainty)</span></span>
<span id="cb16-1028"><a href="#cb16-1028" aria-hidden="true" tabindex="-1"></a>    noise_levels <span class="op">=</span> <span class="fl">0.1</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> np.<span class="bu">abs</span>(np.sin(X.flatten()))</span>
<span id="cb16-1029"><a href="#cb16-1029" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> np.sin(X.flatten()) <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> X.flatten() <span class="op">+</span> np.random.normal(<span class="dv">0</span>, noise_levels)</span>
<span id="cb16-1030"><a href="#cb16-1030" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1031"><a href="#cb16-1031" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split data</span></span>
<span id="cb16-1032"><a href="#cb16-1032" aria-hidden="true" tabindex="-1"></a>    train_idx <span class="op">=</span> np.random.choice(n_samples, <span class="bu">int</span>(<span class="fl">0.7</span> <span class="op">*</span> n_samples), replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-1033"><a href="#cb16-1033" aria-hidden="true" tabindex="-1"></a>    test_idx <span class="op">=</span> np.setdiff1d(np.arange(n_samples), train_idx)</span>
<span id="cb16-1034"><a href="#cb16-1034" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1035"><a href="#cb16-1035" aria-hidden="true" tabindex="-1"></a>    X_train, X_test <span class="op">=</span> X[train_idx], X[test_idx]</span>
<span id="cb16-1036"><a href="#cb16-1036" aria-hidden="true" tabindex="-1"></a>    y_train, y_test <span class="op">=</span> y[train_idx], y[test_idx]</span>
<span id="cb16-1037"><a href="#cb16-1037" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1038"><a href="#cb16-1038" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 1: Bootstrap Aggregation</span></span>
<span id="cb16-1039"><a href="#cb16-1039" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bootstrap_uncertainty(X_train, y_train, X_test, n_bootstrap<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb16-1040"><a href="#cb16-1040" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Estimate uncertainty using bootstrap aggregation"""</span></span>
<span id="cb16-1041"><a href="#cb16-1041" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1042"><a href="#cb16-1042" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb16-1043"><a href="#cb16-1043" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1044"><a href="#cb16-1044" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> []</span>
<span id="cb16-1045"><a href="#cb16-1045" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1046"><a href="#cb16-1046" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_bootstrap):</span>
<span id="cb16-1047"><a href="#cb16-1047" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Bootstrap sample</span></span>
<span id="cb16-1048"><a href="#cb16-1048" aria-hidden="true" tabindex="-1"></a>            n_train <span class="op">=</span> <span class="bu">len</span>(X_train)</span>
<span id="cb16-1049"><a href="#cb16-1049" aria-hidden="true" tabindex="-1"></a>            bootstrap_idx <span class="op">=</span> np.random.choice(n_train, n_train, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-1050"><a href="#cb16-1050" aria-hidden="true" tabindex="-1"></a>            X_boot <span class="op">=</span> X_train[bootstrap_idx]</span>
<span id="cb16-1051"><a href="#cb16-1051" aria-hidden="true" tabindex="-1"></a>            y_boot <span class="op">=</span> y_train[bootstrap_idx]</span>
<span id="cb16-1052"><a href="#cb16-1052" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-1053"><a href="#cb16-1053" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train model</span></span>
<span id="cb16-1054"><a href="#cb16-1054" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">20</span>, random_state<span class="op">=</span>i)</span>
<span id="cb16-1055"><a href="#cb16-1055" aria-hidden="true" tabindex="-1"></a>            model.fit(X_boot, y_boot)</span>
<span id="cb16-1056"><a href="#cb16-1056" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-1057"><a href="#cb16-1057" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict</span></span>
<span id="cb16-1058"><a href="#cb16-1058" aria-hidden="true" tabindex="-1"></a>            pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb16-1059"><a href="#cb16-1059" aria-hidden="true" tabindex="-1"></a>            predictions.append(pred)</span>
<span id="cb16-1060"><a href="#cb16-1060" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1061"><a href="#cb16-1061" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> np.array(predictions)</span>
<span id="cb16-1062"><a href="#cb16-1062" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1063"><a href="#cb16-1063" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate statistics</span></span>
<span id="cb16-1064"><a href="#cb16-1064" aria-hidden="true" tabindex="-1"></a>        mean_pred <span class="op">=</span> np.mean(predictions, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-1065"><a href="#cb16-1065" aria-hidden="true" tabindex="-1"></a>        std_pred <span class="op">=</span> np.std(predictions, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-1066"><a href="#cb16-1066" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1067"><a href="#cb16-1067" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Confidence intervals</span></span>
<span id="cb16-1068"><a href="#cb16-1068" aria-hidden="true" tabindex="-1"></a>        ci_lower <span class="op">=</span> np.percentile(predictions, <span class="fl">2.5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-1069"><a href="#cb16-1069" aria-hidden="true" tabindex="-1"></a>        ci_upper <span class="op">=</span> np.percentile(predictions, <span class="fl">97.5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-1070"><a href="#cb16-1070" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1071"><a href="#cb16-1071" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mean_pred, std_pred, ci_lower, ci_upper</span>
<span id="cb16-1072"><a href="#cb16-1072" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1073"><a href="#cb16-1073" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 2: Quantile Regression</span></span>
<span id="cb16-1074"><a href="#cb16-1074" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> quantile_regression_uncertainty(X_train, y_train, X_test, quantiles<span class="op">=</span>[<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>]):</span>
<span id="cb16-1075"><a href="#cb16-1075" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Estimate uncertainty using quantile regression"""</span></span>
<span id="cb16-1076"><a href="#cb16-1076" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1077"><a href="#cb16-1077" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.ensemble <span class="im">import</span> GradientBoostingRegressor</span>
<span id="cb16-1078"><a href="#cb16-1078" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1079"><a href="#cb16-1079" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> {}</span>
<span id="cb16-1080"><a href="#cb16-1080" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1081"><a href="#cb16-1081" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> q <span class="kw">in</span> quantiles:</span>
<span id="cb16-1082"><a href="#cb16-1082" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> GradientBoostingRegressor(loss<span class="op">=</span><span class="st">'quantile'</span>, alpha<span class="op">=</span>q, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb16-1083"><a href="#cb16-1083" aria-hidden="true" tabindex="-1"></a>            model.fit(X_train, y_train)</span>
<span id="cb16-1084"><a href="#cb16-1084" aria-hidden="true" tabindex="-1"></a>            predictions[q] <span class="op">=</span> model.predict(X_test)</span>
<span id="cb16-1085"><a href="#cb16-1085" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1086"><a href="#cb16-1086" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predictions</span>
<span id="cb16-1087"><a href="#cb16-1087" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1088"><a href="#cb16-1088" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 3: Monte Carlo Dropout (simplified)</span></span>
<span id="cb16-1089"><a href="#cb16-1089" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> MCDropoutModel(nn.Module):</span>
<span id="cb16-1090"><a href="#cb16-1090" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Simple neural network with Monte Carlo Dropout"""</span></span>
<span id="cb16-1091"><a href="#cb16-1091" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1092"><a href="#cb16-1092" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_dim<span class="op">=</span><span class="dv">1</span>, hidden_dim<span class="op">=</span><span class="dv">50</span>, dropout_rate<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb16-1093"><a href="#cb16-1093" aria-hidden="true" tabindex="-1"></a>            <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb16-1094"><a href="#cb16-1094" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers <span class="op">=</span> nn.Sequential(</span>
<span id="cb16-1095"><a href="#cb16-1095" aria-hidden="true" tabindex="-1"></a>                nn.Linear(input_dim, hidden_dim),</span>
<span id="cb16-1096"><a href="#cb16-1096" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb16-1097"><a href="#cb16-1097" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(dropout_rate),</span>
<span id="cb16-1098"><a href="#cb16-1098" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim, hidden_dim),</span>
<span id="cb16-1099"><a href="#cb16-1099" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(), </span>
<span id="cb16-1100"><a href="#cb16-1100" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(dropout_rate),</span>
<span id="cb16-1101"><a href="#cb16-1101" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim, <span class="dv">1</span>)</span>
<span id="cb16-1102"><a href="#cb16-1102" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-1103"><a href="#cb16-1103" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.dropout_rate <span class="op">=</span> dropout_rate</span>
<span id="cb16-1104"><a href="#cb16-1104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1105"><a href="#cb16-1105" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb16-1106"><a href="#cb16-1106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.layers(x)</span>
<span id="cb16-1107"><a href="#cb16-1107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1108"><a href="#cb16-1108" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> predict_with_uncertainty(<span class="va">self</span>, x, n_samples<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb16-1109"><a href="#cb16-1109" aria-hidden="true" tabindex="-1"></a>            <span class="co">"""Predict with MC Dropout uncertainty"""</span></span>
<span id="cb16-1110"><a href="#cb16-1110" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-1111"><a href="#cb16-1111" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.train()  <span class="co"># Keep in training mode for dropout</span></span>
<span id="cb16-1112"><a href="#cb16-1112" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> []</span>
<span id="cb16-1113"><a href="#cb16-1113" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-1114"><a href="#cb16-1114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb16-1115"><a href="#cb16-1115" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb16-1116"><a href="#cb16-1116" aria-hidden="true" tabindex="-1"></a>                    pred <span class="op">=</span> <span class="va">self</span>(x)</span>
<span id="cb16-1117"><a href="#cb16-1117" aria-hidden="true" tabindex="-1"></a>                    predictions.append(pred.numpy())</span>
<span id="cb16-1118"><a href="#cb16-1118" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-1119"><a href="#cb16-1119" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> np.array(predictions).squeeze()</span>
<span id="cb16-1120"><a href="#cb16-1120" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-1121"><a href="#cb16-1121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> predictions.ndim <span class="op">==</span> <span class="dv">1</span>:  <span class="co"># Single prediction</span></span>
<span id="cb16-1122"><a href="#cb16-1122" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> predictions.mean(), predictions.std()</span>
<span id="cb16-1123"><a href="#cb16-1123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:  <span class="co"># Multiple predictions</span></span>
<span id="cb16-1124"><a href="#cb16-1124" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> predictions.mean(axis<span class="op">=</span><span class="dv">0</span>), predictions.std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-1125"><a href="#cb16-1125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1126"><a href="#cb16-1126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mc_dropout_uncertainty(X_train, y_train, X_test):</span>
<span id="cb16-1127"><a href="#cb16-1127" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Train MC Dropout model and get uncertainty estimates"""</span></span>
<span id="cb16-1128"><a href="#cb16-1128" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1129"><a href="#cb16-1129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert to tensors</span></span>
<span id="cb16-1130"><a href="#cb16-1130" aria-hidden="true" tabindex="-1"></a>        X_train_tensor <span class="op">=</span> torch.FloatTensor(X_train)</span>
<span id="cb16-1131"><a href="#cb16-1131" aria-hidden="true" tabindex="-1"></a>        y_train_tensor <span class="op">=</span> torch.FloatTensor(y_train).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb16-1132"><a href="#cb16-1132" aria-hidden="true" tabindex="-1"></a>        X_test_tensor <span class="op">=</span> torch.FloatTensor(X_test)</span>
<span id="cb16-1133"><a href="#cb16-1133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1134"><a href="#cb16-1134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train model</span></span>
<span id="cb16-1135"><a href="#cb16-1135" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> MCDropoutModel()</span>
<span id="cb16-1136"><a href="#cb16-1136" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb16-1137"><a href="#cb16-1137" aria-hidden="true" tabindex="-1"></a>        criterion <span class="op">=</span> nn.MSELoss()</span>
<span id="cb16-1138"><a href="#cb16-1138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1139"><a href="#cb16-1139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Simple training loop</span></span>
<span id="cb16-1140"><a href="#cb16-1140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb16-1141"><a href="#cb16-1141" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb16-1142"><a href="#cb16-1142" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(X_train_tensor)</span>
<span id="cb16-1143"><a href="#cb16-1143" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(outputs, y_train_tensor)</span>
<span id="cb16-1144"><a href="#cb16-1144" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb16-1145"><a href="#cb16-1145" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb16-1146"><a href="#cb16-1146" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1147"><a href="#cb16-1147" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get predictions with uncertainty</span></span>
<span id="cb16-1148"><a href="#cb16-1148" aria-hidden="true" tabindex="-1"></a>        mean_pred, std_pred <span class="op">=</span> model.predict_with_uncertainty(X_test_tensor)</span>
<span id="cb16-1149"><a href="#cb16-1149" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1150"><a href="#cb16-1150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mean_pred, std_pred</span>
<span id="cb16-1151"><a href="#cb16-1151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1152"><a href="#cb16-1152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply different uncertainty methods</span></span>
<span id="cb16-1153"><a href="#cb16-1153" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Uncertainty Quantification Methods:"</span>)</span>
<span id="cb16-1154"><a href="#cb16-1154" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb16-1155"><a href="#cb16-1155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1156"><a href="#cb16-1156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap</span></span>
<span id="cb16-1157"><a href="#cb16-1157" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Running Bootstrap Aggregation..."</span>)</span>
<span id="cb16-1158"><a href="#cb16-1158" aria-hidden="true" tabindex="-1"></a>    boot_mean, boot_std, boot_lower, boot_upper <span class="op">=</span> bootstrap_uncertainty(X_train, y_train, X_test)</span>
<span id="cb16-1159"><a href="#cb16-1159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1160"><a href="#cb16-1160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile regression</span></span>
<span id="cb16-1161"><a href="#cb16-1161" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Running Quantile Regression..."</span>)</span>
<span id="cb16-1162"><a href="#cb16-1162" aria-hidden="true" tabindex="-1"></a>    quantile_preds <span class="op">=</span> quantile_regression_uncertainty(X_train, y_train, X_test)</span>
<span id="cb16-1163"><a href="#cb16-1163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1164"><a href="#cb16-1164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MC Dropout</span></span>
<span id="cb16-1165"><a href="#cb16-1165" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Running MC Dropout..."</span>)</span>
<span id="cb16-1166"><a href="#cb16-1166" aria-hidden="true" tabindex="-1"></a>    mc_mean, mc_std <span class="op">=</span> mc_dropout_uncertainty(X_train, y_train, X_test)</span>
<span id="cb16-1167"><a href="#cb16-1167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1168"><a href="#cb16-1168" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate uncertainty metrics</span></span>
<span id="cb16-1169"><a href="#cb16-1169" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_uncertainty(y_true, mean_pred, std_pred<span class="op">=</span><span class="va">None</span>, ci_lower<span class="op">=</span><span class="va">None</span>, ci_upper<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb16-1170"><a href="#cb16-1170" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Evaluate uncertainty estimation quality"""</span></span>
<span id="cb16-1171"><a href="#cb16-1171" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1172"><a href="#cb16-1172" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prediction accuracy</span></span>
<span id="cb16-1173"><a href="#cb16-1173" aria-hidden="true" tabindex="-1"></a>        mae <span class="op">=</span> mean_absolute_error(y_true, mean_pred)</span>
<span id="cb16-1174"><a href="#cb16-1174" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_true, mean_pred))</span>
<span id="cb16-1175"><a href="#cb16-1175" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> r2_score(y_true, mean_pred)</span>
<span id="cb16-1176"><a href="#cb16-1176" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1177"><a href="#cb16-1177" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> {<span class="st">'mae'</span>: mae, <span class="st">'rmse'</span>: rmse, <span class="st">'r2'</span>: r2}</span>
<span id="cb16-1178"><a href="#cb16-1178" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1179"><a href="#cb16-1179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> std_pred <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb16-1180"><a href="#cb16-1180" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Uncertainty calibration</span></span>
<span id="cb16-1181"><a href="#cb16-1181" aria-hidden="true" tabindex="-1"></a>            residuals <span class="op">=</span> np.<span class="bu">abs</span>(y_true <span class="op">-</span> mean_pred)</span>
<span id="cb16-1182"><a href="#cb16-1182" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-1183"><a href="#cb16-1183" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Correlation between predicted uncertainty and actual errors</span></span>
<span id="cb16-1184"><a href="#cb16-1184" aria-hidden="true" tabindex="-1"></a>            uncertainty_correlation <span class="op">=</span> np.corrcoef(std_pred, residuals)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb16-1185"><a href="#cb16-1185" aria-hidden="true" tabindex="-1"></a>            metrics[<span class="st">'uncertainty_correlation'</span>] <span class="op">=</span> uncertainty_correlation</span>
<span id="cb16-1186"><a href="#cb16-1186" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1187"><a href="#cb16-1187" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ci_lower <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> ci_upper <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb16-1188"><a href="#cb16-1188" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Coverage probability (should be ~95% for 95% CI)</span></span>
<span id="cb16-1189"><a href="#cb16-1189" aria-hidden="true" tabindex="-1"></a>            in_interval <span class="op">=</span> (y_true <span class="op">&gt;=</span> ci_lower) <span class="op">&amp;</span> (y_true <span class="op">&lt;=</span> ci_upper)</span>
<span id="cb16-1190"><a href="#cb16-1190" aria-hidden="true" tabindex="-1"></a>            coverage <span class="op">=</span> np.mean(in_interval)</span>
<span id="cb16-1191"><a href="#cb16-1191" aria-hidden="true" tabindex="-1"></a>            metrics[<span class="st">'coverage'</span>] <span class="op">=</span> coverage</span>
<span id="cb16-1192"><a href="#cb16-1192" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-1193"><a href="#cb16-1193" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Interval width</span></span>
<span id="cb16-1194"><a href="#cb16-1194" aria-hidden="true" tabindex="-1"></a>            interval_width <span class="op">=</span> np.mean(ci_upper <span class="op">-</span> ci_lower)</span>
<span id="cb16-1195"><a href="#cb16-1195" aria-hidden="true" tabindex="-1"></a>            metrics[<span class="st">'mean_interval_width'</span>] <span class="op">=</span> interval_width</span>
<span id="cb16-1196"><a href="#cb16-1196" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-1197"><a href="#cb16-1197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> metrics</span>
<span id="cb16-1198"><a href="#cb16-1198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1199"><a href="#cb16-1199" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate methods</span></span>
<span id="cb16-1200"><a href="#cb16-1200" aria-hidden="true" tabindex="-1"></a>    boot_metrics <span class="op">=</span> evaluate_uncertainty(y_test, boot_mean, boot_std, boot_lower, boot_upper)</span>
<span id="cb16-1201"><a href="#cb16-1201" aria-hidden="true" tabindex="-1"></a>    quantile_metrics <span class="op">=</span> evaluate_uncertainty(y_test, quantile_preds[<span class="fl">0.5</span>], </span>
<span id="cb16-1202"><a href="#cb16-1202" aria-hidden="true" tabindex="-1"></a>                                          ci_lower<span class="op">=</span>quantile_preds[<span class="fl">0.025</span>], </span>
<span id="cb16-1203"><a href="#cb16-1203" aria-hidden="true" tabindex="-1"></a>                                          ci_upper<span class="op">=</span>quantile_preds[<span class="fl">0.975</span>])</span>
<span id="cb16-1204"><a href="#cb16-1204" aria-hidden="true" tabindex="-1"></a>    mc_metrics <span class="op">=</span> evaluate_uncertainty(y_test, mc_mean, mc_std)</span>
<span id="cb16-1205"><a href="#cb16-1205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1206"><a href="#cb16-1206" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Uncertainty Evaluation Results:"</span>)</span>
<span id="cb16-1207"><a href="#cb16-1207" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb16-1208"><a href="#cb16-1208" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Method'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MAE'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'RMSE'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R²'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Coverage'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Uncert.Corr'</span><span class="sc">:&lt;12}</span><span class="ss">"</span>)</span>
<span id="cb16-1209"><a href="#cb16-1209" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb16-1210"><a href="#cb16-1210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1211"><a href="#cb16-1211" aria-hidden="true" tabindex="-1"></a>    methods_data <span class="op">=</span> [</span>
<span id="cb16-1212"><a href="#cb16-1212" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'Bootstrap'</span>, boot_metrics),</span>
<span id="cb16-1213"><a href="#cb16-1213" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'Quantile Reg.'</span>, quantile_metrics),</span>
<span id="cb16-1214"><a href="#cb16-1214" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'MC Dropout'</span>, mc_metrics)</span>
<span id="cb16-1215"><a href="#cb16-1215" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb16-1216"><a href="#cb16-1216" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1217"><a href="#cb16-1217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> method_name, metrics <span class="kw">in</span> methods_data:</span>
<span id="cb16-1218"><a href="#cb16-1218" aria-hidden="true" tabindex="-1"></a>        coverage <span class="op">=</span> metrics.get(<span class="st">'coverage'</span>, <span class="dv">0</span>)</span>
<span id="cb16-1219"><a href="#cb16-1219" aria-hidden="true" tabindex="-1"></a>        uncert_corr <span class="op">=</span> metrics.get(<span class="st">'uncertainty_correlation'</span>, <span class="dv">0</span>)</span>
<span id="cb16-1220"><a href="#cb16-1220" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>method_name<span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'mae'</span>]<span class="sc">:&lt;8.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'rmse'</span>]<span class="sc">:&lt;8.3f}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'r2'</span>]<span class="sc">:&lt;8.3f}</span><span class="ss"> "</span></span>
<span id="cb16-1221"><a href="#cb16-1221" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>coverage<span class="sc">:&lt;10.3f}</span><span class="ss"> </span><span class="sc">{</span>uncert_corr<span class="sc">:&lt;12.3f}</span><span class="ss">"</span>)</span>
<span id="cb16-1222"><a href="#cb16-1222" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1223"><a href="#cb16-1223" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualizations</span></span>
<span id="cb16-1224"><a href="#cb16-1224" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">12</span>))</span>
<span id="cb16-1225"><a href="#cb16-1225" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1226"><a href="#cb16-1226" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort test data for plotting</span></span>
<span id="cb16-1227"><a href="#cb16-1227" aria-hidden="true" tabindex="-1"></a>    sort_idx <span class="op">=</span> np.argsort(X_test.flatten())</span>
<span id="cb16-1228"><a href="#cb16-1228" aria-hidden="true" tabindex="-1"></a>    X_test_sorted <span class="op">=</span> X_test[sort_idx]</span>
<span id="cb16-1229"><a href="#cb16-1229" aria-hidden="true" tabindex="-1"></a>    y_test_sorted <span class="op">=</span> y_test[sort_idx]</span>
<span id="cb16-1230"><a href="#cb16-1230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1231"><a href="#cb16-1231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap results</span></span>
<span id="cb16-1232"><a href="#cb16-1232" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].scatter(X_test, y_test, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>, label<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb16-1233"><a href="#cb16-1233" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(X_test_sorted, boot_mean[sort_idx], <span class="st">'r-'</span>, label<span class="op">=</span><span class="st">'Prediction'</span>)</span>
<span id="cb16-1234"><a href="#cb16-1234" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].fill_between(X_test_sorted.flatten(), </span>
<span id="cb16-1235"><a href="#cb16-1235" aria-hidden="true" tabindex="-1"></a>                          boot_lower[sort_idx], boot_upper[sort_idx], </span>
<span id="cb16-1236"><a href="#cb16-1236" aria-hidden="true" tabindex="-1"></a>                          alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>)</span>
<span id="cb16-1237"><a href="#cb16-1237" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].set_title(<span class="st">'Bootstrap Aggregation'</span>)</span>
<span id="cb16-1238"><a href="#cb16-1238" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].legend()</span>
<span id="cb16-1239"><a href="#cb16-1239" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-1240"><a href="#cb16-1240" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1241"><a href="#cb16-1241" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile regression</span></span>
<span id="cb16-1242"><a href="#cb16-1242" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].scatter(X_test, y_test, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>, label<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb16-1243"><a href="#cb16-1243" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].plot(X_test_sorted, quantile_preds[<span class="fl">0.5</span>][sort_idx], <span class="st">'g-'</span>, label<span class="op">=</span><span class="st">'Median'</span>)</span>
<span id="cb16-1244"><a href="#cb16-1244" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].fill_between(X_test_sorted.flatten(),</span>
<span id="cb16-1245"><a href="#cb16-1245" aria-hidden="true" tabindex="-1"></a>                          quantile_preds[<span class="fl">0.025</span>][sort_idx], quantile_preds[<span class="fl">0.975</span>][sort_idx],</span>
<span id="cb16-1246"><a href="#cb16-1246" aria-hidden="true" tabindex="-1"></a>                          alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'green'</span>, label<span class="op">=</span><span class="st">'95% PI'</span>)</span>
<span id="cb16-1247"><a href="#cb16-1247" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].set_title(<span class="st">'Quantile Regression'</span>)</span>
<span id="cb16-1248"><a href="#cb16-1248" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].legend()</span>
<span id="cb16-1249"><a href="#cb16-1249" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-1250"><a href="#cb16-1250" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1251"><a href="#cb16-1251" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MC Dropout</span></span>
<span id="cb16-1252"><a href="#cb16-1252" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].scatter(X_test, y_test, alpha<span class="op">=</span><span class="fl">0.6</span>, s<span class="op">=</span><span class="dv">20</span>, label<span class="op">=</span><span class="st">'True'</span>)</span>
<span id="cb16-1253"><a href="#cb16-1253" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].plot(X_test_sorted, mc_mean[sort_idx], <span class="st">'b-'</span>, label<span class="op">=</span><span class="st">'Mean'</span>)</span>
<span id="cb16-1254"><a href="#cb16-1254" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1255"><a href="#cb16-1255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate confidence intervals for MC Dropout</span></span>
<span id="cb16-1256"><a href="#cb16-1256" aria-hidden="true" tabindex="-1"></a>    mc_lower <span class="op">=</span> mc_mean <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> mc_std</span>
<span id="cb16-1257"><a href="#cb16-1257" aria-hidden="true" tabindex="-1"></a>    mc_upper <span class="op">=</span> mc_mean <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> mc_std</span>
<span id="cb16-1258"><a href="#cb16-1258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1259"><a href="#cb16-1259" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].fill_between(X_test_sorted.flatten(),</span>
<span id="cb16-1260"><a href="#cb16-1260" aria-hidden="true" tabindex="-1"></a>                          mc_lower[sort_idx], mc_upper[sort_idx],</span>
<span id="cb16-1261"><a href="#cb16-1261" aria-hidden="true" tabindex="-1"></a>                          alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'blue'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>)</span>
<span id="cb16-1262"><a href="#cb16-1262" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].set_title(<span class="st">'MC Dropout'</span>)</span>
<span id="cb16-1263"><a href="#cb16-1263" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].legend()</span>
<span id="cb16-1264"><a href="#cb16-1264" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-1265"><a href="#cb16-1265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1266"><a href="#cb16-1266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Uncertainty comparison</span></span>
<span id="cb16-1267"><a href="#cb16-1267" aria-hidden="true" tabindex="-1"></a>    residuals_boot <span class="op">=</span> np.<span class="bu">abs</span>(y_test <span class="op">-</span> boot_mean)</span>
<span id="cb16-1268"><a href="#cb16-1268" aria-hidden="true" tabindex="-1"></a>    residuals_mc <span class="op">=</span> np.<span class="bu">abs</span>(y_test <span class="op">-</span> mc_mean)</span>
<span id="cb16-1269"><a href="#cb16-1269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1270"><a href="#cb16-1270" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].scatter(boot_std, residuals_boot, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Bootstrap'</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb16-1271"><a href="#cb16-1271" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].scatter(mc_std, residuals_mc, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'MC Dropout'</span>, s<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb16-1272"><a href="#cb16-1272" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted Uncertainty'</span>)</span>
<span id="cb16-1273"><a href="#cb16-1273" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'Absolute Error'</span>)</span>
<span id="cb16-1274"><a href="#cb16-1274" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].set_title(<span class="st">'Uncertainty vs Actual Error'</span>)</span>
<span id="cb16-1275"><a href="#cb16-1275" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].legend()</span>
<span id="cb16-1276"><a href="#cb16-1276" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>,<span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-1277"><a href="#cb16-1277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1278"><a href="#cb16-1278" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-1279"><a href="#cb16-1279" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb16-1280"><a href="#cb16-1280" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-1281"><a href="#cb16-1281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> methods_data</span>
<span id="cb16-1282"><a href="#cb16-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1283"><a href="#cb16-1283" aria-hidden="true" tabindex="-1"></a>uncertainty_methods <span class="op">=</span> demonstrate_uncertainty_quantification()</span>
<span id="cb16-1284"><a href="#cb16-1284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb16-1285"><a href="#cb16-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1286"><a href="#cb16-1286" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb16-1287"><a href="#cb16-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1288"><a href="#cb16-1288" aria-hidden="true" tabindex="-1"></a>Key concepts for model evaluation and validation:</span>
<span id="cb16-1289"><a href="#cb16-1289" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Classification Metrics**: Accuracy, precision, recall, F1, AUC, confusion matrices</span>
<span id="cb16-1290"><a href="#cb16-1290" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Regression Metrics**: MAE, MSE, RMSE, R², residual analysis</span>
<span id="cb16-1291"><a href="#cb16-1291" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Segmentation Metrics**: IoU, Dice coefficient, pixel accuracy, mean accuracy</span>
<span id="cb16-1292"><a href="#cb16-1292" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Spatial Validation**: Block CV, buffer zones, spatial independence</span>
<span id="cb16-1293"><a href="#cb16-1293" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Temporal Validation**: Walk-forward, time series splits, seasonal validation</span>
<span id="cb16-1294"><a href="#cb16-1294" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Uncertainty Quantification**: Bootstrap, quantile regression, Monte Carlo dropout</span>
<span id="cb16-1295"><a href="#cb16-1295" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Domain-Specific Considerations**: Spatial autocorrelation, temporal dependencies</span>
<span id="cb16-1296"><a href="#cb16-1296" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Comprehensive Evaluation**: Multiple metrics, visualization, statistical testing</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../images/geog-logo.png" class="img-fluid figure-img" width="250"></p>
<figcaption>Department of Geography logo</figcaption>
</figure>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This website is built with <a href="https://github.com/kcaylor/GEOG-288KC-geospatial-foundation-models"><i class="fa-brands fa-github" title="the github octocat logo" aria-label="github"></i></a> and <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>